---
title: スクリプト監視の設定手順 - UNIX/Linux 編
date: 2022-10-31 18:00:00
tags:
  - SCOM
  - Operations Manager
  - スクリプト
  - スクリプト監視
  - スクリプト実行
---

皆様こんにちは、System Center サポートチームの 石原 です。
本日は System Center Operations Manager（以後 SCOM） で監視対象の UNIX/Linux サーバーにて任意のスクリプトを実行する手順を紹介いたします。

<!-- more -->
SCOM では監視対象のサーバーで任意のスクリプトを実行し、その返り値を収集することや、しきい値を設定してアラートを生成することができます。
SCOM には各種 OS や ソフトウェアの監視を行うための管理パックがたくさん存在しますが、それらの管理パックを用いた監視だけでは不足する監視項目が存在した場合、それらの情報を取得するスクリプトを用いて補うことができますので、スクリプト監視はとても有効です。
※ Windows サーバーの手順は、[スクリプト監視の設定手順 - Windows 編](/blog/SCOM/SCOM_windows_script_monitor/) にて手順を紹介していますので、こちらも合わせてご参照ください。


## 目的ごとの設定手順について
以下の目的ごとに、設定の手順が異なります。
　① スクリプトの返り値をパフォーマンス データとして収集すること
　② スクリプトの返り値に対してしきい値を設定してアラートを生成すること

①のデータ収集が目的の場合は、まず、データ収集の [ルール] を作成し、収集したデータを参照するための [パフォーマンスビュー] を作成します。
②のアラート生成が目的の場合は、[モニター] を作成します。

---

各々の手順について以下記述いたします。
## ① スクリプトの返り値をパフォーマンス データとして収集する手順
1. SCOM コンソールにログインして、画面左下ペインの [作成] をクリックして、[作成] 画面を開きます。
2. [作成] -> [管理パックオブジェクト] -> [ルール] をクリックして、画面中央の一覧から対象の OS 種類を選択します。
3. 画面右ペインの [ルール] の [新しいルールの作成] をクリックして、[ルールの作成ウィザード] を開きます。
![](001.png)


4. [作成するルールの種類を選択] で [収集ルール] の [UNIX/Linux スクリプト(パフォーマンス) ] を選択します。
5. [ルール名] を入力して、ルールのターゲットが対象の OS 種類であることを確認して、[次へ] をクリックします。
※ルール名の例：Sample Linux Performance View Rule
※全UNIX/Linux サーバーを対象とする場合は、ターゲットに [UNIX/Linux コンピューター] を指定します。
![](002-2.png)


6. 任意のスケジュールを設定して [次へ] をクリックします。
![](003.png)


7. 実行するスクリプトを指定して [次へ] をクリックします。
下の例では、事前に監視対象の Linux サーバーに配置された getramdom.sh というランダムな数値を返すスクリプトを実行します。
Run As profile で指定するアカウントには、指定したスクリプトの実行権限が必要です。
*スクリプト < getramdom.sh > の中身*
```CMD
echo $RANDOM
```

![](004.png)


8. 必要に応じてデータ収集のフィルターを設定して [次へ] をクリックします。
![](005.png)


9. 必要に応じてマッピング情報を設定して [次へ] をクリックします。
補足：コマンドの返り値をそのまま収集する場合、[値] は変更しないでください。
![](006.png)


以上で、任意のスクリプトの値を指定間隔で収集する [ルール] の作成は完了です。
次に、この情報を表示する [パフォーマンス ビュー] を作成します。



1. SCOM コンソールにログインして、画面左下ペインの [監視] をクリックして、[監視] 画面を開きます。
2. 画面左ツリーで、ビューを配置する任意のフォルダを選択します。
右クリックメニューで [新規] -> [パフォーマンス ビュー] をクリックします。
![](007.png)


3. [プロパティ] 画面の [状態の選択] で [特定のルールによって収集された] にチェックを入れ、[条件の説明] で上で作成したルールを選択します。
![](008.png)


4. コマンドの返り値を表示するビューが生成されます。
![](009.png)

---

## ② スクリプトの返り値に対してしきい値を設定してアラートを生成する手順
1. SCOM コンソールにログインして、画面左下ペインの [作成] をクリックして、[作成] 画面を開きます。
2. [作成] -> [管理パックオブジェクト] -> [モニター] をクリックして、画面中央の一覧から対象の OS 種類を選択します。
![](020.png)


3. 画面右ペインで [モニター] -> [モニターの作成] をクリックして [ユニットモニター] を選択します。
4. [モニターの種類] で [スクリプト機能] -> [一般] の中から該当するモニター種類を選択して、[次へ] をクリックします。
※今回の例では [UNIX/Linux スクリプトの 2 つの状態モニター] を選択しました。
![](011.png)


5. [全般] 画面で [モニターのターゲット] に [UNIX/Linuxのコンピューター] を選択して [次へ] をクリックします。
![](019.png)


6. 任意のスケジュールを設定して [次へ] をクリックします。
![](013.png)


7. 実行するスクリプトを指定して [次へ] をクリックします。
![](014.png)


8. [エラー式] にエラーとなる返り値を設定して [次へ] をクリックします。
※下の画面ショットは [StdOut] が 20000より大きく、[ReturnCode] が 0 の場合にエラーとする設定です。 
![](015.png)


9. [正常な式] にエラーが回復する返り値を設定して [次へ] をクリックします。
※下の画面ショットは [StdOut] が 20000 以下、[ReturnCode] が 0 の場合に正常に回復する設定です。
![](016.png)


10. [ヘルスの構成] を設定して [次へ] をクリックします。
![](017.png)


11. ヘルス状態の変化でアラートを生成する場合は [このモニターにアラートを生成する] にチェックを入れて [作成] をクリックします。
※アラートの重大度は任意に指定可能です。
![](018.png)


これにより、スクリプトの返り値に応じてアラートを生成する [モニター] の作成が完了です。

---

いかがでしょうか。

まとめますと、スクリプトの返り値をパフォーマンス データとして収集する場合は [ルール] を作成して参照用の [パフォーマンス ビュー] を用意します。
しきい値を設定してアラートを生成する場合は [モニター] を作成します。
ルールもモニターも [スクリプトの詳細] 画面で、UNIX/Linux サーバー上に配置したスクリプトを指定します。


ご要件に応じてスクリプト監視を設定いただければ幸いです。

