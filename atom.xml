<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan System Center Support Blog</title>
  
  <subtitle>日本マイクロソフトの System Center に関するサポート情報のブログです。</subtitle>
  <link href="https://jpsystemcenter.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpsystemcenter.github.io/blog/"/>
  <updated>2022-11-25T05:20:27.751Z</updated>
  <id>https://jpsystemcenter.github.io/blog/</id>
  
  <author>
    <name>Japan System Center Support</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SCOM で使用する一般的なログ収集方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_Troubleshooting_log/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_Troubleshooting_log/</id>
    <published>2022-11-25T05:11:00.000Z</published>
    <updated>2022-11-25T05:20:27.751Z</updated>
    
    <content type="html"><![CDATA[<p>本記事は SCOM でトラブルシューティングを行う際、調査を行うために収集する一般的なログとその取得方法を解説いたします。</p><span id="more"></span><p>皆さまこんにちは。<br>System Center サポートチームの保科です。 </p><p>System Center Operations Manager (SCOM) をご利用中に様々な問題に対面された経験はございませんでしょうか。<br>この問題を対処するにあたり、弊社までお問合わをいただくことも多いかと存じます。<br>基本的にご申告いただきました問題を対処するにあたってログ等を含めた調査が必須となります。<br>本記事では、弊社が SCOM 観点のトラブルシューティングを行う際に一般的にお客様へ採取依頼を行うログとその採取方法について解説いたします。</p><h2 id="イベントログ"><a href="#イベントログ" class="headerlink" title="イベントログ"></a>イベントログ</h2><p>イベントログの調査は、SCOM のトラブルシューティングを行うにあたって最も一般的なログとなります。<br>基本的に SCOM で発生した問題の多くとその詳細はイベントログにも転記されます。<br>そのため、多くの問題はイベントログを調べることで原因の特定を行える可能性があります。<br>イベントログを採取いただく場合は、状況に応じて以下コンピューターから採取を行います。</p><ul><li>SCOM 管理サーバー:<br>トラブルシューティングの種類に依らず、必ず SCOM 管理サーバーのイベントログを採取します。<br>ご利用の環境で複数台の SCOM 管理サーバーをご利用の場合、それらすべての SCOM 管理サーバーからイベントログの採取を行います。<br>ゲートウェイサーバーを介した別ドメインコンピューターの監視で問題が発生されている場合、ゲートウェイサーバーからもイベントログを採取します。</li><li>事象が発生した監視対象コンピューター:<br>監視の問題が発生している場合、その問題が発生しているすべての監視対象コンピューターよりイベントログを採取します。<br>特定の監視対象コンピューターの問題ではなく、SCOM 全体的な問題によるトラブルシューティングを行う場合は、こちらのコンピューターからのログ採取は不要です。</li><li>SCOM データベースが動作する SQL Server 実行サーバー:<br>データベースの問題が疑われる場合、このコンピューターからイベントログを採取します。<br>一般的には、SCOM の処理が遅い、データが欠落する、SCOM が機能しないといった場合にこれらのサーバーからのイベントログ採取が必要となります。<br>SCOM 管理サーバーの中に SCOM データベースが動作する SQL Server が存在する場合、こちらについては意識いただかなくても問題ございません。</li></ul><p>イベントログの取得方法は以下手順で行います。</p><ol><li><p>対象コンピューターでイベント ビューアーを開きます。<br>確実に開く方法としては、[win] + [R] キーを押下し、”eventvwr.msc” とイベントビューアーの名前を直接指定し、実行する方法がございます。</p></li><li><p>画面左のコンソールツリーより、保存するイベントログをクリックします。<br>SCOM 観点のイベントログは、以下 3 種類のイベントログを採取します。</p><ul><li>アプリケーション (※1)</li><li>システム (※1)</li><li>Operations Manager (※2)</li></ul><p>(※1) は [Windows ログ] 配下に存在します。<br>(※2) は [アプリケーションとサービス ログ] 配下に存在します。<br>SCOM 管理サーバー / ゲートウェイサーバー以外のサーバーで、かつ SCOM エージェントがインストールされていない環境では (※2) のイベントログは存在しない場合がございます。<br>この場合、このコンピューターからの (※2) のイベントログの採取は不要でございます。</p></li><li><p>画面右ペインの [すべてのイベントを名前をつけて保存] をクリックします。</p></li><li><p>保存するイベントログの任意の名称を指定します。<br>ファイルの種類としては、”イベント ファイル (<em>.evtx)” および “CSV (コンマ区切り) (</em>.csv)” の両方で取得します。</p></li></ol><p>イベントログ取得手順は以上となります。<br>弊社までイベントログを送付いただく場合は、コンピューター毎にイベントログを 1 つのフォルダに纏め、それらのフォルダをさらに 1 つのフォルダに纏めて圧縮いただいてお寄せくださいませ。<br>採取対象コンピューターが複数台存在する場合、イベントログ自体のファイル名やそれを格納するフォルダにコンピューター名を付与いただく等、採取対象が分かりやすく識別できるように送付をいただけると幸いです。</p><h2 id="アラート情報"><a href="#アラート情報" class="headerlink" title="アラート情報"></a>アラート情報</h2><p>アラートの状態 (オープンの状態、解決済みの状態等) によらず、SCOM データベースに存在するアラート情報を出力いただけます。<br>こちらもイベントログ程ではありませんが、トラブルシューティングを行う際に有用な情報が確認できる場合が多い資料です。<br>アラート情報を取得する場合は、Operations Manager Shell を利用し、CSV 形式で一覧として取得します。</p><ol><li><p>SCOM 管理サーバー、SCOM 管理者権限を持つアカウントでログインします。</p></li><li><p>事前に、C ドライブの直下に “temp” という名前のフォルダを作成します。</p></li><li><p>[スタート] メニューより [Operations Manager Shell] を実行します。</p></li><li><p>以下のコマンドを実行します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SCOMAlert | export-csv -path &quot;c:/temp/Alert.csv&quot; -encoding UTF8</span><br></pre></td></tr></table></figure></li><li><p>出力された “Alert.csv” を弊社までお寄せください。</p></li></ol><h2 id="インストールログ"><a href="#インストールログ" class="headerlink" title="インストールログ"></a>インストールログ</h2><p>インストールログの調査は、SCOM のインストールやエージェントのプッシュインストールが正常に行えない場合に調査する資料となります。<br>インストールに関する問題が発生しましたら、こちらのログを調査する必要があります。<br>ログは以下のフォルダに格納されております。</p><blockquote><p>C:\Users&lt;SCOM をインストールする際に使用したユーザー名&gt;\AppData\Local\SCOM</p></blockquote><h2 id="トレースログ"><a href="#トレースログ" class="headerlink" title="トレースログ"></a>トレースログ</h2><p>上記までに記載したログは、いずれも事象発生後に後追いで原因調査を行うために採取される資料となります。<br>これらの資料で大半の事象は原因を特定することが出来ますが、中には事象発生後に採取される資料に情報が一切記載されず、調査が困難な場合がございます。<br>この場合、事象発生時のログをリアルタイムで収集し、そのログから SCOM 内部で行われた処理を時系列で調査する必要があります。<br>この調査は SCOM 標準で備わるトレースログの採取によって可能となります。<br>以下手順にて SCOM トレースログの取得を開始します。</p><ol><li>トレースログを取得するコンピューターに、管理者権限でログインします。</li><li>管理者としてコマンドプロンプトを開きます。</li><li>cdコマンドを使用して、 トレースログを採取するコンピューターに応じて以下ディレクトリに移動します。<br>なお、下記のディレクトリは、いずれも既定フォルダにインストールを行った際に使用するディレクトリになります。<br>SCOM 管理サーバーや SCOM エージェントのインストール先を既定値から変更されている場合、適宜そのフォルダに移動をお願いします。<table><thead><tr><th>トレースログ採取対象コンピューター</th><th>cd コマンドで移動するディレクトリの既定値</th></tr></thead><tbody><tr><td>SCOM 2016 管理サーバー</td><td>C:\Program Files\Microsoft System Center 2016\Operations Manager\Server\Tools</td></tr><tr><td>SCOM 2019 管理サーバー</td><td>C:\Program Files\Microsoft System Center\Operations Manager\Server\Tools</td></tr><tr><td>SCOM 2022 管理サーバー</td><td>C:\Program Files\Microsoft System Center\Operations Manager\Server\Tools</td></tr><tr><td>SCOM エージェント</td><td>C:\Program Files\Microsoft Monitoring Agent\Agent\Tools</td></tr></tbody></table></li><li>以下コマンドを実行し、すでに実行中のトレースログ採取を停止します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StopTracing.cmd</span><br></pre></td></tr></table></figure>SCOM トレースログは、”Microsoft Monitoring Agent” サービスが停止中の状態から起動状態に移行すると、自動的にエラーレベルのトレースログを収集開始します。<br>“サービスが停止中の状態から起動状態に移行” する条件として、一例として以下が挙げられます。<ul><li>サービス自体を手動で再起動する</li><li>対象サーバーを再起動する</li></ul></li><li>Windowsエクスプローラーを使用して、“C:\Windows\Logs\OpsMgrTrace” に移動します。</li><li>フォルダ “C:\Windows\Logs\OpsMgrTrace” のすべてのファイルを削除します。</li><li>採取するトレースログのレベルに応じて以下コマンドを実行します。<ul><li>詳細レベルのトレースログ:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StartTracing.cmd VER </span><br></pre></td></tr></table></figure></li><li>デバッグレベルのトレースログ:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StartTracing.cmd DBG</span><br></pre></td></tr></table></figure>基本的に詳細レベルよりデバッグログのトレースログの方がより多くの情報が含まれます。<br>そのため調査に際してはデバッグログの方がより有用な情報が採取される可能性が高いものの、それに比例してログ容量増加速度も上昇します。<br>大まかな考えとしては、即座に事象再現が可能であればデバッグレベルのトレースログを、いつ事象再現が確認されるかが未定である場合は詳細レベルのトレースログを採取する方法を推奨いたします。</li></ul></li><li>事象を再現します。<br>再現が確認されるまでログを採取し、再現が確認されましたら 9. の手順へ進みます。</li><li>以下コマンドを実行し、トレースログの採取を再度停止します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StopTracing.cmd&quot;</span><br></pre></td></tr></table></figure></li><li>以下コマンドを実行し、採取されたトレースログをテキストファイル形式にフォーマットします。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FormatTracing.cmd R</span><br></pre></td></tr></table></figure></li><li>弊社まで資料を送付いただく際は、“C:\Windows\Logs\OpsMgrTrace”フォルダごとzip化し、弊社までお寄せください。<br>この際、複数のコンピューターでトレースログを採取いただけましたら、採取されたコンピューターが判別できるようにコンピューター名を zip ファイルに記載いただく等していただけますと幸いです。</li></ol><p>(※1)<br>“C:\Windows\Logs\OpsMgrTrace” フォルダ内には、収集された診断ログが “etl” 拡張子のファイルにて格納されております。<br>“.etl” の各ファイルは、100MB を上限としてログが保存されます。<br>ログが 100MB を超える場合、古いログから順番に新しいログへ上書きされます。<br>100 MB を超えるまでの時間は、環境に応じて変化いたしますので、一概のご案内が困難でございます。<br>弊社としては、問題の再現実施後に、ただちに 9. の手順でトレースの停止を実施いただきたく思います。<br>トレースログ採取容量は、トレースログ採取を開始する “StartTracing.cmd” の内容を直接編集することで増減が可能です。<br>具体的には、対象ファイル 99 行目に記載されている以下記述より、”-cir” パラメーターに続く数値が、トレースログ容量上限値を MB 単位で指定するものとなります。</p><blockquote><p>if not [%1]==[TracingGuidsConfigService] tracelogsm.exe -start %1 -flag %2 -level %3 -f %OpsMgrTracePath%%1.etl -b 64 -ft 10 <strong>-cir 100</strong> -guid %4</p></blockquote><p>(※2)<br>7. の手順で SCOM 診断ログを取得する際、特にパフォーマンスへの大きな影響が発生しないことを確認しております。</p><p>(※3)<br>トレースログを仕掛けたタイミングでサーバーの再起動等 SCOM エージェントサービスの停止が伴う操作を実施いただくと、トレースログの採取がリセットされ、OS 起動時に取得されるエラーレベルでのトレース採取が開始されます。<br>そのため、トレースログ採取中に SCOM エージェントサービスの停止が伴う操作を実施いただく場合、再度 1. から 8. までの手順を実施いただく必要がございます。</p><p>参考:<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-overview-management-pack?view=sc-om-2022">診断トレースを使用する - Operations Manager | Microsoft Learn</a><br>(SCOM 診断ログについて記載された弊社ドキュメントです。)</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本記事は SCOM でトラブルシューティングを行う際、調査を行うために収集する一般的なログとその取得方法を解説いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="トラブルシューティング" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0/"/>
    
    <category term="ログ収集" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%83%AD%E3%82%B0%E5%8F%8E%E9%9B%86/"/>
    
  </entry>
  
  <entry>
    <title>スクリプト監視の設定手順 - Windows 編</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_windows_script_monitor/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_windows_script_monitor/</id>
    <published>2022-10-31T09:10:00.000Z</published>
    <updated>2022-11-25T05:20:27.759Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>本日は System Center Operations Manager（以後 SCOM） で監視対象の Windows サーバーにて任意のスクリプトを実行する手順を紹介いたします。 </p><span id="more"></span><p>SCOM では監視対象のサーバーで任意のスクリプトを実行し、その返り値を収集することや、しきい値を設定してアラートを生成することができます。<br>SCOM には各種 OS や ソフトウェアの監視を行うための管理パックがたくさん存在しますが、それらの管理パックを用いた監視だけでは不足する監視項目が存在した場合、それらの情報を取得するスクリプトを用いて補うことができますので、スクリプト監視はとても有効です。<br>※ UNIX/Linux サーバーの手順は、<a href="/blog/SCOM/SCOM_unix_script_monitor/">スクリプト監視の設定手順 - UNIX/Linux 編</a> にて手順を紹介していますので、こちらも合わせてご参照ください。</p><h2 id="目的ごとの設定手順について"><a href="#目的ごとの設定手順について" class="headerlink" title="目的ごとの設定手順について"></a>目的ごとの設定手順について</h2><p>以下の目的ごとに、設定の手順が異なります。<br>　① スクリプトの返り値をパフォーマンス データとして収集すること<br>　② スクリプトの返り値に対してしきい値を設定してアラートを生成すること</p><p>①のデータ収集が目的の場合は、まず、データ収集の [収集ルール] を作成し、収集したデータを参照するための [パフォーマンスビュー] を作成します。<br>②のアラート生成が目的の場合は、[モニター] を作成します。</p><hr><p>各々の手順について以下記述いたします。</p><h2 id="①-スクリプトの返り値をパフォーマンス-データとして収集する手順"><a href="#①-スクリプトの返り値をパフォーマンス-データとして収集する手順" class="headerlink" title="① スクリプトの返り値をパフォーマンス データとして収集する手順"></a>① スクリプトの返り値をパフォーマンス データとして収集する手順</h2><ol><li>SCOM コンソールにログインして、画面左下ペインの [作成] をクリックして、[作成] 画面を開きます。</li><li>[作成] -&gt; [管理パック オブジェクト] -&gt; [ルール] をクリックして、画面右ペインから [新しいルールの作成] をクリックします。<br><img src="001.png"></li></ol><ol start="3"><li>[ルールの作成ウィザード] の [作成するルールの種類を選択] で [スクリプト (パフォーマンス) ] を選択して [次へ] をクリックします。<br><img src="002.png"></li></ol><ol start="4"><li>[全般] 画面で [ルールのターゲット] に Windows に関する任意のターゲットを指定し、[次へ] をクリックします。<br>例えば、今回作成するルールの対象を Windows Server 2016 以降の OS を対象とする場合、ターゲットは [Windows Server 2016 以降のコンピューター] を選択します。<br>インポートしている管理パックのバージョンにより [Windows Server 2016 以降のコンピューター] が存在しない場合は、下位のバージョンの [Windows Server XXXX のコンピューター] を選択してください。<br><img src="003.png"></li></ol><ol start="5"><li>スクリプトを実行してデータ収集する間隔を設定します。<br><img src="004.png"></li></ol><ol start="6"><li>スクリプト情報の入力画面にスクリプトをセットします。<br>※スクリプト画面には固定で 「10」 を返すひな形かセットされています。<br><img src="005.png"></li></ol><p>重要なメソッドは以下の値をセットしている箇所です。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Call</span> oBag.AddValue(&quot;PerfValue&quot;, <span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>ここに皆さまの方で用意されたスクリプトが取得した値をセットするようにしてください。<br>サンプルとして 0 ～ 1000 までのランダムな数値をセットするスクリプトは以下の通りです。<br><img src="006.png"></p><p>スクリプトは以下の通りです。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x27; オブジェクト準備</span><br><span class="line">Dim oAPI, oBag</span><br><span class="line"><span class="built_in">Set</span> oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line"><span class="built_in">Set</span> oBag = oAPI.CreatePropertyBag()</span><br><span class="line">&#x27; 属性値をセット</span><br><span class="line">Randomize</span><br><span class="line"><span class="keyword">Call</span> oBag.AddValue(&quot;PerfValue&quot;,Rnd * <span class="number">1000</span>)</span><br><span class="line">&#x27; オブジェクトを返す</span><br><span class="line"><span class="keyword">Call</span> oAPI.Return(oBag)</span><br></pre></td></tr></table></figure><ol start="7"><li>パフォーマンス マッピング画面を確認して [作成] をクリックします。<br>この設定内容が、後続の手順のパフォーマンスビューでパフォーマンスデータを表示した際に表示されるパフォーマンスデータに関する情報となります。<br>“オブジェクト”、”カウンター” および “インスタンス” は表示されるパフォーマンスデータの情報に関する内容を指定するものですので、必要に応じてデータを識別しやすい名称にします。<br><img src="007.png"></li></ol><p>以上で、任意のスクリプトの値を指定間隔で収集する [ルール] の作成は完了です。<br>次に、この情報を表示する [パフォーマンス ビュー] を作成します。</p><ol><li>SCOM コンソールの画面左下ペインの [監視] をクリックして、[監視] 画面を開きます。</li><li>右クリックメニュー の [新規] -&gt; [パフォーマンス ビュー] をクリックします。<br><img src="008.png"></li></ol><ol start="3"><li>[特定のルールによって収集された] にチェックを入れて、画面下部の [条件の説明] で、上で作成したルールを選択して [OK] をクリックします。<br><img src="009.png"></li></ol><p>以下の通り、ランダムな値を取得する VBS を実行して収集した値が表示されます。<br><img src="010.png"></p><p>以上で、スクリプトの返り値をパフォーマンスデータとして収集する [ルール] と収集データを表示する [ビュー] の作成が完了です。</p><hr><h2 id="②-スクリプトの返り値に対してしきい値を設定してアラートを生成する手順"><a href="#②-スクリプトの返り値に対してしきい値を設定してアラートを生成する手順" class="headerlink" title="② スクリプトの返り値に対してしきい値を設定してアラートを生成する手順"></a>② スクリプトの返り値に対してしきい値を設定してアラートを生成する手順</h2><ol><li>SCOM コンソールにログインして、画面左下ペインの [作成] をクリックして、[作成] 画面を開きます。</li><li>[作成] -&gt; [管理パックオブジェクト] -&gt; [モニター] をクリックして、画面中央の一覧から対象の OS 種類を選択します。<br><img src="013.png"></li></ol><ol start="3"><li>画面右ペインで [モニター] -&gt; [モニターの作成] をクリックして [ユニットモニター] を選択します。</li><li>[モニターの種類] で [スクリプト機能] -&gt; [一般] の中から該当するモニター種類を選択して、[次へ] をクリックします。<br>※今回の例では [タイマー スクリプト - 2 つの状態の監視] を選択しました。<br><img src="014.png"></li></ol><ol start="6"><li> [全般] 画面で [モニターのターゲット] に Windows に関する任意のターゲット (以下図は例として [Windows Server 2016 以降のコンピューター] を指定) を選択して [次へ] をクリックします。<br><img src="015.png"></li></ol><ol start="7"><li>任意のスケジュールを設定して [次へ] をクリックします。<br><img src="016.png"></li></ol><ol start="8"><li>スクリプト情報の入力画面にスクリプトをセットします。<br>※スクリプト画面には固定で 「OK」 という文字列を返すひな形かセットされています。<br><img src="017.png"></li></ol><p>上の [ルール] の時と同様に、サンプルとして 0 ～ 1000 までのランダムな数値を返すように修正します。<br><img src="006.png"></p><p>スクリプトは以下の通りです。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x27; オブジェクト準備</span><br><span class="line">Dim oAPI, oBag</span><br><span class="line"><span class="built_in">Set</span> oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line"><span class="built_in">Set</span> oBag = oAPI.CreatePropertyBag()</span><br><span class="line">&#x27; 属性値をセット</span><br><span class="line">Randomize</span><br><span class="line"><span class="keyword">Call</span> oBag.AddValue(&quot;PerfValue&quot;,Rnd * <span class="number">1000</span>)</span><br><span class="line">&#x27; オブジェクトを返す</span><br><span class="line"><span class="keyword">Call</span> oAPI.Return(oBag)</span><br></pre></td></tr></table></figure><p>ファイル名に拡張子を追加すると [次へ] ボタンが有効になりますので、[次へ] をクリックします。<br><img src="018.png"></p><ol start="9"><li>[異常な式] にエラーとなる返り値を設定して [次へ] をクリックします。<br>※下の画面ショットは返り値が 700より大きい場合にエラーとする設定です。<br>　パラーメーター名にはスクリプト内で用いたパラメーター PerfValue を用いて <em>Property[@Name=’PerfValue’]</em> を設定します。<br><img src="019.png"></li></ol><ol start="10"><li>[正常な式] にエラーが回復する返り値を設定して [次へ] をクリックします。<br>※下の画面ショットは返り値が 700以下になった場合に正常に回復する設定です。<br>　パラーメーター名にはスクリプト内で用いたパラメーター PerfValue を用いて <em>Property[@Name=’PerfValue’]</em> を設定します。<br><img src="020.png"></li></ol><ol start="11"><li>[ヘルスの構成] を設定して [次へ] をクリックします。<br><img src="021.png"></li></ol><ol start="12"><li>ヘルス状態の変化でアラートを生成する場合は [このモニターにアラートを生成する] にチェックを入れて [作成] をクリックします。<br>※アラートの重大度は任意に指定可能です。<br><img src="022.png"></li></ol><p>これにより、スクリプトの返り値に応じてアラートを生成する [モニター] の作成が完了です。</p><hr><p>いかがでしょうか。</p><p>まとめますと、スクリプトの返り値をパフォーマンス データとして収集する場合は [ルール] を作成して参照用の [パフォーマンス ビュー] を用意します。<br>しきい値を設定してアラートを生成する場合は [モニター] を作成します。<br>ルールもモニターも [スクリプト] 画面で、Windows サーバーで実行するスクリプトを記述します。</p><p>最後にスクリプトの記述方法について少しだけ補足します。</p><p>【 スクリプトの記述方法の補足 】<br>スクリプト画面で入力するスクリプトは、以下のメソッドで値をセットすることで SCOM にデータを送ることができます。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Call</span> oBag.AddValue(&quot;PerfValue&quot;, <span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>C ドライブの残容量を取得するサンプルを下に貼りましたので、参考にしていただければと存じます。<br>赤枠で囲った個所は [C ドライブの残容量を取得する処理] です。<br>SCOM に依存しないスクリプトです。<br>取得した値を <em>Call oBag.AddValue()</em> にセットしています。 </p><p>この例の通り、まずは単独で動作する情報収集スクリプトを実装します。<br>それをスクリプト内に挿入し、取得した値を <em>Call oBag.AddValue()</em> にセットするというのが作法になります。<br><img src="011.png"></p><p>スクリプトは以下の通りです。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x27; オブジェクト準備</span><br><span class="line">Dim oAPI, oBag</span><br><span class="line"><span class="built_in">Set</span> oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line"><span class="built_in">Set</span> oBag = oAPI.CreatePropertyBag()</span><br><span class="line"></span><br><span class="line">&#x27; 情報取得</span><br><span class="line">Dim objWMIService, objSWbemObjectCollection, objSWbemObject</span><br><span class="line"><span class="built_in">Set</span> objWMIService = GetObject(&quot;winmgmts:&#123;impersonationLevel=impersonate&#125;!\\.\root\cimv2&quot;)</span><br><span class="line"><span class="built_in">Set</span> objSWbemObjectCollection = objWMIService.ExecQuery(&quot;Select * from Win32_LogicalDisk Where DriveType = <span class="number">3</span>&quot;)</span><br><span class="line"></span><br><span class="line">&#x27; 取得情報を解析</span><br><span class="line"><span class="keyword">For</span> Each objSWbemObject <span class="keyword">in</span> objSWbemObjectCollection</span><br><span class="line">    &#x27; C ドライブの場合</span><br><span class="line">    <span class="keyword">If</span> InStr(objSWbemObject.DeviceID, &quot;C&quot;) &gt; <span class="number">0</span> Then</span><br><span class="line">        &#x27; 残容量 （MB） をセット</span><br><span class="line">        <span class="keyword">Call</span> oBag.AddValue(&quot;PerfValue&quot;,objSWbemObject.FreeSpace/<span class="number">1000</span>/<span class="number">1000</span>)</span><br><span class="line">    End <span class="keyword">If</span></span><br><span class="line">Next</span><br><span class="line"></span><br><span class="line">&#x27; オブジェクトを返す</span><br><span class="line"><span class="keyword">Call</span> oAPI.Return(oBag)</span><br></pre></td></tr></table></figure><p>収集したデータはパフォーマンス ビューにて確認できます。<br><img src="012.png"></p><p>本記事を参考にご要件に応じたスクリプト監視を設定いただければ幸いです。 </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;本日は System Center Operations Manager（以後 SCOM） で監視対象の Windows サーバーにて任意のスクリプトを実行する手順を紹介いたします。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="スクリプト" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88/"/>
    
    <category term="スクリプト監視" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E7%9B%A3%E8%A6%96/"/>
    
    <category term="スクリプト実行" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E5%AE%9F%E8%A1%8C/"/>
    
    <category term="VBS" scheme="https://jpsystemcenter.github.io/blog/tags/VBS/"/>
    
  </entry>
  
  <entry>
    <title>スクリプト監視の設定手順 - UNIX/Linux 編</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_unix_script_monitor/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_unix_script_monitor/</id>
    <published>2022-10-31T09:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.755Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>本日は System Center Operations Manager（以後 SCOM） で監視対象の UNIX/Linux サーバーにて任意のスクリプトを実行する手順を紹介いたします。</p><span id="more"></span><p>SCOM では監視対象のサーバーで任意のスクリプトを実行し、その返り値を収集することや、しきい値を設定してアラートを生成することができます。<br>SCOM には各種 OS や ソフトウェアの監視を行うための管理パックがたくさん存在しますが、それらの管理パックを用いた監視だけでは不足する監視項目が存在した場合、それらの情報を取得するスクリプトを用いて補うことができますので、スクリプト監視はとても有効です。<br>※ Windows サーバーの手順は、<a href="/blog/SCOM/SCOM_windows_script_monitor/">スクリプト監視の設定手順 - Windows 編</a> にて手順を紹介していますので、こちらも合わせてご参照ください。</p><h2 id="目的ごとの設定手順について"><a href="#目的ごとの設定手順について" class="headerlink" title="目的ごとの設定手順について"></a>目的ごとの設定手順について</h2><p>以下の目的ごとに、設定の手順が異なります。<br>　① スクリプトの返り値をパフォーマンス データとして収集すること<br>　② スクリプトの返り値に対してしきい値を設定してアラートを生成すること</p><p>①のデータ収集が目的の場合は、まず、データ収集の [ルール] を作成し、収集したデータを参照するための [パフォーマンスビュー] を作成します。<br>②のアラート生成が目的の場合は、[モニター] を作成します。</p><hr><p>各々の手順について以下記述いたします。</p><h2 id="①-スクリプトの返り値をパフォーマンス-データとして収集する手順"><a href="#①-スクリプトの返り値をパフォーマンス-データとして収集する手順" class="headerlink" title="① スクリプトの返り値をパフォーマンス データとして収集する手順"></a>① スクリプトの返り値をパフォーマンス データとして収集する手順</h2><ol><li>SCOM コンソールにログインして、画面左下ペインの [作成] をクリックして、[作成] 画面を開きます。</li><li>[作成] -&gt; [管理パックオブジェクト] -&gt; [ルール] をクリックして、画面中央の一覧から対象の OS 種類を選択します。</li><li>画面右ペインの [ルール] の [新しいルールの作成] をクリックして、[ルールの作成ウィザード] を開きます。<br><img src="001.png"></li></ol><ol start="4"><li>[作成するルールの種類を選択] で [収集ルール] の [UNIX/Linux スクリプト(パフォーマンス) ] を選択します。</li><li>[ルール名] を入力して、ルールのターゲットが対象の OS 種類であることを確認して、[次へ] をクリックします。<br>※ルール名の例：Sample Linux Performance View Rule<br>※全UNIX/Linux サーバーを対象とする場合は、ターゲットに [UNIX/Linux コンピューター] を指定します。<br><img src="002-2.png"></li></ol><ol start="6"><li>任意のスケジュールを設定して [次へ] をクリックします。<br><img src="003.png"></li></ol><ol start="7"><li>実行するスクリプトを指定して [次へ] をクリックします。<br>下の例では、事前に監視対象の Linux サーバーに配置された getramdom.sh というランダムな数値を返すスクリプトを実行します。<br>Run As profile で指定するアカウントには、指定したスクリプトの実行権限が必要です。</li></ol><p><em>スクリプト &lt; getramdom.sh &gt; の中身</em></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> $RANDOM</span><br></pre></td></tr></table></figure><p><img src="004.png"></p><ol start="8"><li>必要に応じてデータ収集のフィルターを設定して [次へ] をクリックします。<br><img src="005.png"></li></ol><ol start="9"><li>必要に応じてマッピング情報を設定して [次へ] をクリックします。<br>補足：コマンドの返り値をそのまま収集する場合、[値] は変更しないでください。<br><img src="006.png"></li></ol><p>以上で、任意のスクリプトの値を指定間隔で収集する [ルール] の作成は完了です。<br>次に、この情報を表示する [パフォーマンス ビュー] を作成します。</p><ol><li>SCOM コンソールにログインして、画面左下ペインの [監視] をクリックして、[監視] 画面を開きます。</li><li>画面左ツリーで、ビューを配置する任意のフォルダを選択します。<br>右クリックメニューで [新規] -&gt; [パフォーマンス ビュー] をクリックします。<br><img src="007.png"></li></ol><ol start="3"><li>[プロパティ] 画面の [状態の選択] で [特定のルールによって収集された] にチェックを入れ、[条件の説明] で上で作成したルールを選択します。<br><img src="008.png"></li></ol><ol start="4"><li>コマンドの返り値を表示するビューが生成されます。<br><img src="009.png"></li></ol><hr><h2 id="②-スクリプトの返り値に対してしきい値を設定してアラートを生成する手順"><a href="#②-スクリプトの返り値に対してしきい値を設定してアラートを生成する手順" class="headerlink" title="② スクリプトの返り値に対してしきい値を設定してアラートを生成する手順"></a>② スクリプトの返り値に対してしきい値を設定してアラートを生成する手順</h2><ol><li>SCOM コンソールにログインして、画面左下ペインの [作成] をクリックして、[作成] 画面を開きます。</li><li>[作成] -&gt; [管理パックオブジェクト] -&gt; [モニター] をクリックして、画面中央の一覧から対象の OS 種類を選択します。<br><img src="020.png"></li></ol><ol start="3"><li>画面右ペインで [モニター] -&gt; [モニターの作成] をクリックして [ユニットモニター] を選択します。</li><li>[モニターの種類] で [スクリプト機能] -&gt; [一般] の中から該当するモニター種類を選択して、[次へ] をクリックします。<br>※今回の例では [UNIX/Linux スクリプトの 2 つの状態モニター] を選択しました。<br><img src="011.png"></li></ol><ol start="5"><li>[全般] 画面で [モニターのターゲット] に [UNIX/Linuxのコンピューター] を選択して [次へ] をクリックします。<br><img src="019.png"></li></ol><ol start="6"><li>任意のスケジュールを設定して [次へ] をクリックします。<br><img src="013.png"></li></ol><ol start="7"><li>実行するスクリプトを指定して [次へ] をクリックします。<br><img src="014.png"></li></ol><ol start="8"><li>[エラー式] にエラーとなる返り値を設定して [次へ] をクリックします。<br>※下の画面ショットは [StdOut] が 20000より大きく、[ReturnCode] が 0 の場合にエラーとする設定です。<br><img src="015.png"></li></ol><ol start="9"><li>[正常な式] にエラーが回復する返り値を設定して [次へ] をクリックします。<br>※下の画面ショットは [StdOut] が 20000 以下、[ReturnCode] が 0 の場合に正常に回復する設定です。<br><img src="016.png"></li></ol><ol start="10"><li>[ヘルスの構成] を設定して [次へ] をクリックします。<br><img src="017.png"></li></ol><ol start="11"><li>ヘルス状態の変化でアラートを生成する場合は [このモニターにアラートを生成する] にチェックを入れて [作成] をクリックします。<br>※アラートの重大度は任意に指定可能です。<br><img src="018.png"></li></ol><p>これにより、スクリプトの返り値に応じてアラートを生成する [モニター] の作成が完了です。</p><hr><p>いかがでしょうか。</p><p>まとめますと、スクリプトの返り値をパフォーマンス データとして収集する場合は [ルール] を作成して参照用の [パフォーマンス ビュー] を用意します。<br>しきい値を設定してアラートを生成する場合は [モニター] を作成します。<br>ルールもモニターも [スクリプトの詳細] 画面で、UNIX/Linux サーバー上に配置したスクリプトを指定します。</p><p>ご要件に応じてスクリプト監視を設定いただければ幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;本日は System Center Operations Manager（以後 SCOM） で監視対象の UNIX/Linux サーバーにて任意のスクリプトを実行する手順を紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="スクリプト" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88/"/>
    
    <category term="スクリプト監視" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E7%9B%A3%E8%A6%96/"/>
    
    <category term="スクリプト実行" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E5%AE%9F%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>Linux エージェントのインストール/アンインストール方法について</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/scxagent_install_uninstall/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/scxagent_install_uninstall/</id>
    <published>2022-09-08T02:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.771Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。<br>本日は SCOM サーバーで監視できる UNIX/Linux 監視方法や監視を構成しているエージェント側のコンポーネント、ならびに具体的なインストール/アンインストール方法についてご紹介いたします。</p><h2 id="監視対象とエージェントのコンポーネントについて"><a href="#監視対象とエージェントのコンポーネントについて" class="headerlink" title="監視対象とエージェントのコンポーネントについて"></a>監視対象とエージェントのコンポーネントについて</h2><h3 id="監視対象"><a href="#監視対象" class="headerlink" title="監視対象"></a>監視対象</h3><p>まず各 SCOM バージョンで監視対象にできる UNIX/Linux の OS については下記当社公開ドキュメントに記載しておりますのでご参照ください。</p><table><thead><tr><th>バージョン</th><th>確認先 URL</th></tr></thead><tbody><tr><td>2016</td><td><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-supported-crossplat-os?view=sc-om-2016">サポートされている UNIX/Linux の OS </a></td></tr><tr><td>2019</td><td><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-supported-crossplat-os?view=sc-om-2019">サポートされている UNIX/Linux の OS </a></td></tr><tr><td>2022</td><td><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-supported-crossplat-os?view=sc-om-2022">サポートされている UNIX/Linux の OS </a></td></tr></tbody></table><h3 id="エージェントのコンポーネント"><a href="#エージェントのコンポーネント" class="headerlink" title="エージェントのコンポーネント"></a>エージェントのコンポーネント</h3><p>監視対象に UNIX/Linux に SCOM エージェント（以後、SCXAgent）をインストールしますと下記ディレクトリ、ならびにその配下にファイルが生成されます。</p><table><thead><tr><th>ディレクトリパス</th><th>内容</th></tr></thead><tbody><tr><td>/opt/omi/</td><td>Open Management Infrastructure (OMI) は次のディレクトリにインストールされます</td></tr><tr><td>/opt/microsoft/scx/</td><td>UNIX/Linux エージェントは次のディレクトリにインストールされます</td></tr><tr><td>/var/opt/microsoft/scx/log/</td><td>UNIX/Linux エージェントは次のディレクトリにログ ファイルを保持します</td></tr><tr><td>/var/opt/omi/log/</td><td>OMI は次のディレクトリにログ ファイルを保持します</td></tr><tr><td>/etc/opt/microsoft/scx/</td><td>証明書などのエージェントの構成ファイルは次のディレクトリに格納されます</td></tr><tr><td>/etc/opt/omi/</td><td>OMI 構成ファイルは次のディレクトリに格納されます</td></tr></tbody></table><h2 id="インストール方法とアンインストール方法について"><a href="#インストール方法とアンインストール方法について" class="headerlink" title="インストール方法とアンインストール方法について"></a>インストール方法とアンインストール方法について</h2><h3 id="インストール方法"><a href="#インストール方法" class="headerlink" title="インストール方法"></a>インストール方法</h3><p>ここからは具体的なインストール方法は記載いたします。</p><p>まず監視をするため UNIX / Linux 管理パックを SCOM 管理サーバーにインポートする必要がございます。<br>以下ダウンロード先から対象管理パックをダウンロードいただき、SCOM 管理サーバーに <a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-mp-import-remove-delete?view=sc-om-2019">インポート</a> します。</p><table><thead><tr><th>バージョン</th><th>確認先 URL</th></tr></thead><tbody><tr><td>2016</td><td><a href="https://www.microsoft.com/en-us/download/details.aspx?id=29696"> ダウンロード先 </a></td></tr><tr><td>2019 / 2022</td><td><a href="https://www.microsoft.com/en-us/download/details.aspx?id=58208"> ダウンロード先 </a></td></tr></tbody></table><p>SCXAgent のインストールは以下２つの方法がございます。</p><h4 id="1-SCOM-Operations-Console-画面での操作"><a href="#1-SCOM-Operations-Console-画面での操作" class="headerlink" title="1. SCOM Operations Console 画面での操作"></a>1. SCOM Operations Console 画面での操作</h4><p>手順は <a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-deploy-crossplat-agent-console?view=sc-om-2019#to-discover-and-install-an-agent-on-a-unix-or-linux-computer">当ページ</a> に記載がございます。<br>下記を確認できる事から可能な限りこちらの操作方法でのインストールを推奨しております。<br>　・SCOM 管理サーバーに必要な管理パックが入っているか<br>　・エージェントコンピューターと通信できる環境となっているか<br>　・インストール時に指定する Linux のユーザーが使用できるか</p><h4 id="2-Linux-のローカルでの操作"><a href="#2-Linux-のローカルでの操作" class="headerlink" title="2. Linux のローカルでの操作"></a>2. Linux のローカルでの操作</h4><p>手順は <a href="https://docs.microsoft.com/en-us/system-center/scom/manage-install-crossplat-agent-cmdline?view=sc-om-2019">当ページ</a> に記載がございます。<br>CentOS を例に記載しますと、上記ページの下記箇所のコマンドを実行いただくことでインストールできます。</p><ul><li><p>事前作業としてエージェントのインストールシェル （ scx-<version>.universalr.<version>.<arch>.sh ）を事前に対象コンピューターに任意フォルダに格納します。<br> エージェント パッケージは、管理サーバーの次のフォルダにあります。<br>　%ProgramFiles%\Microsoft System Center\Operations Manager\Server\AgentManagement\UnixAgents\DownloadedKits</p></li><li><p>以下コマンドでパッケージをインストールします<br>　sh ./scx-<version>.universalr.<version>.<arch>.sh –install –enable-opsmgr</p></li><li><p>以下コマンドでパッケージのインストール結果を確認します。コマンド結果としてアウトプットが出力されればインストールされております。<br>　rpm -q scx</p></li><li><p>以下コマンドで SCX Server の実行状況を確認します。<br>　scxadmin -status</p></li></ul><p>　<br>(結果例) omiagent については実行した後ある程度時間が経過したのち 1 instance 以上が実行状態となります。<br>omiserver: is running<br>omiagent: is stopped<br>または<br>omiserver: is running<br>omiagent: XX instance running</p><h3 id="アンインストール方法"><a href="#アンインストール方法" class="headerlink" title="アンインストール方法"></a>アンインストール方法</h3><h4 id="1-SCOM-Operations-Console-画面での操作-1"><a href="#1-SCOM-Operations-Console-画面での操作-1" class="headerlink" title="1. SCOM Operations Console 画面での操作"></a>1. SCOM Operations Console 画面での操作</h4><p>手順は <a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-upgrade-uninstall-crossplat-agent?view=sc-om-2019#uninstalling-agents">当ページ</a> に記載がございます。</p><h4 id="2-Linux-のローカルでの操作-1"><a href="#2-Linux-のローカルでの操作-1" class="headerlink" title="2. Linux のローカルでの操作"></a>2. Linux のローカルでの操作</h4><p>手順は <a href="https://docs.microsoft.com/en-us/system-center/scom/manage-uninstall-crossplat-agent?view=sc-om-2019">当ページ</a> に記載がございます。<br>CentOS を例に記載しますと、上記ページの下図箇所のコマンドを実行いただくことでアンインストールできます。</p><ul><li>rootユーザーでログオンし、以下コマンドでパッケージをアンインストールします<br>　rpm -e scx</li><li>パッケージがアンインストールされたことを確認するには、次のように入力します。何も出力されなければアンインストールできております。<br>　rpm -q scx</li></ul><p>本日のご紹介は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;br&gt;本日は SCOM サーバーで監視できる UNIX/Linux 監視方法や監視を構成しているエージェント側のコンポーネント、ならびに具体的なインス</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="SCXAgent" scheme="https://jpsystemcenter.github.io/blog/tags/SCXAgent/"/>
    
  </entry>
  
  <entry>
    <title>SCOM 管理パック移行による別環境への設定移行</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_MPTransfer/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_MPTransfer/</id>
    <published>2022-08-23T03:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.751Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆さまこんにちは、System Center サポートチームの保科です。<br>本日は、System Center Operations Manager (以降は SCOM と略称) をアップグレードせずに新規環境を構築された場合、既存環境の一部設定を新規環境へ以降する手順をご紹介いたします。</p><p>2022 年になり SCOM 2016 が延長サポート期間へ移行したり、SCOM 2012 系は延長サポート期間が終了となりました。<br>このように、SCOM に限らず弊社がリリースしておりますオンプレミス製品は原則としてサポート期間が設定されております。<br>サポート期間終了に伴い、古いバージョンの SCOM をご利用のお客様においては、サポート期間中の SCOM 環境へリプレースされることをご検討いただいている状況と存じます。<br>SCOM 環境のリプレースには、既存環境のアップグレードと、既存環境と並行して新規環境を作成いただく 2 種類の方法がございます。<br>詳細は、本ブログ内で別途公開しております下記ページも併せてご確認ください。<br><a href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_migration/">SCOM 2016 から SCOM 2022 へ移行 or アップグレードについて</a></p><p>本記事では、新規環境へ設定を移行する方法について、移行に使用する管理パックの概要と含めて詳細な手順をご説明いたします。</p><h1 id="管理パックとは"><a href="#管理パックとは" class="headerlink" title="管理パックとは"></a>管理パックとは</h1><p>“概要” 項でも簡単に触れました通り、既存環境から新規環境へ設定を移行する場合、管理パックを使用して移行を行います。<br>管理パック移行方法の解説の前に、管理パックとはそもそも何かについてご説明いたします。</p><p>管理パックは、SCOM におけるいわゆるプラグインのような働きをするファイルとなります。<br>管理パックを SCOM 環境内に導入いただくことで、初期状態では存在しない、サーバーの CPU 使用率の監視といった監視機能の拡張を行うことが出来ます。<br>管理パックによって提供される内容は様々な内容が存在し、下記の弊社サイトにも詳細が掲載されております。<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-overview-management-pack?view=sc-om-2022">Operations Manager の管理パックに含まれている内容</a></p><p>こちらのサイトに記載された、管理パックに含まれる内容を抜粋いたします。</p><blockquote><p>管理パックには通常、アプリケーションとサービスの監視設定が含まれます。 管理パックが管理グループの System Center - Operations Manager にインポートされると、既定の構成と管理パックで定義されたしきい値に基づいて直ちにオブジェクトの監視が開始されます。<br>各管理パックには次の部分のいずれかまたはすべてが含まれていることがあります。</p><ul><li>管理されたコンポーネントの各種要素の状態を追跡するよう、エージェントに指示を送るモニター。</li><li>パフォーマンス データや検出データの収集やアラートやイベントの送信などを行うよう、エージェントに指示を送るルール。</li><li>エージェントまたはコンソールが実行可能なアクティビティを定義する、タスク。</li><li>オペレーターが診断や問題解決できるよう、テキストでアドバイスを出すナレッジ。</li><li>このコンポーネントの監視や管理用にカスタマイズしたユーザー インターフェイスを提供する、表示。</li><li>この管理されたコンポーネントに関する情報を報告するための特定の方法を定義する、レポート。</li><li>監視されるべきオブジェクトを特定する、オブジェクト検出。</li><li>異なるコンピューターの異なるアカウントでさまざまなルール、タスク、モニター、検出を実行することを可能にする、実行プロファイル。</li></ul></blockquote><p>上記の事項については管理パックに含まれる内容となります。<br>そのため、管理パックをエクスポートいただくことで、上記設定を纏めてエクスポートいただくことが可能となります。<br>その後、エクスポートされた管理パックを新規環境にインポートいただくことで、上記設定については従前どおりの設定でご利用いただけます。</p><p>しかし、逆の言い方をすれば、管理パックに含まれない内容についてはエクスポートすることが出来ないため、新規環境に引き継ぐことは出来ません。<br>これには、例えば現在監視されているサーバーならびにその監視設定、今までの監視データやアラート情報、実行アカウント、SCOM データベースのクリーンアップ設定等が含まれます。<br>管理パックに含まれない内容については、従前の環境と同等の設定を手動で実施いただく必要がございます。<br>また、今までの監視データはすべて喪失することとなりますので、予めご了承ください。</p><p>管理パックは、大きく分けると下記の 2 種類に分けることが可能です。</p><ul><li>弊社やサードパーティから提供されている管理パック:<br>監視されたいハードウェアやソフトウェア用に、弊社やサードパーティから管理パックがリリースされております。<br>それらの管理パックを導入することで、その管理パックによって提供される監視機能の一式が提供されます。<br>例えば、Windows Server 2016 以降の Windows Server OS を監視する弊社提供の管理パックを導入することで、その OS の監視が実現いただけます。<br>管理パック毎に提供される監視機能はその管理パックの実装面で定義されております。</li><li>お客様が SCOM 運用に際して独自に作成いただいた管理パック:<br>SCOM で動作するルールやモニターは、オーバーライドを行うことでお客様の監視要件に応じて動作方法やアラートのしきい値といった設定値を変更いただけます。<br>また、お客様の監視要件に応じて、SCOM ではお客様が独自にルールやモニターを作成いただける仕組みもございます。<br>こういった内容を保存する際に、お客様の方で SCOM 内に独自の管理パックを作成いただくことが可能です。</li></ul><p>今回の移行手順のご案内では、上記 2 種類の管理パックを移行する手順をご案内としております。<br>それでは、具体的に管理パックをどのように移行することが可能か説明していきます。</p><h1 id="具体的な管理パック移行方法"><a href="#具体的な管理パック移行方法" class="headerlink" title="具体的な管理パック移行方法"></a>具体的な管理パック移行方法</h1><p>既存環境から新規環境に管理パックを移行する方法として、大きく分けて下記の手順を実施いただきます。</p><ol><li>既存の SCOM 環境から管理パックをエクスポート</li><li>既存環境からエクスポートされた管理パックを新規 SCOM 環境にインポート</li></ol><p>各手順の詳細をご案内いたします。</p><h2 id="1-既存の-SCOM-環境から管理パックをエクスポート"><a href="#1-既存の-SCOM-環境から管理パックをエクスポート" class="headerlink" title="1. 既存の SCOM 環境から管理パックをエクスポート"></a>1. 既存の SCOM 環境から管理パックをエクスポート</h2><p>こちらの手順は、既存環境より新規環境に移行するための管理パックをエクスポートする手順となります。<br>エクスポートを実施いただく場合、下記手順を実施します。</p><ol><li>管理者の権限を持つユーザーで Operations Manager 管理サーバーにログオンします。</li><li>C: ドライブの直下に MPs フォルダーを作成します。</li><li>[スタート] 画面から [Operations Manager Shell] を選択します (※)。</li><li>[Operations Manager Shell] ウィンドウのプロンプトで以下のコマンドを実行します。<blockquote><p>Get-SCOMManagementPack | Export-SCOMManagementPack -Path:C:\MPs</p></blockquote></li></ol><p>こちらの手順を実施いただくと、”MPs” フォルダに、SCOM でご利用のすべての管理パックが “&lt;SCOM に保存された管理パックの名称&gt;.xml” のファイル名でエクスポートされます。<br>管理パックの名称にスペースが存在する場合、スペースは “.” に変換の上エクスポートされます。<br>管理パックの名称に日本語が 1 文字でも含まれる場合、エクスポートされる管理パックは “ManagementPack&lt;管理パック毎の固有文字列&gt;” の名称でエクスポートされます。<br>このエクスポートされた管理パックの内、お客様が独自に定義された管理パックを新規環境に移行します。</p><h2 id="2-既存環境からエクスポートされた管理パックを、新規-SCOM-環境にコピー"><a href="#2-既存環境からエクスポートされた管理パックを、新規-SCOM-環境にコピー" class="headerlink" title="2. 既存環境からエクスポートされた管理パックを、新規 SCOM 環境にコピー"></a>2. 既存環境からエクスポートされた管理パックを、新規 SCOM 環境にコピー</h2><p>下記の説明では、特にご要望が多い以下の観点でご案内いたします。</p><ol><li>独自定義ルール / モニターのインポート方法</li><li>ルール / モニターの上書き設定のインポート方法</li><li>配信登録設定のインポート方法</li></ol><h3 id="1-独自定義ルール-モニターのインポート"><a href="#1-独自定義ルール-モニターのインポート" class="headerlink" title="1) 独自定義ルール / モニターのインポート"></a>1) 独自定義ルール / モニターのインポート</h3><p>“1. 既存の SCOM 環境から管理パックをエクスポート” でエクスポートされた管理パックの内、独自定義ルール / モニターを作成される際に指定された管理パックを新規環境にコピーします。<br>その管理パックを新規環境にインポートいただくことで、新規環境でもそのモニターをご利用いただくことが可能となります。</p><h3 id="2-ルール-モニターの上書き設定のインポート"><a href="#2-ルール-モニターの上書き設定のインポート" class="headerlink" title="2) ルール / モニターの上書き設定のインポート"></a>2) ルール / モニターの上書き設定のインポート</h3><p>“1. 既存の SCOM 環境から管理パックをエクスポート” でエクスポートされた管理パックの内、既存環境で上書き設定を保存さる際に使用された管理パックを、新規環境にコピーします。<br>なお、新規環境に存在しないルール / モニターの上書き設定が保存されている管理パックを新規環境でインポートしようとすると、依存関係となる管理パックが存在しないとして、インポートが実施いただけない場合がございます。<br>この依存関係となる、新規環境に存在しないルール / モニターは、例えば Exchange Server 管理パックで使用いただけるルール / モニター等、お客様にて別途入手いただく必要がある管理パックが該当いたします。<br>この場合、まず “1. 既存の SCOM 環境から管理パックをエクスポート” でエクスポートされた管理パックより、当該管理パックと依存関係となる管理パックを新規環境にコピーおよびインポートいただきます。<br>基本的に、依存関係となる管理パックは既存環境に存在しますので、依存関係に関するエラーが出力されましたら、既存環境から依存関係となる管理パックをコピーいただきます様お願いいたします。<br>通常であれば、お客様が別途入手された管理パックは、すべて既定で下記フォルダ上に保存されます。</p><blockquote><p>C:\Program Files (x86)\System Center Management Packs</p></blockquote><p>そのため、既存環境上に存在するこちらのフォルダを全て新規環境にコピーいただき、フォルダ内の管理パックの内新規環境のバージョンで使用することをサポートされる管理パックを全てインポートします。</p><h3 id="3-配信登録設定のインポート"><a href="#3-配信登録設定のインポート" class="headerlink" title="3) 配信登録設定のインポート"></a>3) 配信登録設定のインポート</h3><p>SCOM では、特定のアラートをトリガーとしてスクリプトを実行したり、そのアラート内容を特定のアドレスにメール通知する配信登録設定が提供されております。<br>配信登録設定については、下記の弊社サイトにも詳細な内容が掲載されております。<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-notifications-alert-notifications?view=sc-om-2022">Operations Manager でアラート通知をサブスクライブする</a></p><p>こちらの機能は、多くのお客様がアラート情報を担当者に迅速に連携するべくご利用いただいている状況かと思います。<br>この設定も、”1. 既存の SCOM 環境から管理パックをエクスポート” でエクスポートされた管理パックの内 “Microsoft.SystemCenter.Notifications.Internal.xml” を新規環境にインポートいただくことで、既存環境の配信登録設定を引き継いで利用いただくことが可能です。<br>なお、インポートの際は、既に新しいバージョンの管理パックがインポートされている旨の情報が表示されますが、<br>インポート自体は可能で、この状態でインポートいただいても問題ございません。<br>弊社検証環境での動作内容や過去事例より、古いバージョンの管理パックを上書きする形で新規環境にインポートいただくことで、<br>SCOM の動作上特に問題が発生しないことを確認しております。<br>一例として、SCOM 2012 から 2019 へ当管理パックをインポート後、SCOM 2012 にて設定いただいた内容が正常に SCOM 2019 側へ反映されることも確認しております。<br>念のため、既存環境の “Microsoft.SystemCenter.Notifications.Internal.xml” を新規環境にインポートいただく際は、<br>“1. 既存の SCOM 環境から管理パックをエクスポート” 項の手順に沿って一度新規環境内の管理パックを全てエクスポートしてください。<br>その後、新規環境内にてエクスポートされた “Microsoft.SystemCenter.Notifications.Internal.xml” を任意のフォルダにコピーします。<br>これにより、万が一既存環境の “Microsoft.SystemCenter.Notifications.Internal.xml” を新規環境へインポート後に予期せぬ動作が発生された場合、既存環境よりエクスポートいただいた “Microsoft.SystemCenter.Notifications.Internal.xml” をインポートいただくことで、状況を改善いただけます。</p><p>なお、管理パックの上書きインポートという作業の性質上、新規環境の配信登録設定はすべて既存環境の設定に上書きされることとなります。<br>新規環境で既に配信登録設定が実施されている場合、その設定もすべて消失されることとなりますのでご注意ください。</p><h3 id="ご参考-管理パックのインポート方法"><a href="#ご参考-管理パックのインポート方法" class="headerlink" title="(ご参考) 管理パックのインポート方法"></a>(ご参考) 管理パックのインポート方法</h3><p>管理パックのインポート方法は、下記の弊社サイトに詳しく掲載されております。<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-mp-import-remove-delete?view=sc-om-2022#import-a-management-pack-from-disk">Operations Manager 管理パックをインポート、エクスポート、および削除する方法</a><br>本ページ内で解説しております操作を実施いただく手順としては、”管理パックをディスクからインポートする” 項の手順が適切になります。</p><h1 id="管理パックインポート時のご注意事項"><a href="#管理パックインポート時のご注意事項" class="headerlink" title="管理パックインポート時のご注意事項"></a>管理パックインポート時のご注意事項</h1><p>少なくとも弊社より提供されております管理パックについては、その管理パックのインポートをサポートする SCOM バージョンが予め指定されております。<br>SCOM における非サポートの管理パックをインポートすることは、”管理パック自体は動作し、使用することが出来るものの、使用に際して予期せぬ動作が発生される可能性がある” ことを意味します。<br>そのため、非サポートの管理パックをインポートいただく際は、予期せぬ動作が発生することをご理解いただいた上でインポートしてください。<br>非サポートの管理パックによる監視によって問題が発生された場合、弊社としてはその管理パックを削除いただく以外の対処方法のご案内をいたしかねますので、予めご了承ください。</p><p>弊社が公開しております管理パックは、下記サイトにて一覧で掲載されております。<br><a href="https://social.technet.microsoft.com/wiki/contents/articles/16174.microsoft-management-packs.aspx">Microsoft Management Packs</a><br>この一覧から、例えばサイト内の下図管理パックのリンク先へ遷移しますと、管理パックならびに管理パックガイドがダウンロードいただけます。<br><img src="https://raw.githubusercontent.com/jpsystemcenter/blog/53467ea239369d3ce5e16392b2dfeb5993a443c0/articles/SCOM/img/SCOM_MPTransfer/SCOM_MPTransfer_WS2016%2BMPLink.png"></p><p>このページの ”System Requirements” を確認いただくことで、管理パックのサポート範囲を確認いただけます。<br>今回の例で確認しました、Windows Server 2016 以降の Windows Server OS を監視する際に使用する “Windows Server Operating System 2016 and above” 管理パックは、SCOM 2016 / 2019 / 2022 で使用することをサポートすることが確認いただけます。<br><img src="https://raw.githubusercontent.com/jpsystemcenter/blog/53467ea239369d3ce5e16392b2dfeb5993a443c0/articles/SCOM/img/SCOM_MPTransfer/SCOM_MPTransfer_WS2016%2BMPPage.png"></p><p>また管理パックガイドからも同様の内容を確認いただけます。<br>こちらの管理パックでは、ドキュメント内の ”Supported Configurations” 項から内容をご確認いただけます。<br><img src="https://raw.githubusercontent.com/jpsystemcenter/blog/53467ea239369d3ce5e16392b2dfeb5993a443c0/articles/SCOM/img/SCOM_MPTransfer/SCOM_MPTransfer_WS2016%2BMPDoc.png"></p><p>管理パックのドキュメントは、対応する管理パックによって記述の意匠が異なります。<br>そのため、管理パックのドキュメントからサポートする SCOM バージョンを確認される場合、適宜そのドキュメントからサポート対象に関する内容をご確認ください。</p><p>SCOM 2019 のみではありますが、SCOM 2019 で使用することをサポートする管理パックが一覧で掲載されております。<br><a href="https://social.technet.microsoft.com/wiki/contents/articles/52876.scom-2019-management-packs.aspx">SCOM 2019 Management Packs</a><br>そのため、SCOM 2019 に関しては、上記の手順による確認ではなく、こちらのサイトからサポートされる管理パックをご確認いただくのが有用でございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆さまこんにちは、System Center サポートチームの保科です。&lt;br&gt;本日は、System Center Operations Manager (以降は SCOM と略称) をアップグレードせずに新規環境を構築された</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="アップグレード" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89/"/>
    
    <category term="新環境への移行" scheme="https://jpsystemcenter.github.io/blog/tags/%E6%96%B0%E7%92%B0%E5%A2%83%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>SCOM サーバー の取り得る構成について</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_construction/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_construction/</id>
    <published>2022-08-23T02:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.751Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。<br>本日は SCOM サーバーを構成するコンポーネント、ならびにコンポートネントをホストする OS の台数のよって取り得る構成についてご紹介いたします。</p><h2 id="SCOM-サーバーを構成するコンポーネント"><a href="#SCOM-サーバーを構成するコンポーネント" class="headerlink" title="SCOM サーバーを構成するコンポーネント"></a>SCOM サーバーを構成するコンポーネント</h2><p>まず SCOM サーバーを構成するコンポーネントについては下表に記載いたします。</p><table><thead><tr><th>コンポーネント</th><th>説明</th></tr></thead><tbody><tr><td>管理サーバー</td><td>SCOMの管理サーバーとして、管理対象とデータベース、オペレーションコンソールとの通信チャネルを提供します。複数の管理サーバーを導入することで、負荷分散と冗長化が可能です。</td></tr><tr><td>オペレーションデータベース</td><td>管理グループ内のすべての構成情報、オペレーション情報、セキュリティ情報などを保存する SQL データベースです。</td></tr><tr><td>データウェアハウスデータベース</td><td>オペレーション情報を長期間、保存する SQL データベースです。</td></tr><tr><td>Operations Manager コンソール</td><td>GUI ベースのユーザーインタフェースです。SCOM のほとんどの操作はオペレーションコンソールから実行できます。</td></tr><tr><td>Webコンソール</td><td>Web ベースのユーザーインタフェースで、監視に特化されています。</td></tr><tr><td>Operations Manager レポートサーバー</td><td>データウェアハウスデータベースの情報を元にレポートの作成と表示をおこないます。</td></tr><tr><td>レポートサーバー向けデータベース</td><td>レポートを表示する際に参照される SQL データーベースです。</td></tr><tr><td>ACSサーバー</td><td>セキュリティログを収集し、ACSデータベースに保存します。</td></tr><tr><td>ACSデータベース</td><td>セキュリティログを保存するSQLデータベースです。</td></tr></tbody></table><p>上記それぞれのコンポーネントをインストールするためのハードウェア / ソフトウェア要件がそれぞれございます。<br>主な要件については下記ページに記載しておりますのでご参照ください。</p><h3 id="SCOM-サーバーを構成するコンポーネントの要件"><a href="#SCOM-サーバーを構成するコンポーネントの要件" class="headerlink" title="SCOM サーバーを構成するコンポーネントの要件"></a>SCOM サーバーを構成するコンポーネントの要件</h3><ul><li>SCOM 2019<ul><li><a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2019">SCOM 2019 のシステム要件</a></li><li><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2019">SCOM 2019 のSQL Server の設計に関する考慮事項</a></li></ul></li><li>SCOM 2022 <ul><li><a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2022">SCOM 2022 のシステム要件</a></li><li><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2022">SCOM 2022 のSQL Server の設計に関する考慮事項</a></li></ul></li></ul><h2 id="SCOM-サーバー-の取り得る構成"><a href="#SCOM-サーバー-の取り得る構成" class="headerlink" title="SCOM サーバー の取り得る構成"></a>SCOM サーバー の取り得る構成</h2><p>ここまで上記コンポーネントの説明、ならびにその要件を記載させていただきましたが、以下に具体的な構成について記載します。</p><h3 id="OS-が-1-台の場合"><a href="#OS-が-1-台の場合" class="headerlink" title="OS が 1 台の場合"></a>OS が 1 台の場合</h3><p>1 台のサーバー管理グループに展開するのは、評価やテスト、管理パックの開発など、通常、ラボ、開発、または実稼働以外の環境にインストールする場合を想定しております。<br><img src="/blog/SCOM/SCOM_construction/0101.png"></p><p>構築方法については下記参考ページをご参照ください。　　</p><p><a href="https://docs.microsoft.com/ja-jp/system-center/scom/deploy-single-server?view=sc-om-2019">Operations Manager を 1 台サーバー構成で展開する</a><br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/quickstart-install-single-server?view=sc-om-2019">Operations Manager を 1 台のサーバーにインストールする手順</a></p><h3 id="OS-が-2-台の場合"><a href="#OS-が-2-台の場合" class="headerlink" title="OS が 2 台の場合"></a>OS が 2 台の場合</h3><p>管理グループを分散インストールすると、複数のサーバーに機能とサービスを配布して、環境を拡張できます。<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2019">SQL Server の設計に関する考慮事項</a>に記載しているように中規模から大規模の分散型展開では、SQL Server インスタンスを専用スタンドアロン サーバーまたは SQL Server 高可用性構成に配置する必要があります。</p><p>OS が 2 台の場合、具体的には下図のように DB 機能とサーバー機能を分散させます。<br><img src="/blog/SCOM/SCOM_construction/0201.png"></p><blockquote><p>[!WARNING]<br>システム要件に明確に記載しておらず恐縮ですが、<code>以下の構成は実績上取れない事を確認しているため避ける</code>ようお願いいたします。</p><ul><li> OS1 と OS2 で WSFC 構成を取り、DB（オペレーションデータベース / データウェアハウスデータベース） を always-on として構成</li><li> その OS1 もしくは OS2 上に 管理サーバーを構築する構成。</li></ul></blockquote><p>もし 2 台(この場合は OS というより故障の単位となる筐体でしょうか）で管理サーバー、及びデーターベース機能を冗長構成とすることが必須の場合は、WSFC の役割りとして VM ごと冗長構成とすることをご検討ください。<br>WSFC のフェールオーバー機能を使用して、片方（OS1）が故障した際に、もう片方（OS2）にフェールオーバーする構成となります。別途 CSV を担うサーバー/機能が必要となります。<br>しかし、上記「 OS が 1 台の場合」に記載しておりますとおり、<br> 1 台のサーバー管理グループに展開するのは、評価やテスト、管理パックの開発など、通常、ラボ、開発、または実稼働以外の環境にインストールする場合を想定している点についてご留意くださいませ。</p><h3 id="OS-が-3-台の場合"><a href="#OS-が-3-台の場合" class="headerlink" title="OS が 3 台の場合"></a>OS が 3 台の場合</h3><p>OS が 3 台の場合は<br>DB 機能を <a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2022#sql-server-always-on-1">always-on 構成</a> で冗長化させる構成（パターン 1）<br>または<br>オペレーションデータベース と データウェアハウスデータベースを別 OS として構成（パターン 2）<br>が考えられます。</p><h4 id="パターン-1"><a href="#パターン-1" class="headerlink" title="パターン 1"></a>パターン 1</h4><p><img src="/blog/SCOM/SCOM_construction/0301.png"></p><p>この場合にレポートサーバー向けデータベース構成については、always-on の可用性グループには登録できない点ご留意ください。<br>レポートサーバー向けデータベースをホストする OS が故障した際には <a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-move-reporting-services-role?view=sc-om-2019">Reporting Server の役割を移動する方法</a><br>に従いもう片方の OS 上で構築するようお願いいたします。<br>尚、データウェアハウスデーターベースが健在であれば、その情報からレポーティングに必要なデーターベースは構成可能でございます。</p><p>下記に当社の海外エンジニアが記載したレポーティングサーバーの取り得る構成について記載した下記ブログがございますので、よろしければご参照ください。<br><a href="https://techcommunity.microsoft.com/t5/system-center-blog/operations-manager-reporting-8211-supported-ssrs-configurations/ba-p/340385">レポーティングサーバーの取り得る構成</a></p><h4 id="パターン-2"><a href="#パターン-2" class="headerlink" title="パターン 2"></a>パターン 2</h4><p><img src="/blog/SCOM/SCOM_construction/0302.png"></p><p>当構成に関する情報は<a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2019#operations-manager-data-warehouse-database">Operations Manager データ ウェアハウス データベース</a><br>に以下のように記載しております。</p><p>レポート データ ウェアハウスは Operations Manager データベースとは別のサーバーに配置することを検討してください。 小規模の展開では、多くの場合、Operations Manager データベースとレポート データ ウェアハウスを同じサーバーで統合できますが、エージェントの数と入ってくるオペレーション データの量を増やすときに、分離すると効果的です。 レポート データ ウェアハウスとレポート サーバーが <code>Operations Manager データベースとは別のサーバーにあると、レポート パフォーマンスが向上します</code>。</p><h4 id="2-パターンのすみ分け"><a href="#2-パターンのすみ分け" class="headerlink" title="2 パターンのすみ分け"></a>2 パターンのすみ分け</h4><p>上記 2 パターンのすみ分けとしては以下が考えられますので、お客様の構成時の参考にしていただければ幸いです。<br>　-データのリアルタイム保護性を重要視する（重要視する運用方針の場合）<br>　　　-&gt; パターン 1 を選択<br>　-処理を分散させることで、処理負荷によるデータ I/O 失敗によるデータ欠損やワークフロー失敗を出来るだけ抑止する<br>　　　-&gt; パターン 2 を選択</p><h3 id="OS-が-4-台の場合"><a href="#OS-が-4-台の場合" class="headerlink" title="OS が 4 台の場合"></a>OS が 4 台の場合</h3><p>4 台目は SCOM 管理サーバーの 2号機を構築いただく事が構成として考えられます。<br>追加する手順については <a href="https://docs.microsoft.com/ja-jp/system-center/scom/deploy-install-mgmt-server?view=sc-om-2019#to-install-additional-management-servers-in-the-management-group">管理グループに追加の管理サーバーをインストールするには</a> をご参照ください。<br>SCOM 管理サーバーの 2 台目を構築いただく事が可能であり、それにより管理サーバーも冗長化されるとともに以下のように役割りを分散させる事が可能となります。</p><h4 id="パターン-1-1"><a href="#パターン-1-1" class="headerlink" title="パターン 1"></a>パターン 1</h4><p>Windows と UNIX/LINUX 系でエージェントのプライマリサーバー役（収集データのプライマリ送信先）を分散させる</p><h4 id="パターン-2-1"><a href="#パターン-2-1" class="headerlink" title="パターン 2"></a>パターン 2</h4><p>エージェントの台数が多い場合にエージェントのプライマリサーバー役（収集データのプライマリ送信先）を平準化するよう分散させる</p><h3 id="OS-が-5-台の場合"><a href="#OS-が-5-台の場合" class="headerlink" title="OS が 5 台の場合"></a>OS が 5 台の場合</h3><p>5 台目は レポーティングサーバー、もしくは ACS サーバーを独立させてホストすることが考えられます。<br>こちらはお客様の用途(例、ACS 機能を重視しており使う頻度が高く、その機能にリソースを多く割り当てたい）によってご検討ください。</p><p>構築手順は下記ページをご参照ください。</p><p><a href="https://docs.microsoft.com/ja-jp/system-center/scom/deploy-install-reporting-server?view=sc-om-2019">Operations Manager Reporting Server をインストールする方法</a><br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/deploy-install-acs?view=sc-om-2019">監査コレクション サービス (ACS) とデータベースをインストールする方法</a></p><p>以上、お客様の構成設計の参考になれば幸いでございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;br&gt;本日は SCOM サーバーを構成するコンポーネント、ならびにコンポートネントをホストする OS の台数のよって取り得る構成についてご紹介いたしま</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="SCOM サーバーの構成" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E6%A7%8B%E6%88%90/"/>
    
  </entry>
  
  <entry>
    <title>SCOM 2016 から SCOM 2022 へ移行 or アップグレードについて</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_migration/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_migration/</id>
    <published>2022-08-18T04:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.755Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。<br>本日は System Center Operations Manager（以後 SCOM）  の新環境への移行やアップグレードについての考え方をご紹介いたします。</p><p>まず前提として SCOM の仕様内容について以下記述いたします。</p><ol><li><p>SCOM 管理サーバーのバージョン違いの共存について<br>　基本的には 1 バージョン前の最新の UR とのみ共存が可能となります。<br>　参考：<a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2022#supported-coexistence">共存の要件</a></p></li><li><p>SCOM 管理サーバーのシステム要件<br>　SCOM 管理サーバーにはバージョンごとにシステム要件がございます。<br>　　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2022#supported-coexistence">SCOM 2022 のシステム要件</a><br>　　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2019#supported-coexistence">SCOM 2019 のシステム要件</a><br>　　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2016#supported-coexistence">SCOM 2016 のシステム要件</a><br>　　<a href="https://docs.microsoft.com/ja-jp/previous-versions/system-center/system-center-2012-r2/dn281935(v=sc.12)">SCOM 2012 R2のシステム要件</a></p></li></ol><p>上記ページを参照いただくと確認できるように 2 バージョン 離れていると要件を満たす OS や SQL Server で共有するバージョンがございません。<br>例）<br>SCOM 2022 に対応する OS バージョン<br>　Windows Server 2019 Standard/Datacenter<br>　Windows Server 2019 Server Core<br>　Windows Server 2022 Standard/Datacenter<br>　Windows Server 2022 Server Core<br>SCOM 2016 に対応する OS バージョン<br>　Windows Server 2012 R2  Standard/Datacenter<br>　Windows Server 2016 Standard/Datacenter<br>　Windows 2016 Server Core</p><p>一方、多くのお客様が HW の EOL 対応や減価償却期間を踏まえたリプレース、もしくは Microsoft サポートフェーズを踏まえた移行やアップグレードを検討する場合、新環境は 2 バージョン以上先になると考えております。<br>その場合 2 段階のアップグレード （例、SCOM 2016 -&gt; SCOM 2019 -&gt; SCOM 2022）することはシステム要件を踏まえると現実的（※1）ではございません。</p><p>そのため選択肢としては新規に SCOM 管理サーバーを構築したのちに、監視対象サーバーから旧エージェントをアンインストールいただき、新バージョンをインストールして入れ替えることなります。<br>アンインストール/インストール方法については下記公開情報をご参照ください。</p><p>アンインストール方法の関連情報（SCOM 2016 に関する公開情報）<br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-uninstall-windows-agent?view=sc-om-2016">Windows ベースのコンピューターからエージェントをアンインストールする</a><br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-upgrade-uninstall-crossplat-agent?view=sc-om-2016#uninstalling-agents">Upgrading and Uninstalling Agents on UNIX and Linux Computers (UNIX および Linux コンピューター上のエージェントのアップグレードおよびアンインストール)</a><br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-uninstall-crossplat-agent?view=sc-om-2016">Manually Uninstalling Agents from UNIX and Linux Computers</a><br>インストール方法の関連情報（SCOM 2022 に関する公開情報）<br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-deploy-windows-agent-console?view=sc-om-2022">検出ウィザードを使ってエージェントを Windows にインストールする</a><br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-deploy-windows-agent-manually?view=sc-om-2022">MOMAgent.msi を使用して Windows エージェントを手動でインストールする</a><br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-deploy-crossplat-agent-console?view=sc-om-2022">検出ウィザードを使ってエージェントを UNIX および Linux にインストールする</a><br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-install-crossplat-agent-cmdline?view=sc-om-2022">コマンド ラインから UNIX および Linux コンピューターにエージェントをインストールする</a></p><p>また新環境を構築することで以下のメリットがございます。<br>　・旧環境と併設できるため、エージェント側の状況（監視を停止できる時間）を踏まえて移行できる<br>　・アップグレードの場合サポートしていない管理パックが引き継がれるリスクが混在するが、その問題を回避できる<br>　・新バージョンでサポートしていない監視対象については、引き続き旧環境で監視できる<br>　　　例） SCOM 2022 で監視対象となる Windows のバージョン（※2）は Windows Server 2012 以降/ Windows 10 以降となります。</p><p>新環境への移行やアップグレードについてお困りごとがございましたら Microsoft までお問合せくださいませ。</p><p>※ 1<br>OS や SQL Server のバージョンアップや 要件を満たす HW へ移行をすることで実現できる可能性はございます。<br>※ 2<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2022#microsoft-monitoring-agent-operating-system">監視対象の要件</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;br&gt;本日は System Center Operations Manager（以後 SCOM）  の新環境への移行やアップグレードについての考え方を</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="アップグレード" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89/"/>
    
    <category term="新環境への移行" scheme="https://jpsystemcenter.github.io/blog/tags/%E6%96%B0%E7%92%B0%E5%A2%83%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>SCOM 2019 以降で Windows 検出ウィザードで検出失敗</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_service_logon_access/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_service_logon_access/</id>
    <published>2022-08-03T06:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.755Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以後 SCOM）  2019 で変更のあった仕様の 1 つをご紹介いたします。<br>2022 年 8 月現在の状況として、（<a href="https://docs.microsoft.com/ja-jp/lifecycle/products/microsoft-system-center-2012-r2-operations-manager">SCOM 2012 R2の延長サポートのフェーズが2022年7月に終了</a>）したことに伴い、SCOM 2019 や 2022 など後継バージョンの環境を新規構築して移行を進めている、もしくはご計画されているお客様もいるかと存じます。</p><p>SCOM 2019 の新規環境を構築後に Windows コンピューターを検出する際に SCOM インストール ユーザ以外で検出を試みると下図のエラー（対象コンピューターがいない）と出力される場合がございます。</p><p><img src="/blog/SCOM/SCOM_service_logon_access/SCOM_detection_computer_failures.png"></p><p>この事象はこれまでのバージョンと異なり検出する実行アカウントに対しててサービス ログオンアクセス許可を有効にいない場合に発生している可能性がございます。<br>設定をされていなければ、下記手順にて一度設定をいただき、事象がfai改善するかご確認いただければと存じます。</p><p>SCOM 管理サーバーにて以下設定をする事で、サービス ログオンアクセス許可を有効にできます。</p><ol><li>SCOM 管理サーバーに管理者特権でサインインします。</li><li>[管理ツール] に移動し、 [ローカル セキュリティ ポリシー] をクリックします。<br>　例えば、Windows Server 2016 以降では、スタートメニューを開き、[Windows 管理ツール] -&gt; [ローカル セキュリティ ポリシー] をクリックします。</li><li>[ローカル ポリシー] を展開し、 [ユーザー権利の割り当て] をクリックします。</li><li>右側のウィンドウで、 [サービスとしてログオン] を右クリックし、 [プロパティ] を選択します。</li><li>[ユーザーまたはグループの追加] オプションをクリックし、以下どちらかを追加します。</li><li>サーバーを再起動します。</li></ol><p>参考サイト：<a href="https://docs.microsoft.com/ja-jp/system-center/scom/enable-service-logon?view=sc-om-2019#enable-service-log-on-permission-for-run-as-accounts">https://docs.microsoft.com/ja-jp/system-center/scom/enable-service-logon?view=sc-om-2019#enable-service-log-on-permission-for-run-as-accounts</a></p><blockquote><p>対象バージョン：<br>　System Center Operations Manager 2019<br>　System Center Operations Manager 2022</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以後 SCOM）  2019 で変更のあった仕様の 1 つをご</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM ジョブ保存設定変更方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Job_History/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Job_History/</id>
    <published>2022-07-07T03:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.771Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆さんこんにちは、System Center サポートチームの 保科と申します。</p><p>今回は、System Center Virtual Machine Manager (SCVMM) で保存されるジョブ履歴の保存設定についてご紹介いたします。</p><h3 id="本ページが対象とする-SCVMM-バージョン"><a href="#本ページが対象とする-SCVMM-バージョン" class="headerlink" title="[本ページが対象とする SCVMM バージョン]"></a>[本ページが対象とする SCVMM バージョン]</h3><p>SCVMM 2016<br>SCVMM 2019<br>SCVMM 2022</p><h3 id="概要"><a href="#概要" class="headerlink" title="[概要]"></a>[概要]</h3><p>SCVMM で実行される処理の多くは、ジョブという形で実行されます。<br>このジョブが実行されると、実行可否に関わらず、履歴としてすべて SCVMM データベースに存在する [dbo].[tbl_TR_TaskTrail] というテーブルに保存されます。<br>ジョブ履歴ですが、バッチ処理を組まれる等して大量のジョブが短期間で実行される環境においては、このテーブルが肥大化する要因となります。<br>テーブルが肥大化することで、SCVMM 観点においては下記の影響が発生します。</p><ul><li>単純に [dbo].[tbl_TR_TaskTrail] テーブルサイズが肥大化し、データベースファイルサイズの肥大化</li><li>SCVMM へのパフォーマンスへの影響</li></ul><p>意外に思われるかもしれませんが、ジョブ履歴が大量に保存されている環境においては、SCVMM へのパフォーマンス影響が発生する可能性がございます。<br>特段負荷が大きい処理を連続して実施されていないにも関わらず、SCVMM ジョブの実行速度や SCVMM 自体が以前より遅くなったといった状況では、ジョブ履歴が大量に保存されている可能性がございます。</p><h3 id="対処手順"><a href="#対処手順" class="headerlink" title="[対処手順]"></a>[対処手順]</h3><p>このジョブ履歴ですが、レジストリ値によってジョブ履歴保持日数および削除処理が行われる周期を設定いただけます。<br>そのため、”概要” 項で説明しました影響が発生されている場合は、そのレジストリ値設定を変更いただくのが切り分けとして有用となります。</p><p>追加いただくレジストリは、以下の 2 種類が該当いたします。</p><blockquote><p>レジストリキー:<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft System Center Virtual Machine Manager Server\Settings\Sql</p><p>レジストリの種類:<br>DWORD (32 ビット) 値</p><p>レジストリの名称:<br>TaskGC</p><p>レジストリ値:<br>ジョブの保持日数を整数値で指定します。<br>例えば、本レジストリ値が 7 に設定された場合、ジョブ履歴削除処理が行われた日付時刻から 7 日以内のジョブは保持され、それ以外はすべて削除対象となります。<br>レジストリが未作成の状態である場合、本レジストリ値は 90 に設定されたものとして動作が行われます。<br>こちらのレジストリ設定値を、ご利用の環境でどの程度ジョブ履歴を重要視されるかに応じて設定します。<br>また、本レジストリ値の設定値に関わらず、一度のジョブ履歴削除処理で削除されるジョブ数は最大で 50000 件となります。<br>そのため、各処理間で 50000 件以上のジョブ履歴が保存される場合、ジョブ履歴は傾向として増加される状況となります。<br>ご利用の環境に合わせて、もう一つのレジストリである “DBGCUpdateInterval” のレジストリ値を構成します。</p></blockquote><blockquote><p>レジストリキー:<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft System Center Virtual Machine Manager Server\Settings</p><p>レジストリの種類:<br>DWORD (32 ビット) 値</p><p>キーの名称 :<br>DBGCUpdateInterval</p><p>レジストリ値:<br>ジョブ削除ジョブが実行される周期を秒単位の整数値で指定します。<br>レジストリが未作成の状態である場合、本レジストリ値は 72000 (= 20 時間) に設定されたものとして動作が行われます。</p></blockquote><p>レジストリの作成は、下記手順で行えます。</p><ol><li>レジストリを追加する SCVMM サーバーに管理者権限でログインします。</li><li>[Win] + [R] キーを押下し、”regedit” と入力して実行します。</li><li>画面左ペインより、各レジストリの追加先となるレジストリキーにアクセスします。</li><li> レジストリが表示された画面上で右クリックし、[新規] -&gt; [DWORD (32 ビット) 値] をクリックします。</li><li>追加されたレジストリに対して、”キーの名称” で指定された文字列を入力します。</li><li>追加されたレジストリをダブルクリックし、レジストリの編集を行います。</li><li>ウィンドウ右側に表示された [10 進数] を選択し、レジストリで指定いただく値を入力します。</li><li>レジストリ追加完了後、SCVMM サーバーに関するサービスである “System Center Virtual Machine Manager” サービスを再起動します。</li></ol><h3 id="ご参考"><a href="#ご参考" class="headerlink" title="[ご参考]"></a>[ご参考]</h3><p>既に弊社にて公開がされていないサイトとなりますので、こちらのブログにて併せてそちらのサイトの内容をご紹介いたします。<br>その公開終了されたサイトでは、SCVMM のジョブについて要約すると以下の内容が書かれておりました。</p><ul><li>SCVMM の仕様として、目安ではあるものの 10000 の同時並行実施ジョブが処理可能であること。</li><li>10000 以上のジョブが同時並行で実施されている場合、SCVMM サーバーのパフォーマンスに多大な影響を及ぼす可能性があること。</li><li>大量のジョブが並行実施される動作とは別に、SCVMM ジョブ履歴が大量に保存されている場合、それによっても SCVMM サーバーのパフォーマンスに多大な影響を及ぼす可能性があること。</li></ul><p>公開終了とされる前に記載されております内容について、原文のままご紹介いたします。</p><ul><li><p>SCVMM で同時並行で実行可能なジョブ数に関する記述:</p><blockquote><p>The maximum number of running jobs that an SCVMM system should be able to handle is around 10,000 and hitting this many running jobs at one time would be an exceptionally rare occurrence.<br>Should it occur, however, it can have a severe impact on the performance of the SCVMM engine.</p></blockquote></li><li><p>SCVMM ジョブ履歴が大量に保存されていることで発生しうる影響に関する記述:</p><blockquote><p>The number of retained Jobs count refers to the number of running tasks tracked in the TaskTrail database table in SQL.<br>The size of this database can have as much of an impact on performance as the actual running jobs.<br>If the number of running jobs nowhere reaches 10,000 then it may be that the tombstone limit on entries tracked in the TaskTrail database is too conservative</p></blockquote></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆さんこんにちは、System Center サポートチームの 保科と申します。&lt;/p&gt;
&lt;p&gt;今回は、System Center Virtual Machine Manager (SCVMM) で保存されるジョブ履歴の保存設</summary>
      
    
    
    
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
    <category term="SCVMM Server" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM-Server/"/>
    
    <category term="Job" scheme="https://jpsystemcenter.github.io/blog/tags/Job/"/>
    
  </entry>
  
  <entry>
    <title>Japan System Center Enterprise Management (SCEM) チームの Blog 新規開設のお知らせ</title>
    <link href="https://jpsystemcenter.github.io/blog/general/JapanSCEM_000_NewBlogOpened/"/>
    <id>https://jpsystemcenter.github.io/blog/general/JapanSCEM_000_NewBlogOpened/</id>
    <published>2022-03-18T06:30:00.000Z</published>
    <updated>2022-11-25T05:20:27.771Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Blog-新規開設のお知らせ"><a href="#Blog-新規開設のお知らせ" class="headerlink" title="Blog 新規開設のお知らせ"></a>Blog 新規開設のお知らせ</h2><p>こんにちは、System Center Enterprise Management (SCEM) サポート チームです。<br>この度、Japan System Center Enterprise Management (SCEM) サポート チームのブログを新規に開設しましたことをお知らせいたします。</p><p>こちらのブログでは、我々のチームで扱う System Center 製品のテクノロジーに関する話題を中心に情報を発信していきます。<br>マイクロソフトでは、各製品の動作仕様や、開発部門などからも多くの公式な公開情報を提供しております。<br>このブログでは、新機能に関してのご紹介だけでなく、マイクロソフト製品をご利用のお客様よりサポート依頼を直接受けているサポート エンジニアという立場から、時には私どもの視点を交えて、皆様のお役に立つ情報をご案内したいと思います。<br>これから本ブログで公開していく情報の一例を以下に記載しました。</p><h2 id="公開する情報の例"><a href="#公開する情報の例" class="headerlink" title="公開する情報の例"></a>公開する情報の例</h2><ul><li>リリースされたばかりの新機能に関する情報</li><li>よくサポート チームにお問い合わせいただく “あるある” な問題への対処方法</li><li>System Center 製品をご利用のお客様に是非お伝えしたい情報</li><li>ある問題についてサポートにお問い合わせいただく際、スムーズに調査を進めるために事前に採取いただきたい情報</li></ul><h2 id="本ブログで扱う製品の一覧"><a href="#本ブログで扱う製品の一覧" class="headerlink" title="本ブログで扱う製品の一覧"></a>本ブログで扱う製品の一覧</h2><p>System Center に区分される製品は複数存在しますが、本ブログでは主に下記の製品についてご紹介いたします。</p><ul><li>System Center Operations Manager (SCOM)</li><li>System Center Virtual Machine Manager (SCVMM)</li><li>System Center Orchestrator (SCO, SCORCH)</li><li>System Center Service Manager (SCSM)</li></ul><p>これら以外の System Center 製品、例えば Data Protection Manager (SCDPM) や Configuration Manager (SCCM) は本ブログにて扱う予定はございませんので、予めご了承くださいませ。<br>これから様々な情報を発信しますので、こちらのブログが皆さまのお役に立てれば幸いです。<br>また、実際のサポート サービスでは、製品動作に関する正式な見解のご提供、そして問題解決のサポートを行っていますので、こちらも併せてよろしくお願いいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Blog-新規開設のお知らせ&quot;&gt;&lt;a href=&quot;#Blog-新規開設のお知らせ&quot; class=&quot;headerlink&quot; title=&quot;Blog 新規開設のお知らせ&quot;&gt;&lt;/a&gt;Blog 新規開設のお知らせ&lt;/h2&gt;&lt;p&gt;こんにちは、System Center En</summary>
      
    
    
    
    
    <category term="General" scheme="https://jpsystemcenter.github.io/blog/tags/General/"/>
    
    <category term="Information" scheme="https://jpsystemcenter.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>一部の System Center 2019 で SQL Server 2019 を使用する際の前提条件</title>
    <link href="https://jpsystemcenter.github.io/blog/general/Prerequisites_SQL2019/"/>
    <id>https://jpsystemcenter.github.io/blog/general/Prerequisites_SQL2019/</id>
    <published>2022-02-16T03:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.771Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆さんこんにちは、System Center サポートチームの 保科と申します。</p><p>2022 年 2 月 16 日現在、System Center 2012 の延長サポートが終了間近であったり、System Center 2016 のメインストリームサポートが終了となります。<br>これに伴い、System Center 2019 へのアップグレードや新規環境構築を検討されているお客様も多くいらっしゃるかと思います。<br>System Center 2019 で使用するデータベースでは、SQL Server 2019 の使用がサポートされております。<br>本記事では、一部の System Center 2019 で SQL Server 2019 を使用する際の注意点について説明いたします。</p><h3 id="本記事が対象とする-System-Center-製品"><a href="#本記事が対象とする-System-Center-製品" class="headerlink" title="本記事が対象とする System Center 製品"></a>本記事が対象とする System Center 製品</h3><blockquote><p>・System Center Operations Manager (SCOM) 2019<br>・System Center Service Manager (SCSM) 2019</p></blockquote><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>冒頭でもお伝えしました通り、System Center 2019 では SQL Server 2019 の利用がサポートされております。<br>一方で、本記事が対象としている System Center 製品においては、インストール直後の SQL Server 2019 にデータベースを構成するようにインストールを行うと、インストールに失敗する場合があります。<br>これは、<strong>対象の System Center 2019 製品では、SQL Server 2019 に加えて、SQL Server 2019 CU8 以上の適用が必要となるため</strong>です。<br>CU8 以上の適用はインストール時に表示される前提条件では確認できず、インストール開始まで進めることが可能です。<br>この際、CU8 以上が適用されていないため内部的にエラーが発生し、System Center 2019 のインストールが失敗します。<br>こちらは、各 System Center 2019 でサポートされる構成が掲載された弊社公開情報にも CU8 以上の適用が必須なことが明記されております。<br>・SCOM 2019 における SQL Server 2019 CU8 以上の適用が必要な旨記載された弊社公開情報:<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2019">https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2019</a><br>(“SQL Server の要件” 項を参照ください。)<br>・SCSM 2019 における SQL Server 2019 CU8 以上の適用が必要な旨記載された弊社公開情報:<br><a href="https://docs.microsoft.com/ja-jp/system-center/scsm/system-requirements?view=sc-sm-2019">https://docs.microsoft.com/ja-jp/system-center/scsm/system-requirements?view=sc-sm-2019</a><br>(“SQL Server の要件” 項を参照ください。)</p><p>なお、System Center Virtual Machine Manager (SCVMM) 2019 および System Center Orchestrator (SCORCH) 2019、System Center Data Protection Manager (SCDPM) においては、SCOM 2019 および SCSM 2019 と同様に SQL Server 2019 の使用がサポートされております。<br>一方で、これらの System Center 2019 製品では CU8 以上のアップデートが SQL Server 2019 での適用が必須と明記されておりません。<br>また、実際に CU8 以上が適用されていない状態でもインストールに成功することを弊社検証環境において確認しております。</p><h3 id="対処方法"><a href="#対処方法" class="headerlink" title="対処方法"></a>対処方法</h3><p>SQL Server 2019 を対象となる System Center 2019 製品で使用する場合、SQL Server 2019 に CU8 以上の適用が必要となります。<br>各 SQL Server のバージョンで提供されている最新の CU アップデートは下記の弊社公開情報から参照いただけます。</p><ul><li>アプリケーションとそのコンポーネントのバージョン、エディション、および更新SQL Server決定する<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/sql/general/determine-version-edition-update-level">https://docs.microsoft.com/ja-jp/troubleshoot/sql/general/determine-version-edition-update-level</a></li></ul><p>SQL Server 2019 の最新版の CU アップデートを入手される場合、こちらの公開情報より “現在サポートされているバージョンの更新プログラムで利用可能な最新SQL Server” 項の表を参照します。<br>“バージョン” 列が “SQL Server 2019” と記載された行の “最新の累積的な更新プログラム” より、”CU <strong>xx</strong> for 2019” と書かれた文字をクリックすることで、対象の CU アップデートの内容およびダウンロード先が掲載された弊社サイトが開かれます。<br>( <strong>xx</strong> には、CU アップデートの数値が記載されております。<br>2022 年 2 月 16 日現在、こちらは “CU15 for 2019” と記載されております。)<br>開かれたサイトより最新版の CU アップデートをダウンロードいただけるリンクをクリックし、アップデートファイルを入手します。<br>そのアップデートファイルを System Center 2019 製品で使用する SQL Server 上で適用することでアップデートが完了します。<br>アップデート後、System Center 2019 のインストールが行えるかご確認ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆さんこんにちは、System Center サポートチームの 保科と申します。&lt;/p&gt;
&lt;p&gt;2022 年 2 月 16 日現在、System Center 2012 の延長サポートが終了間近であったり、System Cen</summary>
      
    
    
    
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="General" scheme="https://jpsystemcenter.github.io/blog/tags/General/"/>
    
    <category term="SQL Server" scheme="https://jpsystemcenter.github.io/blog/tags/SQL-Server/"/>
    
  </entry>
  
  <entry>
    <title>SCOM 2012 R2 エージェントのアンインストール時のトラブル事例</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_2012R2_Uninstall-TroubleCase/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_2012R2_Uninstall-TroubleCase/</id>
    <published>2022-02-04T03:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.751Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以後 SCOM）のエージェントの入れ替え作業の失敗事例をご紹介いたします。<br>2022 年 1 月現在の状況として、（<a href="https://docs.microsoft.com/ja-jp/lifecycle/products/microsoft-system-center-2012-r2-operations-manager">SCOM 2012 R2の延長サポートのフェーズが2022年7月に終了</a>）することに伴い、SCOM 2016や2019 など後継バージョンの環境を新規構築して移行を進めている、もしくはご計画されているお客様もいるかと存じます。</p><p>その際、監視対象コンピューターにて <strong>SCOM 2012 R2 のエージェントのアンインストールを行う事となりますが、アンインストール時に想定外に発生したトラブル事例</strong>についてご紹介いたします。</p><p>アンインストールした際には下記パスのように SCOM エージェント専用のフォルダやフォルダ配下のファイルが削除されるのは当然ですが、その他に別ソフトウェアでも使用するファイルが配置しているフォルダにある SCOM エージェント で使用するファイルも削除する対象となります。</p><blockquote><p>例）<br>SCOM エージェント専用のフォルダの例<br>　C:\Program Files\Microsoft Monitoring Agent\Agent<br>別ソフトウェアでも使用するファイルが配置しているフォルダの例<br>　C:\Windows\System32</p><p>上記例に記載しているフォルダ「C:\Windows\System32」からは以下ファイルが削除対象となります。<br>　AcsMsgs.dll<br>　AdtAgent.exe<br>　InterceptCounters.dll<br>　msvcp100.dll<br>　msvcr100.dll</p></blockquote><p>通常他ソフトウェアで上記ファイルを使用している場合は Windows のレジストリの設定値（複数のプログラムで使用しているため、アンインストールしない設定）によりアンインストール時に削除されないようになっているはずが、その設定がされておらず想定外にファイル msvcp100.dll が削除される事例がございました。</p><h4 id="■レジストリ設定個所"><a href="#■レジストリ設定個所" class="headerlink" title="■レジストリ設定個所"></a>■レジストリ設定個所</h4><blockquote><p>　HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\SharedDLLs</p></blockquote><p>当事象は基本発生しないはずですが、万一発生してしまった場合は削除されたファイルを再度インストールする事で基本は復旧いたします。<br>必要なファイルについては各ソフトウェア次第でございますので、ここでのご説明は省略させていただきますが、上記ファイル msvcp100.dll の例でしたら当ファイル含むランタイム一式を下記サイトから取得いただき、再度インストールいただく事で復旧いたしました。<br>x86 と x64 については、今回消失してしまったモジュールにあわせて選択していただく必要がありますのでご留意ください。<br><a href="https://www.microsoft.com/ja-jp/download/details.aspx?id=26999">https://www.microsoft.com/ja-jp/download/details.aspx?id=26999</a> </p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以後 SCOM）のエージェントの入れ替え作業の失敗事例をご紹介</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
    <category term="Agent" scheme="https://jpsystemcenter.github.io/blog/tags/Agent/"/>
    
  </entry>
  
  <entry>
    <title>SCOM エージェントの入れ替え作業の失敗事例</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_agent_failures/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_agent_failures/</id>
    <published>2022-01-28T03:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.751Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以後 SCOM）  のエージェントの入れ替え作業の失敗事例をご紹介いたします。<br>2022 年 1 月現在の状況として、（<a href="https://docs.microsoft.com/ja-jp/lifecycle/products/microsoft-system-center-2012-r2-operations-manager">SCOM 2012 R2の延長サポートのフェーズが2022年7月に終了</a>）することに伴い、SCOM 2016や2019 など後継バージョンの環境を新規構築して移行を進めている、もしくはご計画されているお客様もいるかと存じます。</p><p>その際、監視対象コンピューターにて SCOM 2012 R2 のエージェントのアンインストールを行い、SCOM 2016 や 2019 のエージェントをインストールすることになりますが、<strong>アンインストール時に想定通り削除が出来ず、SCOM 2012 R2 向けのレジストリ設定やフォルダが残存してしまい SCOM エージェントをインストールする際に失敗する事例</strong>が発生しております。</p><h2 id="Error-Message"><a href="#Error-Message" class="headerlink" title="Error Message"></a>Error Message</h2><p>具体的にはプッシュインストール時には下記のようなインストール失敗メッセージが出力されます</p><blockquote><p>リモート コンピューター &lt;&lt;コンピューターFQDN&gt;&gt; のエージェント管理オペレーションは エージェントのインストール に失敗しました。<br>インストール アカウント: XXX<br>エラー コード: 80070643<br>エラーの説明: インストール中に致命的なエラーが発生しました。<br>Microsoft インストーラーのエラーの説明:<br>詳細については、管理サーバーの Windows インストーラーのログ ファイル “C:\Program Files\Microsoft System Center 2016\Operations &gt;Manager\Server\AgentManagement\AgentLogs\xxxAgentInstall.LOG<br>C:\Program Files\Microsoft System Center 2016\Operations Manager\Server\AgentManagement\AgentLogs\XXXMOMAgentMgmt.log” を参照してください。 </p></blockquote><h2 id="対処策"><a href="#対処策" class="headerlink" title="対処策"></a>対処策</h2><p>当事象が発生した際には<br>下記に記載するフォルダとレジストリを確認いただき、残存している場合は削除いただきますようお願いします。</p><p>※下記 2 つの値は環境によりで異なっております。</p><blockquote><p>D996D247BE65CC940AA413D70EF113DC<br>742D699D-56EB-49CC-A04A-317DE01F31CD</p></blockquote><p>以下のように確認いただき、お客様環境の文字列に読み替えをお願いします。</p><p>・D996D247BE65CC940AA413D70EF113DC<br>パス「HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products」において<br>下図のように [InstallProperties] の [DisplayName] が “Microsoft Monitoring Agent”となっている箇所の フォルダ名</p><p>下図の確認結果として ”D996D247BE65CC940AA413D70EF113DC” を ”5C0796876F6E14A42B83EA524D9BE1AE” に読み替えます。<br><img src="https://user-images.githubusercontent.com/71251920/151289630-3ed34906-47a7-467f-ac70-4bf269148ce7.gif" alt="SCOM_agent_failures_01"></p><p>・742D699D-56EB-49CC-A04A-317DE01F31CD<br>パス「HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\」において<br>下図のように [DisplayName] が “Microsoft Monitoring Agent”となっている箇所の フォルダ名</p><p>下図の確認結果として ”742D699D-56EB-49CC-A04A-317DE01F31CD” を”786970C5-E6F6-4A41-B238-AE25D4B91EEA” に読み替えます。<br><img src="https://user-images.githubusercontent.com/71251920/151289631-00aa5d7c-8b20-4bf3-baca-4baefd861d66.gif" alt="SCOM_agent_failures_02"></p><h3 id="削除対象のレジストリ"><a href="#削除対象のレジストリ" class="headerlink" title="削除対象のレジストリ"></a>削除対象のレジストリ</h3><p>・全てフォルダとなります。keyではございません。<br>・2行目の[XXXX\C96403E8AD6025B4F9E1FE9C574E34AE]は固定文字列のフォルダとなります。</p><p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\D996D247BE65CC940AA413D70EF113DC<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UpgradeCodes\C96403E8AD6025B4F9E1FE9C574E34AE<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Components\D9960A263C3B3F948AE9C9793043B7C9<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall{742D699D-56EB-49CC-A04A-317DE01F31CD}<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\System Center<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\System Center Operations Manager<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft Operations Manager<br>HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Installer\Products\D996D247BE65CC940AA413D70EF113DC<br>HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Installer\Features\D996D247BE65CC940AA413D70EF113DC<br>HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Installer\UpgradeCodes\C96403E8AD6025B4F9E1FE9C574E34AE<br>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\MOMConnector<br>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\HealthService<br>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\System Center Management APM</p><h3 id="削除対象のフォルダ"><a href="#削除対象のフォルダ" class="headerlink" title="削除対象のフォルダ"></a>削除対象のフォルダ</h3><p>C:\Windows\Installer{742D699D-56EB-49CC-A04A-317DE01F31CD}<br>C:\Program Files\Common Files\Microsoft Shared\Operations Manager</p><p>上記レジストリ及びフォルダの確認、削除が完了しましたらここで OS の再起動をお願いします。</p><p>確認および削除手順は以上となります。新規エージェントをインストールする際に失敗する事象が発生した際は、ぜひ一度上記確認をお願いいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以後 SCOM）  のエージェントの入れ替え作業の失敗事例をご</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
    <category term="Agent" scheme="https://jpsystemcenter.github.io/blog/tags/Agent/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM サーバーおよび SCVMM 管理対象サーバーの自己署名証明書の更新手順</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Renew_Crtificate/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Renew_Crtificate/</id>
    <published>2022-01-12T03:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.771Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆さんこんにちは、System Center サポートチームの 保科と申します。</p><p>今回は、System Center Virtual Machine Manager (SCVMM) で使用する自己署名証明書の有効期限が切れた場合や、削除をされた場合の対処方法についてご案内いたします。</p><h3 id="本ページが対象とする-SCVMM-バージョン"><a href="#本ページが対象とする-SCVMM-バージョン" class="headerlink" title="[本ページが対象とする SCVMM バージョン]"></a>[本ページが対象とする SCVMM バージョン]</h3><p>SCVMM 2012<br>SCVMM 2012 SP1<br>SCVMM 2012 R2<br>SCVMM 2016<br>SCVMM 2019</p><h3 id="概要"><a href="#概要" class="headerlink" title="[概要]"></a>[概要]</h3><p>SCVMM では、SCVMM サーバー機能をインストールしたサーバーや、SCVMM にて管理対象となる Hyper-V サーバーに SCVMM エージェントがインストールされた際、同時に自己署名証明書も当該サーバーにインストールされます。<br>これは、SCVMM サーバーと管理対象 Hyper-V サーバーの間の通信の安全性を確保するためにインストールされます。<br>そのため、この自己署名証明書は、SCVMM サーバーが管理対象 Hyper-V サーバーと通信を行う際に必須となる証明書となります。</p><p>この自己署名証明書は、フレンドリ名が  “SCVMM_CERTIFICATE_KEY_CONTAINER***” となっており、発行者はそのホスト自身になっています。<br>(*** の部分は SCVMM サーバーもしくは Hyper-V サーバーの完全修飾ドメイン名となります。)<br>この証明書の期限は SCVMM サーバーや、Hyper-V サーバーを SCVMM の管理対象に設定した年の 1/1 から 5 年間に設定されます。<br>例えば 2015/10/26 に Hyper-V ホストを SCVMM の管理対象に設定した場合、設定される証明書の有効期限は 2020/1/1 になります。<br>これは 2015 年中であればいつ Hyper-Vホストを管理対象に追加された場合でも同様の結果となります。</p><p>上記の通りこの証明書の期限は 5 年間 (SCVMM のバージョンによっては 10 年間)となっています。<br>このため、5 年間 (10 年間) が経過するとこの証明書は無効になります。<br>なお、この証明書の有効期限が超過する 1 ヶ月前になりますと、SCVMM サーバー上で以下の警告メッセージが出力されるようになります。</p><blockquote><p>警告 (20583)<br>コンピューター &lt;対象サーバーの完全修飾ドメイン名&gt; の自己署名証明書は既に有効期限切れか、1 か月以内に有効期限切れになります。</p><p>推奨される操作<br>VMM から &lt;対象サーバーの完全修飾ドメイン名&gt; を削除してから追加して、新しい証明書を取得してください。</p></blockquote><p>また何かのトラブルシュートの際などに誤ってこの証明書を削除してしまったりすることも考えられます。<br>その場合、SCVMM サーバーと Hyper-V サーバーの間の通信に問題が発生し、Hyper-V サーバーの管理作業などが正しく動作しなくなります。</p><p>このような場合、SCVMM サーバーもしくは Hyper-V サーバーにインストールされている SCVMM エージェントを再インストールすることで対処することもできますが、証明書を再発行することでも対処することができます。<br>この際の手順は以下の [対処手順 ①] に従って自己署名証明書の再インストールを実施します。<br>また、SCVMM サーバー限定かつ特定の SCVMM バージョン限定の手順とはなりますが、[対処手順 ②] に従った自己署名証明書の更新も実施いただけます。</p><h3 id="対処手順-①"><a href="#対処手順-①" class="headerlink" title="[対処手順 ①]"></a>[対処手順 ①]</h3><ol><li>自己署名証明書を更新いただくサーバーに管理者権限でログインします。</li><li>Windows + R を入力して、[ファイル名を指定して実行] を起動します。</li><li>mmc と入力して [OK] をクリックします。</li><li>表示されたウインドウで、メニュー バーから [ファイル] - [スナップインの追加と削除] を選択します。</li><li>“利用できるスナップイン” から “証明書” を選択し、[追加] をクリックします。</li><li>[証明書スナップイン] ウインドウが表示されたら、”コンピューター アカウント” をチェックし、[次へ] をクリックします。</li><li>[コンピューターの選択] ウインドウでは、既定値のまま [完了] をクリックします。</li><li>[OK] をクリックして、[スナップインの追加と削除] ウインドウを閉じます。</li><li>左側のツリーから、[証明書 (ローカル コンピューター)] -&gt; [個人] -&gt; [証明書] を開きます。</li><li>中央ペインに表示されている証明書のうち、”フレンドリ名” 列に “SCVMM_CERTIFICATE_KEY_CONTAINER***” と表示されてる証明書を選択して削除します。<br>(*** の部分は SCVMM サーバーもしくは Hyper-V サーバーの完全修飾ドメイン名となります。)<br>そのような証明書が既に存在しない場合、そのまま手順 11. に進みます。</li><li>SCVMM サーバー上で、”Virtual Machine Manager Command Shell” を起動します。</li><li>以下のコマンドを実行します。<blockquote><p><code> </code> <code>$credential = get-credential</code> <code> </code></p></blockquote></li><li>表示されたウインドウに、SCVMM サーバーのローカル管理者権限のあるユーザーのユーザー名とパスワードを入力して [OK] をクリックします。</li><li>続いて、以下のコマンドを実行します。<br>(*** の部分は SCVMM サーバーもしくは Hyper-V サーバーの完全修飾ドメイン名を入力します。)<blockquote><p><code> </code> <code>Get-VMMManagedComputer -ComputerName &quot;***&quot; | Register-SCVMMManagedComputer  -Credential $credential</code> <code> </code></p></blockquote></li><li>自己署名証明書を更新されるサーバーに、有効期限が 5 年後 (10 年後) の 1 月 1 日に設定された自己署名証明書が無事再作成されたことを、10. の手順で開いたコンソール上で確認いただきます。<br>手順実施後も証明書が更新されていない場合、画面を最新の情報に更新いただくことで表示される場合がございます。</li></ol><h3 id="対処手順-②"><a href="#対処手順-②" class="headerlink" title="[対処手順 ②]"></a>[対処手順 ②]</h3><p>こちらの手順は、以下の SCVMM バージョンにて追加されたコマンドレットを使用する手順となります。<br>・SCVMM 2016 Update Rollup 10<br>・SCVMM 2019 Update Rollup 2<br>上記のバージョンに SCVMM をアップデートすると、SCVMM サーバーの自己署名証明書を更新する “Update-SCVMMCertificate” コマンドレットがご利用いただけるようになります。<br>SCVMM サーバー限定の手順となり、Hyper-V サーバーに対しては実施いただけない手順となりますが、以下の手順に沿って SCVMM サーバーにインストールされた自己署名証明書を更新いただけます。</p><ol><li>SCVMM サーバーに管理者権限でログインします。</li><li>ログインしたサーバー上で “Virtual Machine Manager Command Shell” を起動します。</li><li>以下のコマンドを実行します。<blockquote><p><code> </code> <code>Update-SCVMMCertificate -VMMServer &#39;***&#39; </code> <code> </code><br><code> </code> <code> (*** の部分は SCVMM サーバーの完全修飾ドメイン名を入力します。)</code> <code> </code></p></blockquote></li><li>自己署名証明書を更新されるサーバーに、有効期限が 5 年後 (10 年後) の 1 月 1 日に設定された自己署名証明書が無事再作成されたことを、”対処手順 ①” の 10. の手順で開けるコンソール上で確認いただきます。<br>手順実施後も証明書が更新されていない場合、画面を最新の情報に更新いただくことで表示される場合がございます。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆さんこんにちは、System Center サポートチームの 保科と申します。&lt;/p&gt;
&lt;p&gt;今回は、System Center Virtual Machine Manager (SCVMM) で使用する自己署名証明書の有効</summary>
      
    
    
    
    
    <category term="Agent" scheme="https://jpsystemcenter.github.io/blog/tags/Agent/"/>
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
    <category term="Library Server" scheme="https://jpsystemcenter.github.io/blog/tags/Library-Server/"/>
    
  </entry>
  
  <entry>
    <title>AdtAdmin / setquery でアクセス拒否エラー(0x00000005)が発生する場合の対処法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_AccessError_0x00000005/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_AccessError_0x00000005/</id>
    <published>2022-01-06T03:00:00.000Z</published>
    <updated>2022-11-25T05:20:27.751Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以後 SCOM） の機能である 監査コレクション サービス (ACS) （<a href="https://docs.microsoft.com/ja-jp/system-center/scom/deploy-install-acs?view=sc-om-2019">監査コレクション サービス (ACS) コレクターとデータベースをインストールする方法 | Microsoft Docs</a>）において WQL クエリ設定を実行する際に必要な設定をご紹介いたします。</p><p>ACS は WQL（<a href="https://docs.microsoft.com/ja-jp/sql/relational-databases/wmi-provider-server-events/using-wql-with-the-wmi-provider-for-server-events?view=sql-server-ver15">WMI Provider for Server Events と WQL の使用 - SQL Server | Microsoft Docs</a>）を使用して取得対象のイベントの範囲を絞ることが可能です。<br>これは ACS データを保存するデータベースの肥大化の防止、また不要なデータを取得しないことでSCOM 管理サーバー/監視対象サーバーの処理負荷の軽減に寄与いたします。</p><p>しかし、規定の設定では下記のように WQL を実行しようとする際にアクセス拒否エラーが出力される事が確認されております。</p><blockquote><p>■コマンド例<br><code> </code> <code>C:\Windows\System32\Security\AdtServer&gt;AdtAdmin /setquery /query:&quot;SELECT * FROM AdtsEvent WHERE EventId=XXX&quot; </code> <code> </code></p></blockquote><p>その際はレジストリエディタにて以下キーに対してユーザー “NETWORK SERVICE” へ フルコントールなどの “値の設定”の権限付与することで改善されます。<br>こちらの設定については SCOM 用に定義されているパラーメータ設定であり、設定変更により他アプリケーションへの影響はございませんのでご安心ください。</p><blockquote><p>■キー<br><code> </code> <code>HKLM\SYSTEM\CurrentControlSet\Services\AdtServer\Parameters</code> <code> </code></p></blockquote><p>参考図：</p><p><img src="https://user-images.githubusercontent.com/71251920/148327138-6c2ba2db-ced8-4408-9c43-144a170ee18d.png" alt="参考図"></p><blockquote><p>対象バージョン：<br>　System Center Operations Manager 2012 R2<br>　System Center Operations Manager 2016<br>　System Center Operations Manager 2019</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以後 SCOM） の機能である 監査コレクション サービス (</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
    <category term="Audit Collection Service (ACS)" scheme="https://jpsystemcenter.github.io/blog/tags/Audit-Collection-Service-ACS/"/>
    
  </entry>
  
</feed>
