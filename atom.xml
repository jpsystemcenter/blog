<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan System Center Support Blog</title>
  
  <subtitle>日本マイクロソフトの System Center に関するサポート情報のブログです。</subtitle>
  <link href="https://jpsystemcenter.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpsystemcenter.github.io/blog/"/>
  <updated>2024-03-13T12:36:01.116Z</updated>
  <id>https://jpsystemcenter.github.io/blog/</id>
  
  <author>
    <name>Japan System Center Support</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>MonitoringHost.exe が仮想メモリを異常に消費する</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_highmemory_MonitoringHost/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_highmemory_MonitoringHost/</id>
    <published>2024-03-13T12:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.116Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以下、SCOM） が監視のために利用するプロセスである MonitoringHost.exe が消費する仮想メモリ量が増大する話についてお伝えします。</p><h2 id="仮想メモリを異常に消費"><a href="#仮想メモリを異常に消費" class="headerlink" title="仮想メモリを異常に消費"></a>仮想メモリを異常に消費</h2><h3 id="事象"><a href="#事象" class="headerlink" title="事象"></a>事象</h3><p>突然、SCOM の管理サーバーやエージェントが導入されているマシンにてプロセスが異常にメモリを消費し、マシンがダウンするといった事象が発生することがあります。<br>その場合、イベント ログ [System] に以下が記録されることを確認しています。</p><h4 id="イベントの例-イベント-ID：2004"><a href="#イベントの例-イベント-ID：2004" class="headerlink" title="イベントの例 (イベント ID：2004)"></a>イベントの例 (イベント ID：2004)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ログの名前：System</span><br><span class="line">日時：yyyy/mm/dd hh:mm:ss </span><br><span class="line">ソース：Resource-Exhaustion-Detector</span><br><span class="line">レベル：警告</span><br><span class="line">タスクのカテゴリ：リソース消費診断イベント</span><br><span class="line">イベント ID：2004</span><br><span class="line">ユーザー：NT AUTHORITY\SYSTEM</span><br><span class="line">コンピュータ：hyperv01.contoso.com</span><br><span class="line">説明：Windows は仮想メモリの不足状態を診断しました。仮想メモリを多く消費したのは次のプログラムです:</span><br><span class="line">*MonitoringHost.exe (4904) は 3003106107520 バイトを消費し* 、WmiPrvSE.exe (2122) は 2003314000 バイトを消費し、svchost.exe (1134) は 192024218 バイトを消費しました。</span><br></pre></td></tr></table></figure><p>上記のイベントではプロセス MonitoringHost.exe が 約280GB （※）の仮想メモリを使用していることを示しています。<br>このイベントが記録されるタイミングでまた、SCOM に関するイベント ログ [Operations Manager] には同時にイベント ID：26008 がかなりの頻度で記録されていることも確認しています。<br>過去お問い合わせを頂いたお客様では、具体的な頻度の度合いは数秒で2000～3000件というかなりの頻度もございました。</p><p>※ 3003106107520 B / 1024 (KB 換算) 1024 （MB 換算）/ 1024 GB （GB 換算）</p><h4 id="イベントの例-イベントID：26008"><a href="#イベントの例-イベントID：26008" class="headerlink" title="イベントの例 (イベントID：26008)"></a>イベントの例 (イベントID：26008)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ソース：Health Service Modules</span><br><span class="line">日時：yyyy/mm/dd hh:mm:ss</span><br><span class="line">イベントID：26008</span><br><span class="line">Level：エラー</span><br><span class="line">コンピュータ名：hyperv01.contoso.com</span><br><span class="line">説明：コンピューター &#x27;hyperv01.contoso.com&#x27; の Operations Manager イベント ログは壊れた状態のままです。イベント ログ プロバイダーが、問題があると思われるレコードをスキップすることによって回復を試みます。</span><br><span class="line">最大 2 つのレコードがスキップされる可能性があります。</span><br><span class="line">1 つ以上のワークフローがこの影響を受けました。</span><br><span class="line"></span><br><span class="line">ワークフロー名: Microsoft.SystemCenter.Apm.Infrastructure.Monitoring.ApmAgent.APMConfigurationConflict.Monitor</span><br><span class="line">      インスタンス名: hyperv01.contoso.com</span><br><span class="line">      インスタンス ID: &#123;8E315A0A-DFFD-8341-6461-A4A561E0F2D&#125;</span><br><span class="line">      管理グループ: SCOM</span><br></pre></td></tr></table></figure><p>上記のイベントが記録されている状態はプロセス MonitoringHost.exe が仮想メモリを異常に消費してしまう状況が発生しており、OS 上の仮想メモリを枯渇させてしまい再起動するしか対処方法がありません。<br>併せて、この問題が発生致しますと Application のイベント ログにイベント ID：1530 が記録されます。</p><h4 id="イベントの例-イベントID：1530"><a href="#イベントの例-イベントID：1530" class="headerlink" title="イベントの例 (イベントID：1530)"></a>イベントの例 (イベントID：1530)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ソース：User Profile Service</span><br><span class="line">日時：yyyy/mm/dd hh:mm:ss</span><br><span class="line">イベントID：1530</span><br><span class="line">ユーザー：NT AUTHORITY\SYSTEM</span><br><span class="line">Level：警告</span><br><span class="line">コンピュータ名：hyperv01.contoso.com</span><br><span class="line">説明：レジストリ ファイルは他のアプリケーションまたはサービスで使用されています。ファイルはすぐにアンロードされます。レジストリ ファイルを保持しているアプリケーションまたはサービスはこれ以降正しく機能しない可能性があります</span><br><span class="line"></span><br><span class="line">詳細 -</span><br><span class="line">32 user registry handles leaked from \Registry\User\S-1-5-21-1614895754-1085031214-725345543-289007:</span><br><span class="line">Process 4904 (\Device\HarddiskVolume1\Program Files\Microsoft System Center 2016\Operations Manager\Server\MonitoringHost.exe) has opened key \REGISTRY\USER\S-1-5-21-1614895754-1085031214-725345543-289007</span><br><span class="line">&lt;・・・以下、同様の内容が記録されるため割愛しています・・・&gt;</span><br></pre></td></tr></table></figure><p>こちらのイベント ID の説明の中で MonitoringHost.exe  のプロセスの記載があれば本事象に該当いたします。<br>そのため、こちらのイベント ログが記録されているかをまずご確認いただく方法も有効です。</p><h3 id="要因"><a href="#要因" class="headerlink" title="要因"></a>要因</h3><p>この事象の問題や要因を説明します。<br>こちらの問題は SCOM の管理サーバーやエージェントが利用するアクション アカウントが関連します。</p><p>SCOM は管理サーバーやエージェント上で監視を行う際に実行される処理はこのアクション アカウントによって実行される仕組みを取っておりますが、このアクション アカウントと同じアカウントを利用して OS 上で操作を行いログオフを実施すると今回の事象が発生することを確認しています。<br>これは OS 上でアクション アカウントと同じアカウントの操作によってログオフが実施されると User Profile がアンロードされるために発生します。</p><p>アクション アカウントでの監視はユーザーによるログオフ操作が実施されたあとも継続するため、User Profile をロードしようとします。<br>しかし、すでにログオフ操作のためアンロードされてしまっているためアクション アカウントは User Profile のロードを正常に行うことができず、エラーとなります。<br>このエラーが繰り返し発生し、エラー時に増加するヒープ領域が仮想メモリの領域を圧迫します。<br>仮想メモリの領域が圧迫されますと、上記のイベント ID：2004 が記録されます。</p><p>発生までの流れは以下です。</p><p>～～発生のプロセス～～</p><ol><li>SCOM 管理サーバーやエージェントで利用するアカウントがアンロードされた User Profile に含まれていたレジストリ キーにアクセスしようとする。</li><li>アクセスが失敗し、エラーに関連する情報がヒープ領域に格納される。</li><li>SCOM 管理サーバーやエージェントで利用するアカウントが繰り返しレジストリ キーへのアクセスを実行し、エラーの情報がヒープに格納され続ける。</li><li>ヒープ領域が肥大化する。</li><li>仮想メモリが枯渇する。</li></ol><p>この挙動は SCOM 含めた COM+ アプリケーションの実装では想定されている動作でもありますため、お客様環境にてこういった状況とならないよう事前にご利用いただくアカウントについてご確認いただく必要がございます。</p><p>この事象を回避いただくための対処方法は至って単純です。<br>それは SCOM の管理サーバーやアクション アカウントに使用しているアカウントと OS 上へとログオン/ログオフするアカウントを異なるものに変更するだけです。</p><p>SCOM の場合ですとアクション アカウントに ローカル システム アカウントを利用することが可能ですので、アカウントを基本的にローカル システム アカウントへと変更していただく、という運用が一番シンプルです。</p><p>しかし、ローカル システム アカウントの場合ですと権限が Administrator と同等ですので、SCOM のプロセスが悪用されるリスクを懸念されるお客様もいらっしゃるかと存じます。<br>それを考慮した場合、ドメインのアカウントを指定するほうがリスクは小さくなります。<br>どのアカウントを利用するかはお客様の運用ポリシーに依存する部分でもありますので検討の上、アカウントを決定してください。</p><p>SCOM のアクション アカウントにご利用いただくための権限については以下に公開情報があるのでご覧ください。</p><p>• 公開情報<br><a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-security-accounts?view=sc-om-2022">サービス、ユーザー、およびセキュリティ アカウント</a><br>※SCOM 2022 の情報ですが、SCOM 2019、SCOM 2016 でも同様です。</p><p>今の環境でこの Blog で案内している事象が発生する可能性があるか、というのは以下の手順で SCOM のアクション アカウントを確認してください。<br>以下の手順ではアクション アカウントに指定されているアカウントを確認していただき、そのアカウントがログオン/ログオフを実施するアカウントであるか確認できます。</p><p>&lt;&lt;確認手順&gt;&gt;<br>以下の手順にてエージェントのアクション アカウントをご確認が可能です。</p><ol><li>SCOM 管理コンソールを起動し、[管理] ペインを開きます。</li><li>左ペインの [プロファイル] をクリックします。</li><li>一覧から [既定のアクション アカウント] をダブルクリックします。</li><li>ウィザード画面上で、[次へ] をクリックします。</li><li>全般プロパティ画面にて [次へ] をクリックします。</li><li>実行アカウント画面に一覧から、問題が発生している SCOM 管理サーバー や SCOM エージェントに設定されているアカウント名を確認します。</li></ol><p>手順は以上です。</p><h2 id="アクション-アカウントとログオン-ログオフに使用しているアカウントが同じであることによる他の問題事例"><a href="#アクション-アカウントとログオン-ログオフに使用しているアカウントが同じであることによる他の問題事例" class="headerlink" title="アクション アカウントとログオン/ログオフに使用しているアカウントが同じであることによる他の問題事例"></a>アクション アカウントとログオン/ログオフに使用しているアカウントが同じであることによる他の問題事例</h2><p>事例：以下アカウントで指定しているユーザーが同じである場合<br>　・SCOM 管理サーバーの  MonitoringHost.exe のアクションアカウント<br>　・SCOM 管理サーバーにログインするアカウント</p><p>この場合、SCOM 管理サーバーの OS からログオフした際に SCOM 管理サーバーの  MonitoringHost.exe で監視している linux コンピューターがグレーアウトする事例がございます。<br>下図構成となるため、ログオフした際に MonitoringHost.exe が動作するために必要な情報（例えばレジストリキーに設定している値）などもログオフとともに参照できなくなり、linux コンピューターが監視不能状態となりグレーアウト状態になる場合があります。</p><p><a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-planning-agent-deployment?view=sc-om-2022&tabs=Windows#linuxunix-agent">Operations Manager エージェント</a><br><img src="/blog/SCOM/SCOM_highmemory_MonitoringHost/0101.png"><img src="https://github.com/jpsystemcenter/blog/assets/102792193/e34cc6c1-4230-4d3f-9cc6-40e1894a479f" alt="image"></p><p>上記事例もございますため、アクション アカウントとログオン/ログオフに使用しているアカウントが同じ場合はどちらかのアカウントを変更してくださいするようお願いいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以下、SCOM） が監視のために利用するプロセスである Mon</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
    <category term="MonitoringHost.exe" scheme="https://jpsystemcenter.github.io/blog/tags/MonitoringHost-exe/"/>
    
  </entry>
  
  <entry>
    <title>SCOM の 更新プログラムのロールアップの適用手順</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_Update_Rollup/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_Update_Rollup/</id>
    <published>2023-11-20T05:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.104Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>今回は、SCOM に更新プログラムのロールアップ (UR：Update Rollup) を適用する手順について説明します。<br><br></p><span id="more"></span><h2 id="更新プログラムのロールアップ-UR：Update-Rollup-について"><a href="#更新プログラムのロールアップ-UR：Update-Rollup-について" class="headerlink" title="更新プログラムのロールアップ (UR：Update Rollup) について"></a>更新プログラムのロールアップ (UR：Update Rollup) について</h2><p>本記事の公開日時点 (2023/11/20) でサポートが有効な System Center Operations Manager（以後 SCOM）には SCOM 2016, SCOM 2019, SCOM 2022 の 3つのバージョンがあります。<br>各々のバージョンの初期公開時のモジュールを一般公開版 (GA：General Availability) と呼びます。一般公開版のリリース後、機能追加や不具合修正、セキュリティ対策等の更新プログラムは、更新プログラムのロールアップ (UR：Update Rollup) として提供されます。そのため、SCOM を最新の状態に維持するためには、更新プログラムのロールアップを適用いただく必要があります。</p><p>各々のバージョンの 更新プログラムのロールアップのリリース状況は以下サイトをご参照ください。<br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/scom/release-build-versions?view=sc-om-2022">SCOM 2022： System Center Operations Manager のリリース ビルドのバージョン | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/scom/release-build-versions?view=sc-om-2019">SCOM 2019： System Center Operations Manager のリリース ビルドのバージョン | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/scom/release-build-versions?view=sc-om-2016">SCOM 2016： System Center Operations Manager のリリース ビルドのバージョン | Microsoft Learn</a></p><p>なお、セキュリティ対策以外の更新プログラム (機能追加や不具合修正) は、原則、メインストリーム サポート期間中 (SCOM 2022, SCOM 2019 <span style="color: red; ">※2023/11/20 時点</span>) の製品に対して提供されます。延長サポート期間中 (SCOM 2016 <span style="color: red; ">※2023/11/20 時点</span>) の製品には、セキュリティ対策の更新プログラムのみが提供されます。</p><p>各バージョンのサポート状況につきましては以下のサイトをご参照ください。<br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2022-operations-manager">System Center 2022 Operations Manager - Microsoft Lifecycle | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2019-operations-manager">System Center 2019 Operations Manager - Microsoft Lifecycle | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2016-operations-manager">System Center 2016 Operations Manager - Microsoft Lifecycle | Microsoft Learn</a><br>また、メインストリーム サポート期間や延長サポート期間の説明につきましては、<a href="https://learn.microsoft.com/ja-jp/lifecycle/policies/fixed">固定ライフサイクル ポリシーのサイト</a>をご参照ください。</p><h2 id="更新プログラムのロールアップ-UR：Update-Rollup-の適用手順"><a href="#更新プログラムのロールアップ-UR：Update-Rollup-の適用手順" class="headerlink" title="更新プログラムのロールアップ (UR：Update Rollup) の適用手順"></a>更新プログラムのロールアップ (UR：Update Rollup) の適用手順</h2><p>今回は、<b>SCOM 2022 に本記事の公開日時点で最新の UR2 を適用する手順</b>をご紹介します。<br>SCOM の更新プログラムのロールアップは累積型のため、順番に適用する必要はありません。常に最新の更新プログラムを適用できます。一般公開版の SCOM 2022 を導入し、更新プログラムのロールアップを適用したことがない場合でも、利用可能な最新の更新プログラム (今回の場合は UR2) を適用することができます。</p><p>UR の適用の際には、<a href="https://learn.microsoft.com/ja-jp/system-center/scom/release-build-versions?view=sc-om-2022#management-server-and-other-components">System Center Operations Manager のビルド バージョン</a> の表の KB 列のリンクをクリックして、最新の更新プログラム ロールアップのサイトに進みます。<br><img src="000.png"></p><p><a href="https://support.microsoft.com/kb/5031649">更新プログラム ロールアップのサイト(SCOM 2022 UR2)</a> には、更新プログラムの内容（機能追加、不具合修正、セキュリティ対策）とモジュールのダウンロード方法、インストール手順が記載されています。</p><hr><p><b>● ステップ１：モジュールをダウンロードする</b><br>① ～ ②のリンクからモジュールをダウンロードします。<br><img src="001.png"></p><p>① Operations Manager 更新プログラム パッケージを<a href="https://www.catalog.update.microsoft.com/Search.aspx?q=5031649">ダウンロード</a>します。<br><img src="002.png"></p><p>ダウンロードファイルしたファイルを展開します。</p><table border="1">    <tr>        <th style="background-color: royalblue; text-align: center; color: black;">対象</th>        <th style="background-color: royalblue; text-align: center; color: black;">ダウンロードファイル</th>        <th style="background-color: royalblue; text-align: center; color: black;">cab ファイル展開後のファイル</th>        <th style="background-color: royalblue; text-align: center; color: black;">備考</th>    </tr>    <tr style="font-size: 12px;">        <td>SCOM 管理サーバー</td>        <td>kb5031649-amd64-server_***.cab</td>        <td>KB5031649-amd64-Server.msp</td>        <td>簡略化された SCOM 管理サーバーの修正プログラムを<br>実行する場合は不要です。</td>    </tr>    <tr style="font-size: 12px;">        <td>SCOM 監査コレクション (ACS)</td>        <td>kb5031649-amd64-acs_***.cab</td>        <td>KB5031649-amd64-ACS.msp</td>        <td></td>    </tr>    <tr style="font-size: 12px;">        <td>Web コンソール</td>        <td>kb5031649-amd64-webconsole_***.cab</td>        <td>KB5031649-amd64-WebConsole.msp</td>        <td></td>    </tr>    <tr style="font-size: 12px;">        <td>SCOM ゲートウェイサーバー</td>        <td>kb5031649-amd64-gateway_***.cab</td>        <td>KB5031649-amd64-Gateway.msp</td>        <td></td>    </tr>    <tr style="font-size: 12px;">        <td>SCOM 管理コンソール</td>        <td>kb5031649-amd64-console_***.cab</td>        <td>KB5031649-amd64-Console.msp</td>        <td></td>    </tr>    <tr style="font-size: 12px;">        <td>レポート</td>        <td>kb5031649-amd64-reporting_***.cab</td>        <td>KB5031649-amd64-Reporting.msp</td>        <td></td>    </tr>    <tr style="font-size: 12px;">        <td>SCOM エージェント</td>        <td>kb5031649-amd64-agent_***.cab</td>        <td>KB5031649-amd64-Agent.msp</td>        <td>SCOM コンソールからアップデートも可能です。</td>    </tr></table><p>② 簡略化された SCOM 管理サーバーの修正プログラム (KB5031649-amd64-Server.exe) を<a href="https://download.microsoft.com/download/d/d/2/dd29ad67-a37e-42f8-9e02-50dd7dac7ec0/KB5031649-amd64-Server.exe">ダウンロード</a>します。</p><p><b>● ステップ２：コマンドプロンプトを管理者で起動して、以下の順でモジュールを実行します。</b><br>　※ コマンドプロンプトを管理者として起動 <img src="003.png"></p><p>【実行の順番】</p><ol><li>簡略化された SCOM 管理サーバーの修正プログラム KB5031649-amd64-Server.exe</li><li>監査コレクション用モジュール　　 KB5031649-amd64-ACS.msp</li><li>Web コンソール用モジュール　　　 KB5031649-amd64-WebConsole.msp</li><li>ゲートウェイサーバー用モジュール KB5031649-amd64-Gateway.msp</li><li>SCOM 管理コンソール用モジュール  KB5031649-amd64-Console.msp</li><li>レポート用モジュール　　　　　　 KB5031649-amd64-Reporting.msp</li><li>エージェント用モジュール　　　　 KB5031649-amd64-Agent.msp</li></ol><p>実行コマンド結果の画面ショットは以下の通りです。</p><ol><li><p>簡略化された SCOM 管理サーバーの修正プログラム (KB5031649-amd64-Server.exe)<br>※ 簡略化された SCOM 管理サーバーの修正プログラムが存在する場合は、本プログラムの使用を推奨します。SCOM 管理サーバー用モジュール (KB5031649-amd64-Server.msp) を用いてアップデートする場合、追加でデータベースの更新と管理パックの更新が必要になります。簡略化された SCOM 管理サーバーの修正プログラムは、これらの更新を一括で行うプログラムです。 <img src="004.png"><br>[Install] を実行します。　<img src="005.png"><br>  <img src="005_2.png"></p></li><li><p>監査コレクション用モジュール (KB5031649-amd64-ACS.mspe)<br><span style="color: red; ">※ 監査コレクションを導入していない SCOM 環境では不要です。</span> <img src="006.png">　<img src="007.png"></p></li><li><p>Web コンソール用モジュール (KB5031649-amd64-WebConsole.msp)<br><span style="color: red; ">※ Web コンソールを導入していない SCOM 環境では不要です。</span> <img src="008.png"></p></li><li><p>ゲートウェイサーバー用モジュール (KB5031649-amd64-Gateway.msp)<br><span style="color: red; ">※ SCOM ゲートウェイ サーバーで実行します。SCOM ゲートウェイ サーバーを導入していない SCOM 環境では不要です。</span> <img src="009.png"></p></li><li><p>SCOM 管理コンソール用モジュール (KB5031649-amd64-Console.msp)<br><span style="color: red; ">※ SCOM 管理サーバーと SCOM コンソールを導入した全てのサーバーで実行します。</span> <img src="010.png"></p></li><li><p>レポート用モジュール (KB5031649-amd64-Reporting.msp)<br><span style="color: red; ">※ レポート機能を導入していない SCOM 環境では不要です。</span> <img src="016.png"></p></li><li><p>エージェント用モジュール (KB5031649-amd64-Agent.msp)<br><span style="color: red; ">※ エージェントサーバーで実行します。</span> <img src="011.png"></p></li></ol><p>※ SCOM コンソールからプッシュインストールしていた場合は、SCOM コンソールから UR2 への更新が可能です。 <img src="012.png"></p><ol start="8"><li>UNIX および Linux 管理パックの更新<br>以下のサイトよりUNIX および Linux 管理パックをダウンロードして、SCOM にインポートします。<br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=104213">Download System Center 2022 Management Pack for UNIX and Linux Operating Systems from Official Microsoft Download Center</a><br><br>管理パックのインポート方法については以下のサポートブログもご参照ください。<br><a href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_ManagementPacks/">管理パック (MP) のインポートについて | Japan System Center Support Blog (jpsystemcenter.github.io)</a></li></ol><p><b>● ステップ３：適用状況を確認します。</b><br>SCOM 管理コンソールの管理画面の [Operations Manager 製品] 配下のメニューにて各モジュールのバージョンを確認できます。<br>SCOM 2022 UR2 のバージョンは<span style="color: red; "> [10.22.10610.0] </span>です。</p><p>■ SCOM 管理サーバー<br><img src="015.png"></p><p>■ SCOM 管理コンソール<br><img src="017.png"></p><p>■ Web コンソール<br><img src="013.png"></p><p>■ 監査コレクション<br><img src="014.png"> </p><p>■ レポート<br><img src="018.png"></p><hr><h2 id="UR-適用時の-OS-再起動の可能性について"><a href="#UR-適用時の-OS-再起動の可能性について" class="headerlink" title="UR 適用時の OS 再起動の可能性について"></a>UR 適用時の OS 再起動の可能性について</h2><p>UR の適用では、基本的には SCOM 管理サーバーや管理対象のサーバーの再起動は発生いたしません。ユーザー様からの事例報告でも OS 再起動はほとんど確認しておりません。<br>ただし、仕組み上は OS 再起動が発生する可能性があります。</p><p>UR のモジュールは、Windows インストーラ形式のファイル ( msp/msi ファイル) にて提供されます。msp/msi インストーラを使用したインストール/アンインストールの挙動として、実行時に置き換えが必要なファイル等が他プロセスによりハンドルを保持されていて置き換えできない場合、一度 OS 再起動を試行してファイルの置き換えを実施します。 そのため、この仕様にあたる状況となった場合に OS 再起動が発生する可能性があります。<br>下記公開情報に記載の通り、基本的にはアプリケーション単位でシャットダウンして、システム全体 (OS) のシャットダウンにつながらないような考慮になっておりますが、可能性という意味では発生し得る点をご認識ください。<br>　参考：再起動マネージャーでの Windows インストーラーの使用<br>　<a href="https://learn.microsoft.com/ja-jp/windows/win32/msi/using-windows-installer-with-restart-manager">https://learn.microsoft.com/ja-jp/windows/win32/msi/using-windows-installer-with-restart-manager</a></p><hr><p>SCOM の UR 適用手順は以上の通りです。<br>本手順を参考に SCOM を常に最新の状態にてご利用いただけますと幸いです</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;今回は、SCOM に更新プログラムのロールアップ (UR：Update Rollup) を適用する手順について説明します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM サーバーの構成" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E6%A7%8B%E6%88%90/"/>
    
    <category term="更新プログラム ロールアップ" scheme="https://jpsystemcenter.github.io/blog/tags/%E6%9B%B4%E6%96%B0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0-%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97/"/>
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="インストール" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB/"/>
    
    <category term="アップグレード" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM の 更新プログラムのロールアップの適用手順</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Update_Rollup/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Update_Rollup/</id>
    <published>2023-11-20T04:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.136Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>今回は、SCVMM に更新プログラムのロールアップ (UR：Update Rollup) を適用する手順について説明します。<br><br></p><span id="more"></span><h2 id="更新プログラムのロールアップ-UR：Update-Rollup-について"><a href="#更新プログラムのロールアップ-UR：Update-Rollup-について" class="headerlink" title="更新プログラムのロールアップ (UR：Update Rollup) について"></a>更新プログラムのロールアップ (UR：Update Rollup) について</h2><p>本記事の公開日時点 (2023/11/20) でサポートが有効な System Center Virtual Machine Manager（以後 SCVMM）には SCVMM 2016, SCVMM 2019, SCVMM 2022 の 3つのバージョンがあります。<br>各々のバージョンの初期公開時のモジュールを一般公開版 (GA：General Availability) と呼びます。一般公開版のリリース後、機能追加や不具合修正、セキュリティ対策等の更新プログラムは、更新プログラムのロールアップ (UR：Update Rollup) として提供されます。そのため、SCVMM を最新の状態に維持するためには、更新プログラムのロールアップを適用いただく必要があります。</p><p>各々のバージョンの 更新プログラムのロールアップのリリース状況は以下サイトをご参照ください。<br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/release-build-versions?view=sc-vmm-2022">SCVMM 2022： System Center Virtual Machine Managerのビルド バージョンをリリースする | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/release-build-versions?view=sc-vmm-2019">SCVMM 2019： System Center Virtual Machine Managerのビルド バージョンをリリースする | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/release-build-versions?view=sc-vmm-2016">SCVMM 2016： System Center Virtual Machine Managerのビルド バージョンをリリースする | Microsoft Learn</a></p><p>なお、セキュリティ対策以外の更新プログラム (機能追加や不具合修正) は、原則、メインストリーム サポート期間中 (SCVMM 2022, SCVMM 2019 <span style="color: red; ">※2023/11/20 時点</span>) の製品に対して提供されます。延長サポート期間中 (SCVMM 2016 <span style="color: red; ">※2023/11/20 時点</span>) の製品には、セキュリティ対策の更新プログラムのみが提供されます。</p><p>各バージョンのサポート状況につきましては以下のサイトをご参照ください。<br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2022-virtual-machine-manager">System Center 2022 Virtual Machine Manager - Microsoft Lifecycle | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2019-virtual-machine-manager">System Center 2019 Virtual Machine Manager - Microsoft Lifecycle | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2016-virtual-machine-manager">System Center 2016 Virtual Machine Manager - Microsoft Lifecycle | Microsoft Learn</a><br>また、メインストリーム サポート期間や延長サポート期間の説明につきましては、<a href="https://learn.microsoft.com/ja-jp/lifecycle/policies/fixed">固定ライフサイクル ポリシーのサイト</a>をご参照ください。</p><h2 id="更新プログラムのロールアップ-UR：Update-Rollup-の適用手順"><a href="#更新プログラムのロールアップ-UR：Update-Rollup-の適用手順" class="headerlink" title="更新プログラムのロールアップ (UR：Update Rollup) の適用手順"></a>更新プログラムのロールアップ (UR：Update Rollup) の適用手順</h2><p>今回は、<b>SCVMM 2022 に本記事の公開日時点で最新の UR2 を適用する手順</b>をご紹介します。<br>SCVMM の更新プログラムのロールアップは累積型のため、順番に適用する必要はありません。常に最新の更新プログラムを適用できます。一般公開版の SCVMM 2022 を導入し、更新プログラムのロールアップを適用したことがない場合でも、利用可能な最新の更新プログラム (今回の場合は UR2) を適用することができます。</p><p>UR の適用の際には、<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/release-build-versions?view=sc-vmm-2022#virtual-machine-manager-2022-build-versions">Virtual Machine Manager 2022 ビルド バージョン</a> の表の KB 列のリンクをクリックして、最新の更新プログラム ロールアップのサイトに進みます。<br><img src="001.png"></p><p><a href="https://support.microsoft.com/kb/5032369">更新プログラム ロールアップのサイト(SCVMM 2022 UR2)</a> には、更新プログラムの内容（機能追加、不具合修正、セキュリティ対策）とモジュールのダウンロード方法、インストール手順が記載されています。</p><hr><p><b>● ステップ１：モジュールをダウンロードする</b><br>① ～ ③の 3つのモジュールをダウンロードします。<br><img src="002.png"></p><p>① Virtual Machine Manager サーバー更新プログラム パッケージ (<a href="https://www.catalog.update.microsoft.com/Search.aspx?q=5032369">kb5032369_vmmserver_amd64_***.cab</a>) をダウンロードします。<br>ダウンロードファイルしたファイルを展開します。※展開後のファイル：kb5032369_vmmserver_amd64.msp<br><img src="003.png"></p><p>② 管理者コンソールの更新プログラム パッケージ (<a href="https://www.catalog.update.microsoft.com/Search.aspx?q=5032370">kb5032370_adminconsole_amd64_***.cab</a>) をダウンロードします。<br>ダウンロードファイルしたファイルを展開します。※展開後のファイル：kb5032370_AdminConsole_amd64.msp<br><img src="004.png"></p><p>③ ゲスト エージェントの更新プログラム パッケージ (<a href="https://www.catalog.update.microsoft.com/Search.aspx?q=5032371">kb5032371_vmmguestagent_amd64_***.cab</a>) をダウンロードします。<br>ダウンロードファイルしたファイルを展開します。※展開後のファイル：kb5032371_vmmGuestAgent_amd64.msp<br><img src="005.png"></p><p><b>● ステップ２：コマンドプロンプトを管理者で起動して、以下の順でモジュールを実行します。</b><br>　※ コマンドプロンプトを管理者として起動 <img src="014.png"></p><p>【実行の順番】</p><ol><li>SCVMM 管理サーバー用モジュール kb5032369_vmmserver_amd64.msp</li><li>SCVMM コンソール用モジュール 　kb5032370_AdminConsole_amd64.msp</li><li>SCVMM エージェント用モジュール kb5032371_vmmGuestAgent_amd64.msp</li></ol><p>実行コマンド結果の画面ショットは以下の通りです。</p><ol><li><p>SCVMM 管理サーバー用モジュール (kb5032369_vmmserver_amd64.msp)<br>　＞ msiexec.exe /update kb5032369_vmmserver_amd64.msp <img src="006.png"></p></li><li><p>SCVMM コンソール用モジュール (kb5032370_AdminConsole_amd64.msp)<br>　<span style="color: red; ">※ SCVMM 管理サーバーのほか、SCVMM コンソールを導入した全てのサーバーで実行します。</span><br>　＞ msiexec.exe /update kb5032370_AdminConsole_amd64.msp <img src="007.png"></p></li><li><p>SCVMM エージェント用モジュール (kb5032371_vmmGuestAgent_amd64.msp)<br>　<span style="color: red; ">※ エージェントサーバーで実行します。</span><br>　＞ msiexec.exe /update kb5032371_vmmGuestAgent_amd64.msp <img src="008.png"></p></li></ol><p>　※ SCVMM エージェントの更新は、モジュールを実行する代わりにSCVMM コンソールから UR2 へ更新することも可能です。 <img src="009.png"></p><p><b>● ステップ３：適用状況を確認します。</b><br>SCVMM コンソールから各コンポーネントのバージョンを確認することができます。<br>SCVMM 2022 UR2 のバージョンは<span style="color: red; "> [10.22.1711.0] </span>です。</p><p>■ SCVMM コンソール <img src="010.png"></p><p>■ SCVMM 管理サーバー <img src="011.png"></p><p>■ SCVMM エージェント <img src="012.png"></p><hr><h2 id="高可用性-VMM-管理サーバーを構成している場合"><a href="#高可用性-VMM-管理サーバーを構成している場合" class="headerlink" title="高可用性 VMM 管理サーバーを構成している場合"></a>高可用性 VMM 管理サーバーを構成している場合</h2><p>複数台の SCVMM 管理サーバーで高可用性 VMM 管理サーバーを構成している場合、全ての SCVMM 管理サーバーで SCVMM 管理サーバー用モジュール と SCVMM コンソール用モジュールを適用する必要があります。適用の順番は、待機系の SCVMM サーバーから適用します。</p><p>【実行の順番】</p><ol><li>待機系の SCVMM 管理サーバーにて SCVMM 管理サーバー用モジュール と SCVMM コンソール用モジュールを適用</li><li>フェールオーバー クラスターマネージャーで稼働系を待機系に切り替え （<span style="color: red; ">※1</span>）</li><li>待機系に切り替わった元稼働系サーバーに SCVMM 管理サーバー用モジュール と SCVMM コンソール用モジュールを適用</li></ol><p><span style="color: red; font-weight: bold;">※1 SCVMM の稼働系の切り替え方法</span><br>SCVMM の稼働系はフェールオーバー クラスターマネージャーの役割画面で移動することで切り替えることができます。<br><img src="013.png"><br><br></p><h2 id="UR-適用時の-OS-再起動の可能性について"><a href="#UR-適用時の-OS-再起動の可能性について" class="headerlink" title="UR 適用時の OS 再起動の可能性について"></a>UR 適用時の OS 再起動の可能性について</h2><p>UR の適用では、基本的には SCVMM 管理サーバーや管理対象のホストサーバーの再起動は発生いたしません。ユーザー様からの事例報告でも OS 再起動はほとんど確認しておりません。<br>ただし、仕組み上は OS 再起動が発生する可能性があります。</p><p>UR のモジュールは、Windows インストーラ形式のファイル ( msp/msi ファイル) にて提供されます。msp/msi インストーラを使用したインストール/アンインストールの挙動として、実行時に置き換えが必要なファイル等が他プロセスによりハンドルを保持されていて置き換えできない場合、一度 OS 再起動を試行してファイルの置き換えを実施します。 そのため、この仕様にあたる状況となった場合に OS 再起動が発生する可能性があります。<br>下記公開情報に記載の通り、基本的にはアプリケーション単位でシャットダウンして、システム全体 (OS) のシャットダウンにつながらないような考慮になっておりますが、可能性という意味では発生し得る点をご認識ください。<br>　参考：再起動マネージャーでの Windows インストーラーの使用<br>　<a href="https://learn.microsoft.com/ja-jp/windows/win32/msi/using-windows-installer-with-restart-manager">https://learn.microsoft.com/ja-jp/windows/win32/msi/using-windows-installer-with-restart-manager</a></p><hr><p>SCVMM の UR 適用手順は以上の通りです。<br>本手順を参考に SCVMM を常に最新の状態にてご利用いただけますと幸いです</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;今回は、SCVMM に更新プログラムのロールアップ (UR：Update Rollup) を適用する手順について説明します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="更新プログラム ロールアップ" scheme="https://jpsystemcenter.github.io/blog/tags/%E6%9B%B4%E6%96%B0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0-%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97/"/>
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="インストール" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB/"/>
    
    <category term="アップグレード" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
  </entry>
  
  <entry>
    <title>管理パック (MP) のインポートについて</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_ManagementPacks/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_ManagementPacks/</id>
    <published>2023-09-22T09:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.096Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。</p><p>今回は、System Center Operations Manager (SCOM) に管理パック (MP：Management Pack) をインポートすることにより監視機能を拡充する手順についてご紹介します。<br><br></p><span id="more"></span><h2 id="管理パック-MP-Management-Pack-導入による監視機能の追加について"><a href="#管理パック-MP-Management-Pack-導入による監視機能の追加について" class="headerlink" title="管理パック (MP:Management Pack) 導入による監視機能の追加について"></a>管理パック (MP:Management Pack) 導入による監視機能の追加について</h2><p>以前のブログ (<a href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_Install_Manual/">SCOM 管理サーバー構築手順 ～ 全画面ショット付き | Japan System Center Support Blog</a>) では SCOM 管理サーバー環境の構築手順を紹介しました。SCOM 管理サーバー環境の構築完了後、エージェントの展開などの前にまず最初に行う必要がある作業が管理パックの導入です。</p><p>SCOM には OS 種別やソフトウェアごとに『管理パック』というモジュールが存在していて、管理パックを導入することで初めて対象システムの監視が有効になります。<br><br><b>管理パックの一覧サイト</b> <a href="https://social.technet.microsoft.com/wiki/contents/articles/16174.microsoft-management-packs.aspx">Microsoft Management Packs - TechNet Articles - United States - TechNet Wiki</a><br><img src="001.png" width="400"></p><p>代表的な管理パックには以下のようなものがあります。<br>【管理パックの例】<br>・Windows Server の監視用管理パック　　　　 ：System Center Management Pack for Windows Server Operating System<br>・Microsoft SQL Server の監視用管理パック　　：Microsoft System Center MP for SQL Server<br>・Microsoft Adtive Directory の監視要管理パック：Microsoft System Center Management Pack for ADDS</p><p>SCOM 管理サーバーの構築時に導入される管理パックは、SCOM のサーバー機能の動作に必要な最小限の管理パックに限られていて、上に記載したような代表的な管理パックについても導入されていません。<br>　※SCOM サーバーの構築時にインストールされる管理パックについては、以下のサイトをご参照ください。<br>　　<a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-mp-installed-during-seutp?view=sc-om-2022">Operations Manager と一緒にインストールされる管理パック | Microsoft Learn</a></p><p>つまり、SCOM で適切な監視を開始するためには、対応する管理パックを導入する必要があります。</p><p>管理パックの導入は、以下の手順で進めます。<br>　① <a href="#%E2%91%A0-%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99%EF%BC%91%EF%BC%9AOperationsManager-%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E6%8B%A1%E5%BC%B5">事前準備１：OperationsManager データベースのファイルサイズの拡張</a><br>　② <a href="#%E2%91%A1-%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99%EF%BC%92%EF%BC%9A%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E7%94%A8%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4-%E2%80%BB%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%81%BF">事前準備２：レポート機能用データベースの設定変更 (※レポート機能をインストールした場合のみ)</a><br>　③ <a href="#%E2%91%A2-%E7%AE%A1%E7%90%86%E3%83%91%E3%83%83%E3%82%AF%E3%81%AE%E5%B0%8E%E5%85%A5">管理パックの導入</a></p><h2 id="①-事前準備１：OperationsManager-データベースのファイルサイズの拡張"><a href="#①-事前準備１：OperationsManager-データベースのファイルサイズの拡張" class="headerlink" title="① 事前準備１：OperationsManager データベースのファイルサイズの拡張"></a>① 事前準備１：OperationsManager データベースのファイルサイズの拡張</h2><p>SCOM 管理サーバーのインストール時に OperationsManager と OperationsManagerDW の２つのデータベースが作成されます。<br>これらのデータベースは、インストール ウィザードに沿ってインストールを行うと、既定で以下の設定になります。</p><table border="1">    <tr>        <th style="background-color: royalblue; text-align: center; color: black;">データベース名</th>        <th style="background-color: royalblue; text-align: center; color: black;">ファイル</th>        <th style="background-color: royalblue; text-align: center; color: black;">初期サイズ (MB)</th>        <th style="background-color: royalblue; text-align: center; color: black;">自動拡張</th>        <th style="background-color: royalblue; text-align: center; color: black;">用途</th>    </tr>    <tr style="font-size: 12px;">        <td rowspan="2">OperationsManager</td>        <td>OperationsManager.mdf</td>        <td style="background-color: yellow; text-align: center;"><b>1,000</b></td>        <td style="background-color: yellow; text-align: center;"><b>無し</b></td>        <td rowspan="2">主に短期データを保管するデータベース<br>        <a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2022#operations-manager-database">Operations Manager データベース | Microsoft Learn</a></td>    </tr>    <tr style="font-size: 12px;">        <td>OperationsManager.ldf</td>        <td style="background-color: yellow; text-align: center;"><b>500</b></td>        <td style="background-color: yellow; text-align: center;"><b>無し</b></td>    </tr>    <tr style="font-size: 12px;">        <td rowspan="2">OperationsManagerDW</td>        <td>OperationsManagerDW.mdf</td>        <td style="text-align: center;">1,000</td>        <td>あり。10 MB 単位</td>        <td rowspan="2">主に長期データを保管するデータベース<br>        <a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2022#operations-manager-data-warehouse-database">Operations Manager データウェアハウス データベース | Microsoft Learn</a></td>    </tr>    <tr style="font-size: 12px;">        <td>OperationsManagerDW.ldf</td>        <td style="text-align: center;">500</td>        <td>あり。10 MB 単位</td>    </tr></table><p>SCOM に管理パックを導入すると、管理パックに包含されるモジュール (監視を定義する xml ファイルなど) がデータベースに保管されます。大部分の管理パックは数 MB 程度以内のファイルサイズですが、中には 100 MB を超える管理パックも存在します。<br>[OperationsManager] データベースは <b>自動拡張</b>が <b>[なし]</b> の設定のため、多数の管理パックを導入する場合、データベースの使用量が増加してファイルサイズを圧迫することになります。そのため、管理パックの導入の前に予めデータベースのファイルサイズを拡大しておく必要があります。</p><p>■ データベースファイルの拡張手順<br>ファイルサイズの拡張は、SQL Server Management Studio から実施できます。<br><br> 1. SQL Server Management Studio にて、データベース管理者アカウントで SCOM データベースに接続します。<br> 2. [データベース] -&gt; [OperationsManager] を選択して、右クリックメニューの [プロパティ] をクリックします。<br> 3. データベースのプロパティ画面にて [File] を開きます。<br> 4. サイズを拡大して、OK ボタンをクリックします。<br> <img src="002.png"></p><p>※ 拡張するサイズの目安について<br>データベースサーバーのディスクサイズに余裕がある場合は OperationsManager.mdf を 10,000 MB、OperationsManager.ldf を 5,000 MB程度に拡大することを推奨します。このサイズであれば、将来に渡って管理パックによるディスクサイズの圧迫は懸念する必要がなくなります。ただし、[OperationsManager] データベースには、管理パックデータ以外にもエージェントが収集した短期データなどが保管されますので、実際には環境ごとにチューニングが必要です。</p><h2 id="②-事前準備２：レポート機能用データベースの設定変更-※レポート機能をインストールした場合のみ"><a href="#②-事前準備２：レポート機能用データベースの設定変更-※レポート機能をインストールした場合のみ" class="headerlink" title="② 事前準備２：レポート機能用データベースの設定変更 (※レポート機能をインストールした場合のみ)"></a>② 事前準備２：レポート機能用データベースの設定変更 (※レポート機能をインストールした場合のみ)</h2><p>レポート機能をインストールした場合、管理パックに含まれるレポートの定義情報がレポートデータベースに展開されます。SQL Server レポーティングサービスの既定の設定を変更して、正しくコンテンツが展開できるようにする必要があります。<br>　※本設定については、以下のユーザーマニュアルサイトもご参照ください。<br>　　<a href="https://learn.microsoft.com/ja-jp/troubleshoot/system-center/scom/cannot-deploy-operations-manager-reports">Operations Manager レポートの展開に失敗する - Operations Manager | Microsoft Learn</a></p><p>レポートデータベースの設定変更の手順は以下の通りです。<br> 1. SQL Server Management Studio (SSMS) を起動し、SCOM が使用するレポートサーバーインスタンスに接続します。<br>　- サーバーの種類: Reporting Services<br>　- サーバー名: &lt;SSRS インスタンスが存在するサーバー名&gt;&lt;SSRS インスタンス名&gt;<br>　※ SSRS の既定のインスタンス名は “SSRS” です。SSRS インスタンス名は、[スタート] メニューより<br>　　[Microsoft SQL Server Reporting Services] -&gt; [Report Server Configuration Manager] を開き<br>　　[レポートサーバーの構成の接続] の [レポート サーバー インスタンス] の名称にて確認できます。<br>　- 認証、ユーザー名、パスワード: SSRS 側で設定いただいた認証方式およびパスワード<br> <img src="003.png"><br> 2. レポートサーバー名を右クリックし、[ プロパティ] を選択して、[ 詳細設定] を選択します。<br> 3. AllowedResourceExtensionsForUploadの設定を見つけ、 設定値に<b> *.* </b>を入力して、[OK] をクリックします。<br>【設定箇所】<br> <img src="004.png">【変更後の値】<br> <img src="005.png"><br> 4. SSRS を以下手順で再起動します。<br>　- Reporting Services 構成ツールを起動して、レポート サーバーに接続します。<br>　- [レポート サーバーの状態] ページで [停止] をクリックし、その後 [開始] を選択します。</p><h2 id="③-管理パックの導入"><a href="#③-管理パックの導入" class="headerlink" title="③ 管理パックの導入"></a>③ 管理パックの導入</h2><p>事前準備が完了したら、いよいよ管理パックの導入です。<br>管理パックの導入方法には、３つの方法があります。</p><p>　<a href="#link1">１）SCOM 管理コンソールの [更新プログラムと推奨機能]  にて推奨管理パックを導入</a><br>　<a href="#link2">２）SCOM 管理コンソールにて、カタログから管理パックをダウンロードして導入</a><br>　<a href="#link3">３）管理パック一覧サイトから選択した管理パックを導入</a></p><p>今回は、基本的な管理パックを [更新プログラムと推奨機能] にて導入して、追加の管理パックをカタログからダウンロードして導入した後、最後に一覧サイトからダウンロードした管理パックを追加導入するシナリオで手順を説明します。</p><div id="link1"><b>１）SCOM 管理コンソールの [更新プログラムと推奨機能]  にて推奨管理パックを導入</b></div>SCOM 管理サーバーの構築の後、たくさん存在する管理パックの中からどの管理パックの導入から開始すべきかが分からない場合、最も簡易的に進められる方法です。手順は以下の通りです。<ol><li>SCOM コンソールにログインして、画面左下ペインの [管理] をクリックして、[管理] 画面を開きます。</li><li> [管理] -&gt; [管理パック] -&gt; [更新プログラムと推奨機能] をクリックします。</li><li>特定の管理パックを選択して [管理パックを取得] をクリックするか、[すべての管理パックを取得] をクリックします。<br>今回の例では [すべての管理パックを取得] をクリックしました。<br><img src="006.png"></li><li>[管理パックのインポート] 画面にて [インストール] ボタンをクリックして、管理パックをインポートします。<br></li></ol><p>※ 注意事項<br> ① 管理パックの中には、日本語の言語パックが存在するものがありますが、[更新プログラムと推奨機能] では言語パックは選択されません。日本語の言語パックが必要な場合は、あとで追加で導入する必要があります。<br> ② [更新プログラムと推奨機能] では、最初、多数の管理パックが表示されます。管理パックには依存関係 (導入の順番) が存在するものがあるため、一部の管理パックの導入が失敗することがありますが、失敗した場合は、再度、[すべての管理パックを取得] を行うことで、依存関係を満たした管理パックの導入が成功するようになりますので、何度か本作業を繰り返してください。<br> <img src="007.png"></p><div id="link2"><b>２）SCOM 管理コンソールにて、カタログから管理パックをダウンロードして導入</b></div>[更新プログラムと推奨機能] に含まれる管理パックを導入することで、Windows Server や Unix/Linux サーバーの基本的な監視は可能になります。一方で、Microsoft SQL Server や Active Directory などのソフトウェア用の管理パックは [更新プログラムと推奨機能] には含まれておらず、相変わらず監視できません。また、[更新プログラムと推奨機能] に含まれない言語パックも未導入です。<p>これらの管理パックは、Microsoft のカタログサイトから取得して導入することができます。</p><p>手順は以下の通りです。<br> 1. SCOM コンソールにログインして、画面左下ペインの [管理] をクリックして、[管理] 画面を開きます。<br> 2. 右クリックメニューにて [管理パックのインポート] をクリックします。<br> <img src="008.png"><br> 3. [管理パックのインポート] 画面にて [追加] -&gt; [カタログから追加する] をクリックします。<br> <img src="009.png"><br> 4. [検索] を実行することでカタログからインポート可能な管理パックが表示されます。<br>　必要な管理パックを選択して [追加] ボタンをクリックします。</p><p>　例１）Active Directory Domain Service の管理パック<br>　　[Windows Server] - [Active Directory Domain Services 2016 and above]<br> <img src="010.png"><br>　例２）Windows Server 1026 and above 用の日本語言語パック<br>　　[Windows Server] - [Core OS 2016 and above] - [Japanese]<br> <img src="011.png"><br> 5. 管理パックの追加が完了したら [OK] ボタン -&gt; [インストール] ボタンをクリックして導入します。<br> <img src="012.png"></p><div id="link3"><b>３）管理パック一覧サイトから選択した管理パックを導入</b></div>SCOM 管理サーバーがインターネット接続できない場合や Microsoft のカタログサイトから取得できない管理パックを導入する場合、管理パックをローカルディスクにコピーして、ディスクから追加することができます。<p>ここでは、SQL Server の管理パックの導入を例に説明します。</p><ol><li>管理パックの一覧サイト (<a href="https://social.technet.microsoft.com/wiki/contents/articles/16174.microsoft-management-packs.aspx">Microsoft Management Packs - TechNet Articles - United States (English) - TechNet Wiki</a>) にアクセスします。</li><li>SQL Server 用管理パックのリンク (<a href="https://www.microsoft.com/en-us/download/details.aspx?id=56203">Download Microsoft System Center MP for SQL Server from Official Microsoft Download Center</a>) をクリックします。<br><img src="013.png"></li><li>[Download] をクリックします。<img src="021.png" width="500"></li><li>必要なファイルを選択して [Download] をクリックします。<br><span style="color: red;">※ 重要<br>[SQLServerMPWorkflowList.pdf] は、SQL Server 用管理パックのマニュアルです。管理パックの導入手順、システム要件、サポート対象、含まれるルールやモニター、ビューなどの情報を確認できます。多くの管理パックは、ダウンロードページにてマニュアルを取得することができます。</span><br><img src="014.png"></li><li>SCOM 管理サーバー内に msi ファイルをコピーして、管理者で実行します。<br>ローカルディスクに管理パック ファイルが解凍されます。<br>例）SQLServerMP.Windows.msi を実行して解凍した管理パックファイル<br><img src="015.png"></li><li>SCOM コンソールにログインして、画面左下ペインの [管理] をクリックして、[管理] 画面を開きます。</li><li>右クリックメニューにて [管理パックのインポート] をクリックします。</li><li>[管理パックのインポート] 画面にて [追加] -&gt; [ディスクから追加する] をクリックします。<br><img src="016.png"></li><li>解凍した管理パックファイルをすべて選択して [インストール] ボタンをクリックします。<br><img src="017.png"></li></ol><br>以上により管理パックの導入作業は完了です。<h2 id="管理パックの導入確認"><a href="#管理パックの導入確認" class="headerlink" title="管理パックの導入確認"></a>管理パックの導入確認</h2><p>管理パックの導入が完了すると、モニターやルールに該当する OS やソフトウェアの設定が追加されたことが確認できます。<br> 例）モニター画面：Active Diretory 監視用のモニター<br> <img src="018.png"><br>収集したデータを確認するためのビューが追加されたことが確認できます。<br> 例）監視画面：Active Diretory に関する収集データを確認するビュー<br> <img src="019.png"><br>レポートが追加されたことも確認できます。<br> 例）レポート画面：Active Diretory に関する収集データを確認するレポート<br> <img src="020.png"></p><p>以上により、監視の準備が完了しましたので、監視対象サーバーにエージェントを展開して、SCOM による監視ができるようになります。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;/p&gt;
&lt;p&gt;今回は、System Center Operations Manager (SCOM) に管理パック (MP：Management Pack) をインポートすることにより監視機能を拡充する手順についてご紹介します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="インストール" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB/"/>
    
  </entry>
  
  <entry>
    <title>SCOM の各種キャッシュクリアの手順</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_CacheClear/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_CacheClear/</id>
    <published>2023-08-02T08:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.080Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>今回は、System Center Operations Manager (SCOM) が保持する各種のキャッシュデータを必要に応じてクリアする手順についてご紹介いたします。<br><br></p><span id="more"></span><h2 id="SCOM-が保持するキャッシュについて"><a href="#SCOM-が保持するキャッシュについて" class="headerlink" title="SCOM が保持するキャッシュについて"></a>SCOM が保持するキャッシュについて</h2><p>SCOM は、各コンポーネントの基本的な動作、コンポーネント間のデータの安定的な引き渡し、場合により高速処理のためにキャッシュを保持します。<br>キャッシュは、以下のコンポーネントに存在します。<br>　① SCOM エージェント　　：<a href="#%E2%91%A0-SCOM-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%AF%E3%83%AA%E3%82%A2%E6%89%8B%E9%A0%86">キャッシュクリア手順</a><br>　② SCOM 管理サーバー　　：<a href="#%E2%91%A1-SCOM-%E7%AE%A1%E7%90%86%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%AF%E3%83%AA%E3%82%A2%E6%89%8B%E9%A0%86">キャッシュクリア手順</a><br>　③ SCOM 管理コンソール　：<a href="#%E2%91%A2-SCOM-%E7%AE%A1%E7%90%86%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%AF%E3%83%AA%E3%82%A2%E6%89%8B%E9%A0%86">キャッシュクリア手順</a></p><p>サーバーのメンテナンス作業等で OS 再起動を繰り返した後や、SCOM 管理サーバーと断続的な通信断が発生した後などに、稀にキャッシュ データに不整合が発生することがあります。<br>① や ② のキャッシュに不整合が発生すると、起動中のサーバーが SCOM では管理不可と表示されたり、監視設定の通りにエージェントが動作しないことがあります。<br>③ のキャッシュに不整合が発生すると、削除したアラートが残存して表示されたり、ビューの情報が適切に更新されないことがあります。<br>そのような場合、キャッシュをクリアすることで事象を解消することができます。<br>以降の章にキャッシュクリアの手順を記載しましたので、相当する事象が発生した際にはキャッシュクリアを実施ください。</p><p>　ご参考：<a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-clear-healthservice-cache?view=sc-om-2022">キャッシュをクリアする方法とタイミング | Microsoft Learn</a></p><p><strong>【SCOM のキャッシュの概要図】</strong><br><img src="001.png"></p><h2 id="①-SCOM-エージェントのキャッシュクリア手順"><a href="#①-SCOM-エージェントのキャッシュクリア手順" class="headerlink" title="① SCOM エージェントのキャッシュクリア手順"></a>① SCOM エージェントのキャッシュクリア手順</h2><p>【手順】<br>1. SCOM エージェントサーバーにコンピューターの管理者権限を持つユーザーでログオンします。<br>2. “Microsoft Monitoring Agent” サービスを停止します。<br>　手順：タスクマネージャーを開き、[サービス] タブより [名前] が [HealthService] の行を右クリックし、[停止] をクリックします。<br>3. 以下のフォルダを開きます。<br>　C:\Program Files\Microsoft Monitoring Agent\Agent\Health Service State<br>　(※) SCOM エージェントのインストール先を変更している場合には、適切なフォルダを開いてください。<br>4. フォルダ内のすべてのファイルとフォルダを削除します。<br>5. 停止していた “Microsoft Monitoring Agent” サービスを再起動します。<br>　手順：タスクマネージャーを開き、[サービス] タブより [名前] が [HealthService] の行を右クリックし、[開始] をクリックします。</p><p>【作業影響】<br>・サービスを止めている間、SCOM エージェントの監視機能（性能情報収集、SCOM 管理サーバーへのデータ送信など）は動作しません。<br>・3. の手順で削除したフォルダは、5. の手順実施後に再生成されます。</p><h2 id="②-SCOM-管理サーバーのキャッシュクリア手順"><a href="#②-SCOM-管理サーバーのキャッシュクリア手順" class="headerlink" title="② SCOM 管理サーバーのキャッシュクリア手順"></a>② SCOM 管理サーバーのキャッシュクリア手順</h2><p>【手順】<br>1. SCOM 管理サーバーに、管理者権限のあるユーザーでログインします。<br>2. 下記のサービスを、この順序で停止します。<br>　2-1. Microsoft Monitoring Agent<br>　2-2. System Center Management Configuration (<span style="color: red; ">※1</span>)<br>　2-3. System Center Data Access Service<br>3. 以下のフォルダを開きます。<br>　C:\Program Files\Microsoft System Center\Operations Manager\Server\Health Service State<br>　(※) SCOM のインストール先を変更している場合には、適切なフォルダを開いてください。<br>4. フォルダ内のすべてのファイルとフォルダを削除します。<br>5. 下記のサービスを、この順序で開始します。<br>　5-1. System Center Data Access Service<br>　5-2. System Center Management Configuration (<span style="color: red; ">※1</span>)<br>　5-3. Microsoft Monitoring Agent<br><span style="color: red; ">※1 日本語環境の SCOM 2022 では、サービス名は “System Center 管理構成” と表記されます。</span></p><p>【作業影響】<br>・サービスを止めている間、SCOM 管理サーバーの監視機能（アラート発砲やメール通知、SCOM コンソールの利用など）は動作しません。<br>・SCOM エージェントが収集している情報は、サービス起動後にSCOM 管理サーバーに連携されます。<br>・「Health Service State」フォルダにキャッシュされている一時情報を削除するため、エージェントから連携されたパフォーマンスデータなどが 1 回分程度 欠損する可能性がございます。<br>・3. の手順で削除したフォルダは、5-3. の手順実施後に再生成されます。</p><h2 id="③-SCOM-管理コンソールのキャッシュクリア手順"><a href="#③-SCOM-管理コンソールのキャッシュクリア手順" class="headerlink" title="③ SCOM 管理コンソールのキャッシュクリア手順"></a>③ SCOM 管理コンソールのキャッシュクリア手順</h2><p>【手順】<br>1. SCOM コンソールを閉じます。<br>2. 管理者権限にてコマンドプロンプトを実行し、以下のコマンドにてキャッシュクリアを実行します。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">　<span class="built_in">cd</span> &quot;C:\Program Files\Microsoft System Center\Operations Manager\Console&quot;</span><br><span class="line">　Microsoft.EnterpriseManagement.Monitoring.Console.exe /Clearcache</span><br></pre></td></tr></table></figure><p>※ SCOM のインストール先を変更している場合は、cd で移動するパスを変更して実施して下さい。<br>3. 上記コマンド実行後、コンソールが開きますので、あらためてログインします。</p><p>【作業影響】<br>特に無し。</p><hr><h2 id="●よくあるお問い合わせ-作業影響について"><a href="#●よくあるお問い合わせ-作業影響について" class="headerlink" title="●よくあるお問い合わせ (作業影響について)"></a>●よくあるお問い合わせ (作業影響について)</h2><p><strong>Q</strong><br>SCOM 管理サーバーのキャッシュの内容は、SCOM エージェントで取得した監視のためのデータ（パフォーマンスデータのような）でしょうか？または、アラート、警告といった２次的な情報でしょうか？<br><strong>A</strong><br>キャッシュには、フォーマンスデータと、アラートの条件となる状態の情報の両方のデータが含まれます。<br>なお、状態の情報については、キャッシュクリア時点で発生していた状態がキャッシュクリア後のサービス起動後も続いていた場合、その時点であらためてアラート、警告の状態を判定する処理が動作いたします。 </p><p><strong>Q</strong><br>SCOM エージェントのキャッシュクリアをすると、キャッシュに残っていた未送信の情報が削除されると思いますが、強制的に SCOM 管理サーバーへデータを送信することは可能でしょうか？<br><strong>A.</strong><br>強制的に SCOM 管理サーバーへデータを送信する方法はございません。<br>基本的には SCOM エージェントが収集したデータは、常にすぐにSCOM 管理サーバーへ送信されています。</p><p><strong>Q</strong><br>キャッシュクリアにより削除される情報の時間（期間）を確認する方法はありますでしょうか？<br><strong>A</strong><br>キャッシュクリアにより削除される情報の時間（期間）を確認する方法はございません。<br>以下のようにご認識いただければと存じます。<br>・アラートの条件となる状態の情報については起動後にあらためて判定される。<br>・基本的にはエージェントが収集したパフォーマンスデータなどデータは常にサーバー側へ送信されているため、削除されない。<br>　(※ 削除されても取得頻度の 1 回分程度)</p><p><strong>Q</strong><br>「SCOMエージェントが収集したデータ」が SCOM 管理サーバに送信されずに残っているかどうかを確認する方法はありますでしょうか？<br><strong>A</strong><br>未送信情報の有無について確認する方法はございません。</p><hr><h2 id="SCOM-エージェントおよび-SCOM-管理サーバーのキャッシュの仕様詳細"><a href="#SCOM-エージェントおよび-SCOM-管理サーバーのキャッシュの仕様詳細" class="headerlink" title="SCOM エージェントおよび SCOM 管理サーバーのキャッシュの仕様詳細"></a>SCOM エージェントおよび SCOM 管理サーバーのキャッシュの仕様詳細</h2><p>既定では、SCOM 管理サーバーは 100MB、SCOM エージェントは 15MB 分の監視データを、一時キャッシュとして保存することが可能です。</p><p>SCOM エージェントのキャッシュデータは、対象サーバーが SCOM 管理サーバーとの疎通を行えない場合に、管理サーバーに送付する予定の監視データを一時的に保存するものです。その後、SCOM 管理サーバーと対象サーバー間の通信が回復した際、キャッシュに保管した監視データが一斉に SCOM 管理サーバーに送付されるものとなります。</p><p>つまり、<span style="text-decoration: underline">通信が行えない間も監視データは絶えず収集され、通信が回復した際はその間の監視データをご利用いただくことが可能</span>となります。また、キャッシュにある程度の余裕があることが重要であることを意味します。</p><p>確保されているキャッシュ容量 (既定で 15MB) に対する現在のキャッシュ使用量の割合は、”Health Service Management Groups\Send Queue % Used” パフォーマンス カウンターにて確認できます。このパフォーマンス カウンターは、SCOM 管理グループ毎にインスタンスが作成されますので、適切なインスタンスのパフォーマンス カウンターを確認してください。</p><p>キャッシュ容量の使用量は、監視対象のサーバーの動作状況によって変化します。お客様の監視ワークフロー量等の要因によっても使用量が増減します。そのため、一概に経過時間に対するキャッシュ使用量を見積もることは困難です。<br>ただし、参考情報として、弊社の検証環境でいくつかのサーバーのキャッシュ消費量を計測した中で、最もキャッシュ消費量が多かったサーバー (SQL Server が動作するサーバー) において、半日で約 12 MB 程を使用したという測定結果があります。<br>キャッシュ使用量が多い環境においても既定の 15MB の範囲に収まっていますので、一般的なサーバーにおいて SCOM 管理サーバーと短時間の通信断が発生した場合は、以下の状況となり、データ欠損が無いことが期待されます。<br>・通信が途絶する際は、リアルタイムの監視が行えなくなる。<br>・通信が回復した瞬間に、キャッシュに保存された監視データが SCOM 管理サーバーに送付され、そのデータを使用することが可能となる。</p><p><strong>キャッシュサイズの増加手順について</strong><br>キャッシュに保存されたデータが指定容量を超えた場合、古い監視データから順番にキャッシュから消去されます。<br>データの欠損を防ぐためにキャッシュのサイズを増加する場合、下記の手順を行います。</p><ol><li>SCOM エージェントがインストールされている監視対象のサーバーに、管理者権限を持つアカウントでログインします。</li><li>Win + R キーを押下し、”ファイル名を指定して実行” ウィンドウを出力します。”regedit” と入力し、”OK” ボタンを押下します。</li><li>レジストリ エディタ” ウィンドウが開きますので、以下のレジストリを参照します。<br>“HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\HealthService\Parameters\Management Groups&lt;SCOM 管理グループ名&gt;\maximumQueueSizeKb”</li><li>レジストリをダブルクリックします。”表記” から “10 進数” を選択し、任意の数値を KB 単位で指定します。</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;今回は、System Center Operations Manager (SCOM) が保持する各種のキャッシュデータを必要に応じてクリアする手順についてご紹介いたします。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Trouble" scheme="https://jpsystemcenter.github.io/blog/tags/Trouble/"/>
    
  </entry>
  
  <entry>
    <title>SCOM OperationsManagerDW データベースの容量削減手順</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_OpsDW_deletedata/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_OpsDW_deletedata/</id>
    <published>2023-07-31T03:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.104Z</updated>
    
    <content type="html"><![CDATA[<p>皆さんこんにちは、System Center サポートチームの 保科と申します。</p><p>今回は、System Center Operations Manager (SCOM) のデータウェアハウスデータベースのデータ削除手順についてご紹介いたします。</p><span id="more"></span><h3 id="本ページが対象とする-SCOM-バージョン"><a href="#本ページが対象とする-SCOM-バージョン" class="headerlink" title="本ページが対象とする SCOM バージョン"></a>本ページが対象とする SCOM バージョン</h3><p>SCOM 2016<br>SCOM 2019<br>SCOM 2022</p><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>SCOM を最小限の構成でインストールすると、以下 2 種類のデータベースが作成されます。</p><ul><li>OperationsManager:<br>SCOM の監視構成やインポートされた管理パック、監視対象の情報、監視データやアラート情報等 SCOM に関するあらゆる情報が保存されるデータベースです。<br>このデータベースが動作不備になったり、容量がいっぱいになると、SCOM 自体を使用することが出来なくなります。</li><li>OperationsManagerDW<br>SCOM のレポート機能で使用するための監視データや監視対象の情報等が保存されるデータベースです。<br>保存されるデータは、SCOM の監視動作に準ずるものとなります。<br>例えば、パフォーマンスカウンターの収集を実施されている場合、まずは “OperationsManager” データベースにその監視内容が保存されます。<br>その後、その監視内容が “OperationsManagerDW” 側でも保存され、更にレポート用のデータとしてその保存されたデータが加工されます。<br>“OperationsManager” データベースと異なり、本データベースが極端の場合存在しない場合でも、SCOM の機能を使用することが出来ます。<br>(データベースの削除自体を推奨しているものではございません。)<br>一方で、本データベースに不備が発生すると、レポートに関するデータが取得できない、つまりレポートを閲覧することが出来なくなります。</li></ul><p>詳細は割愛しますが、”OperationsManagerDW” では監視データの全データ、時間単位で纏められたデータ、日単位でまとめられたデータが保存されます。<br>収集されるデータによってはデータ数が膨大となることがあり、これが要因でデータベースの容量が非常に大きくなる場合がございます。<br>上記に記載した “OperationsManagerDW” に対するデータ保存の仕組みから、一般的に SCOM の監視内容が多いほどデータベースが肥大化しやすい傾向となります。<br>本記事では、肥大化した “OperationsManagerDW” データベースのデータ削除方法と、具体的に削除するデータの選定方法を説明いたします。</p><h3 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h3><p>以降のご説明では、”OperationsManagerDW” データベースの名称を “OpsDW” と略称いたします。<br>SCOM インストール時に “OperationsManagerDW” データベースの名称を変更されている場合、適宜そのデータベース名に “OpsDW” を読み替えてください。</p><h3 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h3><p>クリーンアップの設定を実施いただく前に、まずどのデータセットが OpsDW のデータの多くを占めるか確認する必要がございます。<br>こちらは、以下の手順で OpsDW のテーブル毎のデータ使用量を確認することで確認いただけます。</p><ol><li>OpsDW データベースを運用する SQL Server が存在するサーバーに管理者権限でログインします。</li><li>SQL Server Management Studio (SSMS) を開きます。</li><li>OpsDW の管理者権限を持つアカウントで、OpsDW が存在するサーバーにログインします。</li><li>OpsDW を画面左ペインより [&lt;サーバー名&gt;] -&gt; [データベース] -&gt; [OperationsManagerDW] を右クリックし、[レポート] -&gt; [標準レポート] -&gt; [上位のデーブルによるディスク使用量] をクリックします。<br>(OpsDW のデータベース名が変更されている場合、適宜そのデータベースを [&lt;サーバー名&gt;] -&gt; [データベース] より選択します。)</li></ol><p>こちらの手順で、現在 OpsDW にはどのようなテーブルが存在し、各テーブルでどの程度データを使用しているか確認いただけます。<br>これにより、表示されたテーブルの内、どのデータセットが OpsDW のデータの多くを占めているか確認します。<br>例えば、”perf.perfhourly_&lt;テーブル毎の固有文字列&gt;” が、固有文字列の内容こそ異なるものの “perf.perfhourly_” で始まるテーブルが大量に存在する場合を想定します。<br>この場合、”perf.perfhourly”、つまり下記の弊社サイト内に記載されているテーブルにおける “データセット” が “パフォーマンス” かつ集計の種類が “1 時間ごと” のデータが大量に存在することが確認いただけます。<br><a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-omdwdb-grooming-settings?view=sc-om-2022">レポート データ ウェアハウス データベースのクリーンアップ設定を構成する方法 | Microsoft Learn</a></p><p>このように、適宜お客様環境における OpsDW で [上位のデーブルによるディスク使用量] を開き、どのテーブルが消費容量の多くを占めるか確認いただくことで、クリーンアップ設定実施方針が定義いただけます。</p><h3 id="対処手順"><a href="#対処手順" class="headerlink" title="対処手順"></a>対処手順</h3><p>[事前準備] に記載しました方法でどのデータが OpsDW において多くのデータを消費しているか確認いただけましたら、次の手順としてはこのクリーンアップの設定を行います。<br>クリーンアップの設定手順は、下記の手順にて実施いただけます。</p><ol><li>OpsDW データベースを運用する SQL Server が存在するサーバーに管理者権限でログインします。</li><li>SQL Server Management Studio (SSMS) を開きます。</li><li>OpsDW の管理者権限を持つアカウントで、OpsDW が存在するサーバーにログインします。</li><li>以下弊社公開情報の “レポート データ ウェアハウスのクリーンアップ設定を変更するには” 項に記載された 4. ~ 6. の手順に沿って、削除を実施するデータの GUID を確認します。<br><a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-omdwdb-grooming-settings?view=sc-om-2022">レポート データ ウェアハウス データベースのクリーンアップ設定を構成する方法 | Microsoft Learn</a><br>本公開情報の 4. の手順は機械翻訳されて分かりづらいですが、”dbo.Dataset” テーブルを開くという手順が英語版の公開情報では示されています。</li><li>画面左ペインより [&lt;サーバー名&gt;] -&gt; [データベース] -&gt; [OperationsManagerDW] -&gt; [テーブル] -&gt; [dbo.StandardDatasetAggregation] を右クリックし、[上位 200 行の編集] をクリックします。<br>(OpsDW のデータベース名が変更されている場合、適宜そのデータベースを [&lt;サーバー名&gt;] -&gt; [データベース] より選択します。)<br>dbo.StandardDatasetAggregation のテーブルを編集開始します。</li><li>4. で確認された GUID を持つ行の“MaxDataAgeDays” カラムの各値を、お客様が保持されたいデータの日数で指定します。<br>保持日数変更対象となるデータセットおよび集計の種類の確認方法は、下記の弊社公開情報の内容に基づいて確認します。<br><a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-omdwdb-grooming-settings?view=sc-om-2022">レポート データ ウェアハウス データベースのクリーンアップ設定を構成する方法 | Microsoft Learn</a><br>なお、お客様環境によってはディスクの空き容量がひっ迫している状況も想定されると存じます。<br>この場合、トランザクションログ用の領域も十分に確保することが出来ない可能性もございます。<br>これは、クリーンアップ処理が実行される際、処理のコミットが完了するまで、データがトランザクションログに保存されるためです。<br>(データベースの復旧モデルを、SQL Server Always On 可用性グループをご利用いただく等して “完全” で構成されている場合、トランザクションログはバックアップされない限り保存され続けます。)<br>こういった場合では、“MaxDataAgeDays” の値は目的の値に達成されるまで段階的に減らされることを推奨いたします。<br>例えば、最初の段階では 2 ずつ減らし、ディスクの空き容量が確保いただける状況となった場合に減らす数値を増加する、といった流れでデータ削除を実施ください。</li><li>6. で編集された行の “GroomingIntervalMinutes” に、非常に小さな値を指定します。まずは 5 で設定されることを推奨いたします。<br>これにより、その行で指定されているテーブルのデータを、指定した分間隔で、”MaxDataAgeDays” で指定した日数以上経過しているデータを削除します。<br>例えば、“GroomingIntervalMinutes” の値を 5、”MaxDataAgeDays” の値を 100 と設定すると、５分間隔で、100 日以上経過した対象テーブル内データを削除する処理を行います。<br>なお、“GroomingIntervalMinutes” の値が小さいほど、ログデータ削除の処理が行われる回数も増えるので、実運用において小さな値を指定し続けることは推奨いたしません。<br>なので、“GroomingIntervalMinutes” の値を変更する前の値については、あらかじめメモを取得の上、一通りクリーンアップが完了したタイミングで値を元に戻します。<br>本設定値の変更は、例えばディスクの空き容量を早急に確保する必要があるといったご要望が存在する場合、空き容量が確保できるまでクリーンアップ実行周期を短くします。<br>即座に空き容量を確保いただく必要がない場合、本手順の設定は省略いただいても問題ございません。</li><li>必要に応じて、6. で編集された行の ”MaxRowsToGroom” の値を変更します。<br>一度のクリーンアップによって対象のテーブルより削除されるデータ行数は、”MaxRowsToGroom” にて指定された行数となります。<br>例えば、State データセットのテーブルは、既定で ”MaxRowsToGroom” の値が 50,000 となっております。<br>つまり、この設定状況では、一度のクリーンアップで削除されるデータ行数は 50,000 行までとなります。<br>クリーンアップ量に対して入力されるデータ数が多い場合、データ数は減ることなく増加することが想定されます。<br>こういった状況が想定されますため、必要に応じて、”MaxRowsToGroom” の値を変更します。<br>事例より、”MaxRowsToGroom” の値を 1,000,000 と設定した場合に大きなトランザクションログの容量を消費しないことを確認しております。<br>こちらは “GroomingIntervalMinutes” とは異なり、一通りクリーンアップが完了した後も設定値を保持いただいても問題ございません。<br>なお、こちらの値についても、ディスク空き容量がひっ迫している場合、段階的に値を増加いただく等の操作をご検討ください。</li><li>設定した GroomingIntervalMinutes の時間が経過後、OpsDW の消費容量が小さくなったか確認します。<br>容量が小さくなっていることを確認できましたら、OpsDW を圧縮し、ファイルサイズの縮小を行います。<br>データベースの圧縮手順は、下記の弊社 SQL Server の公開情報を参照ください。<br><a href="https://learn.microsoft.com/ja-jp/sql/relational-databases/databases/shrink-a-database?view=sql-server-ver16">データベースの圧縮 - SQL Server | Microsoft Learn</a><br>データベースの圧縮が不要の場合、こちらの手順の実施も不要です。</li><li>以後、各テーブルのデータ最大保持日数が目的の値となるまで、5. ~ 8. の手順を繰り返します。<br>なお、ディスクの空き容量が増加するに従い、”MaxDataAgeDays” にて減らされる値を大きくされたり、<br>“MaxRowsToGroom” の値を大きくされても問題ございません。</li></ol><h3 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h3><p>SQL Server の復旧モデルが “完全” の場合、トランザクションログの肥大化が懸念されます。<br>復旧モデルは、SQL Server Always On を構成されていない場合、既定で “単純” となり、”単純” で運用されることが推奨されます。<br>なお、SQL Server Always On を構成されている場合、復旧モデルは “完全” で固定となり、それ以外の復旧モデルに変更いただくことは出来ません。。<br>復旧モデルは、下記の手順で確認を行います。</p><ol><li>SQL Server Management Studio (SSMS) を開きます。</li><li>復旧モデルを確認するデータべースが存在するサーバーに、管理者権限でログインします。</li><li>対象のデータベースを右クリックし、[プロパティ] をクリックします。<br>ウィンドウ左の [オプション] をクリックし、 [復旧モデル] の内容を確認します。</li></ol><h3 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h3><p>OpsDW の不要なデータ削除手順は以上となります。<br>上記の通り、OpsDW は、主に SCOM レポートで使用するデータを保存するために使用されるデータベースとなります。<br>お客様が使用されているレポートの要件に応じて、各データの保持日数およびその削除量を調整いただければと思います。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆さんこんにちは、System Center サポートチームの 保科と申します。&lt;/p&gt;
&lt;p&gt;今回は、System Center Operations Manager (SCOM) のデータウェアハウスデータベースのデータ削除手順についてご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Trouble" scheme="https://jpsystemcenter.github.io/blog/tags/Trouble/"/>
    
    <category term="Database" scheme="https://jpsystemcenter.github.io/blog/tags/Database/"/>
    
    <category term="OperationsManagerDW" scheme="https://jpsystemcenter.github.io/blog/tags/OperationsManagerDW/"/>
    
  </entry>
  
  <entry>
    <title>WORKGROUP コンピューターの管理方法について</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_Workgroup/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_Workgroup/</id>
    <published>2023-07-21T08:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.108Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。</p><p>今回は、SCOM 管理サーバーと同じ信頼境界内に存在しない Windows サーバー  ( ※ 信頼関係を結んでいない別ドメイン内のサーバーや WORKGROUP コンピューター) に導入した SCOM エージェントを、証明書認証を用いて管理する方法について説明します。<br><br></p><span id="more"></span><h2 id="SCOM-管理サーバーと同じ信頼境界内に存在しない-Windows-サーバーの管理方法について"><a href="#SCOM-管理サーバーと同じ信頼境界内に存在しない-Windows-サーバーの管理方法について" class="headerlink" title="SCOM 管理サーバーと同じ信頼境界内に存在しない Windows サーバーの管理方法について"></a>SCOM 管理サーバーと同じ信頼境界内に存在しない Windows サーバーの管理方法について</h2><p>System Center Operations Manager（以後、SCOM） は、Windows サーバーの管理に SCOM エージェント ( MMA：Microsoft Monitoring Agent ) を使用します。<br>エージェントと管理サーバーとの間で情報交換を開始する前に相互認証を実行しますが、この認証プロセスは保護のために暗号化されます。エージェントと管理サーバーが同じ Active Directory ドメイン内に存在する場合、または信頼関係が確立された異なる Active Directory ドメイン内に存在する場合は、Active Directory によって提供される Kerberos V5 認証メカニズムを使用します。この認証プロセス用には特に設定等は不要です。<br>エージェントと管理サーバーが同じ信頼境界内に存在しない場合 ( ※信頼関係を結んでいない別ドメイン内のサーバーや WORKGROUP コンピューターの場合) は、セキュリティで保護された相互認証要件を満たすために他のメカニズムを使用する必要があります。</p><p>相互認証が完了していない場合、エージェントは管理サーバーに接続できず、エージェント サーバー側にイベントログ (<strong>21016</strong> と <strong>21007</strong>) が記録されます。</p><p>==========================================<br><span style="font-size: 80%;"><span style="text-decoration: underline"><strong>イベント ID : 21016</strong></span><br>ログの名前 : Operations Manager<br>ソース : OpsMgr Connector<br>レベル : エラー<br>コンピューター :  <span style="text-decoration: underline">エージェントサーバーのコンピューター名</span><br>説明 : OpsMgr は <span style="text-decoration: underline">SCOM 管理サーバーのFQDN</span> との通信チャネルを設定できませんでした。フェールオーバー ホストがありません。<span style="text-decoration: underline">SCOM 管理サーバーのFQDN</span> が使用可能になり、このコンピューターからの通信が許可されるようになったら、通信が再開されます。</span></p><p><span style="font-size: 80%;"><span style="text-decoration: underline"><strong>イベント ID : 21007</strong></span><br>ログの名前 : Operations Manager<br>ソース : OpsMgr Connector<br>レベル:           エラー<br>コンピューター :  <span style="text-decoration: underline">エージェントサーバーのコンピューター名</span><br>説明 : OpsMgr コネクタは、信頼されたドメインにないため、<span style="text-decoration: underline">SCOM 管理サーバーのFQDN</span> への相互に認証された接続を作成できません。<br></span>==========================================</p><p>相互認証のプロセスを完了させる方法には、以下の 2 つの方法があります。</p><p>　<strong>１）ゲートウェイ サーバーを構築する方法</strong>　　　※参考：<a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-mgmt-group-design?view=sc-om-2022#gateway-server">ゲートウェイ サーバー | Microsoft Learn</a><br>　<strong>２）証明書認証を設定する方法　　　　　　　　<span style="color: red; ">← 本記事の内容</strong><span style="color: red; "></p><p>本記事では、管理サーバーとエージェントとサーバーに証明書を登録して証明書認証を行う手順について説明します。<br><br></p><h2 id="証明書認証の設定の流れ"><a href="#証明書認証の設定の流れ" class="headerlink" title="証明書認証の設定の流れ"></a>証明書認証の設定の流れ</h2><p>証明書認証の設定の流れは以下の通りです。<br>次章にて、各々の具体的な設定手順について説明します。</p><p>A. <a href="#A-%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90%EF%BC%88CA-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%EF%BC%89">証明書テンプレートの作成（CA サーバー）</a><br>B. <a href="#B-%E4%BF%A1%E9%A0%BC%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%EF%BC%88SCOM-%E7%AE%A1%E7%90%86%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%EF%BC%89">信頼されているルート証明書のダウンロード（SCOM 管理サーバー）</a><br>C. <a href="#C-%E4%BF%A1%E9%A0%BC%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%EF%BC%88SCOM-%E7%AE%A1%E7%90%86%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%EF%BC%89">信頼されているルート証明書のインポート（SCOM 管理サーバー）</a><br>D. <a href="#D-%E4%BF%A1%E9%A0%BC%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%EF%BC%88WorkGroup-%E3%81%AB%E3%81%82%E3%82%8B%E7%9B%A3%E8%A6%96%E5%AF%BE%E8%B1%A1%EF%BC%89">信頼されているルート証明書のダウンロード（WORKGROUP にある監視対象）</a><br>E. <a href="#E-%E4%BF%A1%E9%A0%BC%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%EF%BC%88WorkGroup-%E3%81%AB%E3%81%82%E3%82%8B%E7%9B%A3%E8%A6%96%E5%AF%BE%E8%B1%A1%EF%BC%89">信頼されているルート証明書のインポート（WORKGROUP にある監視対象）</a><br>F. <a href="#F-CA-%E3%81%B8%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E8%A6%81%E6%B1%82%EF%BC%88SCOM-%E7%AE%A1%E7%90%86%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%EF%BC%89">CA へ証明書の要求（SCOM 管理サーバー）</a><br>G. <a href="#G-CA-%E3%81%B8%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E8%A6%81%E6%B1%82%EF%BC%88WorkGroup-%E3%81%AB%E3%81%82%E3%82%8B%E7%9B%A3%E8%A6%96%E5%AF%BE%E8%B1%A1%EF%BC%89">CA へ証明書の要求（WORKGROUP にある監視対象）</a><br>H. <a href="#H-%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%82%B9%E3%83%88%E3%82%A2%E3%81%AB%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%EF%BC%88SCOM-%E7%AE%A1%E7%90%86%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%EF%BC%89">証明書ストアに証明書のインポート（SCOM 管理サーバー）</a><br>I. <a href="#I-%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%82%B9%E3%83%88%E3%82%A2%E3%81%AB%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%EF%BC%88WorkGroup-%E3%81%AB%E3%81%82%E3%82%8B%E7%9B%A3%E8%A6%96%E5%AF%BE%E8%B1%A1%EF%BC%89">証明書ストアに証明書のインポート（WORKGROUP にある監視対象）</a><br>J. <a href="#J-MOMCertImport-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6-Operations-Manager-%E3%81%AB%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%BE%E3%81%99%E3%80%82%EF%BC%88SCOM-%E7%AE%A1%E7%90%86%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%EF%BC%89">MOMCertImport を使って Operations Manager に証明書をインポートします。（SCOM 管理サーバー）</a><br>K. <a href="#K-MOMCertImport-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6-Operations-Manager-%E3%81%AB%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%BE%E3%81%99%E3%80%82%EF%BC%88WorkGroup-%E3%81%AB%E3%81%82%E3%82%8B%E7%9B%A3%E8%A6%96%E5%AF%BE%E8%B1%A1%EF%BC%89">MOMCertImport を使って Operations Manager に証明書をインポートします。（WORKGROUP にある監視対象）</a><br><br></p><h2 id="証明書認証の設定手順"><a href="#証明書認証の設定手順" class="headerlink" title="証明書認証の設定手順"></a>証明書認証の設定手順</h2><h3 id="A-証明書テンプレートの作成（CA-サーバー）"><a href="#A-証明書テンプレートの作成（CA-サーバー）" class="headerlink" title="A. 証明書テンプレートの作成（CA サーバー）"></a>A. 証明書テンプレートの作成（CA サーバー）</h3><ol><li>CA の管理権限を持つアカウントで、証明書サービスをホストしているコンピューター にログインします。</li><li>[管理ツール] より、[証明機関] を起動します。</li><li>ナビゲーション ウィンドウで、CA 名を展開します。</li><li>[証明書テンプレート] を右クリックし、[管理] を選択して、”証明書テンプレート コンソール” を開きます。<br><img src="001.png"></li><li>画面中央のウィンドウの “テンプレート表示名” の列にある [IPsec (オフライン要求)] を右クリックし、[テンプレートの複製] を選択し、”新しいテンプレートのプロパティ” を開きます。<br><img src="002.png"></li><li>[全般] タブの[テンプレート表示名] のテキスト ボックスに、このテンプレートは名を入力します。<br>例えば、「OperationsManagerCert」とします。(※必要に応じて、[有効期間] を変更してください。)<br><img src="003.png"></li><li>[要求処理] タブの [秘密キーのエクスポートを許可する] にチェックをします。<br><img src="004.png"></li><li>[拡張機能] タブの [このテンプレートに含まれる拡張] に表示されている [アプリケーション ポリシー] を選択し、[編集] をクリックします。</li><li>“アプリケーション ポリシーの拡張の編集” ダイアログ ボックスで [IP セキュリティ IKE 中間] を選択し、[削除] をクリックします。次に、[追加] をクリックし、[クライアント認証] と [サーバー認証] を選択し、[OK] をクリックします。<br><img src="005.png"></li><li>“アプリケーション ポリシーの拡張の編集” ダイアログ ボックスで[OK] をクリックします。</li><li>[セキュリティ] タブを選択し、[Authenticated Users] グループに [読み取り] と [登録] のアクセスを許可し、[OK] をクリックします。<br><img src="006.png"></li><li>“証明書テンプレート コンソール” を閉じます。</li><li>[証明書テンプレート] を右クリックし、[新規作成] - [発行する証明書テンプレート] を選択します。</li><li>先ほど作成したテンプレートを選択し、[OK] をクリックします。(※今回の場合、作成したテンプレートは「OperationsManagerCert」です。)<br><img src="007.png"><br></li></ol><h3 id="B-信頼されているルート証明書のダウンロード（SCOM-管理サーバー）"><a href="#B-信頼されているルート証明書のダウンロード（SCOM-管理サーバー）" class="headerlink" title="B. 信頼されているルート証明書のダウンロード（SCOM 管理サーバー）"></a>B. 信頼されているルート証明書のダウンロード（SCOM 管理サーバー）</h3><ol><li>管理者権限を持つアカウントにて、SCOM 管理サーバーにログインします。</li><li>“Internet Explorer” を起動し、以下のURL より、証明書サービスをホストしているコンピューターへの接続します。<br>　<span style="text-decoration: underline">http://&lt;AD CS サーバーのFQDN 名&gt;/certsrv</span></li><li>“ようこそ” ページで、[CA 証明書、証明書チェーン、または CRL のダウンロード] をクリックします。<br><img src="008.png"></li><li>“CA 証明書、証明書チェーン、または CRL のダウンロード” ページ内にある “エンコード方法” で [Base 64] を選択し、[CA 証明書チェーンのダウンロード] をクリックします。<br><img src="009.png"></li><li>ファイルをダウンロード のダイアログ ボックス で [保存] を選択し、 証明書を保存します。(※例えば [Trustedca.p7b] とします。)</li><li>ダウンロードが完了したら、Internet Explorer を閉じます。<br></li></ol><h3 id="C-信頼されているルート証明書のインポート（SCOM-管理サーバー）"><a href="#C-信頼されているルート証明書のインポート（SCOM-管理サーバー）" class="headerlink" title="C. 信頼されているルート証明書のインポート（SCOM 管理サーバー）"></a>C. 信頼されているルート証明書のインポート（SCOM 管理サーバー）</h3><ol><li>SCOM 管理サーバー上で、[mmc] (※Microsoft Management Console) を起動します。</li><li>“コンソール 1” ウィンドウ上方の[ファイル] をクリックし、[スナップインの追加と削除] をクリックします。</li><li>“利用できるスナップイン” 内にある[証明書] を選択し、[追加] をクリックします。</li><li>“証明書スナップイン” ダイアログ ボックスで、[コンピュータ アカウント] を選択し、[次へ] をクリックします。<br><img src="010.png"></li><li>“コンピューターの選択” ダイアログ ボックスで、[ローカル コンピューター:(このコンソールを実行しているコンピューター)] が選択されていることを確認し、[完了] をクリックします。</li><li>“スナップインの追加と削除” のダイアログ ボックスで、[OK] をクリックします。</li><li>“コンソール 1” ウィンドウで左ペインの[証明書 (ローカル コンピューター)] - [信頼されたルート証明機関] を展開します。</li><li>[証明書] を右クリックし、[すべてのタスク] - [インポート] をクリックします。”証明書のインポート ウィザード” が開きます。</li><li>“証明書のインポート ウィザードの開始” ページで [次へ] をクリックします。</li><li>“インポートする証明書ファイル” のページで[参照] をクリックし、手順 B でダウンロードした CA の証明書ファイルを選択します。(※例えば、[TrustedCA.p7b] を選択します。)<br>※ 画面右下のダイアログ ボックスより、[X.509 証明書] を[すべてのファイル] に変更することで、手順 B でダウンロードした CA の証明書ファイルを一覧から選択できます。<br><img src="011.png"></li><li>“インポートする証明書ファイル” のページで [次へ] をクリックします。</li><li>“証明書ストア” のページで [証明書をすべて次のストアに配置する] が選択されており、[証明書ストア] が<br>「信頼されたルート証明機関」となっていることを確認し、[次へ] をクリックします。</li><li>“証明書のインポート ウィザードの完了” ページで [完了] をクリックします。<br><img src="012.png"><br></li></ol><h3 id="D-信頼されているルート証明書のダウンロード（WorkGroup-にある監視対象）"><a href="#D-信頼されているルート証明書のダウンロード（WorkGroup-にある監視対象）" class="headerlink" title="D. 信頼されているルート証明書のダウンロード（WorkGroup にある監視対象）"></a>D. 信頼されているルート証明書のダウンロード（WorkGroup にある監視対象）</h3><p>手順 B を、ワークグループ上の監視対象となるコンピューターにて実施します。<br>(※下の画面ショットは、ワークグループ コンピューターにダウンロードしたルート証明書です。)<br><img src="013.png"><br><br></p><h3 id="E-信頼されているルート証明書のインポート（WorkGroup-にある監視対象）"><a href="#E-信頼されているルート証明書のインポート（WorkGroup-にある監視対象）" class="headerlink" title="E. 信頼されているルート証明書のインポート（WorkGroup にある監視対象）"></a>E. 信頼されているルート証明書のインポート（WorkGroup にある監視対象）</h3><p>手順 C を、ワークグループ上の監視対象となるコンピューターにて実施します。<br>(※下の画面ショットは、ワークグループ コンピューターにインポートしたルート証明書です。)<br><img src="014.png"><br><br></p><h3 id="F-CA-へ証明書の要求（SCOM-管理サーバー）"><a href="#F-CA-へ証明書の要求（SCOM-管理サーバー）" class="headerlink" title="F. CA へ証明書の要求（SCOM 管理サーバー）"></a>F. CA へ証明書の要求（SCOM 管理サーバー）</h3><ol><li><p>管理者権限を持つアカウントにて、SCOM 管理サーバーにログインします。</p></li><li><p>以下の記述を含む内容をテキスト ファイルに作成します。<br>※ 「Subject= “CN=&lt;SCOM 管理サーバーのFQDN 名&gt;”」については、作業を実施するコンピューターのFQDN 名に置き換えてください。<br><span style="font-size: 80%;">- - - - - - - - - - ここから - - - - - - - - - -<br>[NewRequest]<br>Subject= “CN=&lt;SCOM 管理サーバーの完全修飾ドメイン名&gt;”<br>Exportable=TRUE<br>KeyLength=2048<br>KeySpec=1<br>KeyUsage=0xf0<br>MachineKeySet=TRUE<br>[EnhancedKeyUsageExtension]<br>OID=1.3.6.1.5.5.7.3.1<br>OID=1.3.6.1.5.5.7.3.2</span><br><span style="font-size: 80%;">- - - - - - - - - - ここまで - - - - - - - - - -</span></p></li><li><p>上記のテキスト ファイルを「.inf」の拡張子つけて保存します。(※例えば、[RequestConfig.inf] とします。)<br>※下の画面ショットは、弊社検証環境の [RequestConfig.inf] です。<br><img src="015.png"></p></li><li><p>[コマンド プロンプト] を起動し、以下のコマンドを実行し、リクエスト ファイルを作成します。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CertReq -New -f RequestConfig.inf CertRequest.req</span><br></pre></td></tr></table></figure></li></ol><p>※コマンドが成功すると、下の画面ショットの通り表示されます。<br><img src="016.png"><br>5. 作成されたファイル (CertRequest.req) をメモ帳で開き、内容を全てクリップボードにコピーします。<br>6. “Internet Explorer” を起動し、以下のURL より、証明書サービスをホストしているコンピューターへの接続します。<br>　<span style="text-decoration: underline">http://&lt;AD CS サーバーのFQDN 名&gt;/certsrv</span><br>7. “ようこそ” ページで、[証明書を要求する] をクリックします。<br><img src="017.png"><br>8. “証明書の要求” ページで [証明書の要求の詳細設定] をクリックします。<br><img src="018.png"><br>9. “証明書の要求の詳細設定” ページで、[Base 64 エンコード CMC または PKCS #10 ファイルを使用して証明書の要求を送信するか、または Base 64 エンコード PKCS #7 ファイルを使用して更新の要求を送信する。] をクリックします。(※ 環境によっては、このページが表示されないこともございますが、そのまま次へお進みください。)<br>10. “証明書の要求または更新要求の送信” ページで、[保存された要求] に上記の手順 5 でコピーした内容を貼り付けます。[証明書テンプレート] で、手順 A で作成した「OperationsManagerCert」を選択し、[送信] します。<br><img src="019.png"><br>11. “証明書は発行されました” ページで、[Base 64 エンコード] を選択し、[証明書のダウンロード]を選択し、証明書を保存します。(※例えば、ファイル名を「NewCertificate.cer」とします。)<br><img src="020.png"><br>12. ダウンロードが完了したら、”Internet Explorer” を閉じます。 <br><br></p><h3 id="G-CA-へ証明書の要求（WorkGroup-にある監視対象）"><a href="#G-CA-へ証明書の要求（WorkGroup-にある監視対象）" class="headerlink" title="G. CA へ証明書の要求（WorkGroup にある監視対象）"></a>G. CA へ証明書の要求（WorkGroup にある監視対象）</h3><p>手順 F を、ワークグループ上の監視対象となるコンピューターにて実施します。<br>なお、手順 F-2 で使用する記述内容は以下のものに置き換えて実施してください。<br>※ 「Subject= “CN=&lt; WorkGroup にある監視対象の FQDN 名&gt;”」については、作業を実施するコンピューターの FQDN 名に置き換えてください。</p><p><span style="font-size: 80%;">- - - - - - - - - - ここから - - - - - - - - - -<br>[NewRequest]<br>Subject= “CN=&lt;WorkGroup にある監視対象の完全修飾ドメイン名&gt;”<br>Exportable=TRUE<br>KeyLength=2048<br>KeySpec=1<br>KeyUsage=0xf0<br>MachineKeySet=TRUE<br>[EnhancedKeyUsageExtension]<br>OID=1.3.6.1.5.5.7.3.1<br>OID=1.3.6.1.5.5.7.3.2</span><br><span style="font-size: 80%;">- - - - - - - - - - ここまで - - - - - - - - - -</span></p><p>※下の画面ショットは、弊社検証環境の [RequestConfig.inf] です。<br><img src="021.png"></p><h3 id="H-証明書ストアに証明書のインポート（SCOM-管理サーバー）"><a href="#H-証明書ストアに証明書のインポート（SCOM-管理サーバー）" class="headerlink" title="H. 証明書ストアに証明書のインポート（SCOM 管理サーバー）"></a>H. 証明書ストアに証明書のインポート（SCOM 管理サーバー）</h3><ol><li>管理者権限を持つアカウントにて、SCOM 管理サーバーにログインします。</li><li>[コマンド プロンプト] を起動し、以下のコマンドを実行し、証明書をインポートします。<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. CertReq -Accept NewCertificate.cer</span><br></pre></td></tr></table></figure></li></ol><p>※コマンドが成功すると、下の画面ショットの通り表示されます。<br><img src="022.png"></p><h3 id="I-証明書ストアに証明書のインポート（WorkGroup-にある監視対象）"><a href="#I-証明書ストアに証明書のインポート（WorkGroup-にある監視対象）" class="headerlink" title="I. 証明書ストアに証明書のインポート（WorkGroup にある監視対象）"></a>I. 証明書ストアに証明書のインポート（WorkGroup にある監視対象）</h3><p>手順 H を、ワークグループ上の監視対象となるコンピューターにて実施します。</p><p>※コマンドが成功すると、下の画面ショットの通り表示されます。<br><img src="023.png"><br><br></p><p><strong>続けて、SCOM のインストール メディアを利用して、エージェントのインストールを行います。</strong><br>(※指定する管理グループ・SCOM 管理サーバーの指定を誤りますと、正常に監視を行うことはできません。一旦、エージェントの再インストールが必要となりますので、ご注意くださいませ。)<br><br></p><h3 id="J-MOMCertImport-を使って-Operations-Manager-に証明書をインポートします。（SCOM-管理サーバー）"><a href="#J-MOMCertImport-を使って-Operations-Manager-に証明書をインポートします。（SCOM-管理サーバー）" class="headerlink" title="J. MOMCertImport を使って Operations Manager に証明書をインポートします。（SCOM 管理サーバー）"></a>J. MOMCertImport を使って Operations Manager に証明書をインポートします。（SCOM 管理サーバー）</h3><p>事前にSCOM のインストール メディアをマウントする必要があります。</p><ol><li>[コマンド プロンプト] を起動し、インストール メディアが配置されているドライブへカレントディレクトリを変更します。</li><li>以下のコマンドを実行し、メディア内のフォルダを開きます。<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> (インストール メディアパス)\SupportTools\AMD64</span><br></pre></td></tr></table></figure>32 bit コンピューターの場合は、以下のコマンドを実行してください。<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> (インストール メディアパス)\SupportTools\i386</span><br></pre></td></tr></table></figure></li><li>以下のコマンドを実行します。<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOMCertImport</span><br></pre></td></tr></table></figure><br></li></ol><p>※下の画面ショットは、弊社検証環境での実行画面です。<br><img src="024.png"><br>4. 表示された証明書の一覧から、有効期限の情報をもとに新しい証明書を識別して選択します。<br><img src="025.png"><br><br></p><h3 id="K-MOMCertImport-を使って-Operations-Manager-に証明書をインポートします。（WorkGroup-にある監視対象）"><a href="#K-MOMCertImport-を使って-Operations-Manager-に証明書をインポートします。（WorkGroup-にある監視対象）" class="headerlink" title="K. MOMCertImport を使って Operations Manager に証明書をインポートします。（WorkGroup にある監視対象）"></a>K. MOMCertImport を使って Operations Manager に証明書をインポートします。（WorkGroup にある監視対象）</h3><p>手順 J を、ワークグループ上の監視対象となるコンピューターにて実施します。<br><img src="026.png"></p><p>上記の操作によって、新しい証明書を使用するように Operations Manager が構成されます。<br>必要に応じて、Operations Manager のサービスを再起動してください。</p><p>※ Operations Manager のサービスを再起動するには、以下の手順を実施して下さい。<br> 1. 管理者権限を持つアカウントで SCOM サーバーにログインします。<br>2. [管理ツール] より[サービス] を起動します。<br>3. サービスの一覧から [System Center Management Configuration] を右クリックして[再起動] をクリックします。</p><p>以上で証明書の設定は完了です。この後、SCOM 環境にてワークグループコンピューターから接続された SCOM エージェントの承認をご実施ください。承認が完了すると、管理対処のエージェントに WORKGROUP コンピューターが追加されます。<br><img src="027.png"></p><hr><p>WORKGROUP コンピューターの管理や信頼関係を結んでいない別ドメインサーバーを管理する際に、本手順を参考にしていただければと存じます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;/p&gt;
&lt;p&gt;今回は、SCOM 管理サーバーと同じ信頼境界内に存在しない Windows サーバー  ( ※ 信頼関係を結んでいない別ドメイン内のサーバーや WORKGROUP コンピューター) に導入した SCOM エージェントを、証明書認証を用いて管理する方法について説明します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="アップグレード" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89/"/>
    
    <category term="新環境への移行" scheme="https://jpsystemcenter.github.io/blog/tags/%E6%96%B0%E7%92%B0%E5%A2%83%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM で使用する一般的なログ収集方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Troubleshooting_log/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Troubleshooting_log/</id>
    <published>2023-03-29T04:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.128Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>本記事は、System Center Virtual Machine Manager （以後、SCVMM） で発生したトラブルの調査を行う際に採取いただく機会が多いログ等の取得方法について解説します。</p><span id="more"></span><h2 id="トラブルシューティングに必要な情報"><a href="#トラブルシューティングに必要な情報" class="headerlink" title="[トラブルシューティングに必要な情報]"></a>[トラブルシューティングに必要な情報]</h2><p>SCVMM のトラブルシューティングの際には、お客様環境と SCVMM の動作を把握するために以下の情報をお送りいただいております。<br>本記事では、各々の取得目的と取得手順について解説します。</p><table>  <thead>    <tr>      <th style="text-align:center">No</th>      <th style="text-align:center">項目</th>      <th style="text-align:center">取得目的</th>    </tr>  </thead>  <tbody>    <tr>      <td style="text-align:center">1</td>      <td><a href="#No-1-トレースログ">トレースログ</a></td>      <td>再現可能な不具合動作が発生した場合、事象再現中のトレースログを取得することで、処理の流れを追いかけて原因調査します。</td>    </tr>    <tr>      <td style="text-align:center">2</td>      <td><a href="#No-2-ジョブ一覧">ジョブ一覧</a></td>      <td>SCVMM のジョブが正常終了しなかった場合、ジョブ一覧にて実行ジョブの名称、実行時間、発生したエラーなどを確認します。</td>    </tr>    <tr>      <td style="text-align:center">3</td>      <td><a href="#No-3-SCVMM-環境情報-SCVMM-サーバー情報-ホスト情報-仮想マシン情報">SCVMM 環境情報</a></td>      <td>お客様環境を把握するための情報です。取得対象は、SCVMM サーバー情報, ホスト情報, 仮想マシン情報の3 種類です。</td>    </tr>    <tr>      <td style="text-align:center">4</td>      <td><a href="#No-4-クラスター-ホスト-仮想マシンのプロパティ画面">クラスター/ホスト/仮想マシンのプロパティ画面</a></td>      <td>お客様環境を把握するための情報です。取得対象は、問題が発生している [クラスター/ホスト/仮想マシン] のプロパティ画面です。</td>    </tr>    <tr>      <td style="text-align:center">5</td>      <td><a href="#No-5-SCVMM-エラーログ">SCVMM エラーログ</a></td>      <td>SCVMM にてエラーが発生した場合や、SCVMM コンソールがエラーで異常終了した場合の調査に使用します。</td>    </tr>    <tr>      <td style="text-align:center">6</td>      <td><a href="#No-6-イベントログ">イベントログ</a></td>      <td>不具合動作が発生した時間帯のイベントログを確認して、該当時間の OS や SCVMM の状態を確認します。</td>    </tr>  </tbody></table><h2 id="No-1-トレースログ"><a href="#No-1-トレースログ" class="headerlink" title="[No.1 トレースログ]"></a>[No.1 トレースログ]</h2><p>想定外の事象が発生した際に、事象を再現して、その間の動作を記録するトレースログは、原因調査で最も有益な情報になります。<br>トレースログの取得方法は下記の通りです。</p><p><b>■ 取得手順</b><br>SCVMM サーバーと問題が発生している仮想マシンの展開先仮想化ホストサーバー ( Hyper-V サーバー) において、以下の手順で並行して情報を採取してください。</p><ol><li>コマンド プロンプトを管理者として実行します。</li><li>VMM フォルダー（C:\VMMlogs）を作成します。</li><li>以下のコマンドを順番に実行して VMM トレースの採取を開始します。</li></ol><ul><li>事前準備 ①<br>【実施対象】 SCVMM サーバー<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logman delete VMM</span><br></pre></td></tr></table></figure>【実施対象】SCVMM サーバーおよび、問題が発生している仮想化ホストサーバー<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logman delete WinRM</span><br><span class="line">logman delete WMI</span><br></pre></td></tr></table></figure>(※) 上記コマンドを実行した際に “データ コレクター セットが見つかりませんでした。” というメッセージが表示される場合があります。特に問題ありませんので、そのまま進めてください。</li><li>事前準備 ②<br>【実施対象】 SCVMM サーバー<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logman create trace VMM -v mmddhhmm -ow -o C:\VMMlogs\%computername%_VMMLog.ETL -p Microsoft-VirtualMachineManager-Debug -nb 16 16 -bs 1024 -mode Circular -f bincirc -max 2048</span><br></pre></td></tr></table></figure>【実施対象】SCVMM サーバーおよび、問題が発生している仮想化ホストサーバー<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logman create trace WinRM -v mmddhhmm -ow -o C:\VMMlogs\%computername%_WinRM.ETL -p Microsoft-Windows-WinRM 0xffff 0x5 -nb 16 16 -bs 1024 -mode Circular -f bincirc -max 2048</span><br><span class="line">logman create trace WMI -v mmddhhmm -ow -o C:\VMMlogs\%computername%_WMI.ETL -p WMI_Tracing 0xffff 0x5 -nb 16 16 -bs 1024 -mode Circular -f bincirc -max 2048</span><br></pre></td></tr></table></figure>(※) “C:\VMMLogs” 直下に -max オプションにて、それぞれ最大2GBを上限値としてトレース ファイルを取得します。<br>実施の際は、事前に C ドライブの空き容量をご確認いただくか、容量の大きなドライブをご指定ください。</li><li>取得開始　( C:\VMMLogs フォルダ配下に etl ファイルが作成されます。 )<br>【実施対象】 SCVMM サーバー<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logman start VMM</span><br></pre></td></tr></table></figure>【実施対象】SCVMM サーバーおよび、問題が発生している仮想化ホストサーバー<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logman start WinRM</span><br><span class="line">logman start WMI</span><br></pre></td></tr></table></figure></li></ul><ol start="4"><li>事象の再現手順を実行します。<b><font color="red"> ※ この処理中のトレースログを解析に使用します。</font></b><br></li><li>以下のコマンドを順番に実行してトレースの採取を停止します。<br>【実施対象】 SCVMM サーバー<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logman stop VMM</span><br><span class="line">logman delete VMM</span><br></pre></td></tr></table></figure>【実施対象】SCVMM サーバーおよび、問題が発生している仮想化ホストサーバー<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logman stop WinRM</span><br><span class="line">logman stop WMI</span><br><span class="line">logman delete WinRM</span><br><span class="line">logman delete WMI</span><br></pre></td></tr></table></figure></li><li>以下のコマンドを各 etl ファイルに対して実行してトレースファイルをコンバートします（.txt ファイルが生成されます）。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh trace convert C:\VMMLogs\&lt;コンピューター名&gt;_&lt;各ETLファイル&gt;.etl</span><br></pre></td></tr></table></figure>(※) &lt;各 ETL ファイル&gt; には、WMI、WinRM、VMMLog と3種類ございます。</li><li>C:\VMMLogs フォルダを圧縮して、弊社までお寄せください。<br><br></li></ol><h2 id="No-2-ジョブ一覧"><a href="#No-2-ジョブ一覧" class="headerlink" title="[No.2 ジョブ一覧]"></a>[No.2 ジョブ一覧]</h2><p>SCVMM で実行したジョブが正常終了しなかった場合、ジョブ一覧を確認することで、実行したジョブと発生したエラー、エラーメッセージが確認できます。<br>ジョブ一覧の取得方法は下記の通りです。</p><p><b>■ 取得手順</b></p><ol><li>SCVMM 管理サーバーに管理者権限でログインします。</li><li>事前に、C ドライブの直下に “temp” という名前のフォルダを作成します。</li><li>スタートメニューより [Virtual Machine Manager Command Shell] を実行します。</li><li>以下のコマンドを実行します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SCJOB -All -Full | export-csv -path &quot;C:\temp\scjob.csv&quot; -encoding UTF8</span><br></pre></td></tr></table></figure></li><li>“temp” フォルダに出力された “scjob.csv” を弊社までお寄せください。<br><br></li></ol><h2 id="No-3-SCVMM-環境情報-SCVMM-サーバー情報-ホスト情報-仮想マシン情報"><a href="#No-3-SCVMM-環境情報-SCVMM-サーバー情報-ホスト情報-仮想マシン情報" class="headerlink" title="[No.3 SCVMM 環境情報 (SCVMM サーバー情報, ホスト情報, 仮想マシン情報)]"></a>[No.3 SCVMM 環境情報 (SCVMM サーバー情報, ホスト情報, 仮想マシン情報)]</h2><p>問題が発生している環境とご利用状況を把握する必要がある場合、SCVMM のバージョン情報、SCVMM で管理されているホストの情報、仮想マシンの情報をお送りいただいております。<br>各情報の取得方法は下記の通りです。</p><p><b>■ 取得手順</b></p><ol><li>SCVMM 管理サーバーに管理者権限でログインします。</li><li>事前に、C ドライブの直下に “temp” という名前のフォルダを作成します。</li><li>スタートメニューより [Virtual Machine Manager Command Shell] を実行します。</li><li>以下のコマンドを実行して SCVMM サーバー情報を取得します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SCVMMServer -ComputerName &quot;*** VMMサーバーのFQDN ***&quot; | export-csv -path C:\temp\VMMinfo.csv -encoding UTF8</span><br></pre></td></tr></table></figure>例）Get-SCVMMServer -ComputerName “VMMServer01.Contoso.com” | export-csv -path C:\temp\VMMinfo.csv -encoding UTF8</li><li>以下のコマンドを実行して SCVMM で管理しているホスト情報を取得します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-SCVMHost | export-csv -path C:\temp\Hostlist.csv -encoding UTF8</span><br><span class="line">Get-SCVMHostCluster | export-csv -path C:\temp\Clusterlist.csv -encoding UTF8</span><br><span class="line">Get-SCVMMManagedComputer | export-csv -path C:\temp\ManagedComputer.csv -encoding UTF8</span><br></pre></td></tr></table></figure></li><li>以下のコマンドを実行して SCVMM で管理している仮想マシンの情報を取得します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SCVirtualMachine | export-csv -path C:\temp\VirtualMachine.csv -encoding UTF8</span><br></pre></td></tr></table></figure></li><li>“temp” フォルダに出力された “VMMinfo.csv”, “Hostlist.csv”, “Clusterlist.csv”, “ManagedComputer.csv”, “VirtualMachine.csv” を弊社までお寄せください。<br><br></li></ol><h2 id="No-4-クラスター-ホスト-仮想マシンのプロパティ画面"><a href="#No-4-クラスター-ホスト-仮想マシンのプロパティ画面" class="headerlink" title="[No.4 クラスター/ホスト/仮想マシンのプロパティ画面]"></a>[No.4 クラスター/ホスト/仮想マシンのプロパティ画面]</h2><p>SCVMM で管理しているクラスターやホスト、仮想マシンでステータス異常などの警告が発生している場合、発生している警告と設定内容の確認のために該当のプロパティ画面の画面ショットをお送りいただいております。<br>各情報の取得方法は下記の通りです。<br><br><b>■ 取得手順</b></p><ol><li>SCVMM コンソールにログインします。</li><li>[VMとサービス] 画面を開きます。</li><li>警告が発生している対象を選択して、右クリックメニューからプロパティをクリックします。<br><img src="001.png"></li><li>プロパティ画面にて [全般] 画面、[状態] 画面を開き、画面ショットを取得します。<br>① <b>クラスター</b> の [全般] 画面と [状態] 画面<br><img src="002.png"><br>② <b>ホスト</b> の [全般] 画面と [状態] 画面<br>状態画面にて警告が表示されている場合、対象が分かる形で画面ショットを取得してください。<br>また、[エラーのコピー] ボタンにてコピーしたエラーメッセージを error.txt として保存してください。<br><img src="003.png"><br>③ <b>仮想マシン</b> の [全般] 画面と [状態] 画面<br>状態画面にて警告が表示されている場合、対象が分かる形で画面ショットを取得してください。<br>また、[エラーのコピー] ボタンにてコピーしたエラーメッセージを error.txt として保存してください。<br><img src="004.png"></li><li>取得いただいた画面ショットと error.txt を弊社までお寄せください。 <br><br></li></ol><h2 id="No-5-SCVMM-エラーログ"><a href="#No-5-SCVMM-エラーログ" class="headerlink" title="[No.5 SCVMM エラーログ]"></a>[No.5 SCVMM エラーログ]</h2><p>SCVMM にてエラーが発生した場合や、SCVMM コンソールがエラーで異常終了した場合、発生原因などの情報がエラーログに記載されることがあります。<br>エラーログの取得方法は下記の通りです。</p><p><b>■ 取得手順</b><br>本手順は以下のサーバーにて実施します。<br> - SCVMM サーバー<br> - SCVMM コンソールの異常終了が発生したサーバー<br> ※ SCVMM サーバー上で SCVMM コンソールが開かれていた場合、本ログは SCVMM サーバーのみから採取してください。</p><ol><li>対象のサーバーに管理者権限でログインします。</li><li>エクスプローラーを開き、下記のフォルダにアクセスします。<br>C:\ProgramData<br>既定では、<b>“ProgramData” フォルダ</b> は隠しフォルダに設定されています。<br>こちらのフォルダにアクセスされる場合は、エクスプローラー上で隠しフォルダを表示する設定を有効化してください。</li><li><ol start="2"><li>でアクセスしたフォルダ上に存在する <b>“VMMLogs” フォルダ</b> を圧縮して、弊社までお寄せください。<br>採取対象が複数台存在する場合、採取された対象が判別いただけるように “VMMLogs” の圧縮ファイルの名称を変更してください。<br>例えば、管理サーバーから採取された場合は “MS_VMMLogs”、仮想化ホストから採取された場合は “Host_VMMLogs” といった具合に変更します。<br><br></li></ol></li></ol><h2 id="No-6-イベントログ"><a href="#No-6-イベントログ" class="headerlink" title="[No.6 イベントログ]"></a>[No.6 イベントログ]</h2><p>SCVMM の処理の一部はイベントログに記録されますので、問題の解析のためにイベントログをお送りいただいております。<br>イベント ログの取得方法は下記の通りです。</p><p><b>■ 取得手順</b><br>本手順は、下記コンピューター上にて実施をお願いします。<br>・SCVMM サーバー<br>・問題が発生した仮想化ホストサーバー ( Hyper-V サーバー) </p><p>作業手順は下記弊社公開ドキュメントに沿って、イベント ログを「evt(x) 形式」と「csv 形式」の両方でエクスポートの実施をお願いします。<br><a href="https://learn.microsoft.com/ja-jp/security-updates/planningandimplementationguide/19871931">監査の管理 ‐ イベント ログの保存 | Microsoft Learn</a></p><p>取得対象のログは下記 7 点でございます。<br>　- Application<br>　- システム<br>　- セキュリティ<br>　- WinRM-Operational （VMM サーバーのみ）(※1)<br>　- WMIActivity-Operational (※1)<br>　- Admin (※2)<br>　- Operational (※2)</p><p>(※1) のログは [アプリケーションとサービス ログ] -&gt; [Microsoft] -&gt; [Windows] を展開すると表示されます。<br>(※1) のイベントログが表示されない場合、そのサーバーから (※1) のイベントログの採取は不要でございます。<br>(※2) のログは [アプリケーションとサービス ログ] -&gt; [Microsoft] -&gt; [VirtualMachineManager] -&gt; [Server] を展開すると表示されます。<br>(※2) のイベントログが表示されない場合、そのサーバーから (※2) のイベントログの採取は不要でございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;本記事は、System Center Virtual Machine Manager （以後、SCVMM） で発生したトラブルの調査を行う際に採取いただく機会が多いログ等の取得方法について解説します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
    <category term="トラブルシューティング" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0/"/>
    
    <category term="ログ収集" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%83%AD%E3%82%B0%E5%8F%8E%E9%9B%86/"/>
    
  </entry>
  
  <entry>
    <title>SCOM 管理サーバー構築手順 ～ 全画面ショット付き</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_Install_Manual/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_Install_Manual/</id>
    <published>2023-01-25T01:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.080Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。 </p><p>System Center Operations Manager（以後 SCOM） は 1,000 台を超えるような大規模な IT インフラの監視をサポートする製品であり、IT インフラ環境の構成、規模、運用要件に応じて導入が必要な SCOM コンポーネントとその台数が変わりますが、検証等の目的で簡易的に環境を最短で構築されたいケースもあります。<br>そういったケースに備えて、本記事では、1 台の Windows Server に SCOM の主コンポーネントの SCOM 管理サーバーと SCOM コンソールをインストールして、SCOM 管理コンソールにサインインできるまでの手順を画面ショット付きで紹介します。</p><span id="more"></span><h1 id="SCOM-導入の流れ"><a href="#SCOM-導入の流れ" class="headerlink" title="SCOM 導入の流れ"></a>SCOM 導入の流れ</h1><p>SCOM 導入の大まかな流れは下図の通りです。<br>最初に各種コンポーネントの導入を行い SCOM 環境を構築します。<br>SCOM 管理サーバーや SCOM コンソールなどの必須コンポーネントの導入の後、IT インフラ環境や監視要件に応じてオプション コンポーネントを導入します。<br>SCOM 環境の構築後、監視要件に合致した管理パックのインポートと監視対象機器の登録を行うことで監視が開始されます。<br>以降、運用フェーズにおいて監視設定等のチューニングを行います。<br><img src="001.png"></p><p>※ 構築フェーズの計画ガイド、運用フェーズのタスクについては、以下のマニュアル サイトをご参照ください。<br>　<a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-overview?view=sc-om-2022">Operations Manager 計画ガイド</a><br>　<a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-quick-reference?view=sc-om-2022">Operations Manager のタスクに関するクイック リファレンス</a></p><p>本記事では、1 台の Windows Server にデータベース、SCOM 2022 管理サーバー、SCOM コンソールをインストールする手順 (上の図の赤枠で囲った部分の作業) を画面ショット付きで紹介します。<br><span style="color: red; "><strong>ドメインに参加した Windows Server 2022  (メモリ 16 GB 以上)  を予め 1 台ご準備ください。</strong></span></p><h1 id="データーベース-Microsoft-SQL-Server-2019-の導入"><a href="#データーベース-Microsoft-SQL-Server-2019-の導入" class="headerlink" title="データーベース (Microsoft SQL Server 2019) の導入"></a>データーベース (Microsoft SQL Server 2019) の導入</h1><p>SCOM では、SCOM のシステム情報、監視設定情報、アラート情報、収集したパフォーマンスデータなどの保管にデーターベースを用います。<br>SCOM 管理サーバーをインストールする前に最初にデーターベースの準備が必要です。<br>使用するデーターベースは、Microsoft SQL Server 2019 ( ※累積的な更新プログラム 8 (CU8) 以降 ) をサポートします。<br>　<strong>ご参考：</strong><a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2022#sql-server-requirements">SQL Server の要件</a></p><p>SCOM 用の SQL Server のインストール手順は以下の通りです。</p><h2 id="1-SQL-Server-2019-のインストール-モジュールを準備"><a href="#1-SQL-Server-2019-のインストール-モジュールを準備" class="headerlink" title="1. SQL Server 2019 のインストール モジュールを準備"></a>1. SQL Server 2019 のインストール モジュールを準備</h2><p><em>① SQL Server 2019 のインストーラー</em>と <em>② CU8 以降の累積的な更新プログラム</em>をダウンロードして、SCOM をインストールする Windows Server 内にコピーします。<br><img src="004.png"></p><p><em>① SQL Server 2019 のインストーラー (評価版)</em> は <a href="https://www.microsoft.com/ja-jp/sql-server/sql-server-downloads">SQL Server のダウンロード</a> よりダウンロードできます。<br><img src="002.png"></p><p>ダウンロードした EXE ファイル (SQL2019-SSEI-Eval.exe) を管理者で実行すると以下の画面が表示されます。<br>メディアのダウンロードをクリックすることで、ISO ファイル形式のインストーラーをダウンロードできます。<br><img src="003.png"></p><p><em>② SQL Server 2019 の累積的な更新プログラム</em>は <a href="https://www.microsoft.com/ja-JP/download/details.aspx?id=100809">Download SQL Server® 2019 for Microsoft® Windows の最新の累積的な更新プログラム</a> よりダウンロードできます。<br>本記事では、掲載日時点で最新の CU 18 を使用します。 </p><h2 id="2-SQL-Server-2019-のインストール"><a href="#2-SQL-Server-2019-のインストール" class="headerlink" title="2. SQL Server 2019 のインストール"></a>2. SQL Server 2019 のインストール</h2><p>インストールファイルの準備ができましたら、実際にインストールを実行します。</p><ol><li><p>SCOM をインストールする Windows Server にドメイン管理者でサインインします。</p></li><li><p>SQL Server 2019 のインストーラーを選択して、右クリック メニューでマウントします。<br><img src="005.png"></p></li><li><p>マウント先のドライブで setup.exe を選択して、右クリック メニューの [管理者として実行] をクリックします。<br><img src="006.png"></p></li><li><p>インストール画面を表示して、[SQL Server の新規スタンドアロン インストールを実行するか、既存のインストールに機能を追加] をクリックします。<br><img src="007.png"></p></li><li><p>本記事では Evaluation のまま [次へ] ボタンをクリックして進みます。<br><img src="008.png"></p></li><li><p>ライセンス条項を確認して、 [次へ] ボタンをクリックして進みます。<br><img src="009.png"></p></li><li><p>本記事では [Microsoft Update を使用して更新プログラムを確認する] は未チェックのまま [次へ] ボタンをクリックして進みます。<br><img src="010.png"></p></li><li><p>事前検証でエラーが無いことを確認します。<br>[Windows ファイアウォール] の警告が出ていますが、本記事では SCOM 管理サーバーを同一サーバーにインストールするため SQL Server へのリモート接続は必須ではないことから、このまま [次へ] ボタンをクリックして進みます。<br><img src="011.png"></p></li><li><p>SCOM に必須の [データーベース エンジン サービス] と [検索のためのフルテキスト抽出とセマンティック抽出] を選択して  [次へ] ボタンをクリックして進みます。<br><img src="012.png"></p></li><li><p>本記事では [既定のインスタンス] のまま [次へ] ボタンをクリックして進みます。<br><img src="013.png"></p></li><li><p>[サーバーの構成] の [サービス アカウント] タブ画面で [SQL Server エージェント] と [SQL Server Browser] のスタートアップの種類を [自動] にします。<br>また、[SQL Server データベース エンジン サービスにボリューム メンテナンス タスクを実行する特権を付与する] にチェックします。<br><img src="014.png"></p></li><li><p>[サーバーの構成] の [照合順序] タブ画面で<a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2022#windows-collation">サポートされた日本語の照合順序</a>  ( Japanese_CI_AS、もしくは Japanese_XJIS_100_CI_AS ) が指定されていることを確認して  [次へ] ボタンをクリックして進みます。<br><img src="015.png"></p></li><li><p>本記事では認証モードは [Windows 認証モード] を選択し、SQL Server 管理者には [現在のユーザーの追加] ボタンをクリックして、インストール作業を実行しているユーザーを設定します。<br>その他の設定はそのまま   [次へ] ボタンをクリックして進みます。<br><img src="016.png"></p></li><li><p>[インストール] ボタンをクリックして、インストールを実行します。<br><img src="017.png"></p></li><li><p>完了画面に表示された [状態] がすべて [成功] になっていることを確認して [閉じる] ボタンをクリックします。<br>以上で SQL Server 2019 インスタンスの準備は完了です。<br><img src="018.png"></p></li></ol><h2 id="3-SQL-Server-2019-の累積的な更新プログラム-CU18-を適用する。"><a href="#3-SQL-Server-2019-の累積的な更新プログラム-CU18-を適用する。" class="headerlink" title="3. SQL Server 2019 の累積的な更新プログラム ( CU18 ) を適用する。"></a>3. SQL Server 2019 の累積的な更新プログラム ( CU18 ) を適用する。</h2><ol><li><p>更新プログラムのインストーラーを選択して、右クリック メニューの [管理者として実行] をクリックします。<br><img src="019.png"></p></li><li><p>ライセンス条項を確認して、 [次へ] ボタンをクリックして進みます。<br><img src="020.png"></p></li><li><p>MSSQLSERVER にチェックが付いていることを確認して、 [次へ] ボタンをクリックして進みます。<br><img src="021.png"></p></li><li><p>ファイルの確認が完了したら、 [次へ] ボタンをクリックして進みます。<br><img src="022.png"></p></li><li><p>[更新] ボタンをクリックして、更新プログラムのインストールを実行します。<br><img src="023.png"></p></li><li><p>完了画面に表示された [状態] がすべて [成功] になっていることを確認して [閉じる] ボタンをクリックします。<br>以上で SCOM 用の データーベースの準備は完了です。<br><img src="024.png"></p></li></ol><p>※ 以下の警告が表示された場合は、更新プログラムのインストール完了後、一度 Windows Server を再起動します。<br><img src="025.png"></p><p>==================<span style="font-size: 80%;"><br>【補足】<br>検証用の SCOM 管理サーバーの最短構築に際しては必須ではありませんが、SQL Server の管理に有用な <strong>SQL Server Management Studio (SSMS)</strong> はインストールされることを推奨します。<br>SSMS は、<a href="https://learn.microsoft.com/ja-jp/sql/ssms/download-sql-server-management-studio-ssms?redirectedfrom=MSDN&view=sql-server-ver16#download-ssms">SQL Server Management Studio (SSMS) のダウンロード</a> からダウンロードできます。<br></span>==================</p><h1 id="SCOM-管理サーバーと-SCOM-コンソールのインストール"><a href="#SCOM-管理サーバーと-SCOM-コンソールのインストール" class="headerlink" title="SCOM 管理サーバーと SCOM コンソールのインストール"></a>SCOM 管理サーバーと SCOM コンソールのインストール</h1><p>データーベースの準備が完了したら、いよいよ SCOM 管理サーバーと SCOM コンソールのインストールです。<br>詳細な手順については、以下のマニュアル サイトをご参照ください。<br>・<a href="https://learn.microsoft.com/ja-jp/system-center/scom/deploy-install-mgmt-server?view=sc-om-2022">Operations Manager 管理サーバーをインストールする方法</a><br>・<a href="https://learn.microsoft.com/ja-jp/system-center/scom/deploy-install-ops-console?view=sc-om-2022">オペレーション コンソールをインストールする方法</a></p><p>SCOM 管理サーバーと SCOM コンソールのインストール手順は以下の通りです。</p><h2 id="1-SCOM-2022-のインストール-モジュールを準備"><a href="#1-SCOM-2022-のインストール-モジュールを準備" class="headerlink" title="1. SCOM 2022 のインストール モジュールを準備"></a>1. SCOM 2022 のインストール モジュールを準備</h2><ol><li><p>Microsoft Evaluation Center の <a href="https://www.microsoft.com/ja-JP/evalcenter/download-system-center-2022">System Center 2022 | Microsoft Evaluation Center</a> からインストール ファイル [SCOM_2022.exe] をダウンロードします。<br><img src="026.png"></p></li><li><p>ダウンロードしたファイルを SCOM をインストールする Windows Server 内にコピーします。<br><img src="027.png"></p></li></ol><h2 id="2-インストール-ファイルを解凍する"><a href="#2-インストール-ファイルを解凍する" class="headerlink" title="2. インストール ファイルを解凍する"></a>2. インストール ファイルを解凍する</h2><ol><li><p>SCOM をインストールする Windows Server にドメイン管理者でサインインします。</p></li><li><p>SCOM 2022 のインストーラーを選択して、右クリック メニューの [管理者として実行] をクリックします。<br><img src="028.png"></p></li><li><p>インストール ファイル解凍ウィザードが開きますので、[Next] ボタンをクリックして進みます。<br><img src="029.png"></p></li><li><p>ライセンス条項を確認して、 [Next] ボタンをクリックして進みます。<br><img src="030.png"></p></li><li><p>インストール ファイルの解凍先を確認して、 [Next] ボタンをクリックして進みます。<br><img src="031.png"></p></li><li><p>[Extract] ボタンをクリックして解凍を実行します。<br><img src="032.png"></p></li><li><p>[Finish] ボタンをクリックして、ウィザードを閉じます。<br><img src="033.png"><br>[C:\System Center Operations Manager] フォルダ配下にインストール用ファイルが展開されていることが確認できます。<br><img src="034.png"></p></li></ol><h2 id="3-SCOM-管理サーバーと-SCOM-コンソールのインストール"><a href="#3-SCOM-管理サーバーと-SCOM-コンソールのインストール" class="headerlink" title="3. SCOM 管理サーバーと SCOM コンソールのインストール"></a>3. SCOM 管理サーバーと SCOM コンソールのインストール</h2><ol><li><p>SCOM をインストールする Windows Server にドメイン管理者でサインインします。</p></li><li><p>[C:\System Center Operations Manager] フォルダ配下の [Setup.exe] を選択して、右クリック メニューの [管理者として実行] をクリックします。<br><img src="035.png"></p></li><li><p>インストール ウィザードが起動するので、[インストール] をクリックします。<br><img src="036.png"></p></li><li><p>インストールする機能の選択画面で [Management サーバー] と [オペレーション コンソール] にチェックを入れて、[次へ] ボタンをクリックして進みます。<br>[Management サーバー] が SCOM 管理サーバー、[オペレーション コンソール] が SCOM コンソールです。<br>オプション機能の [Web コンソール] と [レポート サーバー] は本記事では外します。<br><img src="037.png"></p></li><li><p>インストール先フォルダを指定して、[次へ] ボタンをクリックして進みます。<br>標準のインストール先は [C:\Program Files\Microsoft System Center\Operations Manager] です。<br><img src="051.png"></p></li><li><p>前提条件の確認画面でエラーが表示されていないことを確認して、[次へ] ボタンをクリックして進みます。<br><img src="038.png"><br>※ Windows Update の実施後など、サーバーが再起動を控えている状態の場合、Windows の再起動を促す警告が表示されます。<br>警告を無視して [次へ] ボタンをクリックしてそのまま進めても問題なくインストールが完了する場合もありますが、Windows の再起動を促す警告が表示された場合は、念のため Windows の再起動を行ってください。</p></li><li><p>管理グループ名を入力して、[次へ] ボタンをクリックして進みます。<br>ここでは管理グループ名を [SCOM2022] とします。<br><img src="039.png"></p></li><li><p>ライセンス条項を確認して、 [次へ] ボタンをクリックして進みます。<br><img src="040.png"></p></li><li><p>これから SQL Server 上に SCOM で使用するデーターベースを 2 つ構成します。<br>1 つ目は <em>オペレーション データベース (データーベース名：OperationsManager)</em> です。<br>既定のインスタンスとして SQL Server をインストールしましたので、[ サーバー名とインスタンス名] にはサーバーのコンピューター名だけを入力して、 [次へ] ボタンをクリックして進みます。<br><img src="041.png"></p></li><li><p>次に<em>データ ウェアハウス データベース  (データーベース名：OperationsManagerDW)</em> の構成を入力します。<br>既定のインスタンスとして SQL Server をインストールしましたので、[ サーバー名とインスタンス名] にはサーバーのコンピューター名だけを入力して、 [次へ] ボタンをクリックして進みます。<br><img src="042.png"></p></li><li><p>[Operations Manager アカウントの構成] 画面でアカウント情報を入力して、 [次へ] ボタンをクリックして進みます。<br>本記事では、サーバーの管理者でかつ SQL Server インストール時に SQL Server の管理者に設定したドメイン管理者を指定しました。<br><img src="043.png"><br>※ ドメイン管理者を指定した場合、以下の警告が表示されます。<br><img src="044.png"><br>今回は検証環境構築が目的のため [OK] ボタンをクリックしてこのまま進めますが、以下のマニュアルサイトをご参考に必要に応じて SCOM 専用のアカウントをご準備ください。<br>　<strong>ご参考：</strong><a href="https://learn.microsoft.com/ja-jp/system-center/scom/deploy-overview?view=sc-om-2022#operations-manager-administrators-role-assignment">System Center Operations Manager の展開 | 必要なアカウント</a></p></li><li><p>[診断と使用状況のデータ] を確認して、 [次へ] ボタンをクリックして進みます。<br><img src="045.png"></p></li><li><p>本記事では [Microsoft Update] は [オフ] を選択して [次へ] ボタンをクリックして進みます。<br><img src="046.png"></p></li><li><p>[インストールの要約] を確認して、 [インストール] ボタンをインストールします。<br><img src="047.png"></p></li><li><p>完了画面でエラーが出ていないことを確認して、[閉じる] ボタンをクリックしてウィザードを閉じます。<br>評価版をインストールしましたので、ライセンス入手後に適用する方法が警告表示されます。<br>また、コンピューターを再起動する必要がある旨の警告が表示されますので、一度、Windows を再起動します。<br><img src="048.png"></p></li></ol><p>以上で、SCOM 管理サーバーと SCOM コンソールのインストールが完了です。 </p><h1 id="SCOM-コンソールを起動して-SCOM-にログインする"><a href="#SCOM-コンソールを起動して-SCOM-にログインする" class="headerlink" title="SCOM コンソールを起動して SCOM にログインする"></a>SCOM コンソールを起動して SCOM にログインする</h1><ol><li><p>SCOM をインストールした Windows Server にドメイン管理者でサインインします。</p></li><li><p>スタートメニューから [Microsoft System Center] -&gt; [Operations Console] をクリックします。<br><img src="049.png"></p></li><li><p>SCOM コンソールにログインします。<br>Windows Server に SCOM のインストールで使用したドメイン管理者でサインインした場合は、自動的に SCOM コンソールにログインできます。<br><img src="050.png"></p></li></ol><hr><p>以上で、SCOM 管理サーバーを導入して、SCOM コンソールにログイン可能になりました。</p><p>このあと、[管理] 画面で監視要件に合わせて<a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-mp-import-remove-delete?view=sc-om-2022">管理パックのインポート</a>を行います。<br>その後、監視機器を登録することで監視が開始されます。<br>これらの手順についても、今後ブログで紹介したいと考えております。</p><p><strong>ご参考：</strong> <a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-monitoring-scenarios?view=sc-om-2022">Operations Manager の監視シナリオ</a><br>　　　　<a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-mp-import-remove-delete?view=sc-om-2022">Windows 上のエージェントの検出とインストール</a><br>　　　　<a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-deploy-crossplat-agent-console?view=sc-om-2022">UNIX および Linux 上のエージェントの検出とインストール</a></p><p><a href="#SCOM-%E5%B0%8E%E5%85%A5%E3%81%AE%E6%B5%81%E3%82%8C">SCOM 導入の流れ</a> で記載しました通り、SCOM にはインフラ環境、監視要件によって導入が必要なオプション コンポーネントが存在します。<br>長期レポートを参照するために必要な 『レポート機能』 やパフォーマンス データやアラートの確認だけを行うSCOM の一般操作者が存在する場合に便利な 『Web コンソール』機能などは、多くのお客様環境でご利用いただいているコンポーネントです。<br>また、メンテナンス時の可用性や耐障害性を考慮して、複数台の SCOM 管理サーバーを導入して管理グループを構成することや、データーベースを SQL Server AlwaysOn 可用性グループで構成するなど、オール イン ワン以外の構成も存在します。<br>SCOM 環境の構成についても、要件定義や初期の設計フェーズにおいて検討いただければと存じます。</p><p>本番環境の構築においては多数の考慮事項がございますが、まずは今回の手順を進めていただくことで SCOM コンソールにログインすることができたと思います。<br>実際に SCOM コンソールにログインして、SCOM の画面構成、機能、操作性など検証いただければ幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。 &lt;/p&gt;
&lt;p&gt;System Center Operations Manager（以後 SCOM） は 1,000 台を超えるような大規模な IT インフラの監視をサポートする製品であり、IT インフラ環境の構成、規模、運用要件に応じて導入が必要な SCOM コンポーネントとその台数が変わりますが、検証等の目的で簡易的に環境を最短で構築されたいケースもあります。&lt;br&gt;そういったケースに備えて、本記事では、1 台の Windows Server に SCOM の主コンポーネントの SCOM 管理サーバーと SCOM コンソールをインストールして、SCOM 管理コンソールにサインインできるまでの手順を画面ショット付きで紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="インストール" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB/"/>
    
  </entry>
  
  <entry>
    <title>DCOM の脆弱性 (CVE-2021-26414) に対応する更新プログラムの SCOM への影響について</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_DCOM_influence/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_DCOM_influence/</id>
    <published>2022-11-28T04:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.080Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 石原 です。 </p><p> System Center Operations Manager（以後 SCOM） では、Windows サーバーの管理における一部の処理で<strong>分散コンポーネントオブジェクトモデル/Distributed Component Object Model（DCOM）</strong> の通信を用います。<br>インフラ内に <strong>DCOM の脆弱性 (CVE-2021-26414)</strong> に対応する更新プログラムが未適用の Windows サーバーが混在する場合、SCOM での管理に影響するケースがございます。<br>本日は、DCOM の脆弱性 (CVE-2021-26414) に対応する更新プログラムの SCOM への影響についてご説明いたします。</p><h2 id="SCOM-管理サーバーと管理対象の-Windows-サーバー間の-DCOM-通信について"><a href="#SCOM-管理サーバーと管理対象の-Windows-サーバー間の-DCOM-通信について" class="headerlink" title="SCOM 管理サーバーと管理対象の Windows サーバー間の DCOM 通信について"></a>SCOM 管理サーバーと管理対象の Windows サーバー間の DCOM 通信について</h2><p>SCOM 管理サーバーと管理対象の Windows サーバー間の通信の大部分は、エージェントが収集したデータを SCOM 管理サーバーに送信するものです。<br>その際に用いる通信ポートは、エージェントから SCOM 管理サーバーに対して <strong>TCP 5723</strong> が使用されます。<br>※ <a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-planning-agent-deployment?view=sc-om-2022#communication-between-agents-and-management-servers">エージェントと管理サーバー間の通信</a><br><img src="001.png"></p><p>一方で、エージェントから SCOM 管理サーバーへの TCP 5723 以外の通信が発生するタイミングもございます。<br>例えば、SCOM コンソールからエージェントを管理する際 （ エージェントのプッシュ インストール、修復、削除）や エージェント サーバーへのハートビート通信などです。<br>SCOM の各コンポーネント間で使われる通信ポートについては、詳しくは <a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-security-config-firewall?view=sc-om-2022">Operations Manager 用のファイアウォールの構成</a> に記載しています。</p><p>SCOM では、この SCOM コンソールからエージェントを管理 （ エージェントのプッシュ インストール、修復、削除） に際して DCOM 通信 が用いられます。<br>エージェントをプッシュ インストールする事前準備として、対象の Windows サーバーの OS 情報などを WMI クエリにて取得したり、対象サーバーの管理共有のフォルダに一時的にエージェントのインストール ファイルを配置しますが、これらの処理に DCOM 通信を用います。<br>詳しくは <a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-planning-agent-deployment?view=sc-om-2022#agent-deployment-to-windows-system">Windows システムへのエージェントの展開</a> に記載しています。</p><h2 id="DCOM-の脆弱性-CVE-2021-26414-に対応する更新プログラムの適用状況に応じた通信可否"><a href="#DCOM-の脆弱性-CVE-2021-26414-に対応する更新プログラムの適用状況に応じた通信可否" class="headerlink" title="DCOM の脆弱性 (CVE-2021-26414) に対応する更新プログラムの適用状況に応じた通信可否"></a>DCOM の脆弱性 (CVE-2021-26414) に対応する更新プログラムの適用状況に応じた通信可否</h2><p>以下の公開情報に記載の通り、 DCOM の脆弱性（CVE-2021-26414）への対応として、2021 年 6 月 8 日以降に公開された更新プログラムが適用されている環境では、本脆弱性に対応している高い認証レベルで DCOM 通信が行われるようになります。また、2022 年 6 月 14 日以降に公開された更新プログラムが適用されている接続先の環境に対しては、低い認証レベルで通信が行われた際には、通信が拒否され、エラーイベント （SYSTEM Event ID：10036, ソース：DistributedCOM） が記録される動作となります。</p><p> [公開情報]<br>　<a href="https://msrc-blog.microsoft.com/2021/06/08/20210609_dcomenrocement/">[IT管理者向け] DCOM の脆弱性 (CVE-2021-26414) に対応するためのガイダンス</a></p><p><strong>更新プログラムが適用されている接続先の環境に対して接続する対処策は 2つあります。</strong><br>　① 接続元に更新プログラムが適用して高い認証レベルで通信可能にする。<br>　② 接続先サーバーにてセキュリティ強化の変更を無効にするレジストリ設定を行い、低い認証レベルで通信可能にする。</p><p>①について、ブログ掲載日時点 （ 2022年11月28日 ） で Windows Server 2019 向けに公開されている最新の更新プログラムは KB5019966 となります。<br> [公開情報]<br>　<a href="https://support.microsoft.com/en-us/topic/november-8-2022-kb5019966-os-build-17763-3650-b09dad62-5cd7-47cd-992f-b7d01f2956c1">2022 年 11 月 8 日 — KB5019966 (OS ビルド 17763.3650)</a></p><p>②について、以下のサイトにセキュリティ強化の変更を無効にするレジストリ設定について記載しています。<br> [公開情報]<br>　<a href="https://support.microsoft.com/ja-jp/topic/kb5004442-windows-dcom-server-%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E6%A9%9F%E8%83%BD%E3%83%90%E3%82%A4%E3%83%91%E3%82%B9%E3%81%AE%E5%A4%89%E6%9B%B4%E3%82%92%E7%AE%A1%E7%90%86%E3%81%99%E3%82%8B-cve-2021-26414-f1400b52-c141-43d2-941e-37ed901c769c">KB5004442 - Windows DCOM Server セキュリティ機能バイパスの変更を管理する (CVE-2021-26414)</a></p><p>いずれの方法でも DCOM 通信が可能になりますが、② は DCOM の脆弱性対応が実施できていないことになりますので、基本的には ① の接続元サーバーへ更新プログラムを適用する方法を検討してください。<br>更新プログラムが適用したサーバーから更新プログラム未適用のサーバーに対しては低い認証レベルで通信します。</p><p>DCOM の脆弱性 (CVE-2021-26414) に対応する更新プログラムの適用状況に応じた通信可否を纏めると以下の図の通りです。<br><img src="002.jpg"></p><h2 id="SCOM-環境における影響について"><a href="#SCOM-環境における影響について" class="headerlink" title="SCOM 環境における影響について"></a>SCOM 環境における影響について</h2><p>SCOM では、SCOM コンソールからエージェントを管理する際 （ エージェントのプッシュ インストール、修復、削除） に DCOM 通信を用います。<br>SCOM 管理サーバーに DCOM の脆弱性（CVE-2021-26414）への対応として 2021 年 6 月 8 日以降に公開された更新プログラムが適用されていない場合、更新プログラムを適用したサーバーへのエージェントのプッシュ インストールを試みると以下のエラーで失敗します。<br><img src="003.png"></p><p>インストール対象のサーバー側に以下のイベントログが出力されています。<br>更新プログラム未適用のサーバー ( 今回は SCOM 管理サーバー ) から更新プログラム適用済みのサーバーに対して低い認証レベルで DCOM 通信が試行された結果、通信が拒否されたことが分かります。</p><p>==================<br><span style="font-size: 80%;"><span style="color: red; ">ログの名前:System</span><br>ソース:Microsoft-Windows-DistributedCOM<br>日付:2022/11/11 19:53:07<br><span style="color: red; ">イベント ID:10036</span><br>タスクのカテゴリ:なし<br>レベル:エラー<br>キーワード:クラシック<br>ユーザー:HYPERVDOMAIN\administrator<br>コンピューター:win19dcomsrv.hypervdomain.local<br>説明:<br><span style="color: red; ">The server-side authentication level policy does not allow </span>the user HYPERVDOMAIN\Administrator SID (S-1-5-21-462977349-3622049776-211427293-500) from address 172.16.1.41 to activate DCOM server. <span style="color: red; ">Please raise the activation authentication level at least to RPC_C_AUTHN_LEVEL_PKT_INTEGRITY in client application.</span></span><br>==================</p><p>接続先サーバーにてセキュリティ強化の変更を無効にするレジストリ設定を行うことでエージェントのプッシュ インストールが成功しますが、この方法の場合、そのサーバーは DCOM の脆弱性対応が実施できていないことになります。<br>また、更新プログラム適用済みの対象サーバーが多数存在する場合、それらすべてのサーバーのレジストリ設定を行う必要があり、運用負荷が大きくなります。</p><p>ですので、基本的には SCOM 管理サーバーに更新プログラムを適用することを推奨します。<br>SCOM 管理サーバーに更新プログラムを適用することで、更新プログラム適用済みのサーバーに対しては高い認証レベルで DCOM 通信を行い、更新プログラム未適用のサーバーに対しては低い認証レベルで DCOM 通信を行い、エージェントのプッシュ インストールが成功します。</p><hr><p>今回の内容は、長期間 Windows Update による更新プログラムの適用をされていない SCOM 管理サーバーをご利用されている場合に直面しやすい問題です。<br>新規に Windows Server を導入される際は、最初に Windows Update を実施して更新プログラムを適用されるケースが多いと存じます。<br>そういった新規導入の Windows Server を SCOM の管理対象に加える際に、エージェントのプッシュ インストールが失敗して発覚するためです。</p><p>本事象に直面された場合は、Windows Update による更新プログラムの適用をご検討ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。 &lt;/p&gt;
&lt;p&gt; System Center Operations Manager（以後 SCOM） では、Windows サーバーの管理における一部</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="CVE-2021-26414" scheme="https://jpsystemcenter.github.io/blog/tags/CVE-2021-26414/"/>
    
  </entry>
  
  <entry>
    <title>UNIX/Linuxログファイルの監視をカスタマイズして、個別のアラートとして全件検知する方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_Log_Monitor/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_Log_Monitor/</id>
    <published>2022-11-28T03:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.092Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 石原 です。 </p><p> System Center Operations Manager（以後 SCOM） には<strong>製品標準の管理パック テンプレート</strong>に <strong>[UNIX/Linuxログファイルの監視]</strong> があります。<br>[UNIX/Linuxログファイルの監視] を用いることで、UNIX/Linux サーバー内のログファイルに指定の文字列が出力された際にアラートを生成するログファイル監視を設定することができます。<br>SCOM は 5分間隔でログファイル内の文字列の存在チェックを行い、指定文字列が存在していた場合にアラートを発生させます。<br>既にアラート発生中の場合、発生中のアラートの繰り返し回数をカウントアップすることで、同じアラートが多数発生しないように制御しています。<br>本日は、この [UNIX/Linuxログファイルの監視] をカスタマイズして、指定文字列が出力されるたびに全件、個別のアラートとする手順を紹介いたします。</p><p>―――<span style="color: red; ">ご注意</span><span style="font-size: 80%;">―――――――――――――――――――――――――――<br>以下にご案内します<a href="#UNIX-Linux%E3%83%AD%E3%82%B0%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E7%9B%A3%E8%A6%96-%E3%82%92%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA%E3%81%97%E3%81%A6%E5%85%A8%E4%BB%B6%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E7%94%9F%E6%88%90%E3%81%95%E3%81%9B%E3%82%8B">UNIX-Linuxログファイルの監視-をカスタマイズ</a> は、管理パックを直接編集する手順となります。<br>管理パックを直接編集する手順は注意が必要です。<br>本設定によって SCOM の動作に不備が発生した場合、設定実施前の状態の管理パックをインポートしてください。<br>こちらの点から、設定実施前の管理パックは別途バックアップとして個別にファイルを保存いただくことを推奨いたします。</span><br>―――――――――――――――――――――――――――</p><h2 id="UNIX-Linuxログファイルの監視-の設定手順と標準の動作"><a href="#UNIX-Linuxログファイルの監視-の設定手順と標準の動作" class="headerlink" title="[UNIX/Linuxログファイルの監視] の設定手順と標準の動作"></a>[UNIX/Linuxログファイルの監視] の設定手順と標準の動作</h2><p><strong>最初に通常の手順でログファイル監視を設定します。</strong></p><ol><li><p>SCOM コンソールにログインして、画面左下ペインの [作成] をクリックして、画面右ペインから [監視の追加ウィザード] をクリックします。<br><img src="000.png"></p></li><li><p>監視の種類で [UNIX/Linuxログファイルの監視] を選択して [次へ] をクリックします。</p></li><li><p>[管理パック] は <em>[新規] ボタンをクリック</em>して、専用の新規の管理パックを作成・指定して [次へ] をクリックします。<br>※後述の手順で、このルールをエクスポートしてカスタマイズし、再インポートする手順があります。<br>　その手順に備えて本ルール専用の管理パックを作成しておくことで、他の設定に影響しないようにします。<br><img src="001.png"></p></li><li><p>[ログ ファイルの監視の詳細] ページでは、監視設定、ログファイルのパス、式などを設定して [次へ] をクリックします。<br><img src="002.png"></p></li><li><p>[概要] ページで概要を確認して [作成] ボタンをクリックします。</p></li></ol><p><strong>以上で通常の [UNIX/Linuxログファイルの監視] の設定は完了です。</strong></p><p>ログファイルに対象の文字列が出力されるとアラートが生成されます。<br>生成されたアラートは [アクティブなアラート] 画面で確認できます。<br>SCOM は <em>5分間隔でログファイル内の文字列の存在チェック</em>しますので、その間に条件に合致する行が複数行存在した場合、以下のようにまとめて検知します。<br><img src="003.png"></p><p>SCOM コンソールでアラートを閉じる前に再度、同じ文字列が出力された場合、発生中のアラートの<strong>繰り返し回数</strong>をカウントアップします。<br>この<strong>繰り返し回数</strong>を [アクティブなアラート] 画面で確認するためには、[ビューの個人用設定] で [繰り返し回数] を表示するようにします。<br><img src="004.png"></p><p>繰り返し回数がカウントアップされていることが分かります。<br><img src="005.png"></p><h2 id="UNIX-Linuxログファイルの監視-をカスタマイズして全件アラート生成させる"><a href="#UNIX-Linuxログファイルの監視-をカスタマイズして全件アラート生成させる" class="headerlink" title="[UNIX/Linuxログファイルの監視] をカスタマイズして全件アラート生成させる"></a>[UNIX/Linuxログファイルの監視] をカスタマイズして全件アラート生成させる</h2><p><strong>標準の [UNIX/Linuxログファイルの監視] をカスタマイズ</strong>して、ログファイルに対象の文字列が出力されるごとに個別のアラートが生成されるようにします。</p><ol><li><p>SCOM コンソールの画面左下ペインの [管理] をクリックして [管理] 画面を開きます。</p></li><li><p>[管理] -&gt; [管理パック] -&gt; [インストール済み管理パック] を選択し、画面中央の管理パック一覧から前述の No.3 で作成した [ログファイル監視用管理パック] を選択します。</p></li><li><p>画面右ペインから [管理パックのエクスポート] をクリックして、任意の場所に管理パックをエクスポートします。<br><img src="006.png"></p></li><li><p>エクスポートした管理パック ファイル （拡張子は xml です） をテキストエディターで開いて以下の3行を削除して上書き保存します。</p></li></ol><p><strong>XML ファイルの該当箇所</strong></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Suppression&gt;</span><br><span class="line">&lt;SuppressionValue /&gt;</span><br><span class="line">&lt;/Suppression&gt;</span><br></pre></td></tr></table></figure><p><img src="007.png"></p><ol start="5"><li>[インストール済み管理パック] 画面で [管理パックのインポート] をクリックします。</li><li>[追加] -&gt; [ディスクから追加する] をクリックして、No.4 でカスタマイズした管理パック ファイル （ xml ファイル） を選択します。</li><li>[インストール] ボタンをクリックして、カスタマイズした管理パックをインストールします。<br><img src="008.png"></li></ol><p>このカスタマイズにより、既にアラートが発生中に同じ文字列がログファイルに出力された場合、SCOM は既存のアラートの繰り返し回数をカウントアップするのではなく、別のアラートが生成されます。<br><img src="009.png"></p><h2 id="ルールの設定をオーバーライドして纏められたデータを個別のアラートとして生成する"><a href="#ルールの設定をオーバーライドして纏められたデータを個別のアラートとして生成する" class="headerlink" title="ルールの設定をオーバーライドして纏められたデータを個別のアラートとして生成する"></a>ルールの設定をオーバーライドして纏められたデータを個別のアラートとして生成する</h2><p>SCOM は <em>5分間隔でログファイル内の文字列の存在チェック</em>しますので、その間に条件に合致する行が複数行存在した場合、それらをまとめて検知します。<br>この仕様は標準の [UNIX/Linuxログファイルの監視] をカスタマイズしても同様で、以下の通りまとめて検知されます。<br><img src="010.png"></p><p><strong>これらの纏められたアラートについて、[ルール] の [個別のアラート] をオーバーライドすることで、個別のアラートとして生成することができます。</strong><br>[ルール] の [個別のアラート] をオーバーライドする手順は以下の通りです。</p><ol><li><p>SCOM コンソールの画面左下ペインの [作成] をクリックして [作成] 画面を開きます。</p></li><li><p>[作成] -&gt; [管理パック オブジェクト] -&gt; [ルール] を選択して、検索欄に [ログファイル監視用管理パック] と入力して検索します。</p></li><li><p>[Unix/Linux コンピューター] 内のルールを選択して、画面右ペインから [オーバーライド] をクリックします。<br><img src="011.png"></p></li><li><p>[オーバーライド] -&gt; [ルールのオーバーライド] -&gt; [クラス UNIX/Linux コンピューターの特定のオブジェクト] を選択します。</p></li><li><p>ログファイル監視を行うコンピューターを選択して、オーバーライドのプロパティ画面を開きます。</p></li><li><p><strong>[個別のアラート]</strong> を <strong>[真]</strong> に設定して、 [適用] -&gt; [OK] をクリックして、オーバーライド設定を保存します。<br><img src="012.png"></p></li></ol><p>以上の設定により、指定の文字列がログファイルに出力されるたびに、たとえ短時間に条件に合致するログが複数出力された場合も纏められることもなく、全件、個別のアラートとして生成されます。<br><img src="013.png"></p><hr><p>いかがでしょうか。</p><p>標準の [UNIX/Linuxログファイルの監視] は、検知した事象の対処が完了してアラートを手動で閉じるまでは、対象のログを再検知しても同じアラートが多数発生しないように制御しています。<br>基本的にはこの仕様が多くの現場の運用に最も適すると考えますが、ケースに応じてご参考にしていただければと存じます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。 &lt;/p&gt;
&lt;p&gt; System Center Operations Manager（以後 SCOM） には&lt;strong&gt;製品標準の管理パック テンプ</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="ログ監視" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%83%AD%E3%82%B0%E7%9B%A3%E8%A6%96/"/>
    
  </entry>
  
  <entry>
    <title>SCOM で使用する一般的なログ収集方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_Troubleshooting_log/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_Troubleshooting_log/</id>
    <published>2022-11-25T05:11:00.000Z</published>
    <updated>2024-03-13T12:36:01.104Z</updated>
    
    <content type="html"><![CDATA[<p>本記事は SCOM でトラブルシューティングを行う際、調査を行うために収集する一般的なログとその取得方法を解説いたします。</p><span id="more"></span><p>皆さまこんにちは。<br>System Center サポートチームの保科です。 </p><p>System Center Operations Manager (SCOM) をご利用中に様々な問題に対面された経験はございませんでしょうか。<br>この問題を対処するにあたり、弊社までお問合わをいただくことも多いかと存じます。<br>基本的にご申告いただきました問題を対処するにあたってログ等を含めた調査が必須となります。<br>本記事では、弊社が SCOM 観点のトラブルシューティングを行う際に一般的にお客様へ採取依頼を行うログとその採取方法について解説いたします。</p><h2 id="イベントログ"><a href="#イベントログ" class="headerlink" title="イベントログ"></a>イベントログ</h2><p>イベントログの調査は、SCOM のトラブルシューティングを行うにあたって最も一般的なログとなります。<br>基本的に SCOM で発生した問題の多くとその詳細はイベントログにも転記されます。<br>そのため、多くの問題はイベントログを調べることで原因の特定を行える可能性があります。<br>イベントログを採取いただく場合は、状況に応じて以下コンピューターから採取を行います。</p><ul><li>SCOM 管理サーバー:<br>トラブルシューティングの種類に依らず、必ず SCOM 管理サーバーのイベントログを採取します。<br>ご利用の環境で複数台の SCOM 管理サーバーをご利用の場合、それらすべての SCOM 管理サーバーからイベントログの採取を行います。<br>ゲートウェイサーバーを介した別ドメインコンピューターの監視で問題が発生されている場合、ゲートウェイサーバーからもイベントログを採取します。</li><li>事象が発生した監視対象コンピューター:<br>監視の問題が発生している場合、その問題が発生しているすべての監視対象コンピューターよりイベントログを採取します。<br>特定の監視対象コンピューターの問題ではなく、SCOM 全体的な問題によるトラブルシューティングを行う場合は、こちらのコンピューターからのログ採取は不要です。</li><li>SCOM データベースが動作する SQL Server 実行サーバー:<br>データベースの問題が疑われる場合、このコンピューターからイベントログを採取します。<br>一般的には、SCOM の処理が遅い、データが欠落する、SCOM が機能しないといった場合にこれらのサーバーからのイベントログ採取が必要となります。<br>SCOM 管理サーバーの中に SCOM データベースが動作する SQL Server が存在する場合、こちらについては意識いただかなくても問題ございません。</li></ul><p>イベントログの取得方法は以下手順で行います。</p><ol><li><p>対象コンピューターでイベント ビューアーを開きます。<br>確実に開く方法としては、[win] + [R] キーを押下し、”eventvwr.msc” とイベントビューアーの名前を直接指定し、実行する方法がございます。</p></li><li><p>画面左のコンソールツリーより、保存するイベントログをクリックします。<br>SCOM 観点のイベントログは、以下 3 種類のイベントログを採取します。</p><ul><li>アプリケーション (※1)</li><li>システム (※1)</li><li>Operations Manager (※2)</li></ul><p>(※1) は [Windows ログ] 配下に存在します。<br>(※2) は [アプリケーションとサービス ログ] 配下に存在します。<br>SCOM 管理サーバー / ゲートウェイサーバー以外のサーバーで、かつ SCOM エージェントがインストールされていない環境では (※2) のイベントログは存在しない場合がございます。<br>この場合、このコンピューターからの (※2) のイベントログの採取は不要でございます。</p></li><li><p>画面右ペインの [すべてのイベントを名前をつけて保存] をクリックします。</p></li><li><p>保存するイベントログの任意の名称を指定します。<br>ファイルの種類としては、”イベント ファイル (<em>.evtx)” および “CSV (コンマ区切り) (</em>.csv)” の両方で取得します。</p></li></ol><p>イベントログ取得手順は以上となります。<br>弊社までイベントログを送付いただく場合は、コンピューター毎にイベントログを 1 つのフォルダに纏め、それらのフォルダをさらに 1 つのフォルダに纏めて圧縮いただいてお寄せくださいませ。<br>採取対象コンピューターが複数台存在する場合、イベントログ自体のファイル名やそれを格納するフォルダにコンピューター名を付与いただく等、採取対象が分かりやすく識別できるように送付をいただけると幸いです。</p><h2 id="アラート情報"><a href="#アラート情報" class="headerlink" title="アラート情報"></a>アラート情報</h2><p>アラートの状態 (オープンの状態、解決済みの状態等) によらず、SCOM データベースに存在するアラート情報を出力いただけます。<br>こちらもイベントログ程ではありませんが、トラブルシューティングを行う際に有用な情報が確認できる場合が多い資料です。<br>アラート情報を取得する場合は、Operations Manager Shell を利用し、CSV 形式で一覧として取得します。</p><ol><li>SCOM 管理サーバー、SCOM 管理者権限を持つアカウントでログインします。</li><li>事前に、C ドライブの直下に “temp” という名前のフォルダを作成します。</li><li>[スタート] メニューより [Operations Manager Shell] を実行します。</li><li>以下のコマンドを実行します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SCOMAlert | export-csv -path &quot;c:/temp/Alert.csv&quot; -encoding UTF8</span><br></pre></td></tr></table></figure></li><li>出力された “Alert.csv” を弊社までお寄せください。</li></ol><h2 id="インストールログ"><a href="#インストールログ" class="headerlink" title="インストールログ"></a>インストールログ</h2><p>インストールログの調査は、SCOM のインストールやエージェントのプッシュインストール等インストールに関する操作が正常に行えない場合に調査する資料となります。<br>インストールに関する問題が発生しましたら、こちらのログを調査する必要があります。<br>ログは以下のフォルダに格納されております。</p><blockquote><p>C:\Users&lt;SCOM をインストールする際に使用したユーザー名&gt;\AppData\Local\SCOM</p></blockquote><h2 id="管理パック"><a href="#管理パック" class="headerlink" title="管理パック"></a>管理パック</h2><p><a href="/blog/SCOM/SCOM_MPTransfer/">こちらの記事</a> でも書かれております通り、SCOM の監視動作は基本的に管理パック内で定義されます。<br>例えば以下の状況が発生した場合においては、ご利用の管理パック側から調査を行う必要があります。</p><ul><li>検出されると想定されていた内容が検出されない。</li><li>今まで出力されなかったアラートが出力されるようになった。<br>また、このアラートが解消と発生を繰り返している。</li><li>認識していなかったコマンドが監視対象サーバーで実行されているように見えるため、このコマンドが SCOM から実行されている可能性があるか調査したい。</li></ul><p>管理パックは、以下手順でご利用の全管理パックを xml 形式での出力と、ご利用の管理パックを一覧化した html ファイルを出力いただけます。</p><ol><li>管理者の権限を持つユーザーで Operations Manager 管理サーバーにログオンします。</li><li>C: ドライブの直下に MPs フォルダーを作成します。</li><li>[スタート] 画面から [Operations Manager Shell] を選択します (※)。</li><li>[Operations Manager Shell] ウィンドウのプロンプトで以下のコマンドを実行します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Get-SCOMManagementPack | Export-SCOMManagementPack -Path:C:\MPs</span><br><span class="line">Get-SCOMManagementPack | ConvertTo-HTML &gt; C:\MPs\MpList.html</span><br></pre></td></tr></table></figure></li></ol><p>4. の 1 行目のコマンドを実行することで、ご利用の環境に導入されているすべての管理パックを xml 形式でエクスポートいただけます。<br>xml 形式でエクスポートされた管理パックには、その管理パックで定義されている内容がすべて記載されております。<br>基本的に SCOM で行われる監視内容は Powershell や VBS、Javascript 等で作成されたスクリプトを、対象となるコンピューターで実行するものとなります。<br>これらの実装を確認することで、管理パックに関するトラブルシューティングが可能になるというものです。</p><p>こちらの手順で、ご利用の管理パックが最新であるかを確認することもできます。<br>ご申告いただきました事象が、そのバージョンにおいて既知の事象であり、管理パックのアップデートによって解消される可能性もございます。<br>この場合、管理パックのアップデートによってご申告いただきました事象が解消される可能性が高いため、管理パックのアップデートをお願いいたします。<br>なお、このような既知の事象は、ほとんどの管理パックの場合はその管理パックを入手するサイトで入手いただける管理パックドキュメントに記載されております。<br>ドキュメントはほとんどの場合は英語での記述となりますが、ワークフローの一覧等管理パックに関する有用な内容が多く記載されております。</p><p>なお、一部お客様におかれましては、弊社が提供しております管理パック以外にも、サードパーティによって作成された管理パックを導入されている可能性がございます。<br>管理パックを調査した結果、このサードパーティ製の管理パックによってご申告いただきました事象が発生されている場合、弊社での詳細な調査はいたしかねております。<br>サードパーティ製の管理パックは、その管理パックを開発されたベンダーへ別途ご確認いただく必要がございます。<br>サードパーティ製の管理パックに関する調査をご所望でございましたら、その管理パックについて弊社で調査することが出来ないことをあらかじめご認識いただけます様お願いいたします。</p><h2 id="トレースログ"><a href="#トレースログ" class="headerlink" title="トレースログ"></a>トレースログ</h2><p>上記までに記載したログは、いずれも事象発生後に後追いで原因調査を行うために採取される資料となります。<br>これらの資料で大半の事象は原因を特定することが出来ますが、中には事象発生後に採取される資料に情報が一切記載されず、調査が困難な場合がございます。<br>この場合、事象発生時のログをリアルタイムで収集し、そのログから SCOM 内部で行われた処理を時系列で調査する必要があります。<br>この調査は SCOM 標準で備わるトレースログの採取によって可能となります。<br>以下手順にて SCOM トレースログの取得を開始します。</p><ol><li>トレースログを取得するコンピューターに、管理者権限でログインします。</li><li>管理者としてコマンドプロンプトを開きます。</li><li>cdコマンドを使用して、 トレースログを採取するコンピューターに応じて以下ディレクトリに移動します。<br>なお、下記のディレクトリは、いずれも既定フォルダにインストールを行った際に使用するディレクトリになります。<br>SCOM 管理サーバーや SCOM エージェントのインストール先を既定値から変更されている場合、適宜そのフォルダに移動をお願いします。<table><thead><tr><th>トレースログ採取対象コンピューター</th><th>cd コマンドで移動するディレクトリの既定値</th></tr></thead><tbody><tr><td>SCOM 2016 管理サーバー</td><td>C:\Program Files\Microsoft System Center 2016\Operations Manager\Server\Tools</td></tr><tr><td>SCOM 2019 管理サーバー</td><td>C:\Program Files\Microsoft System Center\Operations Manager\Server\Tools</td></tr><tr><td>SCOM 2022 管理サーバー</td><td>C:\Program Files\Microsoft System Center\Operations Manager\Server\Tools</td></tr><tr><td>SCOM エージェント</td><td>C:\Program Files\Microsoft Monitoring Agent\Agent\Tools</td></tr></tbody></table></li><li>以下コマンドを実行し、すでに実行中のトレースログ採取を停止します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StopTracing.cmd</span><br></pre></td></tr></table></figure>SCOM トレースログは、”Microsoft Monitoring Agent” サービスが停止中の状態から起動状態に移行すると、自動的にエラーレベルのトレースログを収集開始します。<br>“サービスが停止中の状態から起動状態に移行” する条件として、一例として以下が挙げられます。<ul><li>サービス自体を手動で再起動する</li><li>対象サーバーを再起動する</li></ul></li><li>Windowsエクスプローラーを使用して、“C:\Windows\Logs\OpsMgrTrace” に移動します。</li><li>フォルダ “C:\Windows\Logs\OpsMgrTrace” のすべてのファイルを削除します。</li><li>採取するトレースログのレベルに応じて以下コマンドを実行します。<ul><li>詳細レベルのトレースログ:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StartTracing.cmd VER </span><br></pre></td></tr></table></figure></li><li>デバッグレベルのトレースログ:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StartTracing.cmd DBG</span><br></pre></td></tr></table></figure>基本的に詳細レベルよりデバッグログのトレースログの方がより多くの情報が含まれます。<br>そのため調査に際してはデバッグログの方がより有用な情報が採取される可能性が高いものの、それに比例してログ容量増加速度も上昇します。<br>大まかな考えとしては、即座に事象再現が可能であればデバッグレベルのトレースログを、いつ事象再現が確認されるかが未定である場合は詳細レベルのトレースログを採取する方法を推奨いたします。</li></ul></li><li>事象を再現します。<br>再現が確認されるまでログを採取し、再現が確認されましたら 9. の手順へ進みます。</li><li>以下コマンドを実行し、トレースログの採取を再度停止します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StopTracing.cmd</span><br></pre></td></tr></table></figure></li><li>以下コマンドを実行し、採取されたトレースログをテキストファイル形式にフォーマットします。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FormatTracing.cmd R</span><br></pre></td></tr></table></figure></li><li>弊社まで資料を送付いただく際は、“C:\Windows\Logs\OpsMgrTrace”フォルダごとzip化し、弊社までお寄せください。<br>この際、複数のコンピューターでトレースログを採取いただけましたら、採取されたコンピューターが判別できるようにコンピューター名を zip ファイルに記載いただく等していただけますと幸いです。</li></ol><p>(※1)<br>“C:\Windows\Logs\OpsMgrTrace” フォルダ内には、収集された診断ログが “etl” 拡張子のファイルにて格納されております。<br>“.etl” の各ファイルは、100MB を上限としてログが保存されます。<br>ログが 100MB を超える場合、古いログから順番に新しいログへ上書きされます。<br>100 MB を超えるまでの時間は、環境に応じて変化いたしますので、一概のご案内が困難でございます。<br>弊社としては、問題の再現実施後に、ただちに 9. の手順でトレースの停止を実施いただきたく思います。<br>トレースログ採取容量は、トレースログ採取を開始する “StartTracing.cmd” の内容を直接編集することで増減が可能です。<br>具体的には、対象ファイル 99 行目に記載されている以下記述より、”-cir” パラメーターに続く数値が、トレースログ容量上限値を MB 単位で指定するものとなります。</p><blockquote><p>if not [%1]==[TracingGuidsConfigService] tracelogsm.exe -start %1 -flag %2 -level %3 -f %OpsMgrTracePath%%1.etl -b 64 -ft 10 <strong>-cir 100</strong> -guid %4</p></blockquote><p>(※2)<br>7. の手順で SCOM 診断ログを取得する際、特にパフォーマンスへの大きな影響が発生しないことを確認しております。</p><p>(※3)<br>トレースログを仕掛けたタイミングでサーバーの再起動等 SCOM エージェントサービスの停止が伴う操作を実施いただくと、トレースログの採取がリセットされ、OS 起動時に取得されるエラーレベルでのトレース採取が開始されます。<br>そのため、トレースログ採取中に SCOM エージェントサービスの停止が伴う操作を実施いただく場合、再度 1. から 8. までの手順を実施いただく必要がございます。</p><p>参考:<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-overview-management-pack?view=sc-om-2022">診断トレースを使用する - Operations Manager | Microsoft Learn</a><br>(SCOM 診断ログについて記載された弊社ドキュメントです。)</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本記事は SCOM でトラブルシューティングを行う際、調査を行うために収集する一般的なログとその取得方法を解説いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="トラブルシューティング" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0/"/>
    
    <category term="ログ収集" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%83%AD%E3%82%B0%E5%8F%8E%E9%9B%86/"/>
    
  </entry>
  
  <entry>
    <title>スクリプト監視の設定手順 - Windows 編</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_windows_script_monitor/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_windows_script_monitor/</id>
    <published>2022-10-31T09:10:00.000Z</published>
    <updated>2024-03-13T12:36:01.120Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>本日は System Center Operations Manager（以後 SCOM） で監視対象の Windows サーバーにて任意のスクリプトを実行する手順を紹介いたします。 </p><span id="more"></span><p>SCOM では監視対象のサーバーで任意のスクリプトを実行し、その返り値を収集することや、しきい値を設定してアラートを生成することができます。<br>SCOM には各種 OS や ソフトウェアの監視を行うための管理パックがたくさん存在しますが、それらの管理パックを用いた監視だけでは不足する監視項目が存在した場合、それらの情報を取得するスクリプトを用いて補うことができますので、スクリプト監視はとても有効です。<br>※ UNIX/Linux サーバーの手順は、<a href="/blog/SCOM/SCOM_unix_script_monitor/">スクリプト監視の設定手順 - UNIX/Linux 編</a> にて手順を紹介していますので、こちらも合わせてご参照ください。</p><h2 id="目的ごとの設定手順について"><a href="#目的ごとの設定手順について" class="headerlink" title="目的ごとの設定手順について"></a>目的ごとの設定手順について</h2><p>以下の目的ごとに、設定の手順が異なります。<br>　① スクリプトの返り値をパフォーマンス データとして収集すること<br>　② スクリプトの返り値に対してしきい値を設定してアラートを生成すること</p><p>①のデータ収集が目的の場合は、まず、データ収集の [収集ルール] を作成し、収集したデータを参照するための [パフォーマンスビュー] を作成します。<br>②のアラート生成が目的の場合は、[モニター] を作成します。</p><hr><p>各々の手順について以下記述いたします。</p><h2 id="①-スクリプトの返り値をパフォーマンス-データとして収集する手順"><a href="#①-スクリプトの返り値をパフォーマンス-データとして収集する手順" class="headerlink" title="① スクリプトの返り値をパフォーマンス データとして収集する手順"></a>① スクリプトの返り値をパフォーマンス データとして収集する手順</h2><ol><li>SCOM コンソールにログインして、画面左下ペインの [作成] をクリックして、[作成] 画面を開きます。</li><li>[作成] -&gt; [管理パック オブジェクト] -&gt; [ルール] をクリックして、画面右ペインから [新しいルールの作成] をクリックします。<br><img src="001.png"></li></ol><ol start="3"><li>[ルールの作成ウィザード] の [作成するルールの種類を選択] で [スクリプト (パフォーマンス) ] を選択して [次へ] をクリックします。<br><img src="002.png"></li></ol><ol start="4"><li>[全般] 画面で [ルールのターゲット] に Windows に関する任意のターゲットを指定し、[次へ] をクリックします。<br>例えば、今回作成するルールの対象を Windows Server 2016 以降の OS を対象とする場合、ターゲットは [Windows Server 2016 以降のコンピューター] を選択します。<br>インポートしている管理パックのバージョンにより [Windows Server 2016 以降のコンピューター] が存在しない場合は、下位のバージョンの [Windows Server XXXX のコンピューター] を選択してください。<br><img src="003.png"></li></ol><ol start="5"><li>スクリプトを実行してデータ収集する間隔を設定します。<br><img src="004.png"></li></ol><ol start="6"><li>スクリプト情報の入力画面にスクリプトをセットします。<br>※スクリプト画面には固定で 「10」 を返すひな形かセットされています。<br><img src="005.png"></li></ol><p>重要なメソッドは以下の値をセットしている箇所です。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Call</span> oBag.AddValue(&quot;PerfValue&quot;, <span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>ここに皆さまの方で用意されたスクリプトが取得した値をセットするようにしてください。<br>サンプルとして 0 ～ 1000 までのランダムな数値をセットするスクリプトは以下の通りです。<br><img src="006.png"></p><p>スクリプトは以下の通りです。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x27; オブジェクト準備</span><br><span class="line">Dim oAPI, oBag</span><br><span class="line"><span class="built_in">Set</span> oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line"><span class="built_in">Set</span> oBag = oAPI.CreatePropertyBag()</span><br><span class="line">&#x27; 属性値をセット</span><br><span class="line">Randomize</span><br><span class="line"><span class="keyword">Call</span> oBag.AddValue(&quot;PerfValue&quot;,Rnd * <span class="number">1000</span>)</span><br><span class="line">&#x27; オブジェクトを返す</span><br><span class="line"><span class="keyword">Call</span> oAPI.Return(oBag)</span><br></pre></td></tr></table></figure><ol start="7"><li>パフォーマンス マッピング画面を確認して [作成] をクリックします。<br>この設定内容が、後続の手順のパフォーマンスビューでパフォーマンスデータを表示した際に表示されるパフォーマンスデータに関する情報となります。<br>“オブジェクト”、”カウンター” および “インスタンス” は表示されるパフォーマンスデータの情報に関する内容を指定するものですので、必要に応じてデータを識別しやすい名称にします。<br><img src="007.png"></li></ol><p>以上で、任意のスクリプトの値を指定間隔で収集する [ルール] の作成は完了です。<br>次に、この情報を表示する [パフォーマンス ビュー] を作成します。</p><ol><li>SCOM コンソールの画面左下ペインの [監視] をクリックして、[監視] 画面を開きます。</li><li>右クリックメニュー の [新規] -&gt; [パフォーマンス ビュー] をクリックします。<br><img src="008.png"></li></ol><ol start="3"><li>[特定のルールによって収集された] にチェックを入れて、画面下部の [条件の説明] で、上で作成したルールを選択して [OK] をクリックします。<br><img src="009.png"></li></ol><p>以下の通り、ランダムな値を取得する VBS を実行して収集した値が表示されます。<br><img src="010.png"></p><p>以上で、スクリプトの返り値をパフォーマンスデータとして収集する [ルール] と収集データを表示する [ビュー] の作成が完了です。</p><hr><h2 id="②-スクリプトの返り値に対してしきい値を設定してアラートを生成する手順"><a href="#②-スクリプトの返り値に対してしきい値を設定してアラートを生成する手順" class="headerlink" title="② スクリプトの返り値に対してしきい値を設定してアラートを生成する手順"></a>② スクリプトの返り値に対してしきい値を設定してアラートを生成する手順</h2><ol><li>SCOM コンソールにログインして、画面左下ペインの [作成] をクリックして、[作成] 画面を開きます。</li><li>[作成] -&gt; [管理パックオブジェクト] -&gt; [モニター] をクリックして、画面中央の一覧から対象の OS 種類を選択します。<br><img src="013.png"></li></ol><ol start="3"><li>画面右ペインで [モニター] -&gt; [モニターの作成] をクリックして [ユニットモニター] を選択します。</li><li>[モニターの種類] で [スクリプト機能] -&gt; [一般] の中から該当するモニター種類を選択して、[次へ] をクリックします。<br>※今回の例では [タイマー スクリプト - 2 つの状態の監視] を選択しました。<br><img src="014.png"></li></ol><ol start="6"><li> [全般] 画面で [モニターのターゲット] に Windows に関する任意のターゲット (以下図は例として [Windows Server 2016 以降のコンピューター] を指定) を選択して [次へ] をクリックします。<br><img src="015.png"></li></ol><ol start="7"><li>任意のスケジュールを設定して [次へ] をクリックします。<br><img src="016.png"></li></ol><ol start="8"><li>スクリプト情報の入力画面にスクリプトをセットします。<br>※スクリプト画面には固定で 「OK」 という文字列を返すひな形かセットされています。<br><img src="017.png"></li></ol><p>上の [ルール] の時と同様に、サンプルとして 0 ～ 1000 までのランダムな数値を返すように修正します。<br><img src="006.png"></p><p>スクリプトは以下の通りです。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x27; オブジェクト準備</span><br><span class="line">Dim oAPI, oBag</span><br><span class="line"><span class="built_in">Set</span> oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line"><span class="built_in">Set</span> oBag = oAPI.CreatePropertyBag()</span><br><span class="line">&#x27; 属性値をセット</span><br><span class="line">Randomize</span><br><span class="line"><span class="keyword">Call</span> oBag.AddValue(&quot;PerfValue&quot;,Rnd * <span class="number">1000</span>)</span><br><span class="line">&#x27; オブジェクトを返す</span><br><span class="line"><span class="keyword">Call</span> oAPI.Return(oBag)</span><br></pre></td></tr></table></figure><p>ファイル名に拡張子を追加すると [次へ] ボタンが有効になりますので、[次へ] をクリックします。<br><img src="018.png"></p><ol start="9"><li>[異常な式] にエラーとなる返り値を設定して [次へ] をクリックします。<br>※下の画面ショットは返り値が 700より大きい場合にエラーとする設定です。<br>　パラーメーター名にはスクリプト内で用いたパラメーター PerfValue を用いて <em>Property[@Name=’PerfValue’]</em> を設定します。<br><img src="019.png"></li></ol><ol start="10"><li>[正常な式] にエラーが回復する返り値を設定して [次へ] をクリックします。<br>※下の画面ショットは返り値が 700以下になった場合に正常に回復する設定です。<br>　パラーメーター名にはスクリプト内で用いたパラメーター PerfValue を用いて <em>Property[@Name=’PerfValue’]</em> を設定します。<br><img src="020.png"></li></ol><ol start="11"><li>[ヘルスの構成] を設定して [次へ] をクリックします。<br><img src="021.png"></li></ol><ol start="12"><li>ヘルス状態の変化でアラートを生成する場合は [このモニターにアラートを生成する] にチェックを入れて [作成] をクリックします。<br>※アラートの重大度は任意に指定可能です。<br><img src="022.png"></li></ol><p>これにより、スクリプトの返り値に応じてアラートを生成する [モニター] の作成が完了です。</p><hr><p>いかがでしょうか。</p><p>まとめますと、スクリプトの返り値をパフォーマンス データとして収集する場合は [ルール] を作成して参照用の [パフォーマンス ビュー] を用意します。<br>しきい値を設定してアラートを生成する場合は [モニター] を作成します。<br>ルールもモニターも [スクリプト] 画面で、Windows サーバーで実行するスクリプトを記述します。</p><p>最後にスクリプトの記述方法について少しだけ補足します。</p><p>【 スクリプトの記述方法の補足 】<br>スクリプト画面で入力するスクリプトは、以下のメソッドで値をセットすることで SCOM にデータを送ることができます。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Call</span> oBag.AddValue(&quot;PerfValue&quot;, <span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>C ドライブの残容量を取得するサンプルを下に貼りましたので、参考にしていただければと存じます。<br>赤枠で囲った個所は [C ドライブの残容量を取得する処理] です。<br>SCOM に依存しないスクリプトです。<br>取得した値を <em>Call oBag.AddValue()</em> にセットしています。 </p><p>この例の通り、まずは単独で動作する情報収集スクリプトを実装します。<br>それをスクリプト内に挿入し、取得した値を <em>Call oBag.AddValue()</em> にセットするというのが作法になります。<br><img src="011.png"></p><p>スクリプトは以下の通りです。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x27; オブジェクト準備</span><br><span class="line">Dim oAPI, oBag</span><br><span class="line"><span class="built_in">Set</span> oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line"><span class="built_in">Set</span> oBag = oAPI.CreatePropertyBag()</span><br><span class="line"></span><br><span class="line">&#x27; 情報取得</span><br><span class="line">Dim objWMIService, objSWbemObjectCollection, objSWbemObject</span><br><span class="line"><span class="built_in">Set</span> objWMIService = GetObject(&quot;winmgmts:&#123;impersonationLevel=impersonate&#125;!\\.\root\cimv2&quot;)</span><br><span class="line"><span class="built_in">Set</span> objSWbemObjectCollection = objWMIService.ExecQuery(&quot;Select * from Win32_LogicalDisk Where DriveType = <span class="number">3</span>&quot;)</span><br><span class="line"></span><br><span class="line">&#x27; 取得情報を解析</span><br><span class="line"><span class="keyword">For</span> Each objSWbemObject <span class="keyword">in</span> objSWbemObjectCollection</span><br><span class="line">    &#x27; C ドライブの場合</span><br><span class="line">    <span class="keyword">If</span> InStr(objSWbemObject.DeviceID, &quot;C&quot;) &gt; <span class="number">0</span> Then</span><br><span class="line">        &#x27; 残容量 （MB） をセット</span><br><span class="line">        <span class="keyword">Call</span> oBag.AddValue(&quot;PerfValue&quot;,objSWbemObject.FreeSpace/<span class="number">1000</span>/<span class="number">1000</span>)</span><br><span class="line">    End <span class="keyword">If</span></span><br><span class="line">Next</span><br><span class="line"></span><br><span class="line">&#x27; オブジェクトを返す</span><br><span class="line"><span class="keyword">Call</span> oAPI.Return(oBag)</span><br></pre></td></tr></table></figure><p>収集したデータはパフォーマンス ビューにて確認できます。<br><img src="012.png"></p><p>本記事を参考にご要件に応じたスクリプト監視を設定いただければ幸いです。 </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;本日は System Center Operations Manager（以後 SCOM） で監視対象の Windows サーバーにて任意のスクリプトを実行する手順を紹介いたします。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="スクリプト" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88/"/>
    
    <category term="スクリプト監視" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E7%9B%A3%E8%A6%96/"/>
    
    <category term="スクリプト実行" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E5%AE%9F%E8%A1%8C/"/>
    
    <category term="VBS" scheme="https://jpsystemcenter.github.io/blog/tags/VBS/"/>
    
  </entry>
  
  <entry>
    <title>スクリプト監視の設定手順 - UNIX/Linux 編</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_unix_script_monitor/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_unix_script_monitor/</id>
    <published>2022-10-31T09:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.116Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>本日は System Center Operations Manager（以後 SCOM） で監視対象の UNIX/Linux サーバーにて任意のスクリプトを実行する手順を紹介いたします。</p><span id="more"></span><p>SCOM では監視対象のサーバーで任意のスクリプトを実行し、その返り値を収集することや、しきい値を設定してアラートを生成することができます。<br>SCOM には各種 OS や ソフトウェアの監視を行うための管理パックがたくさん存在しますが、それらの管理パックを用いた監視だけでは不足する監視項目が存在した場合、それらの情報を取得するスクリプトを用いて補うことができますので、スクリプト監視はとても有効です。<br>※ Windows サーバーの手順は、<a href="/blog/SCOM/SCOM_windows_script_monitor/">スクリプト監視の設定手順 - Windows 編</a> にて手順を紹介していますので、こちらも合わせてご参照ください。</p><h2 id="目的ごとの設定手順について"><a href="#目的ごとの設定手順について" class="headerlink" title="目的ごとの設定手順について"></a>目的ごとの設定手順について</h2><p>以下の目的ごとに、設定の手順が異なります。<br>　① スクリプトの返り値をパフォーマンス データとして収集すること<br>　② スクリプトの返り値に対してしきい値を設定してアラートを生成すること</p><p>①のデータ収集が目的の場合は、まず、データ収集の [ルール] を作成し、収集したデータを参照するための [パフォーマンスビュー] を作成します。<br>②のアラート生成が目的の場合は、[モニター] を作成します。</p><hr><p>各々の手順について以下記述いたします。</p><h2 id="①-スクリプトの返り値をパフォーマンス-データとして収集する手順"><a href="#①-スクリプトの返り値をパフォーマンス-データとして収集する手順" class="headerlink" title="① スクリプトの返り値をパフォーマンス データとして収集する手順"></a>① スクリプトの返り値をパフォーマンス データとして収集する手順</h2><ol><li>SCOM コンソールにログインして、画面左下ペインの [作成] をクリックして、[作成] 画面を開きます。</li><li>[作成] -&gt; [管理パックオブジェクト] -&gt; [ルール] をクリックして、画面中央の一覧から対象の OS 種類を選択します。</li><li>画面右ペインの [ルール] の [新しいルールの作成] をクリックして、[ルールの作成ウィザード] を開きます。<br><img src="001.png"></li></ol><ol start="4"><li>[作成するルールの種類を選択] で [収集ルール] の [UNIX/Linux スクリプト(パフォーマンス) ] を選択します。</li><li>[ルール名] を入力して、ルールのターゲットが対象の OS 種類であることを確認して、[次へ] をクリックします。<br>※ルール名の例：Sample Linux Performance View Rule<br>※全UNIX/Linux サーバーを対象とする場合は、ターゲットに [UNIX/Linux コンピューター] を指定します。<br><img src="002-2.png"></li></ol><ol start="6"><li>任意のスケジュールを設定して [次へ] をクリックします。<br><img src="003.png"></li></ol><ol start="7"><li>実行するスクリプトを指定して [次へ] をクリックします。<br>下の例では、事前に監視対象の Linux サーバーに配置された getramdom.sh というランダムな数値を返すスクリプトを実行します。<br>Run As profile で指定するアカウントには、指定したスクリプトの実行権限が必要です。</li></ol><p><em>スクリプト &lt; getramdom.sh &gt; の中身</em></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> $RANDOM</span><br></pre></td></tr></table></figure><p><img src="004.png"></p><ol start="8"><li>必要に応じてデータ収集のフィルターを設定して [次へ] をクリックします。<br><img src="005.png"></li></ol><ol start="9"><li>必要に応じてマッピング情報を設定して [次へ] をクリックします。<br>補足：コマンドの返り値をそのまま収集する場合、[値] は変更しないでください。<br><img src="006.png"></li></ol><p>以上で、任意のスクリプトの値を指定間隔で収集する [ルール] の作成は完了です。<br>次に、この情報を表示する [パフォーマンス ビュー] を作成します。</p><ol><li>SCOM コンソールにログインして、画面左下ペインの [監視] をクリックして、[監視] 画面を開きます。</li><li>画面左ツリーで、ビューを配置する任意のフォルダを選択します。<br>右クリックメニューで [新規] -&gt; [パフォーマンス ビュー] をクリックします。<br><img src="007.png"></li></ol><ol start="3"><li>[プロパティ] 画面の [状態の選択] で [特定のルールによって収集された] にチェックを入れ、[条件の説明] で上で作成したルールを選択します。<br><img src="008.png"></li></ol><ol start="4"><li>コマンドの返り値を表示するビューが生成されます。<br><img src="009.png"></li></ol><hr><h2 id="②-スクリプトの返り値に対してしきい値を設定してアラートを生成する手順"><a href="#②-スクリプトの返り値に対してしきい値を設定してアラートを生成する手順" class="headerlink" title="② スクリプトの返り値に対してしきい値を設定してアラートを生成する手順"></a>② スクリプトの返り値に対してしきい値を設定してアラートを生成する手順</h2><ol><li>SCOM コンソールにログインして、画面左下ペインの [作成] をクリックして、[作成] 画面を開きます。</li><li>[作成] -&gt; [管理パックオブジェクト] -&gt; [モニター] をクリックして、画面中央の一覧から対象の OS 種類を選択します。<br><img src="020.png"></li></ol><ol start="3"><li>画面右ペインで [モニター] -&gt; [モニターの作成] をクリックして [ユニットモニター] を選択します。</li><li>[モニターの種類] で [スクリプト機能] -&gt; [一般] の中から該当するモニター種類を選択して、[次へ] をクリックします。<br>※今回の例では [UNIX/Linux スクリプトの 2 つの状態モニター] を選択しました。<br><img src="011.png"></li></ol><ol start="5"><li>[全般] 画面で [モニターのターゲット] に [UNIX/Linuxのコンピューター] を選択して [次へ] をクリックします。<br><img src="019.png"></li></ol><ol start="6"><li>任意のスケジュールを設定して [次へ] をクリックします。<br><img src="013.png"></li></ol><ol start="7"><li>実行するスクリプトを指定して [次へ] をクリックします。<br><img src="014.png"></li></ol><ol start="8"><li>[エラー式] にエラーとなる返り値を設定して [次へ] をクリックします。<br>※下の画面ショットは [StdOut] が 20000より大きく、[ReturnCode] が 0 の場合にエラーとする設定です。<br><img src="015.png"></li></ol><ol start="9"><li>[正常な式] にエラーが回復する返り値を設定して [次へ] をクリックします。<br>※下の画面ショットは [StdOut] が 20000 以下、[ReturnCode] が 0 の場合に正常に回復する設定です。<br><img src="016.png"></li></ol><ol start="10"><li>[ヘルスの構成] を設定して [次へ] をクリックします。<br><img src="017.png"></li></ol><ol start="11"><li>ヘルス状態の変化でアラートを生成する場合は [このモニターにアラートを生成する] にチェックを入れて [作成] をクリックします。<br>※アラートの重大度は任意に指定可能です。<br><img src="018.png"></li></ol><p>これにより、スクリプトの返り値に応じてアラートを生成する [モニター] の作成が完了です。</p><hr><p>いかがでしょうか。</p><p>まとめますと、スクリプトの返り値をパフォーマンス データとして収集する場合は [ルール] を作成して参照用の [パフォーマンス ビュー] を用意します。<br>しきい値を設定してアラートを生成する場合は [モニター] を作成します。<br>ルールもモニターも [スクリプトの詳細] 画面で、UNIX/Linux サーバー上に配置したスクリプトを指定します。</p><p>ご要件に応じてスクリプト監視を設定いただければ幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;本日は System Center Operations Manager（以後 SCOM） で監視対象の UNIX/Linux サーバーにて任意のスクリプトを実行する手順を紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="スクリプト" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88/"/>
    
    <category term="スクリプト監視" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E7%9B%A3%E8%A6%96/"/>
    
    <category term="スクリプト実行" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E5%AE%9F%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>Linux エージェントのインストール/アンインストール方法について</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/scxagent_install_uninstall/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/scxagent_install_uninstall/</id>
    <published>2022-09-08T02:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.128Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。<br>本日は SCOM サーバーで監視できる UNIX/Linux 監視方法や監視を構成しているエージェント側のコンポーネント、ならびに具体的なインストール/アンインストール方法についてご紹介いたします。</p><h2 id="監視対象とエージェントのコンポーネントについて"><a href="#監視対象とエージェントのコンポーネントについて" class="headerlink" title="監視対象とエージェントのコンポーネントについて"></a>監視対象とエージェントのコンポーネントについて</h2><h3 id="監視対象"><a href="#監視対象" class="headerlink" title="監視対象"></a>監視対象</h3><p>まず各 SCOM バージョンで監視対象にできる UNIX/Linux の OS については下記当社公開ドキュメントに記載しておりますのでご参照ください。</p><table><thead><tr><th>バージョン</th><th>確認先 URL</th></tr></thead><tbody><tr><td>2016</td><td><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-supported-crossplat-os?view=sc-om-2016">サポートされている UNIX/Linux の OS </a></td></tr><tr><td>2019</td><td><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-supported-crossplat-os?view=sc-om-2019">サポートされている UNIX/Linux の OS </a></td></tr><tr><td>2022</td><td><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-supported-crossplat-os?view=sc-om-2022">サポートされている UNIX/Linux の OS </a></td></tr></tbody></table><h3 id="エージェントのコンポーネント"><a href="#エージェントのコンポーネント" class="headerlink" title="エージェントのコンポーネント"></a>エージェントのコンポーネント</h3><p>監視対象に UNIX/Linux に SCOM エージェント（以後、SCXAgent）をインストールしますと下記ディレクトリ、ならびにその配下にファイルが生成されます。</p><table><thead><tr><th>ディレクトリパス</th><th>内容</th></tr></thead><tbody><tr><td>/opt/omi/</td><td>Open Management Infrastructure (OMI) は次のディレクトリにインストールされます</td></tr><tr><td>/opt/microsoft/scx/</td><td>UNIX/Linux エージェントは次のディレクトリにインストールされます</td></tr><tr><td>/var/opt/microsoft/scx/log/</td><td>UNIX/Linux エージェントは次のディレクトリにログ ファイルを保持します</td></tr><tr><td>/var/opt/omi/log/</td><td>OMI は次のディレクトリにログ ファイルを保持します</td></tr><tr><td>/etc/opt/microsoft/scx/</td><td>証明書などのエージェントの構成ファイルは次のディレクトリに格納されます</td></tr><tr><td>/etc/opt/omi/</td><td>OMI 構成ファイルは次のディレクトリに格納されます</td></tr></tbody></table><h2 id="インストール方法とアンインストール方法について"><a href="#インストール方法とアンインストール方法について" class="headerlink" title="インストール方法とアンインストール方法について"></a>インストール方法とアンインストール方法について</h2><h3 id="インストール方法"><a href="#インストール方法" class="headerlink" title="インストール方法"></a>インストール方法</h3><p>ここからは具体的なインストール方法は記載いたします。</p><p>まず監視をするため UNIX / Linux 管理パックを SCOM 管理サーバーにインポートする必要がございます。<br>以下ダウンロード先から対象管理パックをダウンロードいただき、SCOM 管理サーバーに <a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-mp-import-remove-delete?view=sc-om-2019">インポート</a> します。</p><table><thead><tr><th>バージョン</th><th>確認先 URL</th></tr></thead><tbody><tr><td>2016</td><td><a href="https://www.microsoft.com/en-us/download/details.aspx?id=29696"> ダウンロード先 </a></td></tr><tr><td>2019 / 2022</td><td><a href="https://www.microsoft.com/en-us/download/details.aspx?id=58208"> ダウンロード先 </a></td></tr></tbody></table><p>SCXAgent のインストールは以下２つの方法がございます。</p><h4 id="1-SCOM-Operations-Console-画面での操作"><a href="#1-SCOM-Operations-Console-画面での操作" class="headerlink" title="1. SCOM Operations Console 画面での操作"></a>1. SCOM Operations Console 画面での操作</h4><p>手順は <a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-deploy-crossplat-agent-console?view=sc-om-2019#to-discover-and-install-an-agent-on-a-unix-or-linux-computer">当ページ</a> に記載がございます。<br>下記を確認できる事から可能な限りこちらの操作方法でのインストールを推奨しております。<br>　・SCOM 管理サーバーに必要な管理パックが入っているか<br>　・エージェントコンピューターと通信できる環境となっているか<br>　・インストール時に指定する Linux のユーザーが使用できるか</p><h4 id="2-Linux-のローカルでの操作"><a href="#2-Linux-のローカルでの操作" class="headerlink" title="2. Linux のローカルでの操作"></a>2. Linux のローカルでの操作</h4><p>手順は <a href="https://docs.microsoft.com/en-us/system-center/scom/manage-install-crossplat-agent-cmdline?view=sc-om-2019">当ページ</a> に記載がございます。<br>CentOS を例に記載しますと、上記ページの下記箇所のコマンドを実行いただくことでインストールできます。</p><ul><li><p>事前作業としてエージェントのインストールシェル （ scx-<version>.universalr.<version>.<arch>.sh ）を事前に対象コンピューターに任意フォルダに格納します。<br> エージェント パッケージは、管理サーバーの次のフォルダにあります。<br>　%ProgramFiles%\Microsoft System Center\Operations Manager\Server\AgentManagement\UnixAgents\DownloadedKits</p></li><li><p>以下コマンドでパッケージをインストールします<br>　sh ./scx-<version>.universalr.<version>.<arch>.sh –install –enable-opsmgr</p></li><li><p>以下コマンドでパッケージのインストール結果を確認します。コマンド結果としてアウトプットが出力されればインストールされております。<br>　rpm -q scx</p></li><li><p>以下コマンドで SCX Server の実行状況を確認します。<br>　scxadmin -status</p></li></ul><p>　<br>(結果例) omiagent については実行した後ある程度時間が経過したのち 1 instance 以上が実行状態となります。<br>omiserver: is running<br>omiagent: is stopped<br>または<br>omiserver: is running<br>omiagent: XX instance running</p><h3 id="アンインストール方法"><a href="#アンインストール方法" class="headerlink" title="アンインストール方法"></a>アンインストール方法</h3><h4 id="1-SCOM-Operations-Console-画面での操作-1"><a href="#1-SCOM-Operations-Console-画面での操作-1" class="headerlink" title="1. SCOM Operations Console 画面での操作"></a>1. SCOM Operations Console 画面での操作</h4><p>手順は <a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-upgrade-uninstall-crossplat-agent?view=sc-om-2019#uninstalling-agents">当ページ</a> に記載がございます。</p><h4 id="2-Linux-のローカルでの操作-1"><a href="#2-Linux-のローカルでの操作-1" class="headerlink" title="2. Linux のローカルでの操作"></a>2. Linux のローカルでの操作</h4><p>手順は <a href="https://docs.microsoft.com/en-us/system-center/scom/manage-uninstall-crossplat-agent?view=sc-om-2019">当ページ</a> に記載がございます。<br>CentOS を例に記載しますと、上記ページの下図箇所のコマンドを実行いただくことでアンインストールできます。</p><ul><li>rootユーザーでログオンし、以下コマンドでパッケージをアンインストールします<br>　rpm -e scx</li><li>パッケージがアンインストールされたことを確認するには、次のように入力します。何も出力されなければアンインストールできております。<br>　rpm -q scx</li></ul><p>本日のご紹介は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;br&gt;本日は SCOM サーバーで監視できる UNIX/Linux 監視方法や監視を構成しているエージェント側のコンポーネント、ならびに具体的なインス</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="SCXAgent" scheme="https://jpsystemcenter.github.io/blog/tags/SCXAgent/"/>
    
  </entry>
  
  <entry>
    <title>SCOM 管理パック移行による別環境への設定移行</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_MPTransfer/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_MPTransfer/</id>
    <published>2022-08-23T03:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.096Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆さまこんにちは、System Center サポートチームの保科です。<br>本日は、System Center Operations Manager (以降は SCOM と略称) をアップグレードせずに新規環境を構築された場合、既存環境の一部設定を新規環境へ以降する手順をご紹介いたします。</p><p>2022 年になり SCOM 2016 が延長サポート期間へ移行したり、SCOM 2012 系は延長サポート期間が終了となりました。<br>このように、SCOM に限らず弊社がリリースしておりますオンプレミス製品は原則としてサポート期間が設定されております。<br>サポート期間終了に伴い、古いバージョンの SCOM をご利用のお客様においては、サポート期間中の SCOM 環境へリプレースされることをご検討いただいている状況と存じます。<br>SCOM 環境のリプレースには、既存環境のアップグレードと、既存環境と並行して新規環境を作成いただく 2 種類の方法がございます。<br>詳細は、本ブログ内で別途公開しております下記ページも併せてご確認ください。<br><a href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_migration/">SCOM 2016 から SCOM 2022 へ移行 or アップグレードについて</a></p><p>本記事では、新規環境へ設定を移行する方法について、移行に使用する管理パックの概要と含めて詳細な手順をご説明いたします。</p><h1 id="管理パックとは"><a href="#管理パックとは" class="headerlink" title="管理パックとは"></a>管理パックとは</h1><p>“概要” 項でも簡単に触れました通り、既存環境から新規環境へ設定を移行する場合、管理パックを使用して移行を行います。<br>管理パック移行方法の解説の前に、管理パックとはそもそも何かについてご説明いたします。</p><p>管理パックは、SCOM におけるいわゆるプラグインのような働きをするファイルとなります。<br>管理パックを SCOM 環境内に導入いただくことで、初期状態では存在しない、サーバーの CPU 使用率の監視といった監視機能の拡張を行うことが出来ます。<br>管理パックによって提供される内容は様々な内容が存在し、下記の弊社サイトにも詳細が掲載されております。<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-overview-management-pack?view=sc-om-2022">Operations Manager の管理パックに含まれている内容</a></p><p>こちらのサイトに記載された、管理パックに含まれる内容を抜粋いたします。</p><blockquote><p>管理パックには通常、アプリケーションとサービスの監視設定が含まれます。 管理パックが管理グループの System Center - Operations Manager にインポートされると、既定の構成と管理パックで定義されたしきい値に基づいて直ちにオブジェクトの監視が開始されます。<br>各管理パックには次の部分のいずれかまたはすべてが含まれていることがあります。</p><ul><li>管理されたコンポーネントの各種要素の状態を追跡するよう、エージェントに指示を送るモニター。</li><li>パフォーマンス データや検出データの収集やアラートやイベントの送信などを行うよう、エージェントに指示を送るルール。</li><li>エージェントまたはコンソールが実行可能なアクティビティを定義する、タスク。</li><li>オペレーターが診断や問題解決できるよう、テキストでアドバイスを出すナレッジ。</li><li>このコンポーネントの監視や管理用にカスタマイズしたユーザー インターフェイスを提供する、表示。</li><li>この管理されたコンポーネントに関する情報を報告するための特定の方法を定義する、レポート。</li><li>監視されるべきオブジェクトを特定する、オブジェクト検出。</li><li>異なるコンピューターの異なるアカウントでさまざまなルール、タスク、モニター、検出を実行することを可能にする、実行プロファイル。</li></ul></blockquote><p>上記の事項については管理パックに含まれる内容となります。<br>そのため、管理パックをエクスポートいただくことで、上記設定を纏めてエクスポートいただくことが可能となります。<br>その後、エクスポートされた管理パックを新規環境にインポートいただくことで、上記設定については従前どおりの設定でご利用いただけます。</p><p>しかし、逆の言い方をすれば、管理パックに含まれない内容についてはエクスポートすることが出来ないため、新規環境に引き継ぐことは出来ません。<br>これには、例えば現在監視されているサーバーならびにその監視設定、今までの監視データやアラート情報、実行アカウント、SCOM データベースのクリーンアップ設定等が含まれます。<br>管理パックに含まれない内容については、従前の環境と同等の設定を手動で実施いただく必要がございます。<br>また、今までの監視データはすべて喪失することとなりますので、予めご了承ください。</p><p>管理パックは、大きく分けると下記の 2 種類に分けることが可能です。</p><ul><li>弊社やサードパーティから提供されている管理パック:<br>監視されたいハードウェアやソフトウェア用に、弊社やサードパーティから管理パックがリリースされております。<br>それらの管理パックを導入することで、その管理パックによって提供される監視機能の一式が提供されます。<br>例えば、Windows Server 2016 以降の Windows Server OS を監視する弊社提供の管理パックを導入することで、その OS の監視が実現いただけます。<br>管理パック毎に提供される監視機能はその管理パックの実装面で定義されております。</li><li>お客様が SCOM 運用に際して独自に作成いただいた管理パック:<br>SCOM で動作するルールやモニターは、オーバーライドを行うことでお客様の監視要件に応じて動作方法やアラートのしきい値といった設定値を変更いただけます。<br>また、お客様の監視要件に応じて、SCOM ではお客様が独自にルールやモニターを作成いただける仕組みもございます。<br>こういった内容を保存する際に、お客様の方で SCOM 内に独自の管理パックを作成いただくことが可能です。</li></ul><p>今回の移行手順のご案内では、上記 2 種類の管理パックを移行する手順をご案内としております。<br>それでは、具体的に管理パックをどのように移行することが可能か説明していきます。</p><h1 id="具体的な管理パック移行方法"><a href="#具体的な管理パック移行方法" class="headerlink" title="具体的な管理パック移行方法"></a>具体的な管理パック移行方法</h1><p>既存環境から新規環境に管理パックを移行する方法として、大きく分けて下記の手順を実施いただきます。</p><ol><li>既存の SCOM 環境から管理パックをエクスポート</li><li>既存環境からエクスポートされた管理パックを新規 SCOM 環境にインポート</li></ol><p>各手順の詳細をご案内いたします。</p><h2 id="1-既存の-SCOM-環境から管理パックをエクスポート"><a href="#1-既存の-SCOM-環境から管理パックをエクスポート" class="headerlink" title="1. 既存の SCOM 環境から管理パックをエクスポート"></a>1. 既存の SCOM 環境から管理パックをエクスポート</h2><p>こちらの手順は、既存環境より新規環境に移行するための管理パックをエクスポートする手順となります。<br>エクスポートを実施いただく場合、下記手順を実施します。</p><ol><li>管理者の権限を持つユーザーで Operations Manager 管理サーバーにログオンします。</li><li>C: ドライブの直下に MPs フォルダーを作成します。</li><li>[スタート] 画面から [Operations Manager Shell] を選択します (※)。</li><li>[Operations Manager Shell] ウィンドウのプロンプトで以下のコマンドを実行します。<blockquote><p>Get-SCOMManagementPack | Export-SCOMManagementPack -Path:C:\MPs</p></blockquote></li></ol><p>こちらの手順を実施いただくと、”MPs” フォルダに、SCOM でご利用のすべての管理パックが “&lt;SCOM に保存された管理パックの名称&gt;.xml” のファイル名でエクスポートされます。<br>管理パックの名称にスペースが存在する場合、スペースは “.” に変換の上エクスポートされます。<br>管理パックの名称に日本語が 1 文字でも含まれる場合、エクスポートされる管理パックは “ManagementPack&lt;管理パック毎の固有文字列&gt;” の名称でエクスポートされます。<br>このエクスポートされた管理パックの内、お客様が独自に定義された管理パックを新規環境に移行します。</p><h2 id="2-既存環境からエクスポートされた管理パックを、新規-SCOM-環境にコピー"><a href="#2-既存環境からエクスポートされた管理パックを、新規-SCOM-環境にコピー" class="headerlink" title="2. 既存環境からエクスポートされた管理パックを、新規 SCOM 環境にコピー"></a>2. 既存環境からエクスポートされた管理パックを、新規 SCOM 環境にコピー</h2><p>下記の説明では、特にご要望が多い以下の観点でご案内いたします。</p><ol><li>独自定義ルール / モニターのインポート方法</li><li>ルール / モニターの上書き設定のインポート方法</li><li>配信登録設定のインポート方法</li></ol><h3 id="1-独自定義ルール-モニターのインポート"><a href="#1-独自定義ルール-モニターのインポート" class="headerlink" title="1) 独自定義ルール / モニターのインポート"></a>1) 独自定義ルール / モニターのインポート</h3><p>“1. 既存の SCOM 環境から管理パックをエクスポート” でエクスポートされた管理パックの内、独自定義ルール / モニターを作成される際に指定された管理パックを新規環境にコピーします。<br>その管理パックを新規環境にインポートいただくことで、新規環境でもそのモニターをご利用いただくことが可能となります。</p><h3 id="2-ルール-モニターの上書き設定のインポート"><a href="#2-ルール-モニターの上書き設定のインポート" class="headerlink" title="2) ルール / モニターの上書き設定のインポート"></a>2) ルール / モニターの上書き設定のインポート</h3><p>“1. 既存の SCOM 環境から管理パックをエクスポート” でエクスポートされた管理パックの内、既存環境で上書き設定を保存さる際に使用された管理パックを、新規環境にコピーします。<br>なお、新規環境に存在しないルール / モニターの上書き設定が保存されている管理パックを新規環境でインポートしようとすると、依存関係となる管理パックが存在しないとして、インポートが実施いただけない場合がございます。<br>この依存関係となる、新規環境に存在しないルール / モニターは、例えば Exchange Server 管理パックで使用いただけるルール / モニター等、お客様にて別途入手いただく必要がある管理パックが該当いたします。<br>この場合、まず “1. 既存の SCOM 環境から管理パックをエクスポート” でエクスポートされた管理パックより、当該管理パックと依存関係となる管理パックを新規環境にコピーおよびインポートいただきます。<br>基本的に、依存関係となる管理パックは既存環境に存在しますので、依存関係に関するエラーが出力されましたら、既存環境から依存関係となる管理パックをコピーいただきます様お願いいたします。<br>通常であれば、お客様が別途入手された管理パックは、すべて既定で下記フォルダ上に保存されます。</p><blockquote><p>C:\Program Files (x86)\System Center Management Packs</p></blockquote><p>そのため、既存環境上に存在するこちらのフォルダを全て新規環境にコピーいただき、フォルダ内の管理パックの内新規環境のバージョンで使用することをサポートされる管理パックを全てインポートします。</p><h3 id="3-配信登録設定のインポート"><a href="#3-配信登録設定のインポート" class="headerlink" title="3) 配信登録設定のインポート"></a>3) 配信登録設定のインポート</h3><p>SCOM では、特定のアラートをトリガーとしてスクリプトを実行したり、そのアラート内容を特定のアドレスにメール通知する配信登録設定が提供されております。<br>配信登録設定については、下記の弊社サイトにも詳細な内容が掲載されております。<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-notifications-alert-notifications?view=sc-om-2022">Operations Manager でアラート通知をサブスクライブする</a></p><p>こちらの機能は、多くのお客様がアラート情報を担当者に迅速に連携するべくご利用いただいている状況かと思います。<br>この設定も、”1. 既存の SCOM 環境から管理パックをエクスポート” でエクスポートされた管理パックの内 “Microsoft.SystemCenter.Notifications.Internal.xml” を新規環境にインポートいただくことで、既存環境の配信登録設定を引き継いで利用いただくことが可能です。<br>なお、インポートの際は、既に新しいバージョンの管理パックがインポートされている旨の情報が表示されますが、<br>インポート自体は可能で、この状態でインポートいただいても問題ございません。<br>弊社検証環境での動作内容や過去事例より、古いバージョンの管理パックを上書きする形で新規環境にインポートいただくことで、<br>SCOM の動作上特に問題が発生しないことを確認しております。<br>一例として、SCOM 2012 から 2019 へ当管理パックをインポート後、SCOM 2012 にて設定いただいた内容が正常に SCOM 2019 側へ反映されることも確認しております。<br>念のため、既存環境の “Microsoft.SystemCenter.Notifications.Internal.xml” を新規環境にインポートいただく際は、<br>“1. 既存の SCOM 環境から管理パックをエクスポート” 項の手順に沿って一度新規環境内の管理パックを全てエクスポートしてください。<br>その後、新規環境内にてエクスポートされた “Microsoft.SystemCenter.Notifications.Internal.xml” を任意のフォルダにコピーします。<br>これにより、万が一既存環境の “Microsoft.SystemCenter.Notifications.Internal.xml” を新規環境へインポート後に予期せぬ動作が発生された場合、既存環境よりエクスポートいただいた “Microsoft.SystemCenter.Notifications.Internal.xml” をインポートいただくことで、状況を改善いただけます。</p><p>なお、管理パックの上書きインポートという作業の性質上、新規環境の配信登録設定はすべて既存環境の設定に上書きされることとなります。<br>新規環境で既に配信登録設定が実施されている場合、その設定もすべて消失されることとなりますのでご注意ください。</p><h3 id="ご参考-管理パックのインポート方法"><a href="#ご参考-管理パックのインポート方法" class="headerlink" title="(ご参考) 管理パックのインポート方法"></a>(ご参考) 管理パックのインポート方法</h3><p>管理パックのインポート方法は、下記の弊社サイトに詳しく掲載されております。<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-mp-import-remove-delete?view=sc-om-2022#import-a-management-pack-from-disk">Operations Manager 管理パックをインポート、エクスポート、および削除する方法</a><br>本ページ内で解説しております操作を実施いただく手順としては、”管理パックをディスクからインポートする” 項の手順が適切になります。</p><h1 id="管理パックインポート時のご注意事項"><a href="#管理パックインポート時のご注意事項" class="headerlink" title="管理パックインポート時のご注意事項"></a>管理パックインポート時のご注意事項</h1><p>少なくとも弊社より提供されております管理パックについては、その管理パックのインポートをサポートする SCOM バージョンが予め指定されております。<br>SCOM における非サポートの管理パックをインポートすることは、”管理パック自体は動作し、使用することが出来るものの、使用に際して予期せぬ動作が発生される可能性がある” ことを意味します。<br>そのため、非サポートの管理パックをインポートいただく際は、予期せぬ動作が発生することをご理解いただいた上でインポートしてください。<br>非サポートの管理パックによる監視によって問題が発生された場合、弊社としてはその管理パックを削除いただく以外の対処方法のご案内をいたしかねますので、予めご了承ください。</p><p>弊社が公開しております管理パックは、下記サイトにて一覧で掲載されております。<br><a href="https://social.technet.microsoft.com/wiki/contents/articles/16174.microsoft-management-packs.aspx">Microsoft Management Packs</a><br>この一覧から、例えばサイト内の下図管理パックのリンク先へ遷移しますと、管理パックならびに管理パックガイドがダウンロードいただけます。<br><img src="https://raw.githubusercontent.com/jpsystemcenter/blog/53467ea239369d3ce5e16392b2dfeb5993a443c0/articles/SCOM/img/SCOM_MPTransfer/SCOM_MPTransfer_WS2016%2BMPLink.png"></p><p>このページの ”System Requirements” を確認いただくことで、管理パックのサポート範囲を確認いただけます。<br>今回の例で確認しました、Windows Server 2016 以降の Windows Server OS を監視する際に使用する “Windows Server Operating System 2016 and above” 管理パックは、SCOM 2016 / 2019 / 2022 で使用することをサポートすることが確認いただけます。<br><img src="https://raw.githubusercontent.com/jpsystemcenter/blog/53467ea239369d3ce5e16392b2dfeb5993a443c0/articles/SCOM/img/SCOM_MPTransfer/SCOM_MPTransfer_WS2016%2BMPPage.png"></p><p>また管理パックガイドからも同様の内容を確認いただけます。<br>こちらの管理パックでは、ドキュメント内の ”Supported Configurations” 項から内容をご確認いただけます。<br><img src="https://raw.githubusercontent.com/jpsystemcenter/blog/53467ea239369d3ce5e16392b2dfeb5993a443c0/articles/SCOM/img/SCOM_MPTransfer/SCOM_MPTransfer_WS2016%2BMPDoc.png"></p><p>管理パックのドキュメントは、対応する管理パックによって記述の意匠が異なります。<br>そのため、管理パックのドキュメントからサポートする SCOM バージョンを確認される場合、適宜そのドキュメントからサポート対象に関する内容をご確認ください。</p><p>SCOM 2019 のみではありますが、SCOM 2019 で使用することをサポートする管理パックが一覧で掲載されております。<br><a href="https://social.technet.microsoft.com/wiki/contents/articles/52876.scom-2019-management-packs.aspx">SCOM 2019 Management Packs</a><br>そのため、SCOM 2019 に関しては、上記の手順による確認ではなく、こちらのサイトからサポートされる管理パックをご確認いただくのが有用でございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆さまこんにちは、System Center サポートチームの保科です。&lt;br&gt;本日は、System Center Operations Manager (以降は SCOM と略称) をアップグレードせずに新規環境を構築された</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="アップグレード" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89/"/>
    
    <category term="新環境への移行" scheme="https://jpsystemcenter.github.io/blog/tags/%E6%96%B0%E7%92%B0%E5%A2%83%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>SCOM サーバー の取り得る構成について</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_construction/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_construction/</id>
    <published>2022-08-23T02:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.112Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。<br>本日は SCOM サーバーを構成するコンポーネント、ならびにコンポートネントをホストする OS の台数のよって取り得る構成についてご紹介いたします。</p><h2 id="SCOM-サーバーを構成するコンポーネント"><a href="#SCOM-サーバーを構成するコンポーネント" class="headerlink" title="SCOM サーバーを構成するコンポーネント"></a>SCOM サーバーを構成するコンポーネント</h2><p>まず SCOM サーバーを構成するコンポーネントについては下表に記載いたします。</p><table><thead><tr><th>コンポーネント</th><th>説明</th></tr></thead><tbody><tr><td>管理サーバー</td><td>SCOMの管理サーバーとして、管理対象とデータベース、オペレーションコンソールとの通信チャネルを提供します。複数の管理サーバーを導入することで、負荷分散と冗長化が可能です。</td></tr><tr><td>オペレーションデータベース</td><td>管理グループ内のすべての構成情報、オペレーション情報、セキュリティ情報などを保存する SQL データベースです。</td></tr><tr><td>データウェアハウスデータベース</td><td>オペレーション情報を長期間、保存する SQL データベースです。</td></tr><tr><td>Operations Manager コンソール</td><td>GUI ベースのユーザーインタフェースです。SCOM のほとんどの操作はオペレーションコンソールから実行できます。</td></tr><tr><td>Webコンソール</td><td>Web ベースのユーザーインタフェースで、監視に特化されています。</td></tr><tr><td>Operations Manager レポートサーバー</td><td>データウェアハウスデータベースの情報を元にレポートの作成と表示をおこないます。</td></tr><tr><td>レポートサーバー向けデータベース</td><td>レポートを表示する際に参照される SQL データーベースです。</td></tr><tr><td>ACSサーバー</td><td>セキュリティログを収集し、ACSデータベースに保存します。</td></tr><tr><td>ACSデータベース</td><td>セキュリティログを保存するSQLデータベースです。</td></tr></tbody></table><p>上記それぞれのコンポーネントをインストールするためのハードウェア / ソフトウェア要件がそれぞれございます。<br>主な要件については下記ページに記載しておりますのでご参照ください。</p><h3 id="SCOM-サーバーを構成するコンポーネントの要件"><a href="#SCOM-サーバーを構成するコンポーネントの要件" class="headerlink" title="SCOM サーバーを構成するコンポーネントの要件"></a>SCOM サーバーを構成するコンポーネントの要件</h3><ul><li>SCOM 2019<ul><li><a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2019">SCOM 2019 のシステム要件</a></li><li><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2019">SCOM 2019 のSQL Server の設計に関する考慮事項</a></li></ul></li><li>SCOM 2022 <ul><li><a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2022">SCOM 2022 のシステム要件</a></li><li><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2022">SCOM 2022 のSQL Server の設計に関する考慮事項</a></li></ul></li></ul><h2 id="SCOM-サーバー-の取り得る構成"><a href="#SCOM-サーバー-の取り得る構成" class="headerlink" title="SCOM サーバー の取り得る構成"></a>SCOM サーバー の取り得る構成</h2><p>ここまで上記コンポーネントの説明、ならびにその要件を記載させていただきましたが、以下に具体的な構成について記載します。</p><h3 id="OS-が-1-台の場合"><a href="#OS-が-1-台の場合" class="headerlink" title="OS が 1 台の場合"></a>OS が 1 台の場合</h3><p>1 台のサーバー管理グループに展開するのは、評価やテスト、管理パックの開発など、通常、ラボ、開発、または実稼働以外の環境にインストールする場合を想定しております。<br><img src="/blog/SCOM/SCOM_construction/0101.png"></p><p>構築方法については下記参考ページをご参照ください。　　</p><p><a href="https://docs.microsoft.com/ja-jp/system-center/scom/deploy-single-server?view=sc-om-2019">Operations Manager を 1 台サーバー構成で展開する</a><br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/quickstart-install-single-server?view=sc-om-2019">Operations Manager を 1 台のサーバーにインストールする手順</a></p><h3 id="OS-が-2-台の場合"><a href="#OS-が-2-台の場合" class="headerlink" title="OS が 2 台の場合"></a>OS が 2 台の場合</h3><p>管理グループを分散インストールすると、複数のサーバーに機能とサービスを配布して、環境を拡張できます。<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2019">SQL Server の設計に関する考慮事項</a>に記載しているように中規模から大規模の分散型展開では、SQL Server インスタンスを専用スタンドアロン サーバーまたは SQL Server 高可用性構成に配置する必要があります。</p><p>OS が 2 台の場合、具体的には下図のように DB 機能とサーバー機能を分散させます。<br><img src="/blog/SCOM/SCOM_construction/0201.png"></p><blockquote><p>[!WARNING]<br>システム要件に明確に記載しておらず恐縮ですが、<code>以下の構成は実績上取れない事を確認しているため避ける</code>ようお願いいたします。</p><ul><li> OS1 と OS2 で WSFC 構成を取り、DB（オペレーションデータベース / データウェアハウスデータベース） を always-on として構成</li><li> その OS1 もしくは OS2 上に 管理サーバーを構築する構成。</li></ul></blockquote><p>もし 2 台(この場合は OS というより故障の単位となる筐体でしょうか）で管理サーバー、及びデーターベース機能を冗長構成とすることが必須の場合は、WSFC の役割りとして VM ごと冗長構成とすることをご検討ください。<br>WSFC のフェールオーバー機能を使用して、片方（OS1）が故障した際に、もう片方（OS2）にフェールオーバーする構成となります。別途 CSV を担うサーバー/機能が必要となります。<br>しかし、上記「 OS が 1 台の場合」に記載しておりますとおり、<br> 1 台のサーバー管理グループに展開するのは、評価やテスト、管理パックの開発など、通常、ラボ、開発、または実稼働以外の環境にインストールする場合を想定している点についてご留意くださいませ。</p><h3 id="OS-が-3-台の場合"><a href="#OS-が-3-台の場合" class="headerlink" title="OS が 3 台の場合"></a>OS が 3 台の場合</h3><p>OS が 3 台の場合は<br>DB 機能を <a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2022#sql-server-always-on-1">always-on 構成</a> で冗長化させる構成（パターン 1）<br>または<br>オペレーションデータベース と データウェアハウスデータベースを別 OS として構成（パターン 2）<br>が考えられます。</p><h4 id="パターン-1"><a href="#パターン-1" class="headerlink" title="パターン 1"></a>パターン 1</h4><p><img src="/blog/SCOM/SCOM_construction/0301.png"></p><p>この場合にレポートサーバー向けデータベース構成については、always-on の可用性グループには登録できない点ご留意ください。<br>レポートサーバー向けデータベースをホストする OS が故障した際には <a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-move-reporting-services-role?view=sc-om-2019">Reporting Server の役割を移動する方法</a><br>に従いもう片方の OS 上で構築するようお願いいたします。<br>尚、データウェアハウスデーターベースが健在であれば、その情報からレポーティングに必要なデーターベースは構成可能でございます。</p><p>下記に当社の海外エンジニアが記載したレポーティングサーバーの取り得る構成について記載した下記ブログがございますので、よろしければご参照ください。<br><a href="https://techcommunity.microsoft.com/t5/system-center-blog/operations-manager-reporting-8211-supported-ssrs-configurations/ba-p/340385">レポーティングサーバーの取り得る構成</a></p><h4 id="パターン-2"><a href="#パターン-2" class="headerlink" title="パターン 2"></a>パターン 2</h4><p><img src="/blog/SCOM/SCOM_construction/0302.png"></p><p>当構成に関する情報は<a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2019#operations-manager-data-warehouse-database">Operations Manager データ ウェアハウス データベース</a><br>に以下のように記載しております。</p><p>レポート データ ウェアハウスは Operations Manager データベースとは別のサーバーに配置することを検討してください。 小規模の展開では、多くの場合、Operations Manager データベースとレポート データ ウェアハウスを同じサーバーで統合できますが、エージェントの数と入ってくるオペレーション データの量を増やすときに、分離すると効果的です。 レポート データ ウェアハウスとレポート サーバーが <code>Operations Manager データベースとは別のサーバーにあると、レポート パフォーマンスが向上します</code>。</p><h4 id="2-パターンのすみ分け"><a href="#2-パターンのすみ分け" class="headerlink" title="2 パターンのすみ分け"></a>2 パターンのすみ分け</h4><p>上記 2 パターンのすみ分けとしては以下が考えられますので、お客様の構成時の参考にしていただければ幸いです。<br>　-データのリアルタイム保護性を重要視する（重要視する運用方針の場合）<br>　　　-&gt; パターン 1 を選択<br>　-処理を分散させることで、処理負荷によるデータ I/O 失敗によるデータ欠損やワークフロー失敗を出来るだけ抑止する<br>　　　-&gt; パターン 2 を選択</p><h3 id="OS-が-4-台の場合"><a href="#OS-が-4-台の場合" class="headerlink" title="OS が 4 台の場合"></a>OS が 4 台の場合</h3><p>4 台目は SCOM 管理サーバーの 2号機を構築いただく事が構成として考えられます。<br>追加する手順については <a href="https://docs.microsoft.com/ja-jp/system-center/scom/deploy-install-mgmt-server?view=sc-om-2019#to-install-additional-management-servers-in-the-management-group">管理グループに追加の管理サーバーをインストールするには</a> をご参照ください。<br>SCOM 管理サーバーの 2 台目を構築いただく事が可能であり、それにより管理サーバーも冗長化されるとともに以下のように役割りを分散させる事が可能となります。</p><h4 id="パターン-1-1"><a href="#パターン-1-1" class="headerlink" title="パターン 1"></a>パターン 1</h4><p>Windows と UNIX/LINUX 系でエージェントのプライマリサーバー役（収集データのプライマリ送信先）を分散させる</p><h4 id="パターン-2-1"><a href="#パターン-2-1" class="headerlink" title="パターン 2"></a>パターン 2</h4><p>エージェントの台数が多い場合にエージェントのプライマリサーバー役（収集データのプライマリ送信先）を平準化するよう分散させる</p><h3 id="OS-が-5-台の場合"><a href="#OS-が-5-台の場合" class="headerlink" title="OS が 5 台の場合"></a>OS が 5 台の場合</h3><p>5 台目は レポーティングサーバー、もしくは ACS サーバーを独立させてホストすることが考えられます。<br>こちらはお客様の用途(例、ACS 機能を重視しており使う頻度が高く、その機能にリソースを多く割り当てたい）によってご検討ください。</p><p>構築手順は下記ページをご参照ください。</p><p><a href="https://docs.microsoft.com/ja-jp/system-center/scom/deploy-install-reporting-server?view=sc-om-2019">Operations Manager Reporting Server をインストールする方法</a><br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/deploy-install-acs?view=sc-om-2019">監査コレクション サービス (ACS) とデータベースをインストールする方法</a></p><p>以上、お客様の構成設計の参考になれば幸いでございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;br&gt;本日は SCOM サーバーを構成するコンポーネント、ならびにコンポートネントをホストする OS の台数のよって取り得る構成についてご紹介いたしま</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="SCOM サーバーの構成" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E6%A7%8B%E6%88%90/"/>
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>SCOM 2016 から SCOM 2022 へ移行 or アップグレードについて</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_migration/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_migration/</id>
    <published>2022-08-18T04:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.116Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。<br>本日は System Center Operations Manager（以後 SCOM）  の新環境への移行やアップグレードについての考え方をご紹介いたします。</p><p>まず前提として SCOM の仕様内容について以下記述いたします。</p><ol><li><p>SCOM 管理サーバーのバージョン違いの共存について<br>　基本的には 1 バージョン前の最新の UR とのみ共存が可能となります。<br>　参考：<a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2022#supported-coexistence">共存の要件</a></p></li><li><p>SCOM 管理サーバーのシステム要件<br>　SCOM 管理サーバーにはバージョンごとにシステム要件がございます。<br>　　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2022#supported-coexistence">SCOM 2022 のシステム要件</a><br>　　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2019#supported-coexistence">SCOM 2019 のシステム要件</a><br>　　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2016#supported-coexistence">SCOM 2016 のシステム要件</a><br>　　<a href="https://docs.microsoft.com/ja-jp/previous-versions/system-center/system-center-2012-r2/dn281935(v=sc.12)">SCOM 2012 R2のシステム要件</a></p></li></ol><p>上記ページを参照いただくと確認できるように 2 バージョン 離れていると要件を満たす OS や SQL Server で共有するバージョンがございません。<br>例）<br>SCOM 2022 に対応する OS バージョン<br>　Windows Server 2019 Standard/Datacenter<br>　Windows Server 2019 Server Core<br>　Windows Server 2022 Standard/Datacenter<br>　Windows Server 2022 Server Core<br>SCOM 2016 に対応する OS バージョン<br>　Windows Server 2012 R2  Standard/Datacenter<br>　Windows Server 2016 Standard/Datacenter<br>　Windows 2016 Server Core</p><p>一方、多くのお客様が HW の EOL 対応や減価償却期間を踏まえたリプレース、もしくは Microsoft サポートフェーズを踏まえた移行やアップグレードを検討する場合、新環境は 2 バージョン以上先になると考えております。<br>その場合 2 段階のアップグレード （例、SCOM 2016 -&gt; SCOM 2019 -&gt; SCOM 2022）することはシステム要件を踏まえると現実的（※1）ではございません。</p><p>そのため選択肢としては新規に SCOM 管理サーバーを構築したのちに、監視対象サーバーから旧エージェントをアンインストールいただき、新バージョンをインストールして入れ替えることなります。<br>アンインストール/インストール方法については下記公開情報をご参照ください。</p><p>アンインストール方法の関連情報（SCOM 2016 に関する公開情報）<br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-uninstall-windows-agent?view=sc-om-2016">Windows ベースのコンピューターからエージェントをアンインストールする</a><br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-upgrade-uninstall-crossplat-agent?view=sc-om-2016#uninstalling-agents">Upgrading and Uninstalling Agents on UNIX and Linux Computers (UNIX および Linux コンピューター上のエージェントのアップグレードおよびアンインストール)</a><br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-uninstall-crossplat-agent?view=sc-om-2016">Manually Uninstalling Agents from UNIX and Linux Computers</a><br>インストール方法の関連情報（SCOM 2022 に関する公開情報）<br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-deploy-windows-agent-console?view=sc-om-2022">検出ウィザードを使ってエージェントを Windows にインストールする</a><br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-deploy-windows-agent-manually?view=sc-om-2022">MOMAgent.msi を使用して Windows エージェントを手動でインストールする</a><br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-deploy-crossplat-agent-console?view=sc-om-2022">検出ウィザードを使ってエージェントを UNIX および Linux にインストールする</a><br>　<a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-install-crossplat-agent-cmdline?view=sc-om-2022">コマンド ラインから UNIX および Linux コンピューターにエージェントをインストールする</a></p><p>また新環境を構築することで以下のメリットがございます。<br>　・旧環境と併設できるため、エージェント側の状況（監視を停止できる時間）を踏まえて移行できる<br>　・アップグレードの場合サポートしていない管理パックが引き継がれるリスクが混在するが、その問題を回避できる<br>　・新バージョンでサポートしていない監視対象については、引き続き旧環境で監視できる<br>　　　例） SCOM 2022 で監視対象となる Windows のバージョン（※2）は Windows Server 2012 以降/ Windows 10 以降となります。</p><p>新環境への移行やアップグレードについてお困りごとがございましたら Microsoft までお問合せくださいませ。</p><p>※ 1<br>OS や SQL Server のバージョンアップや 要件を満たす HW へ移行をすることで実現できる可能性はございます。<br>※ 2<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/system-requirements?view=sc-om-2022#microsoft-monitoring-agent-operating-system">監視対象の要件</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;br&gt;本日は System Center Operations Manager（以後 SCOM）  の新環境への移行やアップグレードについての考え方を</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="アップグレード" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89/"/>
    
    <category term="新環境への移行" scheme="https://jpsystemcenter.github.io/blog/tags/%E6%96%B0%E7%92%B0%E5%A2%83%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>SCOM 2019 以降で Windows 検出ウィザードで検出失敗</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_service_logon_access/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_service_logon_access/</id>
    <published>2022-08-03T06:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.116Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以後 SCOM）  2019 で変更のあった仕様の 1 つをご紹介いたします。<br>2022 年 8 月現在の状況として、（<a href="https://docs.microsoft.com/ja-jp/lifecycle/products/microsoft-system-center-2012-r2-operations-manager">SCOM 2012 R2の延長サポートのフェーズが2022年7月に終了</a>）したことに伴い、SCOM 2019 や 2022 など後継バージョンの環境を新規構築して移行を進めている、もしくはご計画されているお客様もいるかと存じます。</p><p>SCOM 2019 の新規環境を構築後に Windows コンピューターを検出する際に SCOM インストール ユーザ以外で検出を試みると下図のエラー（対象コンピューターがいない）と出力される場合がございます。</p><p><img src="/blog/SCOM/SCOM_service_logon_access/SCOM_detection_computer_failures.png"></p><p>この事象はこれまでのバージョンと異なり検出する実行アカウントに対しててサービス ログオンアクセス許可を有効にいない場合に発生している可能性がございます。<br>設定をされていなければ、下記手順にて一度設定をいただき、事象がfai改善するかご確認いただければと存じます。</p><p>SCOM 管理サーバーにて以下設定をする事で、サービス ログオンアクセス許可を有効にできます。</p><ol><li>SCOM 管理サーバーに管理者特権でサインインします。</li><li>[管理ツール] に移動し、 [ローカル セキュリティ ポリシー] をクリックします。<br>　例えば、Windows Server 2016 以降では、スタートメニューを開き、[Windows 管理ツール] -&gt; [ローカル セキュリティ ポリシー] をクリックします。</li><li>[ローカル ポリシー] を展開し、 [ユーザー権利の割り当て] をクリックします。</li><li>右側のウィンドウで、 [サービスとしてログオン] を右クリックし、 [プロパティ] を選択します。</li><li>[ユーザーまたはグループの追加] オプションをクリックし、以下どちらかを追加します。</li><li>サーバーを再起動します。</li></ol><p>参考サイト：<a href="https://docs.microsoft.com/ja-jp/system-center/scom/enable-service-logon?view=sc-om-2019#enable-service-log-on-permission-for-run-as-accounts">https://docs.microsoft.com/ja-jp/system-center/scom/enable-service-logon?view=sc-om-2019#enable-service-log-on-permission-for-run-as-accounts</a></p><blockquote><p>対象バージョン：<br>　System Center Operations Manager 2019<br>　System Center Operations Manager 2022</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以後 SCOM）  2019 で変更のあった仕様の 1 つをご</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM ジョブ保存設定変更方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Job_History/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Job_History/</id>
    <published>2022-07-07T03:00:00.000Z</published>
    <updated>2024-03-13T12:36:01.128Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆さんこんにちは、System Center サポートチームの 保科と申します。</p><p>今回は、System Center Virtual Machine Manager (SCVMM) で保存されるジョブ履歴の保存設定についてご紹介いたします。</p><h3 id="本ページが対象とする-SCVMM-バージョン"><a href="#本ページが対象とする-SCVMM-バージョン" class="headerlink" title="本ページが対象とする SCVMM バージョン"></a>本ページが対象とする SCVMM バージョン</h3><p>SCVMM 2016<br>SCVMM 2019<br>SCVMM 2022</p><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>SCVMM で実行される処理の多くは、ジョブという形で実行されます。<br>このジョブが実行されると、実行可否に関わらず、履歴としてすべて SCVMM データベースに存在する [dbo].[tbl_TR_TaskTrail] というテーブルに保存されます。<br>ジョブ履歴ですが、バッチ処理を組まれる等して大量のジョブが短期間で実行される環境においては、このテーブルが肥大化する要因となります。<br>テーブルが肥大化することで、SCVMM 観点においては下記の影響が発生します。</p><ul><li>単純に [dbo].[tbl_TR_TaskTrail] テーブルサイズが肥大化し、データベースファイルサイズの肥大化</li><li>SCVMM へのパフォーマンスへの影響</li></ul><p>意外に思われるかもしれませんが、ジョブ履歴が大量に保存されている環境においては、SCVMM へのパフォーマンス影響が発生する可能性がございます。<br>特段負荷が大きい処理を連続して実施されていないにも関わらず、SCVMM ジョブの実行速度や SCVMM 自体が以前より遅くなったといった状況では、ジョブ履歴が大量に保存されている可能性がございます。</p><h3 id="対処手順"><a href="#対処手順" class="headerlink" title="対処手順"></a>対処手順</h3><p>このジョブ履歴ですが、レジストリ値によってジョブ履歴保持日数および削除処理が行われる周期を設定いただけます。<br>そのため、”概要” 項で説明しました影響が発生されている場合は、そのレジストリ値設定を変更いただくのが切り分けとして有用となります。</p><p>追加いただくレジストリは、以下の 2 種類が該当いたします。</p><blockquote><p>レジストリキー:<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft System Center Virtual Machine Manager Server\Settings\Sql</p><p>レジストリの種類:<br>DWORD (32 ビット) 値</p><p>レジストリの名称:<br>TaskGC</p><p>レジストリ値:<br>ジョブの保持日数を整数値で指定します。<br>例えば、本レジストリ値が 7 に設定された場合、ジョブ履歴削除処理が行われた日付時刻から 7 日以内のジョブは保持され、それ以外はすべて削除対象となります。<br>レジストリが未作成の状態である場合、本レジストリ値は 90 に設定されたものとして動作が行われます。<br>こちらのレジストリ設定値を、ご利用の環境でどの程度ジョブ履歴を重要視されるかに応じて設定します。<br>また、本レジストリ値の設定値に関わらず、一度のジョブ履歴削除処理で削除されるジョブ数は最大で 25000 件となります。<br>そのため、各処理間で 25000 件以上のジョブ履歴が保存される場合、ジョブ履歴は傾向として増加される状況となります。<br>ご利用の環境に合わせて、もう一つのレジストリである “DBGCUpdateInterval” のレジストリ値を構成します。</p></blockquote><blockquote><p>レジストリキー:<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft System Center Virtual Machine Manager Server\Settings</p><p>レジストリの種類:<br>DWORD (32 ビット) 値</p><p>キーの名称 :<br>DBGCUpdateInterval</p><p>レジストリ値:<br>ジョブ削除ジョブが実行される周期を秒単位の整数値で指定します。<br>レジストリが未作成の状態である場合、本レジストリ値は 72000 (= 20 時間) に設定されたものとして動作が行われます。</p></blockquote><p>レジストリの作成は、下記手順で行えます。</p><ol><li>レジストリを追加する SCVMM サーバーに管理者権限でログインします。</li><li>[Win] + [R] キーを押下し、”regedit” と入力して実行します。</li><li>画面左ペインより、各レジストリの追加先となるレジストリキーにアクセスします。</li><li> レジストリが表示された画面上で右クリックし、[新規] -&gt; [DWORD (32 ビット) 値] をクリックします。</li><li>追加されたレジストリに対して、”キーの名称” で指定された文字列を入力します。</li><li>追加されたレジストリをダブルクリックし、レジストリの編集を行います。</li><li>ウィンドウ右側に表示された [10 進数] を選択し、レジストリで指定いただく値を入力します。</li><li>レジストリ追加完了後、SCVMM サーバーに関するサービスである “System Center Virtual Machine Manager” サービスを再起動します。</li></ol><h3 id="厳密な処理内容"><a href="#厳密な処理内容" class="headerlink" title="厳密な処理内容"></a>厳密な処理内容</h3><p>ジョブ履歴削除処理は、SCVMM データベースに作成された “dbo.prc_TR_GarbageCollect” ストアド プロシージャが呼び出されて実行されます。<br>最大25000 行のデータ削除処理は、ストアド プロシージャ内に下記の通り “SELECT TOP 25000…” と、実装が明示的に行われております。</p><blockquote><p>(途中略)</p><p>-- do at most 25,000 every time to handle extreme backlog cases<br>-- get the list of IDs to delete<br>SELECT TOP 25000 TaskID, ResultObjectID<br>INTO #TasksToDelete<br>FROM dbo.tbl_TR_TaskTrail<br>WITH (ROWLOCK, UPDLOCK, HOLDLOCK)<br>WHERE EndDateTime IS NOT NULL AND EndDateTime &lt; @CutoffDateTime</p><p>(途中略)</p><p>(こちらの実装は SCVMM 2016、2019 および 2022 で同一です。)</p></blockquote><h3 id="ご参考"><a href="#ご参考" class="headerlink" title="ご参考"></a>ご参考</h3><p>既に弊社にて公開がされていないサイトとなりますので、こちらのブログにて併せてそちらのサイトの内容をご紹介いたします。<br>その公開終了されたサイトでは、SCVMM のジョブについて要約すると以下の内容が書かれておりました。</p><ul><li>SCVMM の仕様として、目安ではあるものの 10000 の同時並行実施ジョブが処理可能であること。</li><li>10000 以上のジョブが同時並行で実施されている場合、SCVMM サーバーのパフォーマンスに多大な影響を及ぼす可能性があること。</li><li>大量のジョブが並行実施される動作とは別に、SCVMM ジョブ履歴が大量に保存されている場合、それによっても SCVMM サーバーのパフォーマンスに多大な影響を及ぼす可能性があること。</li></ul><p>公開終了とされる前に記載されております内容について、原文のままご紹介いたします。</p><ul><li><p>SCVMM で同時並行で実行可能なジョブ数に関する記述:</p><blockquote><p>The maximum number of running jobs that an SCVMM system should be able to handle is around 10,000 and hitting this many running jobs at one time would be an exceptionally rare occurrence.<br>Should it occur, however, it can have a severe impact on the performance of the SCVMM engine.</p></blockquote></li><li><p>SCVMM ジョブ履歴が大量に保存されていることで発生しうる影響に関する記述:</p><blockquote><p>The number of retained Jobs count refers to the number of running tasks tracked in the TaskTrail database table in SQL.<br>The size of this database can have as much of an impact on performance as the actual running jobs.<br>If the number of running jobs nowhere reaches 10,000 then it may be that the tombstone limit on entries tracked in the TaskTrail database is too conservative</p></blockquote></li></ul><h3 id="アップデート履歴"><a href="#アップデート履歴" class="headerlink" title="アップデート履歴"></a>アップデート履歴</h3><ul><li>2023/11/13 更新:<br>一度のジョブ履歴削除処理が行われる際に削除されるデータ件数の記述を 50000 件から 25000 件に変更しました。<br>従前の記述である 50000 件は、SCVMM 2008 における仕様でございました。<br>また、データ削除処理の詳細も記載いたしました。</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆さんこんにちは、System Center サポートチームの 保科と申します。&lt;/p&gt;
&lt;p&gt;今回は、System Center Virtual Machine Manager (SCVMM) で保存されるジョブ履歴の保存設</summary>
      
    
    
    
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
    <category term="SCVMM Server" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM-Server/"/>
    
    <category term="Job" scheme="https://jpsystemcenter.github.io/blog/tags/Job/"/>
    
  </entry>
  
</feed>
