<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan System Center Support Blog</title>
  
  <subtitle>日本マイクロソフトの System Center に関するサポート情報のブログです。</subtitle>
  <link href="https://jpsystemcenter.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpsystemcenter.github.io/blog/"/>
  <updated>2025-12-10T08:31:19.038Z</updated>
  <id>https://jpsystemcenter.github.io/blog/</id>
  
  <author>
    <name>Japan System Center Support</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>write ロックによってジョブの実行が行えなくなる事象の対処方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_DeleteWriteLock/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_DeleteWriteLock/</id>
    <published>2025-11-05T00:00:00.000Z</published>
    <updated>2025-12-10T08:31:19.038Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 保科 です。<br>今回は、SCVMM の運用上オブジェクトに write ロックが発生したことによって、仮想マシンの操作が行えなくなった場合の対処方法をご案内します。<br><br></p><span id="more"></span><h2 id="本ページが対象とする-SCVMM-バージョン"><a href="#本ページが対象とする-SCVMM-バージョン" class="headerlink" title="本ページが対象とする SCVMM バージョン"></a>本ページが対象とする SCVMM バージョン</h2><p>SCVMM 2016 以降の全バージョン</p><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>SCVMM ではデータベース上のオブジェクトを変更する際、ロックテーブルにエントリを書き込み、ロックがある場合は他のジョブが更新出来ない様になっています。<br>このテーブルにロックが残ることがあり、クリアしないと更新が出来なくなる場合があります。<br>ロックが発生したオブジェクトに対する操作を行った場合、以下のエラーが表示されることが一般的です。</p><blockquote><p>エラー（2606）<br>型VMHostのオブジェクトｘｘｘｘｘｘはタスクｘｘｘｘｘ’バーチャルマシンプロパティの更新’によって’Write’ロックでロックされているため<br>このオブジェクトに対する’Write’ロックを取得できません</p><p>推奨される操作<br>ロックを保持しているタスクを取り消すか、完了するまで待機してから操作を再試行してください</p></blockquote><h2 id="対処方法"><a href="#対処方法" class="headerlink" title="対処方法"></a>対処方法</h2><p>write ロックは SCVMM で実行されるジョブによって設定されます。<br>そのジョブの実行完了とともに write ロックが解除されることが一般的で、多くの場合時間経過によって解消が見込まれます。<br>ただし、時間経過によって解消されない場合、write ロックの手動削除が必要となります。<br>下記にご案内とします手順は、その手動削除を行うための操作となります。</p><h3 id="1-SCVMM-データベースのバックアップ"><a href="#1-SCVMM-データベースのバックアップ" class="headerlink" title="1. SCVMM データベースのバックアップ"></a>1. SCVMM データベースのバックアップ</h3><ol><li>SCVMM コンソールを起動し、管理者の権限を持つユーザーでログインします。</li><li>ナビゲーション ボタン (左下) の [設定] をクリックします。</li><li>上部のリボン メニューから [バックアップ] ボタンをクリックします。</li><li>バックアップの作成先となるフォルダー (例: C:\Temp) を入力して [OK] ボタンをクリックします。<br>指定するフォルダーは、SQL Server 上に存在し、アクセス可能なフォルダーである必要があります。</li><li>ナビゲーション ボタン (左下) の [ジョブ] をクリックします。</li><li>VMM データベースのバックアップの作成 ジョブが完了したことを確認します。<br>指定したフォルダーに bak ファイルが作成されたことを確認します。</li></ol><h3 id="2-SCVMM-サービス再起動"><a href="#2-SCVMM-サービス再起動" class="headerlink" title="2. SCVMM サービス再起動"></a>2. SCVMM サービス再起動</h3><ol><li>SCVMM コンソールを閉じ、スタートメニューから、”サービス” を開き、[System Center Virtual Machine Manager Service] を停止します。</li><li>“Microsoft SQL Management Studio” を開き、”VirtualManagerDB” -&gt; “テーブル” -&gt; [dbo.tbl_VMM_Lock] を確認し、空となっていることを確認します。</li><li>テーブル空となっている場合、write ロックの削除は完了しております。<br>スタートメニューから、”サービス” を開き、[System Center Virtual Machine Manager Service] を起動します。<br>SCVMM コンソールを開き、以前までに失敗していたジョブが正常に完了するかご確認下さい。<br>もし空になっていない場合、サービスの起動は行わず、次の手順を実行します。</li></ol><h3 id="3-write-ロックの全削除"><a href="#3-write-ロックの全削除" class="headerlink" title="3. write ロックの全削除"></a>3. write ロックの全削除</h3><ol><li>“VirtualManagerDB” -&gt; “プログラミング” -&gt; “ストアド プロシージャ” -&gt; “システム ストアド プロシージャ” -&gt; [dbo.prc_VMM_ReleaseAllLocks] を探します。</li><li>[dbo.prc_VMM_ReleaseAllLocks] を右クリックし、”ストアド プロシージャの実行” をクリックします。</li><li>[プロシージャの実行] ウインドウにて [OK] をクリックします。</li><li>再度 “Microsoft SQL Management Studio” を開き、”VirtualManagerDB” -&gt; “テーブル” -&gt; [dbo.tbl_VMM_Lock] を確認し、空となっていることを確認します。<br>スタートメニューから、”サービス” を開き、[System Center Virtual Machine Manager Service] を起動します。<br>SCVMM コンソールを開き、以前までに失敗していたジョブが正常に完了するかご確認下さい。</li></ol><h2 id="対処方法実施による影響"><a href="#対処方法実施による影響" class="headerlink" title="対処方法実施による影響"></a>対処方法実施による影響</h2><p>結論として、対処操作実施による影響はございません。<br>Write ロックの削除を行うストアド プロシージャは、[dbo.tbl_VMM_Lock] テーブルのレコードをすべて削除する操作となります。<br>ただし、削除操作は [System Center Virtual Machine Manager Service] サービスを停止してから行う手順としております。<br>このサービスは SCVMM サーバー本体のサービスに該当するため、削除操作中は SCVMM サーバー機能が停止中の状態となります。<br>そのため、削除操作中に新たに write ロックが発生することもないため、安心して削除操作を実施いただいても問題ございません。<br>レコードの個別削除は、どのオブジェクトに write ロックがかかっているか、といった高度な診断が必要となります。<br>どちらの場合で、以下の観点から全削除の方が効果的な対処方法とご判断ください。</p><ul><li> SCVMM 環境への影響を及ぼすことなく操作を行えること</li><li>SCVMM サービス停止中は write ロックは存在しないことが理想的につき、最終的には write ロックはすべて削除する状態 (= 全削除でも個別削除でも最終目標は同じ) を目指すため</li></ul><h2 id="ご参考"><a href="#ご参考" class="headerlink" title="ご参考"></a>ご参考</h2><p>本ブログでご紹介しました内容は、弊社公開情報に纏められた手順を詳細にまとめたものとなります。<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/system-center/vmm/deploying-vm-error-2931">System Center Virtual Machine Manager で仮想マシンをデプロイするときのエラー 2931</a></p><hr><p>write ロックの削除方法は以上となります。<br>write ロックがかかった状態となり続けることは稀ですが、万が一発生した場合はこの手順に沿って対処を行ってください。<br>最後までご覧いただきありがとうございました。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 保科 です。&lt;br&gt;今回は、SCVMM の運用上オブジェクトに write ロックが発生したことによって、仮想マシンの操作が行えなくなった場合の対処方法をご案内します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="Database" scheme="https://jpsystemcenter.github.io/blog/tags/Database/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
    <category term="Troubleshooting" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshooting/"/>
    
    <category term="2606" scheme="https://jpsystemcenter.github.io/blog/tags/2606/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM の機能紹介</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_About/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_About/</id>
    <published>2025-11-04T00:00:00.000Z</published>
    <updated>2025-12-10T08:31:19.015Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 保科 です。<br>今回は、はじめて SCVMM をご利用いただく方に向けて、SCVMM とは何ができるのか？という点を説明します。<br><br></p><span id="more"></span><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>昨今の VMWare ライセンス費用の実質的な高騰に伴い、多くのお客様が Hyper-V への移行をご検討いただいているものと思います。<br>Hyper-V における VMWare vCenter の役割を果たすのが SCVMM となります。<br>また、Microsoft 公式として、VMWare 環境から Hyper-V 環境へ仮想マシンを変換することをサポートするアプリケーションは、現在 SCVMM のみとなります。<br>この移行を行うために、大変ありがたいことに多くのお客様に SCVMM をご利用いただいております。<br>しかし、SCVMM を導入したとして、そもそも SCVMM では何ができるのか？どんな機能があるのか？vCenter の代替になりえるのか？といったご質問を多くいただいております。<br>本記事では、現在移行をご検討いただいている方に向けて、SCVMM の機能概要を説明するものとなります。<br>概要の紹介にとどまりますが、今後移行を予定されている方も、移行が完了された後にどんな機能があるか知りたい方も、ぜひこちらの内容をご参考としてください。</p><h2 id="SCVMM-で実現可能な機能"><a href="#SCVMM-で実現可能な機能" class="headerlink" title="SCVMM で実現可能な機能"></a>SCVMM で実現可能な機能</h2><p>SCVMM をご利用いただくことで、以下の利用が可能です。<br>まず SCVMM の概要を紹介している弊社公開情報をご案内いたします。<br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/overview?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115746627%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=TE+mmNN7Gz+4Qu92qMHfjYrKrkds44UdwsBVUSP17X0=&reserved=0">Virtual Machine Manager とは | Microsoft Learn</a><br>こちらの内容を、以下の通りに要約いたします。</p><ul><li>各種 Hyper-V ホストやクラスター、VMWare ESXi ホストやクラスターの管理、およびそれらの上で動作する仮想マシンの管理:<br>SCVMM では、ご利用の環境内に存在するホストやクラスター、およびそれらの上で動作する仮想マシンを、単一の SCVMM ファブリック内で一元管理可能です。<br>Hyper-V に関しては、基本的に Hyper-V マネージャーで設定可能な項目は SCVMM 内でも設定可能です。<br>もちろん、仮想マシンの展開も SCVMM より実施いただけます。</li><li>ネットワーク設定の管理:<br>ホストや仮想マシンに必要なネットワーク設定を管理することが可能です。<br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/manage-networks?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115755432%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=batbjHxt57YTLZkbySzDH2HU8QDBfq08ct7efOirfUA=&reserved=0">VMM ネットワーク ファブリックのセットアップ | Microsoft Learn</a><br>代表的な機能をご紹介します。<ul><li>論理ネットワークとその上に IP アドレス プールを設定することで、その IP アドレス プール範囲内から、展開される仮想マシンに IP アドレスを自動付与</li><li>論理スイッチを作成することで、指定した設定に沿ってホストの NIC チーミングを SCVMM 経由で設定</li><li>ストレージ機器の管理:<br>SCVMM 上でストレージ機器を管理することが可能です。<br>管理対象のストレージ機器に共有フォルダを作成したり、ストレージ機器上の LUN をホストに割り当てすることが可能です。<br>これらのストレージ機器で作成された各種設定事項は、ホスト上で仮想マシンの配置に使用することが可能です。<br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/manage-storage?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115767042%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=Mv9xRkDWnxndxKqf8DtJ2DRnflCxJ6Ius/6bZHl5X60=&reserved=0">VMM 記憶域ファブリックを設定する | Microsoft Learn</a></li></ul></li><li>プライベート クラウドの設定:<br>SCVMM サーバー上にプライベート クラウドの設定を行うことで、各種物理リソースをクラウドに割り当てることが可能です。<br>割り当てられた物理リソースが利用可能な限り、ユーザーや仮想マシンが配置される物理リソースの設定を行うことなく、仮想マシンの管理運用が可能となります。<br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/deploy-cloud?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115775739%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=kS4/lC0G7cygkejvyhfB6v6MG8rMgSdANGSu1tmlkwE=&reserved=0">プライベート VMM クラウドを展開する | Microsoft Learn</a></li><li>インフラストラクチャ サーバーの管理:<br>SCVMM では、仮想マシンで使用する ISO ファイルや vhdx ファイル等を配置するために使用可能なライブラリ サーバーという機能がございます。<br>これらに各種仮想マシンで使用するファイルを配置いただくことで、例えばライブラリ サーバーに配置された ISO ファイルを、管理対象の仮想マシンすべてに割り当てることが可能となります。<br>その他にも PXE サーバー、IPAM サーバー、WSUS 等を管理対象とすることができ、それらのサーバー毎に提供される機能をホストや仮想マシンの管理に役立てることが可能です。<br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/infrastructure-server?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115782734%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=DifC7BvzG2drcXDEKVKUE/EH6Qc9AKP993VshFkX4v4=&reserved=0">VMM コンピューティング ファブリックでインフラストラクチャ サーバーを設定する | Microsoft Learn</a><br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/update-server?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115789456%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=3hX6uvRbS6v6LUnhi5sQH73bXAlrT9fAtt+StcDozkc=&reserved=0">VMM コンピューティング ファブリックで更新サーバーを設定する | Microsoft Learn</a></li><li>仮想化ホストの追加、プロビジョニング、管理:<br>SCVMM を使用することで、ベアメタル コンピューターより Hyper-V ホストやクラスターを展開することが可能です。<br>また、管理対象のスタンドアロン Hyper-V ホストを使用し、SCVMM よりそれらのホストでクラスターを新規に構成することも可能です。<br>クラスターの OS をアップグレードいただく場合、SCVMM を使用することで、ベアメタル展開の仕様に準拠してローリング アップグレードが可能となります。<br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/hyper-v-bare-metal?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115797346%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=DGzxiC2IYhzkwYy7nMQvaqle+/bZYVSdhinY/BprHYk=&reserved=0">ベア メタル コンピューターから Hyper-V ホストまたはクラスターをプロビジョニングする | Microsoft Learn</a><br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/hyper-v-standalone?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115804669%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=jFpP4KKxVSAEgJX0EZLMr/cd3hVjuZbsDKZJ/y5j+Uw=&reserved=0">VMM ファブリックの Hyper-V スタンドアロン ホストからクラスターをプロビジョニングする | Microsoft Learn</a><br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/hyper-v-rolling-upgrade?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115811448%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=XLhAatob/iWgIuGnnOH0+HGoRcQiy58ZAjBps7zDBfI=&reserved=0">VMM で Hyper-V ホスト クラスターの Windows Server へのローリング アップグレードを実行する | Microsoft Learn</a></li><li>VM テンプレートの利用:<br>既存の仮想マシンを VM テンプレート化することで、テンプレート化された時点の OS 設定で仮想マシンを複数デプロイすることが可能です。<br>テンプレートはライブラリに保存いただく必要がございます。<br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/library-vm-templates?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115818033%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=i8KJgOIGtAKgR5q+PhDffzeEZzfGlUjXR+mISq08nEA=&reserved=0">VM テンプレートを VMM ライブラリに追加する | Microsoft Learn</a><br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/library-service-templates?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115825118%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=IzogSQgeIvXzzJyNLpCkWw1o5D315e5f47tPqYWnZZk=&reserved=0">VMM ライブラリにサービス テンプレートを追加する | Microsoft Learn</a></li><li>Azure 管理:<br>SCVMM は、Azure Arc 対応 SCVMM として Azure に登録いただけます。<br>登録を行うことで、SCVMM 上に存在する各種リソースを Azure で管理いただけるようになります。<br>また、テンプレートを使用して SCVMM プライベート クラウド上に仮想マシンを展開いただけるようにもなります。<br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/azure/azure-arc/system-center-virtual-machine-manager/overview%23how-does-it-work&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115834558%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=0mUGNAK4MlLir4dZTCM7J0fRMfm0SuADj9G0R0vF+jQ=&reserved=0">Azure Arc 対応 System Center Virtual Machine Manager の概要 - Azure Arc | Microsoft Learn</a></li><li>VMWare 仮想マシンを Hyper-V 仮想マシンに変換:<br>SCVMM では、VMWare ESXi ホストの管理だけでなく、その上で動作する仮想マシンを Hyper-V 仮想マシンに変換いただけます。<br>現状弊社公式より提供されているアプリケーションにおいて、この変換が実施可能なアプリケーションは SCVMM のみとなります。<br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/vm-convert-vmware?view=sc-vmm-2022&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115841828%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=3NH7zgOS+apQ7j/8izl/3xtZRnN5RnHfAJGsfB3/avg=&reserved=0">VMM ファブリックで VMware VM を Hyper-V に変換する | Microsoft Learn</a></li><li>クラスター間ライブ マイグレーション:<br>SCVMM では、クラスター間で仮想マシンをライブ マイグレーションすることがサポートされております。<br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/ja-jp/system-center/vmm/migrate-live?view=sc-vmm-2025&tabs=SharedStorage&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115848558%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=+JP5E56qGXcKwpkxz3Z0mxKv8cKyC2CLua6+Zb0O5R0=&reserved=0">VMM ファブリックでライブ マイグレーションを実行する | Microsoft Learn</a><br>操作自体は SCVMM を使用することなく実施いただけますが、必要な操作が SCVMM を使用した場合は簡略化されているのが特徴です。<br><a href="https://nam06.safelinks.protection.outlook.com/?url=https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_LiveMigration_and_Errors/&data=05%7C02%7CAtsushi.Hoshina@microsoft.com%7Cdd62472f8425493f517a08dd62bc113a%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638775282115855145%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ==%7C0%7C%7C%7C&sdata=YAX/21LO5qJlttcDNjqt4Nl0/gwd6zTueBTOi5RFP9Q=&reserved=0">SCVMM のクラスター間ライブ マイグレーションの動作仕様、および仮想マシン移動時のエラーの対処方法 | Japan System Center Support Blog</a></li></ul><p>Hyper-V マネージャーや WAC を使用することで、Hyper-V の各種操作が可能となります。<br>具体的には以下が該当いたします。</p><ul><li>仮想マシンの作成</li><li>仮想ディスクの作成</li><li>仮想マシンのインポート/エクスポート</li><li>チェックポイントの作成</li><li>仮想マシンの開始/停止</li><li>仮想ディスクの拡張/縮小</li><li>仮想スイッチの作成/削除<br>これらの設定は SCVMM でも行うことが可能です。</li></ul><p>なお、WAC は厳密には Hyper-V に限らず、Windows に関する各種設定事項や Azure との機能連携も可能となります。<br>本件は SCVMM の観点からの機能紹介となりますので、Hyper-V に関連しない WAC の操作事項に関して詳細は割愛できればと思います。<br>WAC で利用可能な Hyper-V 以外の機能のご紹介に留められればと存じますが、具体的には下記操作を WAC によって実現可能です。</p><ul><li>Azure Backup</li><li>Azure Kubernetes サービス</li><li>Azure Monitor</li><li>クラスターの管理 (クラスター マネージャー相当)</li><li>PowerShel の実行</li><li>イベント ログの確認</li><li>サービスの状態の確認</li><li>タスク実行状況 (タスク スケジューラ相当) の確認</li><li>デバイス状態 (デバイス マネージャ相当) の確認</li><li>パケット キャプチャの採取</li><li>パフォーマンス (パフォーマンス モニター相当) の確認</li><li>役割と機能の追加/削除</li><li>リモート デスクトップ</li><li>記憶域レプリカの管理</li><li>レジストリの操作</li><li>ユーザーの追加/削除</li><li>Windows Update の適用</li></ul><h1 id="SCVMM-でのみ利用可能な機能"><a href="#SCVMM-でのみ利用可能な機能" class="headerlink" title="SCVMM でのみ利用可能な機能"></a>SCVMM でのみ利用可能な機能</h1><p>Hyper-V や WAC では実現できず、SCVMM を使用することで実現可能な機能としては下記が挙げられます。</p><ul><li>各種 Hyper-V ホストやクラスター、VMWare ESXi ホストやクラスターの管理、およびそれらの上で動作する仮想マシンの一元管理</li><li>仮想化ホストや仮想マシンに関するネットワーク設定の一元管理</li><li>ストレージ機器の一元管理と仮想化ホスト / 仮想マシンへのストレージ機器の割り当て</li><li>プライベート クラウドの運用</li><li>インフラストラクチャ サーバーの管理による、より SCVMM による一元管理を実現できる仮想化ホスト / 仮想マシン管理</li><li>SCVMM を経由した仮想化ホストの追加、プロビジョニング、管理</li><li>VM テンプレートの利用することによる同一設定仮想マシンのデプロイの容易化</li><li>SCVMM と登録仮想化ホスト / 仮想マシンのAzure 管理</li><li>VMWare 仮想マシンを Hyper-V 仮想マシンに変換</li><li>クラスター間ライブ マイグレーションの容易化</li></ul><p>Hyper-V マネージャーや WAC が提供する仮想マシンの管理操作に対して、SCVMM はそれを大きく拡張することが可能なアプリケーションとしてご認識いただければ問題ございません。</p><hr><p>SCVMM の概要紹介は以上となります。<br>これらの内容をレビューいただき、お客様の要件上 SCVMM の運用が適切かご判断いただく材料としてお役立てください。<br>最後までご覧いただきありがとうございました。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 保科 です。&lt;br&gt;今回は、はじめて SCVMM をご利用いただく方に向けて、SCVMM とは何ができるのか？という点を説明します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
  </entry>
  
  <entry>
    <title>Azure Arc SCVMM の紹介</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Azure_ARC/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Azure_ARC/</id>
    <published>2025-09-29T00:00:00.000Z</published>
    <updated>2025-12-10T08:31:19.016Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>今回は、SCVMM で管理しているオンプレミスの Hyper-V 環境を、Azure ポータルから操作できるようにする <strong>「Azure Arc SCVMM」</strong> についてご紹介します。<br><br></p><span id="more"></span><h2 id="Azure-Arc-SCVMM-とは"><a href="#Azure-Arc-SCVMM-とは" class="headerlink" title="Azure Arc SCVMM とは"></a>Azure Arc SCVMM とは</h2><p>Azure Arc SCVMM を利用すると、SCVMM で管理するオンプレミスの Hyper-V 上で稼働する仮想マシンを Azure ポータルから管理できるようになります。具体的には次のような操作が可能です：</p><ul><li>仮想マシンの起動・停止・削除</li><li>新規仮想マシンの作成</li><li>仮想マシンに Azure の拡張機能（例：Azure Monitor エージェント）をインストールし、Azure VM と同じように管理・監視</li></ul><p>本記事では以下について説明します。<br><b><a href="#%EF%BC%91%EF%BC%8ESCVMM-%E3%82%92-Azure-%E3%81%AB%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B">１．SCVMM を Azure に登録する方法</a></b><br><b><a href="#%EF%BC%92%EF%BC%8E%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E7%AE%A1%E7%90%86%E3%81%99%E3%82%8B">２．仮想マシンを管理する方法</a></b></p><h2 id="１．SCVMM-を-Azure-に登録する"><a href="#１．SCVMM-を-Azure-に登録する" class="headerlink" title="１．SCVMM を Azure に登録する"></a>１．SCVMM を Azure に登録する</h2><p>SCVMM を Azure に登録する際には、以下のリソースが必要です。<br><b>Azure 側</b><br>● リソースブリッジ①<br>● カスタムの場所<br><b>SCVMM 側</b><br>● リソースブリッジ② (※ Hyper-V 上の仮想アプライアンス)</p><p>これらのリソースは、Azure ポータルからダウンロードできるスクリプトを実行することで一度に作成されます。</p><h3 id="工程１：登録用スクリプトのダウンロード"><a href="#工程１：登録用スクリプトのダウンロード" class="headerlink" title="工程１：登録用スクリプトのダウンロード"></a>工程１：登録用スクリプトのダウンロード</h3><p>登録先の Azure 環境にログインし、Azure Arc 画面を開きます。 <strong>[リソースの追加]</strong> をクリックします。<br><img src="001.png"></p><p><strong>[System Center VMM]</strong> の <strong>[追加]</strong> をクリックします。<br><img src="002.png"></p><p><strong>[リソース ブリッジの新規作成]</strong> を選択し、 <strong>[次へ：基本]</strong> をクリックします。<br><img src="003.png"></p><p>以下の情報を入力し、 <strong>[次へ：タグ]</strong> をクリックします。<br>① リソースブリッジ名<br>② カスタムの場所名<br>③ SCVMM 管理サーバー名<br><img src="004.png"></p><p>必要に応じてタグを設定し、 <strong>[次へ：スクリプトのダウンロードと実行]</strong> をクリックします。<br><strong>[スクリプトをダウンロードする]</strong> をクリックして、スクリプトのダウンロードが完了したら <strong>[閉じる]</strong> をクリックします。<br><img src="005.png"></p><h3 id="工程２：スクリプトの実行"><a href="#工程２：スクリプトの実行" class="headerlink" title="工程２：スクリプトの実行"></a>工程２：スクリプトの実行</h3><p>ダウンロードした PowerShell スクリプト <code>resource-bridge-onboarding-script.ps1</code> を SCVMM 管理サーバー内の任意の場所にコピーします。<br>※ スクリプトは任意のサーバーで実行可能ですが、接続の問題を避けるため、 <strong>Azure ポータルにログイン可能な SCVMM 管理サーバーでの実行を推奨</strong> します。<br><img src="006.png"></p><p>PowerShell を管理者として起動し、スクリプトを実行します。<br><img src="007.png"></p><p><b>① Step 1/5： Setting up thecurrent workstation</b><br>初期構成に関する質問に回答します。<br>また、スクリプトの実行に必要なモジュールが自動的にインストールされるため、完了するまで待機します。<br><img src="008.png"></p><p><b>② Step 2/5： Creating the Arc Resource bridge</b><br>リソース ブリッジ作成のメイン処理です。<br>SCVMM サーバー接続情報やリソース ブリッジの設定を入力しながら進めます。<br><img src="009.png"></p><p><strong>状態が「Connected → Running」になれば作成完了</strong> です。<br><img src="010.png"></p><p>この時点で Hyper-V 上にリソース ブリッジの仮想アプライアンスが展開され、Azure ポータル上のリソース ブリッジも [Running] と表示されます。<br><img src="011.png"></p><p><b>③ Step 3/5： Installing cluster extension</b><br>クラスター拡張機能のインストール処理です。<br>通常は短時間で完了します。<br><img src="012.png"></p><p><b>④ Step 4/5： Creating custom location</b><br>Azure 上に「カスタムの場所」を作成する処理です。<br><img src="013.png"><br>正常に終了すると、Azure ポータルに新しいカスタムの場所が作成されていることを確認できます。<br><img src="014.png"></p><p><b>⑤ Step 5/5： Connectiong to VMMServer</b><br>最終ステップです。登録対象となる <strong>SCVMM の接続情報を再入力</strong> します。<br><img src="015.png"></p><h3 id="工程３：登録確認"><a href="#工程３：登録確認" class="headerlink" title="工程３：登録確認"></a>工程３：登録確認</h3><p>登録処理が正常に完了したら、Azure ポータルで以下を確認します。</p><ol><li><p><strong>[Azure Arc] &gt; [SCVMM 管理サーバー]</strong> を開き、SCVMM 管理サーバーが登録され、状態が <strong>Connected</strong> になっていることを確認します。<br><img src="016.png"></p></li><li><p><strong>[設定] &gt; [SCVMM インベントリ]</strong> を開き、SCVMM 環境のリソースが Azure 上に連携されていることを確認します。<br>以下は [仮想マシン] 画面の例です。（SCVMM 環境の仮想マシン一覧が表示されます）<br><img src="017.png"></p></li></ol><hr><h3 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h3><p>登録スクリプトの中では多数の処理が動作します。主な処理は次の通りです。</p><ul><li>SCVMM 環境への接続</li><li>ライブラリ サーバーへの仮想ディスクコピー</li><li>Hyper-V 上へのリソース ブリッジ仮想アプライアンス配置</li><li>Azure リソースの作成（リソース ブリッジ、カスタムの場所、SCVMM 管理サーバーなど）</li></ul><p>これらの処理には、<strong>20～30 分程度かかる場合があります</strong>。</p><p>実行中に突発的な通信断などが発生すると、スクリプトが失敗することがあります。<br>その場合は、以下のように <strong><code>-Force</code> オプション</strong>を付けて再実行してください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./resource-bridge-onboarding-script.ps1 -Force</span><br></pre></td></tr></table></figure><p>-Force を付けることで、失敗時に途中まで作成されたリソースが自動的にクリーンアップされ、再実行が可能になります。</p><p><b>● 参考情報</b><br>Azure Arc SCVMM の詳細および登録手順につきましては、以下の公開情報をご参照ください。<br>● <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/system-center-virtual-machine-manager/">Azure Arc SCVMM について</a><br>● <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/system-center-virtual-machine-manager/quickstart-connect-system-center-virtual-machine-manager-to-arc">Azure Arc SCVMM の登録手順</a></p><h2 id="２．仮想マシンを管理する"><a href="#２．仮想マシンを管理する" class="headerlink" title="２．仮想マシンを管理する"></a>２．仮想マシンを管理する</h2><h3 id="仮想マシンの管理"><a href="#仮想マシンの管理" class="headerlink" title="仮想マシンの管理"></a>仮想マシンの管理</h3><p>SCVMM が Azure に登録されると、SCVMM で管理している仮想マシンが Azure 上のリソースとして表示されます。<br>ただし、初期状態では <strong>参照のみ</strong> で操作はできません。</p><p>操作を有効にするには、Azure ポータルにて <strong>[Azure で有効にする]</strong> を実行します。<br>さらに、 <strong>[ゲスト管理を有効にする]</strong> にチェックを入れると、該当仮想マシンに <strong>Azure Connected Agent</strong> がインストールされ、Azure Monitor エージェントなどの拡張機能も利用できるようになります。<br><img src="018.png"></p><p>「Azure で有効にする」と「ゲスト管理を有効にする」を有効にした画面ショットです。<br><img src="019.png"></p><p>Azure で有効にした仮想マシンは、Azure VM と同じような管理画面が作成されます。</p><ul><li>状態の確認</li><li>起動／停止／削除<br>などの操作が可能です。<br><img src="020.png"></li></ul><p>また、<strong>ゲスト管理を有効にした仮想マシン</strong> では Azure Monitor エージェントなどの拡張機能のインストールが可能です。<br><img src="021.png"></p><p>拡張機能をインストールすることで以下の機能が利用可能になります。</p><ul><li>Azure Monitor エージェントを用いた監視データの収集</li><li>分析情報や変更分析の有効化</li><li>Azure VM と同様の拡張機能のインストールと監視<br><img src="022.png"></li></ul><p>ゲスト管理を有効にした仮想マシンは Azure Connected Agent がインストールされることで、Azure Arc リソースの「マシン」画面からも管理可能です。<br><img src="023.png"></p><h3 id="仮想マシンの作成"><a href="#仮想マシンの作成" class="headerlink" title="仮想マシンの作成"></a>仮想マシンの作成</h3><p>Azure ポータルから、オンプレミスの Hyper-V 上に <strong>新規仮想マシンを作成</strong>することも可能です。</p><p>作成できる仮想マシンは <strong>SCVMM 上のテンプレートに準拠</strong>している必要があります。<br><img src="024.png"></p><p>作成後は、SCVMM 管理下の Hyper-V 環境に VM が展開されます。<br><img src="025.png"></p><p>Azure ポータルから SCVMM で管理する Hyper-V 環境に対して行える操作の紹介は以上です。</p><hr><p>Azure ポータルからオンプレミスの Hyper-V 環境の管理を検討中の場合、本記事が参考になれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;今回は、SCVMM で管理しているオンプレミスの Hyper-V 環境を、Azure ポータルから操作できるようにする &lt;strong&gt;「Azure Arc SCVMM」&lt;/strong&gt; についてご紹介します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM を使用した VMware 仮想マシンの Hyper-V 仮想マシンへの変換</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Conversion/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Conversion/</id>
    <published>2025-08-04T00:00:00.000Z</published>
    <updated>2025-12-10T08:31:19.028Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>今回は、SCVMM を用いて VMWare VM を Hyper-V VM に変換する手順について説明します。<br><br></p><span id="more"></span><h2 id="仮想マシンへの変換について"><a href="#仮想マシンへの変換について" class="headerlink" title="仮想マシンへの変換について"></a>仮想マシンへの変換について</h2><p>Microsoft が提供する仮想マシンの変換・移行ツールには、以下のようなものがあります：<br><b>１．SCVMM（System Center Virtual Machine Manager）</b><br>　VMware ESXi ホスト上で稼働している VMware 仮想マシンを、Hyper-V 仮想マシンへ変換するためのツールです。<br><b>２．Azure Migrate</b> <a href="https://learn.microsoft.com/ja-jp/azure/migrate/migrate-services-overview?view=migrate-classic">参考</a><br>　オンプレミス環境にある物理・仮想マシンを、Azure 上に移行する際に使用するツールです。評価、準備、移行までを一貫してサポートします。<br><b>３．Disk2vhd</b> <a href="https://learn.microsoft.com/ja-jp/sysinternals/downloads/disk2vhd">参考</a><br>　稼働中の Windows マシンのボリューム（ディスク）を、Hyper-V 環境で使用可能な VHD または VHDX ファイルとして保存するツールです。シンプルな物理→仮想（P2V）変換に利用されます。</p><p>本記事では、１の SCVMM を用いた変換について説明します。<br><br>変換処理は、以下の3つのステップで実施します：<br><a href="#%E3%82%B9%E3%83%86%E3%83%83%E3%83%97%EF%BC%91%EF%BC%8E%E5%A4%89%E6%8F%9B-VM-%E3%82%92%E9%85%8D%E7%BD%AE%E3%81%99%E3%82%8B-Hyper-V-%E3%83%9B%E3%82%B9%E3%83%88%E3%82%92-SCVMM-%E3%81%AB%E7%AE%A1%E7%90%86%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%97%E3%81%A6%E7%99%BB%E9%8C%B2">ステップ１．</a>変換先の VM を配置する Hyper-V ホストを SCVMM に管理対象として登録します。<br><a href="#%E3%82%B9%E3%83%86%E3%83%83%E3%83%97%EF%BC%92%EF%BC%8E%E5%A4%89%E6%8F%9B%E5%85%83%E3%81%AE-VMWare-VM-%E3%81%AB-SCVMM-%E3%81%8C%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E5%8F%AF%E8%83%BD%E3%81%AB%E3%81%99%E3%82%8B">ステップ２．</a>変換元の VMWare VM に SCVMM がアクセス可能にします。<br><a href="#%E3%82%B9%E3%83%86%E3%83%83%E3%83%97%EF%BC%93%EF%BC%8ESCVMM-%E3%81%8B%E3%82%89%E5%A4%89%E6%8F%9B%E5%87%A6%E7%90%86%E3%82%92%E5%AE%9F%E8%A1%8C">ステップ３．</a>SCVMM から変換処理を実行します。</p><h2 id="ステップ１．変換-VM-を配置する-Hyper-V-ホストを-SCVMM-に管理対象として登録"><a href="#ステップ１．変換-VM-を配置する-Hyper-V-ホストを-SCVMM-に管理対象として登録" class="headerlink" title="ステップ１．変換 VM を配置する Hyper-V ホストを SCVMM に管理対象として登録"></a>ステップ１．変換 VM を配置する Hyper-V ホストを SCVMM に管理対象として登録</h2><p>[ファブリック] 画面から Hyper-V ホストやクラスターをリソースとして追加することで、SCVMM の管理対象に登録できます。<br>■ リソースの追加画面<br><img src="001.png"></p><p>本記事では、リソース追加の具体的な手順については割愛しております。詳細な手順については、以下の公開ドキュメントをご参照ください。<br>※ 公開ドキュメント：<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/hyper-v-existing?view=sc-vmm-2025">VMM コンピューティング ファブリックで Hyper-V ホストまたはクラスターとして Windows サーバーを追加する</a></p><p>リソース追加の過程で、対象の Hyper-V ホストには自動的に SCVMM エージェントがインストールされ、SCVMM による管理が可能な状態になります。</p><h2 id="ステップ２．変換元の-VMWare-VM-に-SCVMM-がアクセス可能にする"><a href="#ステップ２．変換元の-VMWare-VM-に-SCVMM-がアクセス可能にする" class="headerlink" title="ステップ２．変換元の VMWare VM に SCVMM がアクセス可能にする"></a>ステップ２．変換元の VMWare VM に SCVMM がアクセス可能にする</h2><p>変換元の VMware VM に SCVMM がアクセスできるようにする方法としては、次の2通りがあります。<br><b>方法1：vCenter 経由で ESXi ホストを SCVMM に登録する方法</b><br>SCVMM に vCenter を追加し、そこから管理対象の VMware ESXi ホストを登録することで、VMware VM へのアクセスが可能になります。</p><p><b>方法2：VM ファイルを SCVMM ライブラリに手動でコピーする方法</b><br>変換対象の VMware 仮想マシンのファイル（.vmdk など）を、SCVMM のライブラリ サーバー上にあるライブラリ共有へコピーすることで、SCVMM からファイルベースで変換処理を行うことができます。</p><hr><p>■ 方法1「vCenter 経由で ESXi ホストを SCVMM に登録する方法」の構成イメージは、以下の図の通りです。<br><img src="002.png"></p><p>まず、[ファブリック] 画面から SCVMM に vCenter サーバーをリソースとして追加します。<br>次に、vCenter 経由で ESXi ホストをリソースとして登録します。<br><img src="003.png"></p><p>vCenter サーバーと ESXi ホストの具体的な登録手順については、以下の公開ドキュメント内の [vCenter サーバーとソース ESXi ホストを SCVMM 管理下に置きます] 章をご参照ください。<br>※ 公開ドキュメント：<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/vm-convert-vmware?view=sc-vmm-2025">vCenter サーバーとソース ESXi ホストを SCVMM 管理下に置きます</a></p><p>■ 方法2「VM ファイルを SCVMM ライブラリに手動でコピーする方法」の構成イメージは、以下の図の通りです。<br><img src="004.png" width="80%"><br>SCVMM のライブラリ サーバーにある ライブラリ共有フォルダーへ、変換対象の VMware 仮想マシンのファイル一式をコピーします。<br>※1：VM の整合性を保つため、コピー前に変換対象の VMware 上の仮想マシンは OS をシャットダウンしてください。<br>※2：仮想ディスク ファイル（.vmdk）だけでなく、構成ファイル（.nvram、.vmx など）もすべてコピーする必要があります。<br><img src="005.png"></p><p>ファイルのコピーが完了すると、SCVMM のライブラリ画面上で、該当の VMware 仮想マシンが [バーチャル マシン] として認識されるようになります。<br><img src="006.png"></p><h2 id="ステップ３．SCVMM-から変換処理を実行"><a href="#ステップ３．SCVMM-から変換処理を実行" class="headerlink" title="ステップ３．SCVMM から変換処理を実行"></a>ステップ３．SCVMM から変換処理を実行</h2><p>変換処理は、[VM とサービス] 画面から実行することができます。<br>詳細な手順については、以下の公開ドキュメント内の [VMware VM を Hyper-V に変換する] 章をご参照ください。<br>※ 公開ドキュメント：<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/vm-convert-vmware?view=sc-vmm-2025#convert-your-vmware-vms-to-hyper-v">VMware VM を Hyper-V に変換する</a></p><p>以下に、バーチャル マシン変換ウィザードの手順を掲載しましたので、ご参考になれば幸いです。<br>■ [VM とサービス] 画面から、バーチャル マシン変換ウィザードを起動します。<br><img src="007.png"></p><p>■ [ソースの選択] 画面にて、変換対象の VMWare VM を選択して [次へ] をクリックします。<br><img src="008.png"></p><p>■ [バーチャル マシン ID の指定] 画面にて、SCVMM や Hyper-V マネージャー上で表示される変換後の仮想マシン名を入力し、[次へ] をクリックします。<br><img src="009.png"></p><p>■ [VM 構成] 画面にて、プロセッサ数、メモリ、世代を設定し、[次へ] をクリックします。<br><img src="010.png"></p><p>■ [ホストの選択] 画面にて、配置先の Hyper-V ホストを選択し、[次へ] をクリックします。<br>※「選択された VM ネットワークに使用できる接続が見つかりません。」というエラーが表示される場合は、<strong>後述の「<a href="#note1">注意①</a>」</strong>の内容をご確認ください。<br><img src="011.png"></p><p>■ [パスの選択] 画面にて、Hyper-V VM の VM ファイル (仮想ディスク ファイルや構成ファイルなど) を配置するストレージのパスを選択し、[次へ] をクリックします。<br><img src="012.png"></p><p>■ [ネットワークの選択] 画面にて、変換後の VM のネットワーク アダプターが接続するネットワークを選択し、[次へ] をクリックします。<br>※ ネットワーク アダプターは、新規のデバイスとして Hyper-V 仮想マシンに作成されます。本件に関する補足説明は、後述の <a href="#note2"><strong>注意③</strong></a> に記載しておりますので、あわせてご確認ください。<br><img src="013.png"></p><p>■ [プロパティの追加] 画面にて、起動時と停止時の操作を選択し、[次へ] をクリックします。<br><img src="014.png"></p><p>■ [サマリー] 画面にて、設定内容を確認し、[作成] をクリックすると変換処理が開始されます。<br><img src="015.png"></p><p>変換処理が完了すると、SCVMM コンソールや Hyper-V マネージャーで管理可能になります。<br><img src="016.png" width="80%"></p><p>=====================================================================<br><b><a id="note1"></a>注意①：ホストの選択時に「選択された VM ネットワークに使用できる接続が見つかりません。」というエラーが表示された場合</b><br>=====================================================================<br>変換対象の VMware 仮想マシンが接続している VM ネットワークに対して、配置先の Hyper-V ホストが対応するネットワーク アダプターを保持していない場合、そのホストに仮想マシンを配置すると ネットワークの不整合が発生する可能性があります。<br>このエラーは、そうした状況を事前に検出して変換を抑止するための警告です。</p><p>■ 回避方法<br>変換元の仮想マシンについて、[プロパティ] &gt; [ハードウェア構成] &gt; [ネットワーク アダプター] を開き、接続されている VM ネットワーク を確認します。<br>次に、配置先となる Hyper-V ホストに対して、[プロパティ] &gt; [ハードウェア構成] &gt; [ネットワーク アダプター] を開き、[論理ネットワーク] に、先ほど確認した VM ネットワークへの接続を追加することで、エラーを回避できます。</p><p>以下の例では、変換元の VM が VMNetwork という VM ネットワークに接続しているため、配置先の Hyper-V ホストも VMNetwork への接続を追加しています。<br><img src="017.png"></p><p>■ 補足説明<br>SCVMM には、[設定] &gt; [全般] &gt; [ネットワーク設定] に [論理ネットワークの自動作成] という設定項目があります。<br>この設定は、既定で有効になっています。</p><p>この設定が有効な場合、Hyper-V や ESXi ホストを SCVMM に登録すると、SCVMM はホスト上の仮想スイッチに基づいて、vSwitch0 や vSwitch1 といった論理ネットワークを自動的に作成します。<br>その結果、変換元の ESXi 側で自動作成された vSwitch0 や vSwitch1 に対して、配置先の Hyper-V ホストが接続されていない（紐づいていない）場合、ネットワークの整合性が取れず、<strong>「選択された VM ネットワークに使用できる接続が見つかりません」</strong>というエラーが表示されることがあります。</p><p>=====================================================================<br><b>注意②：変換処理がエラー 2944 で失敗した場合</b><br>=====================================================================<br>変換処理が開始された後、処理が 33% まで進んだ段階で「エラー 2944」により失敗するケースがあります。<br>その際に表示されるエラーメッセージは以下の通りです：</p><p>■ エラー (2944) のエラーメッセージ<br>～～～～～～～～～～～～<span style="font-size: 80%;"><br>エラー <b>(2944)</b><br>サーバー名 <i>[ESXi ホストサーバーの FQDN]</i> を解決できないため、VMM は要求された操作を完了できません。</span></p><p><span style="font-size: 80%;">推奨される操作<br>操作を再試行してください。問題が解決しない場合は、ネットワーク管理者に問い合わせてください。<br></span>～～～～～～～～～～～～</p><p>■ 回避方法<br>変換処理では、仮想マシンを配置する Hyper-V ホストから、元の VMware 仮想マシンが存在する ESXi ホストに対して、直接通信が行われます。<br>この際、<strong>ESXi ホストの FQDN（完全修飾ドメイン名）</strong>を使用して接続が行われます。</p><p>そのため、Hyper-V ホストが対象の ESXi ホストの FQDN を名前解決できるようにする必要があります。<br>以下のいずれかの方法で、名前解決が可能な状態にしてください：<br>・Active Directory の DNS サーバーに該当の ESXi ホストのレコードを登録する<br>・Hyper-V ホストの hosts ファイルに ESXi ホストの名前と IP アドレスを追記する</p><p>=====================================================================<br><b><a id="note2"></a>注意③：変換前後のネットワークについて</b><br>=====================================================================<br>変換処理では、仮想ディスクが VMware 形式（VMDK）から Hyper-V 形式（VHDX）へ変換されるとともに、仮想マシンの構成情報も Hyper-V に適した形式へ変換されます。<br>ただし、ネットワーク アダプターについては VMware の設定を引き継ぐことはできず、Hyper-V 用の新しいネットワーク アダプターが作成・割り当てられます。</p><p>そのため、変換完了後には、Hyper-V ホスト環境に応じたネットワーク構成を手動で設定する必要があります。<br>具体的には以下のような設定を行ってください：<br>・IP アドレスの再割り当て<br>・デフォルトゲートウェイの設定<br>・DNS サーバーの指定</p><p>なお、VMware 仮想マシンで設定されていたネットワーク構成は自動的には移行されません。<br>この点をご留意のうえ、変換処理の計画および実施をご検討ください。</p><hr><p>SCVMM を用いて VMWare VM を Hyper-V VM に変換する手順に関する説明は以上の通りです。<br>Hyper-V 環境への仮想マシンの以降を検討されている場合に参考にしていただけますと幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;今回は、SCVMM を用いて VMWare VM を Hyper-V VM に変換する手順について説明します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
  </entry>
  
  <entry>
    <title>SCOM OperationsManagerDW データベースの容量削減手順</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_OpsDW_deletedata/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_OpsDW_deletedata/</id>
    <published>2025-03-03T09:00:00.000Z</published>
    <updated>2025-12-10T08:31:18.985Z</updated>
    
    <content type="html"><![CDATA[<p>皆さんこんにちは、System Center サポートチームの 保科と申します。</p><p>今回は、System Center Operations Manager (SCOM) のデータウェアハウスデータベースのデータ削除手順についてご紹介いたします。</p><span id="more"></span><h3 id="本ページが対象とする-SCOM-バージョン"><a href="#本ページが対象とする-SCOM-バージョン" class="headerlink" title="本ページが対象とする SCOM バージョン"></a>本ページが対象とする SCOM バージョン</h3><p>SCOM 2016<br>SCOM 2019<br>SCOM 2022</p><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>SCOM を最小限の構成でインストールすると、以下 2 種類のデータベースが作成されます。</p><ul><li>OperationsManager:<br>SCOM の監視構成やインポートされた管理パック、監視対象の情報、監視データやアラート情報等 SCOM に関するあらゆる情報が保存されるデータベースです。<br>このデータベースが動作不備になったり、容量がいっぱいになると、SCOM 自体を使用することが出来なくなります。</li><li>OperationsManagerDW<br>SCOM のレポート機能で使用するための監視データや監視対象の情報等が保存されるデータベースです。<br>保存されるデータは、SCOM の監視動作に準ずるものとなります。<br>例えば、パフォーマンスカウンターの収集を実施されている場合、まずは “OperationsManager” データベースにその監視内容が保存されます。<br>その後、その監視内容が “OperationsManagerDW” 側でも保存され、更にレポート用のデータとしてその保存されたデータが加工されます。本データベースに不備が発生すると、レポートに関するデータが取得できない、つまりレポートを閲覧することが出来なくなります。<br>※ 補足<br>本データベースの主要用途はレポート機能ですので、本データベースに接続できない場合でも SCOM コンソールにログインして利用する各種機能 (パフォーマンス ビューの参照など) は一見、利用できているように見えます。それらの機能は主に “OperationsManager” データベースを利用するためです。しかしながら、SCOM では “OperationsManager”, “OperationsManagerDW” の両方のデータベースが必須です。レポート機能を利用されない場合でも “OperationsManagerDW” は必要なデータベースです。</li></ul><p>詳細は割愛しますが、”OperationsManagerDW” では監視データの全データ、時間単位で纏められたデータ、日単位でまとめられたデータが保存されます。<br>収集されるデータによってはデータ数が膨大となることがあり、これが要因でデータベースの容量が非常に大きくなる場合がございます。<br>上記に記載した “OperationsManagerDW” に対するデータ保存の仕組みから、一般的に SCOM の監視内容が多いほどデータベースが肥大化しやすい傾向となります。<br>本記事では、肥大化した “OperationsManagerDW” データベースのデータ削除方法と、具体的に削除するデータの選定方法を説明いたします。</p><h3 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h3><p>以降のご説明では、”OperationsManagerDW” データベースの名称を “OpsDW” と略称いたします。<br>SCOM インストール時に “OperationsManagerDW” データベースの名称を変更されている場合、適宜そのデータベース名に “OpsDW” を読み替えてください。</p><h3 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h3><p>クリーンアップの設定を実施いただく前に、まずどのデータセットが OpsDW のデータの多くを占めるか確認する必要がございます。<br>こちらは、以下の手順で OpsDW のテーブル毎のデータ使用量を確認することで確認いただけます。</p><ol><li>OpsDW データベースを運用する SQL Server が存在するサーバーに管理者権限でログインします。</li><li>SQL Server Management Studio (SSMS) を開きます。</li><li>OpsDW の管理者権限を持つアカウントで、OpsDW が存在するサーバーにログインします。</li><li>OpsDW を画面左ペインより [&lt;サーバー名&gt;] -&gt; [データベース] -&gt; [OperationsManagerDW] を右クリックし、[レポート] -&gt; [標準レポート] -&gt; [上位のデーブルによるディスク使用量] をクリックします。<br>(OpsDW のデータベース名が変更されている場合、適宜そのデータベースを [&lt;サーバー名&gt;] -&gt; [データベース] より選択します。)</li></ol><p>こちらの手順で、現在 OpsDW にはどのようなテーブルが存在し、各テーブルでどの程度データを使用しているか確認いただけます。<br>これにより、表示されたテーブルの内、どのデータセットが OpsDW のデータの多くを占めているか確認します。<br>例えば、”perf.perfhourly_&lt;テーブル毎の固有文字列&gt;” が、固有文字列の内容こそ異なるものの “perf.perfhourly_” で始まるテーブルが大量に存在する場合を想定します。<br>この場合、”perf.perfhourly”、つまり下記の弊社サイト内に記載されているテーブルにおける “データセット” が “パフォーマンス” かつ集計の種類が “1 時間ごと” のデータが大量に存在することが確認いただけます。<br><a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-omdwdb-grooming-settings?view=sc-om-2022">レポート データ ウェアハウス データベースのクリーンアップ設定を構成する方法 | Microsoft Learn</a></p><p>このように、適宜お客様環境における OpsDW で [上位のデーブルによるディスク使用量] を開き、どのテーブルが消費容量の多くを占めるか確認いただくことで、クリーンアップ設定実施方針が定義いただけます。</p><h3 id="対処手順"><a href="#対処手順" class="headerlink" title="対処手順"></a>対処手順</h3><p>[事前準備] に記載しました方法でどのデータが OpsDW において多くのデータを消費しているか確認いただけましたら、次の手順としてはこのクリーンアップの設定を行います。<br>クリーンアップの設定手順は、下記の手順にて実施いただけます。</p><ol><li>OpsDW データベースを運用する SQL Server が存在するサーバーに管理者権限でログインします。</li><li>SQL Server Management Studio (SSMS) を開きます。</li><li>OpsDW の管理者権限を持つアカウントで、OpsDW が存在するサーバーにログインします。</li><li>以下弊社公開情報の “レポート データ ウェアハウスのクリーンアップ設定を変更するには” 項に記載された 4. ~ 6. の手順に沿って、削除を実施するデータの GUID を確認します。<br><a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-omdwdb-grooming-settings?view=sc-om-2022">レポート データ ウェアハウス データベースのクリーンアップ設定を構成する方法 | Microsoft Learn</a><br>本公開情報の 4. の手順は機械翻訳されて分かりづらいですが、”dbo.Dataset” テーブルを開くという手順が英語版の公開情報では示されています。</li><li>画面左ペインより [&lt;サーバー名&gt;] -&gt; [データベース] -&gt; [OperationsManagerDW] -&gt; [テーブル] -&gt; [dbo.StandardDatasetAggregation] を右クリックし、[上位 200 行の編集] をクリックします。<br>(OpsDW のデータベース名が変更されている場合、適宜そのデータベースを [&lt;サーバー名&gt;] -&gt; [データベース] より選択します。)<br>dbo.StandardDatasetAggregation のテーブルを編集開始します。</li><li>4. で確認された GUID を持つ行の“MaxDataAgeDays” カラムの各値を、お客様が保持されたいデータの日数で指定します。<br>保持日数変更対象となるデータセットおよび集計の種類の確認方法は、下記の弊社公開情報の内容に基づいて確認します。<br><a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-omdwdb-grooming-settings?view=sc-om-2022">レポート データ ウェアハウス データベースのクリーンアップ設定を構成する方法 | Microsoft Learn</a><br>なお、お客様環境によってはディスクの空き容量がひっ迫している状況も想定されると存じます。<br>この場合、トランザクションログ用の領域も十分に確保することが出来ない可能性もございます。<br>これは、クリーンアップ処理が実行される際、処理のコミットが完了するまで、データがトランザクションログに保存されるためです。<br>(データベースの復旧モデルを、SQL Server Always On 可用性グループをご利用いただく等して “完全” で構成されている場合、トランザクションログはバックアップされない限り保存され続けます。)<br>こういった場合では、“MaxDataAgeDays” の値は目的の値に達成されるまで段階的に減らされることを推奨いたします。<br>例えば、最初の段階では 2 ずつ減らし、ディスクの空き容量が確保いただける状況となった場合に減らす数値を増加する、といった流れでデータ削除を実施ください。</li><li>6. で編集された行の “GroomingIntervalMinutes” に、非常に小さな値を指定します。まずは 5 で設定されることを推奨いたします。<br>これにより、その行で指定されているテーブルのデータを、指定した分間隔で、”MaxDataAgeDays” で指定した日数以上経過しているデータを削除します。<br>例えば、“GroomingIntervalMinutes” の値を 5、”MaxDataAgeDays” の値を 100 と設定すると、５分間隔で、100 日以上経過した対象テーブル内データを削除する処理を行います。<br>なお、“GroomingIntervalMinutes” の値が小さいほど、ログデータ削除の処理が行われる回数も増えるので、実運用において小さな値を指定し続けることは推奨いたしません。<br>なので、“GroomingIntervalMinutes” の値を変更する前の値については、あらかじめメモを取得の上、一通りクリーンアップが完了したタイミングで値を元に戻します。<br>本設定値の変更は、例えばディスクの空き容量を早急に確保する必要があるといったご要望が存在する場合、空き容量が確保できるまでクリーンアップ実行周期を短くします。<br>即座に空き容量を確保いただく必要がない場合、本手順の設定は省略いただいても問題ございません。</li><li>必要に応じて、6. で編集された行の ”MaxRowsToGroom” の値を変更します。<br>一度のクリーンアップによって対象のテーブルより削除されるデータ行数は、”MaxRowsToGroom” にて指定された行数となります。<br>例えば、State データセットのテーブルは、既定で ”MaxRowsToGroom” の値が 50,000 となっております。<br>つまり、この設定状況では、一度のクリーンアップで削除されるデータ行数は 50,000 行までとなります。<br>クリーンアップ量に対して入力されるデータ数が多い場合、データ数は減ることなく増加することが想定されます。<br>こういった状況が想定されますため、必要に応じて、”MaxRowsToGroom” の値を変更します。<br>事例より、”MaxRowsToGroom” の値を 1,000,000 と設定した場合に大きなトランザクションログの容量を消費しないことを確認しております。<br>こちらは “GroomingIntervalMinutes” とは異なり、一通りクリーンアップが完了した後も設定値を保持いただいても問題ございません。<br>なお、こちらの値についても、ディスク空き容量がひっ迫している場合、段階的に値を増加いただく等の操作をご検討ください。</li><li>設定した GroomingIntervalMinutes の時間が経過後、OpsDW の消費容量が小さくなったか確認します。<br>容量が小さくなっていることを確認できましたら、OpsDW を圧縮し、ファイルサイズの縮小を行います。<br>データベースの圧縮手順は、下記の弊社 SQL Server の公開情報を参照ください。<br><a href="https://learn.microsoft.com/ja-jp/sql/relational-databases/databases/shrink-a-database?view=sql-server-ver16">データベースの圧縮 - SQL Server | Microsoft Learn</a><br>データベースの圧縮が不要の場合、こちらの手順の実施も不要です。</li><li>以後、各テーブルのデータ最大保持日数が目的の値となるまで、5. ~ 8. の手順を繰り返します。<br>なお、ディスクの空き容量が増加するに従い、”MaxDataAgeDays” にて減らされる値を大きくされたり、<br>“MaxRowsToGroom” の値を大きくされても問題ございません。</li></ol><h3 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h3><p>SQL Server の復旧モデルが “完全” の場合、トランザクションログの肥大化が懸念されます。<br>復旧モデルは、SQL Server Always On を構成されていない場合、既定で “単純” となり、”単純” で運用されることが推奨されます。<br>なお、SQL Server Always On を構成されている場合、復旧モデルは “完全” で固定となり、それ以外の復旧モデルに変更いただくことは出来ません。。<br>復旧モデルは、下記の手順で確認を行います。</p><ol><li>SQL Server Management Studio (SSMS) を開きます。</li><li>復旧モデルを確認するデータべースが存在するサーバーに、管理者権限でログインします。</li><li>対象のデータベースを右クリックし、[プロパティ] をクリックします。<br>ウィンドウ左の [オプション] をクリックし、 [復旧モデル] の内容を確認します。</li></ol><h3 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h3><p>OpsDW の不要なデータ削除手順は以上となります。<br>上記の通り、OpsDW は、主に SCOM レポートで使用するデータを保存するために使用されるデータベースとなります。<br>お客様が使用されているレポートの要件に応じて、各データの保持日数およびその削除量を調整いただければと思います。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆さんこんにちは、System Center サポートチームの 保科と申します。&lt;/p&gt;
&lt;p&gt;今回は、System Center Operations Manager (SCOM) のデータウェアハウスデータベースのデータ削除手順についてご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Trouble" scheme="https://jpsystemcenter.github.io/blog/tags/Trouble/"/>
    
    <category term="Database" scheme="https://jpsystemcenter.github.io/blog/tags/Database/"/>
    
    <category term="OperationsManagerDW" scheme="https://jpsystemcenter.github.io/blog/tags/OperationsManagerDW/"/>
    
  </entry>
  
  <entry>
    <title>SCOM で使用する一般的なログ収集方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_Troubleshooting_log/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_Troubleshooting_log/</id>
    <published>2025-01-03T08:00:00.000Z</published>
    <updated>2025-12-10T08:31:18.986Z</updated>
    
    <content type="html"><![CDATA[<p>本記事は SCOM でトラブルシューティングを行う際、調査を行うために収集する一般的なログとその取得方法を解説いたします。</p><span id="more"></span><p>皆さまこんにちは。<br>System Center サポートチームの保科です。 </p><p>System Center Operations Manager (SCOM) をご利用中に様々な問題に対面された経験はございませんでしょうか。<br>この問題を対処するにあたり、弊社までお問合わをいただくことも多いかと存じます。<br>基本的にご申告いただきました問題を対処するにあたってログ等を含めた調査が必須となります。<br>本記事では、弊社が SCOM 観点のトラブルシューティングを行う際に一般的にお客様へ採取依頼を行うログとその採取方法について解説いたします。</p><h2 id="イベントログ"><a href="#イベントログ" class="headerlink" title="イベントログ"></a>イベントログ</h2><p>イベントログの調査は、SCOM のトラブルシューティングを行うにあたって最も一般的なログとなります。<br>基本的に SCOM で発生した問題の多くとその詳細はイベントログにも転記されます。<br>そのため、多くの問題はイベントログを調べることで原因の特定を行える可能性があります。<br>イベントログを採取いただく場合は、状況に応じて以下コンピューターから採取を行います。</p><ul><li>SCOM 管理サーバー:<br>トラブルシューティングの種類に依らず、必ず SCOM 管理サーバーのイベントログを採取します。<br>ご利用の環境で複数台の SCOM 管理サーバーをご利用の場合、それらすべての SCOM 管理サーバーからイベントログの採取を行います。<br>ゲートウェイサーバーを介した別ドメインコンピューターの監視で問題が発生されている場合、ゲートウェイサーバーからもイベントログを採取します。</li><li>事象が発生した監視対象コンピューター:<br>監視の問題が発生している場合、その問題が発生しているすべての監視対象コンピューターよりイベントログを採取します。<br>特定の監視対象コンピューターの問題ではなく、SCOM 全体的な問題によるトラブルシューティングを行う場合は、こちらのコンピューターからのログ採取は不要です。</li><li>SCOM データベースが動作する SQL Server 実行サーバー:<br>データベースの問題が疑われる場合、このコンピューターからイベントログを採取します。<br>一般的には、SCOM の処理が遅い、データが欠落する、SCOM が機能しないといった場合にこれらのサーバーからのイベントログ採取が必要となります。<br>SCOM 管理サーバーの中に SCOM データベースが動作する SQL Server が存在する場合、こちらについては意識いただかなくても問題ございません。</li></ul><p>イベントログの取得方法は以下手順で行います。</p><ol><li><p>対象コンピューターでイベント ビューアーを開きます。<br>確実に開く方法としては、[win] + [R] キーを押下し、”eventvwr.msc” とイベントビューアーの名前を直接指定し、実行する方法がございます。</p></li><li><p>画面左のコンソールツリーより、保存するイベントログをクリックします。<br>SCOM 観点のイベントログは、以下 3 種類のイベントログを採取します。</p><ul><li>アプリケーション (※1)</li><li>システム (※1)</li><li>Operations Manager (※2)</li></ul><p>(※1) は [Windows ログ] 配下に存在します。<br>(※2) は [アプリケーションとサービス ログ] 配下に存在します。<br>SCOM 管理サーバー / ゲートウェイサーバー以外のサーバーで、かつ SCOM エージェントがインストールされていない環境では (※2) のイベントログは存在しない場合がございます。<br>この場合、このコンピューターからの (※2) のイベントログの採取は不要でございます。</p></li><li><p>画面右ペインの [すべてのイベントを名前をつけて保存] をクリックします。</p></li><li><p>保存するイベントログの任意の名称を指定します。<br>ファイルの種類としては、”イベント ファイル (<em>.evtx)” および “CSV (コンマ区切り) (</em>.csv)” の両方で取得します。</p></li></ol><p>イベントログ取得手順は以上となります。<br>弊社までイベントログを送付いただく場合は、コンピューター毎にイベントログを 1 つのフォルダに纏め、それらのフォルダをさらに 1 つのフォルダに纏めて圧縮いただいてお寄せくださいませ。<br>採取対象コンピューターが複数台存在する場合、イベントログ自体のファイル名やそれを格納するフォルダにコンピューター名を付与いただく等、採取対象が分かりやすく識別できるように送付をいただけると幸いです。</p><h2 id="アラート情報"><a href="#アラート情報" class="headerlink" title="アラート情報"></a>アラート情報</h2><p>アラートの状態 (オープンの状態、解決済みの状態等) によらず、SCOM データベースに存在するアラート情報を出力いただけます。<br>こちらもイベントログ程ではありませんが、トラブルシューティングを行う際に有用な情報が確認できる場合が多い資料です。<br>アラート情報を取得する場合は、Operations Manager Shell を利用し、CSV 形式で一覧として取得します。</p><ol><li>SCOM 管理サーバー、SCOM 管理者権限を持つアカウントでログインします。</li><li>事前に、C ドライブの直下に “temp” という名前のフォルダを作成します。</li><li>[スタート] メニューより [Operations Manager Shell] を実行します。</li><li>以下のコマンドを実行します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SCOMAlert | export-csv -path &quot;c:/temp/Alert.csv&quot; -encoding UTF8</span><br></pre></td></tr></table></figure></li><li>出力された “Alert.csv” を弊社までお寄せください。</li></ol><h2 id="アラート情報-※-例外-過去に解決済みのアラート情報"><a href="#アラート情報-※-例外-過去に解決済みのアラート情報" class="headerlink" title="アラート情報 (※ 例外 : 過去に解決済みのアラート情報)"></a>アラート情報 (※ 例外 : 過去に解決済みのアラート情報)</h2><p>SCOM のトラブルシューティングは多くの場合、現在発生中のアラートや直近で発生したアラートが対象になりますので、基本的には上記の <b>Get-SCOMAlert</b> コマンドの手順により必要なアラート情報を取得できます。<br>稀に、すでに解決済みで過去に発生していたアラートの調査が必要になる場合があります。解決済みのアラートは指定の期間 (既定の設定では 7日間) 経過後に直近データを保管する Opemarions Manager データベースから削除され、長期データを保管する Opemarions Manager DW データベースにのみデータが保管されます。このアラート情報は <b>Get-SCOMAlert</b> コマンドでは取得できないため、データベースから取得する必要があります。</p><ol><li>SCOM データベースサーバーにて SSMS (SQL Server Management Studio) を立ち上げて、SCOM データベースに接続します。</li><li>[OperationsManagerDW] データベースの [テーブル] を開き、[Alert].[Alert_xxxx] のテーブル名をメモします。</li><li>[新しいクエリ] ボタンをクリックして、クエリ画面に以下の SQL を入力して [実行] ボタンをクリックして SQL を実行します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM [OperationsManagerDW].[Alert].[Alert_xxxx]</span><br><span class="line">where [Alert].Alert_xxxx.RaisedDateTime &gt; &#x27;2025-01-01 00:00:00.000&#x27;</span><br><span class="line">order by [Alert].Alert_xxxx.RaisedDateTime desc</span><br></pre></td></tr></table></figure>※ Alert_xxxx の部分は 2 でメモしたテーブル名に置き換えてください。<br>※ 2025/01/01 以降に発生したアラートを抽出する SQL です。<br>● ご参考 (テーブル名を [Alert_xxxx] -&gt; [Alert_92C3917ECB5741DF9AEDDA1DDB06527E] に置き換えて実行しています。)<br><img src="001.png"></li><li>画面下部に結果が出力されますので、結果表のタイトル行の最初の列 (赤枠の空白部分) を右クリックして、[結果に名前を付けて保存] をクリックします。<br><img src="002.png"></li><li>CSV 形式で出力したファイルを弊社までお寄せください。</li></ol><h2 id="インストールログ"><a href="#インストールログ" class="headerlink" title="インストールログ"></a>インストールログ</h2><p>インストールログの調査は、SCOM のインストールやエージェントのプッシュインストール等インストールに関する操作が正常に行えない場合に調査する資料となります。<br>インストールに関する問題が発生しましたら、こちらのログを調査する必要があります。<br>ログは以下のフォルダに格納されております。</p><blockquote><p>C:\Users&lt;SCOM をインストールする際に使用したユーザー名&gt;\AppData\Local\SCOM</p></blockquote><h2 id="管理パック"><a href="#管理パック" class="headerlink" title="管理パック"></a>管理パック</h2><p><a href="/blog/SCOM/SCOM_MPTransfer/">こちらの記事</a> でも書かれております通り、SCOM の監視動作は基本的に管理パック内で定義されます。<br>例えば以下の状況が発生した場合においては、ご利用の管理パック側から調査を行う必要があります。</p><ul><li>検出されると想定されていた内容が検出されない。</li><li>今まで出力されなかったアラートが出力されるようになった。<br>また、このアラートが解消と発生を繰り返している。</li><li>認識していなかったコマンドが監視対象サーバーで実行されているように見えるため、このコマンドが SCOM から実行されている可能性があるか調査したい。</li></ul><p>管理パックは、以下手順でご利用の全管理パックを xml 形式での出力と、ご利用の管理パックを一覧化した html ファイルを出力いただけます。</p><ol><li>管理者の権限を持つユーザーで Operations Manager 管理サーバーにログオンします。</li><li>C: ドライブの直下に MPs フォルダーを作成します。</li><li>[スタート] 画面から [Operations Manager Shell] を選択します (※)。</li><li>[Operations Manager Shell] ウィンドウのプロンプトで以下のコマンドを実行します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Get-SCOMManagementPack | Export-SCOMManagementPack -Path:C:\MPs</span><br><span class="line">Get-SCOMManagementPack | ConvertTo-HTML &gt; C:\MPs\MpList.html</span><br></pre></td></tr></table></figure></li></ol><p>4. の 1 行目のコマンドを実行することで、ご利用の環境に導入されているすべての管理パックを xml 形式でエクスポートいただけます。<br>xml 形式でエクスポートされた管理パックには、その管理パックで定義されている内容がすべて記載されております。<br>基本的に SCOM で行われる監視内容は Powershell や VBS、Javascript 等で作成されたスクリプトを、対象となるコンピューターで実行するものとなります。<br>これらの実装を確認することで、管理パックに関するトラブルシューティングが可能になるというものです。</p><p>こちらの手順で、ご利用の管理パックが最新であるかを確認することもできます。<br>ご申告いただきました事象が、そのバージョンにおいて既知の事象であり、管理パックのアップデートによって解消される可能性もございます。<br>この場合、管理パックのアップデートによってご申告いただきました事象が解消される可能性が高いため、管理パックのアップデートをお願いいたします。<br>なお、このような既知の事象は、ほとんどの管理パックの場合はその管理パックを入手するサイトで入手いただける管理パックドキュメントに記載されております。<br>ドキュメントはほとんどの場合は英語での記述となりますが、ワークフローの一覧等管理パックに関する有用な内容が多く記載されております。</p><p>なお、一部お客様におかれましては、弊社が提供しております管理パック以外にも、サードパーティによって作成された管理パックを導入されている可能性がございます。<br>管理パックを調査した結果、このサードパーティ製の管理パックによってご申告いただきました事象が発生されている場合、弊社での詳細な調査はいたしかねております。<br>サードパーティ製の管理パックは、その管理パックを開発されたベンダーへ別途ご確認いただく必要がございます。<br>サードパーティ製の管理パックに関する調査をご所望でございましたら、その管理パックについて弊社で調査することが出来ないことをあらかじめご認識いただけます様お願いいたします。</p><h2 id="トレースログ"><a href="#トレースログ" class="headerlink" title="トレースログ"></a>トレースログ</h2><p>上記までに記載したログは、いずれも事象発生後に後追いで原因調査を行うために採取される資料となります。<br>これらの資料で大半の事象は原因を特定することが出来ますが、中には事象発生後に採取される資料に情報が一切記載されず、調査が困難な場合がございます。<br>この場合、事象発生時のログをリアルタイムで収集し、そのログから SCOM 内部で行われた処理を時系列で調査する必要があります。<br>この調査は SCOM 標準で備わるトレースログの採取によって可能となります。<br>以下手順にて SCOM トレースログの取得を開始します。</p><ol><li>トレースログを取得するコンピューターに、管理者権限でログインします。</li><li>管理者としてコマンドプロンプトを開きます。</li><li>cdコマンドを使用して、 トレースログを採取するコンピューターに応じて以下ディレクトリに移動します。<br>なお、下記のディレクトリは、いずれも既定フォルダにインストールを行った際に使用するディレクトリになります。<br>SCOM 管理サーバーや SCOM エージェントのインストール先を既定値から変更されている場合、適宜そのフォルダに移動をお願いします。<table><thead><tr><th>トレースログ採取対象コンピューター</th><th>cd コマンドで移動するディレクトリの既定値</th></tr></thead><tbody><tr><td>SCOM 2016 管理サーバー</td><td>C:\Program Files\Microsoft System Center 2016\Operations Manager\Server\Tools</td></tr><tr><td>SCOM 2019 管理サーバー</td><td>C:\Program Files\Microsoft System Center\Operations Manager\Server\Tools</td></tr><tr><td>SCOM 2022 管理サーバー</td><td>C:\Program Files\Microsoft System Center\Operations Manager\Server\Tools</td></tr><tr><td>SCOM エージェント</td><td>C:\Program Files\Microsoft Monitoring Agent\Agent\Tools</td></tr></tbody></table></li><li>以下コマンドを実行し、すでに実行中のトレースログ採取を停止します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StopTracing.cmd</span><br></pre></td></tr></table></figure>SCOM トレースログは、”Microsoft Monitoring Agent” サービスが停止中の状態から起動状態に移行すると、自動的にエラーレベルのトレースログを収集開始します。<br>“サービスが停止中の状態から起動状態に移行” する条件として、一例として以下が挙げられます。<ul><li>サービス自体を手動で再起動する</li><li>対象サーバーを再起動する</li></ul></li><li>Windowsエクスプローラーを使用して、“C:\Windows\Logs\OpsMgrTrace” に移動します。</li><li>フォルダ “C:\Windows\Logs\OpsMgrTrace” のすべてのファイルを削除します。</li><li>採取するトレースログのレベルに応じて以下コマンドを実行します。<ul><li>詳細レベルのトレースログ:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StartTracing.cmd VER </span><br></pre></td></tr></table></figure></li><li>デバッグレベルのトレースログ:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StartTracing.cmd DBG</span><br></pre></td></tr></table></figure>基本的に詳細レベルよりデバッグログのトレースログの方がより多くの情報が含まれます。<br>そのため調査に際してはデバッグログの方がより有用な情報が採取される可能性が高いものの、それに比例してログ容量増加速度も上昇します。<br>大まかな考えとしては、即座に事象再現が可能であればデバッグレベルのトレースログを、いつ事象再現が確認されるかが未定である場合は詳細レベルのトレースログを採取する方法を推奨いたします。</li></ul></li><li>事象を再現します。<br>再現が確認されるまでログを採取し、再現が確認されましたら 9. の手順へ進みます。</li><li>以下コマンドを実行し、トレースログの採取を再度停止します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StopTracing.cmd</span><br></pre></td></tr></table></figure></li><li>以下コマンドを実行し、採取されたトレースログをテキストファイル形式にフォーマットします。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FormatTracing.cmd R</span><br></pre></td></tr></table></figure></li><li>弊社まで資料を送付いただく際は、“C:\Windows\Logs\OpsMgrTrace”フォルダごとzip化し、弊社までお寄せください。<br>この際、複数のコンピューターでトレースログを採取いただけましたら、採取されたコンピューターが判別できるようにコンピューター名を zip ファイルに記載いただく等していただけますと幸いです。</li></ol><p>(※1)<br>“C:\Windows\Logs\OpsMgrTrace” フォルダ内には、収集された診断ログが “etl” 拡張子のファイルにて格納されております。<br>“.etl” の各ファイルは、100MB を上限としてログが保存されます。<br>ログが 100MB を超える場合、古いログから順番に新しいログへ上書きされます。<br>100 MB を超えるまでの時間は、環境に応じて変化いたしますので、一概のご案内が困難でございます。<br>弊社としては、問題の再現実施後に、ただちに 9. の手順でトレースの停止を実施いただきたく思います。<br>トレースログ採取容量は、トレースログ採取を開始する “StartTracing.cmd” の内容を直接編集することで増減が可能です。<br>具体的には、対象ファイル 99 行目に記載されている以下記述より、”-cir” パラメーターに続く数値が、トレースログ容量上限値を MB 単位で指定するものとなります。</p><blockquote><p>if not [%1]==[TracingGuidsConfigService] tracelogsm.exe -start %1 -flag %2 -level %3 -f %OpsMgrTracePath%%1.etl -b 64 -ft 10 <strong>-cir 100</strong> -guid %4</p></blockquote><p>(※2)<br>7. の手順で SCOM 診断ログを取得する際、特にパフォーマンスへの大きな影響が発生しないことを確認しております。</p><p>(※3)<br>トレースログを仕掛けたタイミングでサーバーの再起動等 SCOM エージェントサービスの停止が伴う操作を実施いただくと、トレースログの採取がリセットされ、OS 起動時に取得されるエラーレベルでのトレース採取が開始されます。<br>そのため、トレースログ採取中に SCOM エージェントサービスの停止が伴う操作を実施いただく場合、再度 1. から 8. までの手順を実施いただく必要がございます。</p><p>参考:<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-overview-management-pack?view=sc-om-2022">診断トレースを使用する - Operations Manager | Microsoft Learn</a><br>(SCOM 診断ログについて記載された弊社ドキュメントです。)</p><h2 id="SCOM-環境情報"><a href="#SCOM-環境情報" class="headerlink" title="SCOM 環境情報"></a>SCOM 環境情報</h2><p>SCOM のトラブルシューティングでは、SCOM 管理サーバー・SCOM エージェントのバージョン、更新プログラム ロールアップのバージョン、起動状態などを正確に把握する必要があります。<br>これらの情報は Operations Manager Shell を利用して、CSV 形式で一覧として取得します。</p><ol><li>SCOM 管理サーバー、SCOM 管理者権限を持つアカウントでログインします。</li><li>事前に、C ドライブの直下に “temp” という名前のフォルダを作成します。</li><li>[スタート] メニューより [Operations Manager Shell] を実行します。</li><li>以下のコマンドを実行します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-SCOMManagementServer | export-csv -path &quot;c:/temp/SCOMManagementServer.csv&quot; -encoding UTF8</span><br><span class="line">Get-SCOMAgent | export-csv -path &quot;c:/temp/SCOMAgent.csv&quot; -encoding UTF8</span><br><span class="line">Get-SCXAgent | export-csv -path &quot;c:/temp/SCXAgent.csv&quot; -encoding UTF8</span><br></pre></td></tr></table></figure></li><li>出力された SCOMManagementServer.csv, SCOMAgent.csv, SCXAgent.csv を弊社までお寄せください。</li></ol><h2 id="システム情報"><a href="#システム情報" class="headerlink" title="システム情報"></a>システム情報</h2><p>SCOM のトラブルシューティングでは、サーバー自身の情報 (Windows Server のバージョン、インストールされたソフトウェア、サービス一覧など) が必要になることがあります。<br>これらの情報はシステム情報ツールを用いて取得します。</p><ol><li>対象サーバーにサインインします。</li><li>事前に、C ドライブの直下に “temp” という名前のフォルダを作成します。</li><li>コマンドプロンプトを管理者権限で起動し、 msinfo32 とエンターを投入して MSInfo32 を起動します。</li><li>[ファイル]-[上書き保存]より情報を保存します。(コンピューター名.NFO)</li><li>続けて以下のコマンドを入力し、実行します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">　msinfo32 /report C:\temp\msinfo32.txt</span><br></pre></td></tr></table></figure></li></ol><p>4 と 5 で出力したファイルを弊社までお寄せください。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本記事は SCOM でトラブルシューティングを行う際、調査を行うために収集する一般的なログとその取得方法を解説いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="トラブルシューティング" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0/"/>
    
    <category term="ログ収集" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%83%AD%E3%82%B0%E5%8F%8E%E9%9B%86/"/>
    
  </entry>
  
  <entry>
    <title>SCOM OperationsManager データベースの unused 領域開放手順</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_OpsDB_optimizeindex/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_OpsDB_optimizeindex/</id>
    <published>2024-11-01T03:00:00.000Z</published>
    <updated>2025-12-10T08:31:18.984Z</updated>
    
    <content type="html"><![CDATA[<p>皆さんこんにちは、System Center サポートチームの 保科と申します。</p><p>今回は、System Center Operations Manager (SCOM) のベース内で増加した unused 領域を開放する手順をご紹介します。</p><span id="more"></span><p>SCOM 2016<br>SCOM 2019<br>SCOM 2022</p><h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><p>SCOM を最小限の構成でインストールすると、以下 2 種類のデータベースが作成されます。</p><ul><li>OperationsManager:<br>SCOM の監視構成やインポートされた管理パック、監視対象の情報、監視データやアラート情報等 SCOM に関するあらゆる情報が保存されるデータベースです。<br>このデータベースが動作不備になったり、容量がいっぱいになると、SCOM 自体を使用することが出来なくなります。</li><li>OperationsManagerDW<br>SCOM のレポート機能で使用するための監視データや監視対象の情報等が保存されるデータベースです。<br>保存されるデータは、SCOM の監視動作に準ずるものとなります。<br>例えば、パフォーマンスカウンターの収集を実施されている場合、まずは “OperationsManager” データベースにその監視内容が保存されます。<br>その後、その監視内容が “OperationsManagerDW” 側でも保存され、更にレポート用のデータとしてその保存されたデータが加工されます。<br>“OperationsManager” データベースと異なり、本データベースが極端の場合存在しない場合でも、SCOM の機能を使用することが出来ます。<br>(データベースの削除自体を推奨しているものではございません。)<br>一方で、本データベースに不備が発生すると、レポートに関するデータが取得できない、つまりレポートを閲覧することが出来なくなります。</li></ul><p>今回ご紹介とするのは、”OperationsManager” のデータベースに関してです。<br>こちらのデータベースが長期的に運用されることで、”unused” 領域が増加する事象が確認されます。<br>データベースの空き容量は “unallocated” 領域に該当し、”unused” 領域は未使用領域ではあるものの、厳密には空き容量として計上されません。<br>そのため、空き容量に該当しない未使用領域が長期運用に伴い増加することで、データベースの空き容量を圧迫する要因となります。<br>今回は、この “unused” 領域を解放する手順と、その操作を定期的に実行するための設定手順をご紹介いたします。</p><h1 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h1><p>本格的なご説明の前に、今回の記事の大元となる弊社エンジニアのブログをご紹介いたします。<br><a href="https://kevinholman.com/2017/08/03/what-sql-maintenance-should-i-perform-on-my-scom-2016-databases/">What SQL maintenance should I perform on my SCOM databases?</a><br>今回ご紹介とします操作に加え、SCOM 関連データベースおよび SQL Server で必要なメンテナンスや設計思想が数多く掲載された、有用なブログ記事です。</p><h1 id="事象発生要因"><a href="#事象発生要因" class="headerlink" title="事象発生要因"></a>事象発生要因</h1><p>結論を先に述べると、”unused” 領域の拡大は、インデックス最適化が行われていない場合に発生する可能性がございます。<br>SCOM データベースである “OperationsManager” データベースの設計と SQL Server 2016 以降の仕様によって、一部テーブルに対してインデックス最適化処理が行われない可能性がございます。<br>比較的多い事例として、”dbo.PerformanceData_xx” テーブルが “unused” の領域の大半を消費することがございます。<br>(“xx” にはテーブル番号を示す数値が入力されます。)<br>“dbo.PerformanceData_xx” は SCOM の処理上、現在のテーブル内データに応じてインデックスを最適化する処理が行われません。<br>これによって、下記の影響が発生する場合がございます。</p><ul><li>実データ総数に対して、テーブルが実際に使用する容量が必要以上に消費される。</li><li>データベース自体のパフォーマンスへの影響。</li><li>テーブル内の未使用領域 (= “unused” 領域) の未開放</li></ul><p>こちらの事象対処のため、後述の手順で対象テーブルのインデックス最適化を行います。<br>下記にご紹介します手順を弊社検証環境でも実施しました結果、テーブル内のレコード数が減ることなく “OperationsManager” データベースの “unused” 領域の割合が下記の遷移となりましたことを確認しております。</p><ul><li>手順実施前: 10.95%</li><li>手順実施後: 3.76%</li></ul><p>上記で減少した “unused” 領域の割合だけ、”unallocated” 領域の割合も増加します。<br>また、手順実施後も SCOM 上でのデータ欠損等は見られず、動作も正常に行われ続けることも確認しております。<br>そのため、事象対処にあたっては、下記にご案内します手順の実施は有用と判断しております。</p><h1 id="“unused”-領域占有状況の確認方法"><a href="#“unused”-領域占有状況の確認方法" class="headerlink" title="“unused” 領域占有状況の確認方法"></a>“unused” 領域占有状況の確認方法</h1><p>“unused” 領域はユーザーでも簡単に確認いただけます。<br>確認点としてはデータべーズ全体の “unused” 領域の割合を確認する方法と、テーブル毎に “unused” 領域の総容量を確認する方法がございます。<br>以下確認では SQL Server データベースのレポートを表示します。<br>各レポート表示後、レポートの画面上で右クリックし、[エクスポート] から以下形式でレポートをエクスポートいただけます。</p><ul><li>Excel</li><li>PDF</li><li>Word</li></ul><p>状況に応じてレポートをエクスポートいただき、データ分析のお役に立ててください。</p><h2 id="データべーズ全体の-“unused”-領域割合の確認方法"><a href="#データべーズ全体の-“unused”-領域割合の確認方法" class="headerlink" title="データべーズ全体の “unused” 領域割合の確認方法"></a>データべーズ全体の “unused” 領域割合の確認方法</h2><ol><li>“OperationsManager” データベースが存在するサーバーに管理者権限でログインします。</li><li>SQL Server Management Studio (SSMS) を開きます。</li><li>目的のデータべースが存在するサーバーに、管理者権限でログインします。</li><li>左ペインより “OperationsManager” を右クリックし、[レポート] -&gt; [標準レポート] -&gt; [ディスク使用量] をクリックします。</li><li>ディスク使用量のレポートが表示されますので、表示された左側の円グラフの “unused” 領域の割合を確認します。<br>この割合が、現在 “OperationsManager” データベースで占有されている “unused” 領域の割合となります。</li></ol><h2 id="テーブル毎の-“unused”-領域使用量の確認方法"><a href="#テーブル毎の-“unused”-領域使用量の確認方法" class="headerlink" title="テーブル毎の “unused” 領域使用量の確認方法"></a>テーブル毎の “unused” 領域使用量の確認方法</h2><ol><li>“OperationsManager” データベースが存在するサーバーに管理者権限でログインします。</li><li>SQL Server Management Studio (SSMS) を開きます。</li><li>目的のデータべースが存在するサーバーに、管理者権限でログインします。</li><li>左ペインより “OperationsManager” を右クリックし、[レポート] -&gt; [標準レポート] -&gt; [テーブルごとのディスク使用量] をクリックします。</li><li>表示されたレポートの [未使用 (KB)] 列の値を確認します。<br>こちらの値が、各テーブルで “unused” 領域に該当する使用容量を表示します。</li></ol><h1 id="“unused”-領域の開放"><a href="#“unused”-領域の開放" class="headerlink" title="“unused” 領域の開放"></a>“unused” 領域の開放</h1><p>それでは本題の、”OperationsManager” データベースより “unused” 領域を解放する手順をご紹介します。</p><h2 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h2><p>本手順は “OperationsManager” データベースに対してインデックス最適化を行う処理を実施いただきます。<br>念のため、手順を実施いただく前に、”OperationsManager” データベースのバックアップを取得いただくことを推奨致します。<br>バックアップ方法は、下記の弊社サイトをご確認ください。<br><a href="https://learn.microsoft.com/ja-jp/sql/relational-databases/backup-restore/create-a-full-database-backup-sql-server?view=sql-server-ver22">データベースの完全バックアップの作成</a><br>万が一インデックス最適化後に SCOM 動作が不安定になったり、機能不全に陥った場合、データベースの復元を行います。</p><p>復元をいただく場合、ご利用の SCOM サーバー全台で、本ブログ別記事の [② SCOM 管理サーバーのキャッシュクリア手順] 項の手順を実施いただきます。<br><a href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_CacheClear/#%E2%91%A1-SCOM-%E7%AE%A1%E7%90%86%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%AF%E3%83%AA%E3%82%A2%E6%89%8B%E9%A0%86">SCOM の各種キャッシュクリアの手順 - ② SCOM 管理サーバーのキャッシュクリア手順</a><br>その際、2. の手順実施後から 5. の手順実施前の任意の間で、データベースを復元いただきます。<br>なお、復元の際は、必ずすべての SCOM サーバーで 2. の手順が実施された状態としていただきます。</p><p>復元手順は下記の弊社サイトに沿って行います。<br><a href="https://learn.microsoft.com/ja-jp/sql/relational-databases/backup-restore/restore-a-database-backup-using-ssms?view=sql-server-ver16&viewFallbackFrom=sql-server-ver22">データベースの完全バックアップの作成</a><br>復元後、停止された SCOM サービス一式を起動します。</p><h2 id="手順で使用するクエリの入手"><a href="#手順で使用するクエリの入手" class="headerlink" title="手順で使用するクエリの入手"></a>手順で使用するクエリの入手</h2><p>今回ご紹介としますインデックス最適化は、別途環境内に作成いただくストアド プロシージャを実行することで行われます。<br>こちらのストアド プロシージャを作成するクエリを提供しておりますサイトをご紹介します。<br><a href="https://ola.hallengren.com/sql-server-index-and-statistics-maintenance.html">SQL Server Maintenance Solution - SQL Server Index and Statistics Maintenance</a><br>以下図の箇所を参考とし、手順内で使用するクエリをダウンロードします。<br><img src="001.png"></p><h2 id="本手順"><a href="#本手順" class="headerlink" title="本手順"></a>本手順</h2><ol><li>“OperationsManager” データベースを運用する SQL Server が動作するサーバーに管理者権限でログインします。</li><li>ダウンロードされた “MaintenanceSolution.sql” を、1. でログインされたサーバーにコピーします。</li><li>1. でログインされたサーバー上で SQL Server Management Studio (SSMS) を開きます。</li><li>“OperationsManager” データベースが存在するサーバーに、管理者権限でログインします。</li><li>画面左ペインより、ログインされたサーバー名を右クリックし、[新しいクエリ] をクリックします。</li><li>クエリ入力欄に、2. でコピーされた “MaintenanceSolution.sql” ファイルをドラッグ &amp; ドロップします。</li><li>クエリ入力欄にクエリが表示されましたら、F5 キーを押下してクエリを実行します。<br>対象サーバーのシステムデータベースである “master” データベースに、”dbo.IndexOptimize” ストアドプロシージャが新規に作成されます。</li><li>続けて、画面左ペインより、ログインされたサーバー名を右クリックし、[新しいクエリ] をクリックします。</li><li>下記のクエリをクエリ入力欄に貼り付け、F5 キーを押下してクエリを実行します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">use [master]</span><br><span class="line">EXECUTE dbo.IndexOptimize</span><br><span class="line">@Databases = &#x27;OperationsManager&#x27;,</span><br><span class="line">@FragmentationLow = NULL,</span><br><span class="line">@FragmentationMedium = &#x27;INDEX_REORGANIZE,INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE&#x27;,</span><br><span class="line">@FragmentationHigh = &#x27;INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE&#x27;,</span><br><span class="line">@FragmentationLevel1 = 5,</span><br><span class="line">@FragmentationLevel2 = 30</span><br></pre></td></tr></table></figure></li></ol><p>手順は以上となります。<br>こちらのクエリによって、インデックス最適化が必要なテーブルのみに対してインデックス最適化を行う “dbo.IndexOptimize” ストアドプロシージャを実行します。<br>弊社検証環境では、”dbo.PerformanceData_xx”、”dbo.Event_xx”、”dbo.StateChangeEvent” テーブルに対してのみインデックス最適化が行われたことを確認しております。<br>なお、テーブルのインデックス最適化という処理の関係上、サーバーの性能や最適化対象となるテーブル数やその大小によってクエリ実行時間が大きく変動いたします。<br>クエリを実行いただく際は、可能であれば業務影響の小さい時間帯に実施いただくことを推奨いたします。</p><p>クエリ実行後、”OperationsManager” データベースに占める “unused” 領域が縮小し “unallocated” 領域が拡大したことを確認します。<br>仕様上、すべての “unused” 領域が “unallocated” 領域になることはありません。</p><h2 id="事象再発抑止のための定期的なクエリ実行スケジュールの設定"><a href="#事象再発抑止のための定期的なクエリ実行スケジュールの設定" class="headerlink" title="事象再発抑止のための定期的なクエリ実行スケジュールの設定"></a>事象再発抑止のための定期的なクエリ実行スケジュールの設定</h2><p>[対処手順] 項で記載しました手順を実施いただくことで、テーブルのインデックス最適化が実施されます。<br>これにより、”OperationsManager” データベース内の “unused” 領域を開放いただけます。<br>一方で、時間経過によってインデックス情報が陳腐化され、再度 “unused” 領域が拡大する場合がございます。<br>そのため、本日ご案内しましたクエリについては、1 日に一度実行いただくことを推奨いたします。<br>SQL Server には特定のクエリをスケジュールする機能がございますので、そちらで設定いただいてクエリを自動化いただくのが有用と判断しております。<br>下記にスケジュール設定手順をご案内いたします。</p><ol><li>[対処手順] でクエリを実行されたサーバーに管理者権限でログインします。</li><li>SQL Server Management Studio (SSMS) を開き、サーバーに管理者権限でログインします。</li><li>画面左ペインの [&lt;サーバー名&gt;] -&gt; [SQL Server エージェント] -&gt; [ジョブ] を右クリックし、[新しいジョブ] をクリックします。</li><li>新しいウィンドウが表示されますので、まず [全般] 項にてジョブの任意の名称を [名前] 入力欄に入力します。</li><li>[ステップ] 項をクリックし、ウィンドウ下部の [新規作成] をクリックします。</li><li>以下の設定を行います。<br>特に明記していない項については、既定値の状態で設定いただくものとします。<br>設定完了後、[OK] をクリックしてステップを保存します。<blockquote><p>① [全般] 項の設定:<br>・ステップ名:<br>作成するステップの任意の名称を指定します。</p><p>・種類:<br>“Transact-SQL スクリプト (T-SQL)” を選択します。</p><p>・データベース:<br>“master” を選択します。</p><p>・コマンド:<br>[対処手順] の 9. の手順でご案内しましたクエリを貼り付けます。</p><p>② [詳細設定] 項の設定:<br>・実行時のユーザー:<br>SQL Server に管理者権限を持つアカウントを指定します。</p></blockquote></li><li>[スケジュール] 項をクリックし、ウィンドウ下部の [新規作成] をクリックします。</li><li>以下の設定を行います。<br>特に明記していない項については、既定値の状態で設定いただくものとします。<br>設定完了後、[OK] をクリックしてスケジュールを保存します。<blockquote><p>・名前:<br>作成するスケジュールの任意の名称を指定します。</p><p>・スケジュールの種類:<br>“定期的” を指定します。</p><p>・実行:<br>“毎日” を指定します。</p><p>・間隔:<br>既定状態の “1” となることを確認します。</p><p>・一日のうちの頻度:<br>“1 回” を指定します。<br>その後、指定する時間については 3:00 から4:00 の間で指定いただくことを推奨いたします。<br>これは、その付近で実行される SCOM データベースのメンテナンス時間との重複を避け、かつ業務時間への影響が小さい時間にクエリを実行することを目的としております。<br>SCOM データベースで実行されるメンテナンスおよびその実行時間は、下記の弊社サイトに纏めて掲載されております。<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/manage-scheduled-maintenance-in-operations-manager?view=sc-om-2022">Operations Manager のスケジュールされたメンテナンス</a></p></blockquote></li><li>[OK] をクリックし、設定された内容でジョブを保存します。</li></ol><h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>今回は、SCOM データベースの未使用領域を解放する手順をご紹介としました。<br>SCOM データベースの容量は SCOM 自体でも監視されており、空き容量が少なくなるとアラートが発生します。<br>このアラートが発生した場合、まずは未使用領域が増加していないかご確認の上、増加が認められた場合は上記手順に沿って領域開放を行います。<br>お客様の SCOM データベース運用が、本記事でより円滑なものとなれば幸いでした。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆さんこんにちは、System Center サポートチームの 保科と申します。&lt;/p&gt;
&lt;p&gt;今回は、System Center Operations Manager (SCOM) のベース内で増加した unused 領域を開放する手順をご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Trouble" scheme="https://jpsystemcenter.github.io/blog/tags/Trouble/"/>
    
    <category term="Database" scheme="https://jpsystemcenter.github.io/blog/tags/Database/"/>
    
    <category term="OperationsManager" scheme="https://jpsystemcenter.github.io/blog/tags/OperationsManager/"/>
    
  </entry>
  
  <entry>
    <title>SCOM でメモリ使用率を監視する方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_RAMPercentMonitor/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_RAMPercentMonitor/</id>
    <published>2024-10-31T03:00:00.000Z</published>
    <updated>2025-12-10T08:31:18.985Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの保科です。<br>本日は、System Center Operations Manager (以後 SCOM と表記します) で、Windows OS のメモリ使用率を監視する方法をご紹介いたします。</p><span id="more"></span><p>SCOM 2016<br>SCOM 2019<br>SCOM 2022</p><h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><p>SCOM では、パフォーマンス カウンターの監視を行うモニターを作成することが出来ます。<br>これにより、サーバーによって重要なパフォーマンス カウンターを監視し、必要に応じてアラートを発生するといった構成を可能とします。</p><p>CPU やメモリ使用率は、多くのお客様がサーバーの重要なパフォーマンス指標として監視要件をお持ちと存じます。<br>CPU 使用率はパフォーマンス カウンターとしての取得が可能で、メモリは以下カウンターで空き容量の実値が取得可能です。</p><ul><li>バイト単位: Memory\Available Bytes</li><li>キロバイト単位: Memory\Available KBytes</li><li>メガバイト単位: Memory\Available MBytes</li></ul><p>しかし、メモリ使用率はパフォーマンス カウンターとしては提供されておりません。<br>そのため、SCOM のパフォーマンス カウンターの監視モニターでも、メモリ使用率の監視は行えません。<br>メモリ使用率の監視にあたっては、スクリプト等によって、割り当てメモリと使用メモリからメモリ使用率の算出が必要となります。<br>今回の記事では、その算出を行う SCOM 用のサンプル スクリプトをご紹介とします。</p><h1 id="サンプル-スクリプトの監視シナリオ"><a href="#サンプル-スクリプトの監視シナリオ" class="headerlink" title="サンプル スクリプトの監視シナリオ"></a>サンプル スクリプトの監視シナリオ</h1><p>今回ご紹介するサンプル スクリプトは vbs スクリプトで、以下の処理で監視を行います。</p><ol><li>OS に割り当てられているメモリと、メモリの空き容量を WMI クラスより取得します。<br>この処理で参照する WMI クラスは “Win32_OperatingSystem” です。</li><li>OS に割り当てられているメモリから、メモリの空き容量を減算し、その値を 1024 で除算します。<br>これによって、メモリの使用容量を MB 単位に変換して算出します。</li><li>OS で利用可能なメモリ容量を WMI クラスより取得します。<br>この処理で参照する WMI クラスは “Win32_PerfRawData_Counters_HyperVDynamicMemoryIntegrationServic” です。<br>1. の処理で取得している、OS に割り当てられているメモリとの相違点は、例えば動的メモリが設定されている仮想マシンの場合は、動的メモリで割り当て可能なメモリの最大容量を取得する点です。<br>逆に、1. の処理で取得している、OS に割り当てられているメモリは、動的メモリが設定されている場合は、現在仮想マシンに割り当てられているメモリ容量を取得します。<br>この処理によって、動的メモリで運用されている仮想マシンも、動的メモリで割り当て可能なメモリの最大値から見たメモリ使用率を算出することが可能です。<br>なお、物理マシンではこの WMI クラスが利用不可なので、その場合は 1. と同様”Win32_OperatingSystem” クラスを使用します。</li><li>2. で算出した値と 3. で取得した値を除算し、その値を 100 で乗算します。<br>これによってメモリ使用率の割合を算出します。</li></ol><p>スクリプト監視モニターの仕様上、値を SCOM に渡した場合、その値は文字列として扱われます。<br>そのため、監視値の正常判定はスクリプト内で行います。</p><h1 id="サンプルスクリプト"><a href="#サンプルスクリプト" class="headerlink" title="サンプルスクリプト"></a>サンプルスクリプト</h1><p>ご紹介しますスクリプトは、Hyper-V 仮想マシンの動的メモリも考慮したメモリ空き容量の割合を計算する処理としています。<br>物理マシンのメモリ空き容量を計算する場合、もしくは仮想マシンの現在割り当てられたメモリ容量を参照とした空き容量の割合計算を実施される場合、コメント アウトされた箇所をお読みの上、スクリプトを書き換えてください。</p><ol><li><p>2 つのヘルス状態に基づく監視を行う場合のサンプル スクリプト:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Dim oArgs, objWMIService, colItems, usedPhysicalMemory, totalPhysicalMemory, usedRAMSizePercentage, threshold</span><br><span class="line">Set oArgs = Wscript.Arguments</span><br><span class="line">threshold = Cdbl(oArgs(0))</span><br><span class="line">Set objWMIService = GetObject(&quot;winmgmts:\\.\root\cimv2&quot;)</span><br><span class="line">Set colItems = objWMIService.ExecQuery(&quot;Select * from Win32_OperatingSystem&quot;)</span><br><span class="line"></span><br><span class="line">For Each objItem in colItems</span><br><span class="line">  usedPhysicalMemory = (objItem.TotalVisibleMemorySize - objItem.FreePhysicalMemory) /1024</span><br><span class="line">  &#x27; 物理マシンのメモリ割り当て容量、もしくは仮想マシンの現状のメモリ割り当て容量を確認したい場合、以下の処理のコメント アウトを削除します。</span><br><span class="line">  &#x27; totalPhysicalMemory = objItem.TotalVisibleMemorySize / 1024</span><br><span class="line">Next</span><br><span class="line"></span><br><span class="line">&#x27; 物理マシンのメモリ割り当て容量、もしくは仮想マシンの現状のメモリ割り当て容量を確認したい場合、指定範囲の処理を削除します。</span><br><span class="line">&#x27; 削除範囲ここから</span><br><span class="line">Set colItems = objWMIService.ExecQuery(&quot;SELECT * FROM Win32_PerfRawData_Counters_HyperVDynamicMemoryIntegrationService&quot;,,48)</span><br><span class="line">For Each objItem in colItems</span><br><span class="line">  totalPhysicalMemory = objItem.MaximumMemoryMbytes</span><br><span class="line">Next</span><br><span class="line">&#x27; 削除範囲ここまで</span><br><span class="line"></span><br><span class="line">usedRAMSizePercentage = usedPhysicalMemory / totalPhysicalMemory * 100</span><br><span class="line"> </span><br><span class="line">if usedRAMSizePercentage &gt; threshold then</span><br><span class="line">Set oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line">Set oBag = oAPI.CreatePropertyBag()</span><br><span class="line">Call oBag.AddValue(&quot;PerfValue&quot;, &quot;Bad&quot;)</span><br><span class="line">Call oBag.AddValue(&quot;usedRAMSizePercentage&quot;, usedRAMSizePercentage)</span><br><span class="line">Call oBag.AddValue(&quot;usedPhysicalMemory&quot;, usedPhysicalMemory)</span><br><span class="line">Call oAPI.Return(oBag)</span><br><span class="line"></span><br><span class="line">Else</span><br><span class="line">Set oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line">Set oBag = oAPI.CreatePropertyBag()</span><br><span class="line">Call oBag.AddValue(&quot;PerfValue&quot;, &quot;Good&quot;)</span><br><span class="line">Call oBag.AddValue(&quot;usedRAMSizePercentage&quot;, usedRAMSizePercentage)</span><br><span class="line">Call oBag.AddValue(&quot;usedPhysicalMemory&quot;, usedPhysicalMemory)</span><br><span class="line">Call oAPI.Return(oBag)</span><br><span class="line">End If</span><br></pre></td></tr></table></figure></li><li><p>3 つのヘルス状態に基づく監視を行う場合のサンプル スクリプト:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Dim oArgs, objWMIService, colItems, usedPhysicalMemory, totalPhysicalMemory, usedRAMSizePercentage, ErrorThreshold, WarningThreshold</span><br><span class="line">Set oArgs = Wscript.Arguments</span><br><span class="line">ErrorThreshold = Cdbl(oArgs(0))</span><br><span class="line">WarningThreshold = Cdbl(oArgs(1))</span><br><span class="line">Set objWMIService = GetObject(&quot;winmgmts:\\.\root\cimv2&quot;)</span><br><span class="line">Set colItems = objWMIService.ExecQuery(&quot;Select * from Win32_OperatingSystem&quot;)</span><br><span class="line"></span><br><span class="line">For Each objItem in colItems</span><br><span class="line">  usedPhysicalMemory = (objItem.TotalVisibleMemorySize - objItem.FreePhysicalMemory) /1024</span><br><span class="line">  &#x27; 物理マシンのメモリ割り当て容量、もしくは仮想マシンの現状のメモリ割り当て容量を確認したい場合、以下の処理のコメント アウトを削除します。</span><br><span class="line">  &#x27; totalPhysicalMemory = objItem.TotalVisibleMemorySize / 1024</span><br><span class="line">Next</span><br><span class="line"> </span><br><span class="line">&#x27; 物理マシンのメモリ割り当て容量、もしくは仮想マシンの現状のメモリ割り当て容量を確認したい場合、指定範囲の処理を削除します。</span><br><span class="line">&#x27; 削除範囲ここから</span><br><span class="line">Set colItems = objWMIService.ExecQuery(&quot;SELECT * FROM Win32_PerfRawData_Counters_HyperVDynamicMemoryIntegrationService&quot;,,48)</span><br><span class="line">For Each objItem in colItems</span><br><span class="line">  totalPhysicalMemory = objItem.MaximumMemoryMbytes</span><br><span class="line">Next</span><br><span class="line">&#x27; 削除範囲ここまで</span><br><span class="line"> </span><br><span class="line">usedRAMSizePercentage = usedPhysicalMemory / totalPhysicalMemory * 100</span><br><span class="line"> </span><br><span class="line">if usedRAMSizePercentage &gt; ErrorThreshold then</span><br><span class="line">Set oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line">Set oBag = oAPI.CreatePropertyBag()</span><br><span class="line">Call oBag.AddValue(&quot;PerfValue&quot;, &quot;Bad&quot;)</span><br><span class="line">Call oBag.AddValue(&quot;usedRAMSizePercentage&quot;, usedRAMSizePercentage)</span><br><span class="line">Call oBag.AddValue(&quot;usedPhysicalMemory&quot;, usedPhysicalMemory)</span><br><span class="line">Call oAPI.Return(oBag)</span><br><span class="line"></span><br><span class="line">Else If usedRAMSizePercentage &lt;= ErrorThreshold and usedRAMSizePercentage &gt; WarningThreshold then</span><br><span class="line">Set oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line">Set oBag = oAPI.CreatePropertyBag()</span><br><span class="line">Call oBag.AddValue(&quot;PerfValue&quot;, &quot;Warning&quot;)</span><br><span class="line">Call oBag.AddValue(&quot;usedRAMSizePercentage&quot;, usedRAMSizePercentage)</span><br><span class="line">Call oBag.AddValue(&quot;usedPhysicalMemory&quot;, usedPhysicalMemory)</span><br><span class="line">Call oAPI.Return(oBag)</span><br><span class="line"></span><br><span class="line">Else</span><br><span class="line">Set oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line">Set oBag = oAPI.CreatePropertyBag()</span><br><span class="line">Call oBag.AddValue(&quot;PerfValue&quot;, &quot;Good&quot;)</span><br><span class="line">Call oBag.AddValue(&quot;usedRAMSizePercentage&quot;, usedRAMSizePercentage)</span><br><span class="line">Call oBag.AddValue(&quot;usedPhysicalMemory&quot;, usedPhysicalMemory)</span><br><span class="line">Call oAPI.Return(oBag)</span><br><span class="line">End If</span><br></pre></td></tr></table></figure></li></ol><h1 id="スクリプト監視の実装方法"><a href="#スクリプト監視の実装方法" class="headerlink" title="スクリプト監視の実装方法"></a>スクリプト監視の実装方法</h1><p>監視の実装方法は、本ブログの以下記事の “② スクリプトの返り値に対してしきい値を設定してアラートを生成する手順” 項の手順に沿って行います。<br><a href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_windows_script_monitor/">スクリプト監視の設定手順 - Windows 編</a><br>今回のスクリプト監視における、こちらの手順に対して追加で必要となる事項をご紹介します。</p><ul><li><p>8. の手順で、追加で画面内の [パラメーター] ボタンをクリックします。<br>その後スクリプトのパラメーターとして渡す値を入力します。<br>2 つのヘルス状態で監視を行う場合、渡すパラメーターは重大しきい値用の 1 つのみです。<br>アラートのしきい値を 70 に設定いただく場合は以下の通りに入力します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;70&quot;</span><br></pre></td></tr></table></figure><p>3 つのヘルス状態に基づく監視を行う場合のサンプル スクリプトを作成いただく場合は、警告と重大の 2 つのしきい値の設定が必要となります。<br>パラメーターを入力する場合、各パラメーターに半角スペースを入力する必要があります。<br>ご紹介しましたスクリプトでは、1 番目のパラメーターが重大、2 番目のパラメーターが警告レベルのしきい値として指定されます。<br>そのため、例えば重大のしきい値を 70、警告のしきい値を 50 に設定する場合は、以下のようにパラメーターを入力します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;70&quot; &quot;50&quot;</span><br></pre></td></tr></table></figure><p>文字入力の際、スペースやダブル クォーテーション、数字の値は必ず半角で入力してください。<br>全角が含まれている場合、監視が正常に実行されません。<br>上記入力例はすべて半角で入力していますが、設定を実施される際は、念のためコピー &amp; ペーストではなくキーボードで直接文字入力された方がよろしいかと思います。<br>場合によっては上記文字が全角で貼り付けされる可能性があるためです。</p></li><li><p>同様に 8. の手順で、スクリプト名についてです。<br>今回ご紹介しましたスクリプトは vbs 形式のスクリプトなので、スクリプトのファイル名の拡張子は “.vbs” を指定します。</p></li><li><p>9. の手順では、入力するパラメーター名 (Property[@Name=’PerfValue’]) に変更はございません。<br>ですがアラート判定で使用する文字列が上記スクリプトでは一意に決まっているため、以下の設定を行います。<br>しきい値はスクリプトのパラメーターで指定しており、最終的な値の健全性は、スクリプト内の分岐処理で文字列を決定しているためです。<br>以下図の入力内容参考にしてください。<br><img src="002.png"></p><ul><li>演算子: 次の値と等しい</li><li>値: Bad</li></ul></li><li><p>10. の手順も同様に、正常値の場合は入力するパラメーターに対する文字列の内容で判定を行います。<br>以下図の入力内容参考にしてください。<br><img src="003.png"></p><ul><li>演算子: 次の値と等しい</li><li>値: Good</li></ul></li><li><p>3 つのヘルス状態に基づく監視を行う場合、9. および 10. の手順の間で、警告しきい値の入力を行う [低下した場合の式] セクションがございます。<br>入力値は以下図参考にしてください。<br><img src="004.png"><br>こちらの入力の考え方も 9. および 10. の手順と同じで、パラメーターに対して以下の演算子と値をしきい値とします。</p><ul><li>演算子: 次の値と等しい</li><li>値: Warning</li></ul></li><li><p>3 つのヘルス状態に基づく監視を行う場合、発生するアラートは、監視値に応じて重大もしくは警告レベルに切り替えられたいご要望があると思います。<br>既定設定では、12. の手順では、以下図のようになっております。<br><img src="005.png"><br>この設定の問題点としては、重大しきい値の条件を満たした場合のみ、アラートのレベルは重大固定でアラートが発生する点です。<br>警告しきい値を満たした場合もアラートを発生させ、かつ警告しきい値を満たした場合は警告レベル、重大しきい値を満たした場合は重大レベルのアラートを発生させたい場合、以下図のように構成を変更します。<br><img src="006.png"></p></li></ul><p>こちらでメモリ使用率の監視と、値に応じたアラート発生の準備は完了です。</p><h1 id="アラート説明文のカスタマイズ"><a href="#アラート説明文のカスタマイズ" class="headerlink" title="アラート説明文のカスタマイズ"></a>アラート説明文のカスタマイズ</h1><p>作成されたユニット モニターの既定では、アラート説明文は以下のようになります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">詳細については、アラートのコンテキストを参照してください。</span><br></pre></td></tr></table></figure><p>お客様によっては、アラート説明文には、アラート発生時に検知されたメモリ使用率やメモリ使用量を転記されたいと思います。<br>その情報はスクリプトでも取得しておりますので、その内容を転記出来ます。<br>モニター作成時および編集時、アラートのプロパティで、アラートの説明文を入力する箇所がございます。<br>そちらの箇所の右側に表示された […] のアイコンをクリックします。<br>具体的な箇所は下記図の赤枠をご参照ください。<br><img src="001.png"></p><p>アラート説明文に、スクリプトで取得された変数毎の値を転記する場合、以下の書式で指定します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$Data/Context/Property[@Name=&#x27;&lt;&lt;STRING&gt;&gt;&#x27;]$</span><br></pre></td></tr></table></figure><p>“&lt;&lt;STRING&gt;&gt;” の箇所を、スクリプトで最終的に渡される各変数名に置き換えることで、その値をアラート説明文に転記出来ます。<br>この、スクリプトに最終的に渡される各変数とは、SCOM で監視スクリプトを実装する場合、指定された書式がございます。<br>今回のスクリプトでは、一例として以下の処理が、各変数を保存するための関数呼び出しおよび変数保存を行う処理に該当します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Set oAPI = CreateObject(&quot;MOM.ScriptAPI&quot;)</span><br><span class="line">Set oBag = oAPI.CreatePropertyBag()</span><br><span class="line">Call oBag.AddValue(&quot;PerfValue&quot;, &quot;Good&quot;)</span><br><span class="line">Call oBag.AddValue(&quot;usedRAMSizePercentage&quot;, usedRAMSizePercentage)</span><br><span class="line">Call oBag.AddValue(&quot;usedPhysicalMemory&quot;, usedPhysicalMemory)</span><br><span class="line">Call oAPI.Return(oBag)</span><br></pre></td></tr></table></figure><p>詳細は割愛できればと思いますが、”Call oBag.AddValue” 関数 1 番目の引数に変数名を、2 番目の引数に指定の変数に渡す値を指定します。<br>今回はスクリプトで変数の定義およびその変数に値を入力しているので、2 番目の引数は、スクリプト内で定義した変数名をそのまま使用します。<br>今回のスクリプトで取得している値と、その際のアラート説明文に入力する値をご紹介します。</p><ul><li>メモリ使用率: $Data/Context/Property[@Name=’usedRAMSizePercentage’]$</li><li>メモリ使用量 (MB): $Data/Context/Property[@Name=’usedPhysicalMemory’]$</li></ul><p>必要に応じてアラート説明文にこちらを転記いただき、アラート発生時の状況把握にお役立てください。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>SCOM でメモリ使用率を算出し、それをアラートで使用するサンプル スクリプトをご紹介しました。<br>動的メモリを使用している仮想マシンであれば、割り当て可能な最大値に対するメモリ使用率を監視できます。<br>今回ご紹介した内容はあくまでサンプル スクリプトですので、ご要望に応じてスクリプトを適宜カスタマイズいただくのも有用です。<br>是非お客様のメモリ使用率の監視にお役立てください。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの保科です。&lt;br&gt;本日は、System Center Operations Manager (以後 SCOM と表記します) で、Windows OS のメモリ使用率を監視する方法をご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="howto" scheme="https://jpsystemcenter.github.io/blog/tags/howto/"/>
    
    <category term="スクリプト監視" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E7%9B%A3%E8%A6%96/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM で TPM が有効な仮想マシンを管理する方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_vTPM/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_vTPM/</id>
    <published>2024-09-22T00:00:00.000Z</published>
    <updated>2025-12-10T08:31:19.081Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>今回は、SCVMM で トラステッド プラットフォーム モジュール (TPM) が有効な仮想マシンを管理する方法について説明します。<br><br></p><span id="more"></span><h2 id="トラステッド-プラットフォーム-モジュール-TPM-について"><a href="#トラステッド-プラットフォーム-モジュール-TPM-について" class="headerlink" title="トラステッド プラットフォーム モジュール (TPM) について"></a>トラステッド プラットフォーム モジュール (TPM) について</h2><p>SCVMM は Hyper-V 環境の統合管理システムですので、Hyper-V マネージャーやフェールオーバー クラスターマネージャーで設定可能な項目の多くは SCVMM コンソールから設定できます。ですが、一部の設定は SCVMM では対応しておらず、直接 Hyper-V  やフェールオーバークラスターにて設定する必要がある項目があります。トラステッド プラットフォーム モジュール (TPM) は SCVMM コンソールからは設定できない項目の一つです。(※ SCVMM 2022 UR2 時点)</p><p>Windows 11 では TPM が有効であることがシステム要件になります。そのため、Windows 11 が稼働する Hyper-V ホストを SCVMM で管理する場合、TPM が有効な仮想マシンの管理が必要になります。<br>・<a href="https://www.microsoft.com/ja-jp/windows/windows-11-specifications">Windows 11 の仕様とシステム要件</a><br><img src="001.png"></p><p>本記事では以下のケースについて手順を説明します。<br>１．<a href="#%EF%BC%91%EF%BC%8ETPM-%E3%81%8C%E6%9C%89%E5%8A%B9%E3%81%AA%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E4%BD%9C%E6%88%90%E6%96%B9%E6%B3%95">TPM が有効な仮想マシンの作成方法</a><br>２．<a href="#%EF%BC%92%EF%BC%8ETPM-%E3%81%8C%E6%9C%89%E5%8A%B9%E3%81%AA%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E8%A4%87%E8%A3%BD%E3%83%BB%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E5%8C%96%E6%96%B9%E6%B3%95">TPM が有効な仮想マシンの複製・テンプレート化方法</a><br>３．<a href="#%EF%BC%93%EF%BC%8ETPM-%E3%81%8C%E6%9C%89%E5%8A%B9%E3%81%AA%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96-%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E7%92%B0%E5%A2%83%E3%81%AE%E6%A7%8B%E7%AF%89%E6%96%B9%E6%B3%95-%E8%A8%BC%E6%98%8E%E6%9B%B8%E6%96%B9%E5%BC%8F">TPM が有効な仮想マシンのライブ マイグレーションができる環境の構築方法 (証明書方式)</a></p><h2 id="１．TPM-が有効な仮想マシンの作成方法"><a href="#１．TPM-が有効な仮想マシンの作成方法" class="headerlink" title="１．TPM が有効な仮想マシンの作成方法"></a>１．TPM が有効な仮想マシンの作成方法</h2><p>SCVMM コンソールから [新規仮想マシンの作成] にて Windows 11 を作成後、仮想マシンの電源を入れて Windows 11 OS のインストールを開始すると、以下のエラー画面が表示されて途中で失敗します。SCVMM による仮想マシンの新規作成では <b><strong>TPM が無効な仮想マシン</strong></b> が作成されますので、Windows 11 のシステム要件を満たさないためです。<br>■ Windows 11 インストール エラー画面<br><img src="002.png"></p><p>そのため、仮想マシンの電源 ON の前に Hyper-V マネージャーにて TPM を有効にしておく必要があります。<br>■ Hyper-V マネージャーにて仮想マシンの TPM を有効化<br><img src="003.png"></p><p> Hyper-V マネージャーにて該当仮想マシンの TPM を有効にすることで、SCVMM コンソールで該当 VM の電源をオンにして Windows 11 OS のインストールを進めることができます。（※ もちろん、このまま Hyper-V マネージャーで VM の電源をオンにして Windows 11 OS のインストールを進めることでも問題ありません。）<br>■ TPM を有効化することで OS インストール が進められます。<br><img src="004.png"></p><h2 id="２．TPM-が有効な仮想マシンの複製・テンプレート化方法"><a href="#２．TPM-が有効な仮想マシンの複製・テンプレート化方法" class="headerlink" title="２．TPM が有効な仮想マシンの複製・テンプレート化方法"></a>２．TPM が有効な仮想マシンの複製・テンプレート化方法</h2><p>TPM が有効な仮想マシンは SCVMM コンソールの複製・テンプレート化のメニューが無効になります。<br>■ TPM 有効な仮想マシンの複製・テンプレート化 メニュー (※グレーアウトしています。)<br><img src="005.png"></p><p>Hyper-V マネージャーで一度 TPM を無効化したのちに、複製・テンプレート化します。<br>■ Hyper-V マネージャーで TPM を無効化すると SCVMM 管理コンソールの複製・テンプレート化メニューが有効になります。<br><img src="006.png"></p><p><b><strong>注意</strong></b><br>複製した仮想マシンやテンプレートから作成した VM は TPM が無効な状態です。Windows 11 コンピューターは TPM が有効であることがシステム要件のため、VM を電源オンする前に Hyper-V マネージャーで TPM 有効にしてください。</p><p><b><strong>補足</strong></b><br>TPM の有効/無効化は Hyper-V マネージャーの画面上での設定変更の他に Hyper-V コマンドでも実行することができます。<br>　無効化：<a href="https://learn.microsoft.com/en-us/powershell/module/hyper-v/disable-vmtpm?view=windowsserver2022-ps">Disable-VMTPM (Hyper-V) | Microsoft Learn</a><br>　有効化：<a href="https://learn.microsoft.com/en-us/powershell/module/hyper-v/enable-vmtpm?view=windowsserver2022-ps">Enable-VMTPM (Hyper-V) | Microsoft Learn</a></p><p>以下のスクリプトは Hyper-V ホスト上の VM の TPM 設定を一括で無効化/有効化するサンプルです。<br>※ Hyper-V ホスト上で実行してください。</p><p>■ Hyper-V ホスト上の仮想マシンの TPM を一斉に無効化</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$vmNames = Get-VM | Select-Object -ExpandProperty Name foreach ($vmName <span class="keyword">in</span> $vmNames) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">             Disable-VMTPM -VMName $vmName -ErrorAction Stop</span><br><span class="line">             Write-Output &quot;Successfully disabled TPM <span class="keyword">for</span> VM: $vmName&quot;</span><br><span class="line">      &#125; catch &#123;</span><br><span class="line">             Write-Output &quot;Failed to disable TPM <span class="keyword">for</span> VM: $vmName. Error: $_&quot;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>■ Hyper-V ホスト上の仮想マシンの TPM を一斉に有効化</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$vmNames = Get-VM | Select-Object -ExpandProperty Name foreach ($vmName <span class="keyword">in</span> $vmNames) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">             Enable-VMTPM -VMName $vmName -ErrorAction Stop</span><br><span class="line">             Write-Output &quot;Successfully eabled TPM <span class="keyword">for</span> VM: $vmName&quot;</span><br><span class="line">      &#125; catch &#123;</span><br><span class="line">             Write-Output &quot;Failed to enable TPM <span class="keyword">for</span> VM: $vmName. Error: $_&quot;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="３．TPM-が有効な仮想マシンのライブ-マイグレーションができる環境の構築方法-証明書方式"><a href="#３．TPM-が有効な仮想マシンのライブ-マイグレーションができる環境の構築方法-証明書方式" class="headerlink" title="３．TPM が有効な仮想マシンのライブ マイグレーションができる環境の構築方法 (証明書方式)"></a>３．TPM が有効な仮想マシンのライブ マイグレーションができる環境の構築方法 (証明書方式)</h2><p>TPM が有効な仮想マシンをライブ マイグレーションするとエラー (10698) で失敗します。シールドされた VM をライブ マイグレーションする場合は、2 つ以上の保護されたホストをデプロイする必要があるためです。<br>■ ライブ マイグレーションがエラー (10698) で失敗<br><img src="007.png"></p><p>対処方法は以下の２つです。<br> <b>方法１．</b>ホスト ガーディアン サービス (HGS) サーバーに接続してホスト間でシールドされた VM を移行可能にする。<br> <b>方法２．</b>Hyper-V ホストに保存されている証明書を各ホストにインポートしてホスト間でシールドされた VM を移行可能にする。</p><p>方法１については、以下のサイトに詳細な手順の記載がありますので、こちらを参照してください。<br>　<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/deploy-guarded-host-fabric?view=sc-vmm-2022">保護されたホスト ファブリックをデプロイする</a></p><p>多数の Hyper-V ホストが存在する大規模環境では方法１の構成が推奨されますが、HGS サーバーが必要であることなど、準備が煩雑になります。Hyper-V ホストの台数が10台以下の環境では、証明書をお互いにインポートする方法２が簡潔になります。本記事では方法２について説明します。</p><p>=====================================================================<br>方法２：証明書を介した環境構築の詳細手順<br>=====================================================================<br>Hyper-V ホストに保存されている以下の証明書をライブマイグレーション先のホストにインポートすることで、ホスト間でシールドされた VM がライブ マイグレーション可能になります。</p><p>// 証明書<br>Shielded VM Signing Certificate (UntrustedGuardian) (ホスト名)<br>Shielded VM Encryption Certificate (UntrustedGuardian) (ホスト名)</p><p>TPM を有効にすると上記の 2 つの証明書が作成されます。これは、仮想マシンのキー保護機能を解除するために使用されます。ライブ マイグレーション先にこの証明書がない状態だと、上述のエラー (10698) が発生します。</p><p>以下の手順にて証明書のエクスポートとインポートを行います。</p><ol><li><p>TPM を有効化した仮想マシンが稼働している Hyper-V ホストにログオンします。</p></li><li><p>管理者権限のコマンド プロンプトを起動します。</p></li><li><p>以下のコマンドを実行します。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil -store &quot;Shielded VM Local Certificates&quot;</span><br></pre></td></tr></table></figure></li><li><p>以下の証明書のシリアル番号をそれぞれメモします。<br>Shielded VM Signing Certificate (UntrustedGuardian) (ホスト名)<br>Shielded VM Encryption Certificate (UntrustedGuardian) (ホスト名)<br>【実行例】<br><img src="008.png"></p></li><li><p>以下のコマンドを実行して、それぞれの証明書をエクスポートします。<br>※ &lt;パスワード&gt; は任意になります。<br>※ &lt;シリアル番号&gt; は 4. で確認した番号を指定してください。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">certutil -exportPFX -p &lt;パスワード&gt; &quot;Shielded VM Local Certificates&quot; &lt;シリアル番号&gt; &lt;出力先フォルダ&gt;\VMSigning.pfx</span><br><span class="line">certutil -exportPFX -p &lt;パスワード&gt; &quot;Shielded VM Local Certificates&quot; &lt;シリアル番号&gt; &lt;出力先フォルダ&gt;\VMEncryption.pfx</span><br></pre></td></tr></table></figure><p>【実行例】<br><img src="009.png"></p></li><li><p>作成された 2 ファイルを別の Hyper-V ホストへコピーします。</p></li><li><p>別の Hyper-V ホストで管理者権限のコマンド プロンプトを起動します。</p></li><li><p>以下を実行して、証明書をインポートします。<br>※ インポートの際にパスワードが要求されますので、エクスポートの際に指定したパスワードを入力ください。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">certutil -importPFX &quot;Shielded VM Local Certificates&quot; &lt;配置先フォルダ&gt;\VMSigning.pfx</span><br><span class="line">certutil -importPFX &quot;Shielded VM Local Certificates&quot; &lt;配置先フォルダ&gt;\VMEncryption.pfx</span><br></pre></td></tr></table></figure><p>【実行例】<br><img src="010.png"></p></li><li><p>TPM を有効化した仮想マシンを証明書をインポートした Hyper-V ホストへ移行させて、正常に動作することを確認します。<br><img src="011.png"></p></li><li><p>上の 6. ～ 9. の作業をクラスターに参加しているノード (Hyper-V ホスト) 全てで実行します。お互いに証明書をインポートすることで、どの Hyper-V ホストに対してもライブ マイグレーションできるようになります。</p></li></ol><hr><p>SCVMM で TPM が有効な仮想マシンを管理する方法に関する説明は以上の通りです。<br>Windows 11 コンピューターが稼働する Hyper-V ホストを SCVMM で管理する際の参考にしていただけますと幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;今回は、SCVMM で トラステッド プラットフォーム モジュール (TPM) が有効な仮想マシンを管理する方法について説明します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM 管理サーバー構築手順 ～ 全画面ショット付き</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Install_Manual/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Install_Manual/</id>
    <published>2024-09-16T01:00:00.000Z</published>
    <updated>2025-12-10T08:31:19.038Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。</p><p>System Center Virtual Machine Manager（以後 SCVMM）は、複数の Windows Server フェールオーバー クラスター環境を統合管理するシステムです。異なるクラスター間で仮想マシンのライブ マイグレーションが可能になるほか、システム全体で参照可能なファイル置き場 (ライブラリ サーバー) の構築、類似の仮想スイッチの設定を簡易的に反映できる設定 (論理スイッチ) などが利用できます。また、VMWare vCenter と連携することで VMWare VM を Hyper-V VM に移行することができます。<br><br>SCVMM の構成は、IT インフラ環境の規模や運用要件に応じて変わりますが、検証等の目的で簡易的に最短で SCVMM を構築されたいケースがあります。そういったケースに備えて、本記事では、1 台の Windows Server に SCVMM の主コンポーネントの SCVMM 管理サーバーと SCVMM コンソールをインストールして、SCVMM コンソールにサインインできるまでの手順を画面ショット付きで紹介します。</p><span id="more"></span><h1 id="SCVMM-導入の流れ"><a href="#SCVMM-導入の流れ" class="headerlink" title="SCVMM 導入の流れ"></a>SCVMM 導入の流れ</h1><p>SCVMM 導入の大まかな流れは下図の通りです。<br><img src="001.png"><br>最初に SCVMM 管理サーバーと SVMMM コンソールをインストールして SCVMM 環境を構築します。<br>その後、SCVMM で管理する Windows Server フェールオーバー クラスターを管理対象として追加します。<br>クラスターのメンバーではない独立した Hyper-V ホストを管理対象に追加することも可能です。<br>また、VMWare vCenter と連係することで、VMWare 環境を管理することもできます。</p><p>※ 構築フェーズの計画ガイドについては、以下のマニュアル サイトをご参照ください。<br>　<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/plan-install?view=sc-vmm-2022">VMM のインストールを計画する</a></p><p>本記事では、1 台の Windows Server にデータベース、SCVMM 管理サーバー、SCVM コンソールをインストールする手順 (上の図の赤枠で囲った部分の作業) を画面ショット付きで紹介します。<br><span style="color: red; "><strong>ドメインに参加した Windows Server 2022  (メモリ 16 GB 以上)  を予め 1 台ご準備ください。</strong></span></p><h1 id="データーベース-Microsoft-SQL-Server-2022-の導入"><a href="#データーベース-Microsoft-SQL-Server-2022-の導入" class="headerlink" title="データーベース (Microsoft SQL Server 2022) の導入"></a>データーベース (Microsoft SQL Server 2022) の導入</h1><p>SCVMM では、SCVMM のシステム情報、管理対象のホストの情報、ジョブ履歴などの保管にデーターベースを用います。<br>SCVMM 管理サーバーをインストールする前に最初にデーターベースの準備が必要です。<br>SCVMM 2022 は Microsoft SQL Server 2016/2019/2022をサポートします。(<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/system-requirements?view=sc-vmm-2022#sql-server">SQL Server の要件</a>)<br><br>※ SQL Server 2022 は SCVMM 2022 UR1 以降でサポート対象になりました。そのため、SCVMM 2022 を構築後、すぐに最新の UR (更新プログラム のロールアップ) を適用してください。UR の適用は、サポートブログ <a href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Update_Rollup/">UR (更新プログラム のロールアップ) を適用</a> を参考にしてください。</p><p>SCVMM 用の SQL Server のインストール手順は以下の通りです。</p><h2 id="1-SQL-Server-2022-のインストール-モジュールを準備"><a href="#1-SQL-Server-2022-のインストール-モジュールを準備" class="headerlink" title="1. SQL Server 2022 のインストール モジュールを準備"></a>1. SQL Server 2022 のインストール モジュールを準備</h2><p><em>① SQL Server 2022 のインストーラー</em>と <em>② 最新の累積的な更新プログラム(CU)</em> をダウンロードして、SCVMM をインストールする Windows Server 内にコピーします。<br><img src="004.png"></p><p><em>① SQL Server 2022 のインストーラー (評価版)</em> は <a href="https://www.microsoft.com/ja-jp/sql-server/sql-server-downloads">SQL Server のダウンロード</a> よりダウンロードできます。<br><img src="002.png"></p><p>ダウンロードした EXE ファイル (SQL2022-SSEI-Eval.exe) を管理者で実行すると以下の画面が表示されます。<br>メディアのダウンロードをクリックすることで、ISO ファイル形式のインストーラーをダウンロードできます。<br><img src="003.png"></p><p><em>② SQL Server 2022 の累積的な更新プログラム</em>は <a href="https://www.microsoft.com/ja-JP/download/details.aspx?id=105013">Download SQL Server® 2022 for Microsoft® Windows の最新の累積的な更新プログラム</a> よりダウンロードできます。( ※ 本記事では、掲載日時点で最新の CU 14 を使用します。)</p><h2 id="2-SQL-Server-2022-のインストール"><a href="#2-SQL-Server-2022-のインストール" class="headerlink" title="2. SQL Server 2022 のインストール"></a>2. SQL Server 2022 のインストール</h2><p>インストールファイルの準備ができましたら、実際にインストールを実行します。</p><ol><li><p>SCVMM をインストールする Windows Server にドメイン管理者でサインインします。</p></li><li><p>SQL Server 2022 のインストーラーを選択して、右クリック メニューでマウントします。<br><img src="005.png"></p></li><li><p>マウント先のドライブで setup.exe を選択して、右クリック メニューの [管理者として実行] をクリックします。<br><img src="006.png"></p></li><li><p>インストール画面を表示して、[SQL Server の新規スタンドアロン インストールを実行するか、既存のインストールに機能を追加] をクリックします。<br><img src="007.png"></p></li><li><p>本記事では Evaluation のまま [次へ] ボタンをクリックします。<br><img src="008.png"></p></li><li><p>ライセンス条項を確認して、 [次へ] ボタンをクリックします。<br><img src="009.png"></p></li><li><p>本記事では [Microsoft Update を使用して更新プログラムを確認する] は未チェックのまま [次へ] ボタンをクリックします。<br><img src="010.png"></p></li><li><p>事前検証でエラーが無いことを確認します。<br>[Windows ファイアウォール] の警告が出ていますが、本記事では SCVMM 管理サーバーを同一サーバーにインストールするため SQL Server へのリモート接続は必須ではないことから、このまま [次へ] ボタンをクリックします。<br><img src="011.png"></p></li><li><p>本記事では [SQL Server 用 Azure 拡張機能] はチェックを外して [次へ] ボタンをクリックします。<br><img src="011-2.png"></p></li><li><p>[データーベース エンジン サービス] にチェックを入れて [次へ] ボタンをクリックします。<br><img src="012.png"></p></li><li><p>本記事では [既定のインスタンス] のまま [次へ] ボタンをクリックします。<br><img src="013.png"></p></li><li><p>[サーバーの構成] の [サービス アカウント] タブ画面で [SQL Server エージェント] と [SQL Server Browser] のスタートアップの種類を [自動] にします。<br>また、[SQL Server データベース エンジン サービスにボリューム メンテナンス タスクを実行する特権を付与する] にチェックします。<br><img src="014.png"></p></li><li><p>[サーバーの構成] の [照合順序] タブ画面で<a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2022#windows-collation">サポートされた日本語の照合順序</a>  ( Japanese_CI_AS、もしくは Japanese_XJIS_100_CI_AS ) が指定されていることを確認して  [次へ] ボタンをクリックします。<br><img src="015.png"></p></li><li><p>本記事では認証モードは [Windows 認証モード] を選択し、SQL Server 管理者には [現在のユーザーの追加] ボタンをクリックして、インストール作業を実行しているユーザーを設定します。<br>その他の設定はそのまま   [次へ] ボタンをクリックします。<br><img src="016.png"></p></li><li><p>[インストール] ボタンをクリックして、インストールを実行します。<br><img src="017.png"></p></li><li><p>完了画面に表示された [状態] がすべて [成功] になっていることを確認して [閉じる] ボタンをクリックします。<br>以上で SQL Server 2022 インスタンスの準備は完了です。<br><img src="018.png"></p></li></ol><h2 id="3-SQL-Server-2022-の累積的な更新プログラム-CU-14-を適用する。"><a href="#3-SQL-Server-2022-の累積的な更新プログラム-CU-14-を適用する。" class="headerlink" title="3. SQL Server 2022 の累積的な更新プログラム ( CU 14 ) を適用する。"></a>3. SQL Server 2022 の累積的な更新プログラム ( CU 14 ) を適用する。</h2><ol><li><p>更新プログラムのインストーラーを選択して、右クリック メニューの [管理者として実行] をクリックします。<br><img src="019.png"></p></li><li><p>ライセンス条項を確認して、 [次へ] ボタンをクリックします。<br><img src="020.png"></p></li><li><p>MSSQLSERVER にチェックが付いていることを確認して、 [次へ] ボタンをクリックします。<br><img src="021.png"></p></li><li><p>ファイルの確認が完了したら、 [次へ] ボタンをクリックして進みます。<br><img src="022.png"></p></li><li><p>[更新] ボタンをクリックして、更新プログラムのインストールを実行します。<br><img src="023.png"></p></li><li><p>完了画面に表示された [状態] がすべて [成功] になっていることを確認して [閉じる] ボタンをクリックします。<br>以上で SCVMM 用の データーベースの準備は完了です。<br><img src="024.png"></p></li></ol><p>※ 以下の警告が表示された場合は、更新プログラムのインストール完了後、一度 Windows Server を再起動します。<br><img src="025.png"></p><p>==================<span style="font-size: 80%;"><br>【補足】<br>検証用の SCVMM の最短構築に際しては必須ではありませんが、SQL Server の管理に有用な <strong>SQL Server Management Studio (SSMS)</strong> はインストールされることを推奨します。SSMS は、<a href="https://learn.microsoft.com/ja-jp/sql/ssms/download-sql-server-management-studio-ssms?redirectedfrom=MSDN&view=sql-server-ver16#download-ssms">SQL Server Management Studio (SSMS) のダウンロード</a> からダウンロードできます。<br></span>==================</p><h1 id="SCVMM-管理サーバーと-SCVMM-コンソールのインストール"><a href="#SCVMM-管理サーバーと-SCVMM-コンソールのインストール" class="headerlink" title="SCVMM 管理サーバーと SCVMM コンソールのインストール"></a>SCVMM 管理サーバーと SCVMM コンソールのインストール</h1><p>データーベースの準備が完了したら、いよいよ SCVMM 管理サーバーと SCVMM コンソールのインストールになりますが、その前に前提条件のソフトウェアをインストールします。<br>詳細な手順については、以下のマニュアル サイトをご参照ください。<br>・<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/install?view=sc-vmm-2022">SCVMM 管理サーバーをインストールする方法</a><br>・<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/install-console?view=sc-vmm-2022">SCVMM コンソールをインストールする方法</a></p><p>前提条件のソフトウェア、SCVMM 管理サーバー、SCVMM コンソールのインストール手順は以下の通りです。</p><h2 id="1-SCVMM-2022-の前提条件のソフトウェアのインストール"><a href="#1-SCVMM-2022-の前提条件のソフトウェアのインストール" class="headerlink" title="1. SCVMM 2022 の前提条件のソフトウェアのインストール"></a>1. SCVMM 2022 の前提条件のソフトウェアのインストール</h2><p>SCVMM 管理サーバーと SCVMM コンソールのインストール サーバーは、以下の前提条件を満たしている必要があります。<br><a href="https://learn.microsoft.com/ja-jp/system-center/vmm/system-requirements?view=sc-vmm-2022#installation-components">インストール コンポーネント</a><br><img src="pre001.png"></p><p>Windows Server 2022 の場合、PowerShell や .Net については最初から条件を満たしていると思いますので、<em>Windows ADK</em> をインストールします。Windows ADK のインストーラーは <a href="https://learn.microsoft.com/ja-jp/windows-hardware/get-started/adk-install">ココ</a> からダウンロードできます。adksetup.exe と adkwinpesetup.exe をダウンロードします。<br><img src="pre002.png"></p><ol><li><p>Windows ADK (adksetup.exe) を選択して、右クリック メニューの [管理者として実行] をクリックします。<br><img src="pre003.png"></p></li><li><p>インストール先を指定して、 [次へ] ボタンをクリックします。<br><img src="pre004.png"></p></li><li><p>Windows キット プライバシーを選択して、 [次へ] ボタンをクリックします。<br><img src="pre005.png"></p></li><li><p>使用許諾契約の内容を確認して、 [同意する] ボタンをクリックします。<br><img src="pre006.png"></p></li><li><p>SCVMM で必須の機能 [Deployment Tools] を残して [インストール] ボタンをクリックします。<br><img src="pre007.png"></p></li><li><p>[閉じる] ボタンをクリックします。<br><img src="pre008.png"></p></li><li><p>次に Windows ADK PE アドオン (adkwinpesetup.exe) を選択して、右クリック メニューの [管理者として実行] をクリックします。<br><img src="pre009.png"></p></li><li><p>Windows ADK 本体のインストール先がインストール パスにセットされていることを確認して、 [次へ] ボタンをクリックします。<br><img src="pre010.png"></p></li><li><p>Windows キット プライバシーを選択して、 [次へ] ボタンをクリックします。<br><img src="pre011.png"></p></li><li><p>使用許諾契約の内容を確認して、 [同意する] ボタンをクリックします。<br><img src="pre012.png"></p></li><li><p>Windows ADK 本体でインストールした [Deployment Tools] にチェックが入っていることを確認して [インストール] ボタンをクリックします。<br><img src="pre013.png"></p></li><li><p>[閉じる] ボタンをクリックします。<br><img src="pre014.png"></p></li></ol><p><b><strong>注意</strong></b><br><img src="pre016.png"><br>新しい Windows ADK ではフォルダー構成が変更されているため、以下のコピー元フォルダー内の全ファイルをコピー先フォルダー内にコピーしてください。(※ 移動ではなくコピーしてください。)<br>　コピー元：C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\WSIM\amd64<br>　コピー先：C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\WSIM<br><img src="pre015.png"></p><h2 id="2-SCVMM-2022-のインストール-モジュールを準備"><a href="#2-SCVMM-2022-のインストール-モジュールを準備" class="headerlink" title="2. SCVMM 2022 のインストール モジュールを準備"></a>2. SCVMM 2022 のインストール モジュールを準備</h2><ol><li><p>Microsoft Evaluation Center の <a href="https://www.microsoft.com/ja-JP/evalcenter/download-system-center-2022">System Center 2022 | Microsoft Evaluation Center</a> からインストール ファイル [SCVMM_2022.exe] をダウンロードします。<br><img src="026.png"></p></li><li><p>ダウンロードしたファイルを SCVMM をインストールする Windows Server 内にコピーします。<br><img src="027.png"></p></li></ol><h2 id="3-インストール-ファイルを解凍する"><a href="#3-インストール-ファイルを解凍する" class="headerlink" title="3. インストール ファイルを解凍する"></a>3. インストール ファイルを解凍する</h2><ol><li><p>SCVMM をインストールする Windows Server にドメイン管理者でサインインします。</p></li><li><p>SCVMM 2022 のインストーラーを選択して、右クリック メニューの [管理者として実行] をクリックします。<br><img src="028.png"></p></li><li><p>インストール ファイル解凍ウィザードが開きますので、[Next] ボタンをクリックします。<br><img src="029.png"></p></li><li><p>ライセンス条項を確認して、 [Next] ボタンをクリックします。<br><img src="030.png"></p></li><li><p>インストール ファイルの解凍先を確認して、 [Next] ボタンをクリックします。<br><img src="031.png"></p></li><li><p>[Extract] ボタンをクリックして解凍を実行します。<br><img src="032.png"></p></li><li><p>[Finish] ボタンをクリックして、ウィザードを閉じます。<br><img src="033.png"><br>[C:\System Center Virtual Machine Manager] フォルダ配下にインストール用ファイルが展開されていることが確認できます。<br><img src="034.png"></p></li></ol><h2 id="4-SCVMM-管理サーバーと-SCVMM-コンソールのインストール"><a href="#4-SCVMM-管理サーバーと-SCVMM-コンソールのインストール" class="headerlink" title="4. SCVMM 管理サーバーと SCVMM コンソールのインストール"></a>4. SCVMM 管理サーバーと SCVMM コンソールのインストール</h2><ol><li><p>SCVMM をインストールする Windows Server にドメイン管理者でサインインします。</p></li><li><p>[C:\System Center Virtual Machine Manager] フォルダ配下の [Setup.exe] を選択して、右クリック メニューの [管理者として実行] をクリックします。<br><img src="035.png"></p></li><li><p>インストール ウィザードが起動するので、[インストール] をクリックします。<br>※ 「再起動が必要です」と表示されている場合は、一度、Windows を再起動してください。ただし、再起動直後でも表示される場合がありますので、その場合はこのまま進めてください。<br><img src="036.png"></p></li><li><p>インストールする機能の選択画面で [VMM 管理サーバー] にチェックを入れて、[次へ] ボタンをクリックして進みます。<br>SCVMM 管理サーバーには SCVMM コンソールが必ずインストールされますので、[VMM 管理サーバー] にチェックを入れると自動的に [VMM コンソール] にもチェックが入ります。<br><img src="037.png"></p></li><li><p>[プロダクトキー] をお持ちの場合は入力します。評価版として構築する場合は空のまま [次へ] ボタンをクリックします。<br>※ 後述の手順で 180日以内にプロダクトキーを適用することで、評価版環境からライセンス適用環境に切り替えることができます。<br><img src="037-2.png"></p></li><li><p>ライセンス条項を確認して、 [次へ] ボタンをクリックします。<br><img src="038.png"></p></li><li><p>[診断と使用状況のデータ] を確認して、 [次へ] ボタンをクリックします。<br><img src="039.png"></p></li><li><p>本記事では [Microsoft Update] は [オフ] を選択して [次へ] ボタンをクリックします。<br><img src="040.png"></p></li><li><p>インストール先フォルダを指定して、[次へ] ボタンをクリックします。<br>標準のインストール先は [C:\Program Files\Microsoft System Center\Virtual Machine Manager] です。<br><img src="041.png"></p></li><li><p>データベースの構成画面で、SCVMM で使用するデータベース [VirtualManagerDB] を作成します。<br>[次の資格情報を使用する] にチェックを入れて、SQL Server インストール時に SQL Server 管理者として登録した AD アカウント情報を入力します。<br><img src="042.png"></p></li><li><p>サービス アカウントおよび分散キー管理の構成画面に AD アカウント情報を入力して、 [次へ] ボタンをクリックします。<br><img src="043.png"></p></li><li><p>ポートの構成画面の設定を確認して、 [次へ] ボタンをクリックします。<br><img src="044.png"></p></li><li><p>ライブラリの構成画面の設定を確認して、 [次へ] ボタンをクリックします。<br>既定の設定では SCVMM 管理サーバーがライブラリ サーバーを兼ねて、SCVMM 管理サーバー内にライブラリ共有が作成されます。<br><img src="045.png"></p></li><li><p>インストールの概要画面を確認して、 [インストール] ボタンをクリックして、インストールを実行します。<br><img src="046.png"></p></li><li><p>完了画面でエラーが出ていないことを確認して、[閉じる] ボタンをクリックしてウィザードを閉じます。<br><img src="047.png"></p></li></ol><p>SCVMM コンソールのログイン画面が立ち上がりますので、接続をクリックすることでログインできます。<br><img src="048.png"></p><h1 id="プロダクトキーの適用"><a href="#プロダクトキーの適用" class="headerlink" title="プロダクトキーの適用"></a>プロダクトキーの適用</h1><p>SCVMM コンソールの左上のメニューバーで [バージョン情報] をクリックして、[アクティブ化] ボタンからプロダクトキーを入力することができます。<br><img src="049.png"></p><hr><p>以上で、SCVMM 管理サーバーを導入して、SCVMM コンソールにログイン可能になりました。<br>このあと、[ファブリック] 画面で管理対象の フェールオーバー クラスターや Hyper-V ホストを追加したり、VMWare vCenter と連係することで、仮想化サーバー基盤の統合管理ができるようになります。<br>これらの手順についても、今後ブログで紹介したいと考えております。</p><p><strong>更新プログラム のロールアップ</strong><br>各種設定を進める前に最新の更新プログラムのロールアップを適用してください。<br>ロールアップを適用の際は、サポートブログ <a href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Update_Rollup/">UR (更新プログラム のロールアップ) を適用</a> を参考にしてください。</p><p><a href="#SCVMM-%E5%B0%8E%E5%85%A5%E3%81%AE%E6%B5%81%E3%82%8C">SCVMM 導入の流れ</a> で記載しました通り、インフラ環境や要件によって SCVMM 環境の各コンポーネントの構成や台数が変わります。メンテナンス時の可用性や耐障害性を考慮して、複数台の SCVMM 管理サーバーを導入して高可用性環境を構成することや、データーベースを SQL Server AlwaysOn 可用性グループで構成することも可能です。SCVMM 環境の構成については、要件定義や初期の設計フェーズにおいて検討いただければと存じます。</p><p>本番環境の構築においては多数の考慮事項がございますが、まずは今回の手順を進めていただくことで SCVMM コンソールにログインすることができたと思います。実際に SCVMM コンソールにログインして、SCVMM の画面構成、機能、操作性など検証いただければ幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;/p&gt;
&lt;p&gt;System Center Virtual Machine Manager（以後 SCVMM）は、複数の Windows Server フェールオーバー クラスター環境を統合管理するシステムです。異なるクラスター間で仮想マシンのライブ マイグレーションが可能になるほか、システム全体で参照可能なファイル置き場 (ライブラリ サーバー) の構築、類似の仮想スイッチの設定を簡易的に反映できる設定 (論理スイッチ) などが利用できます。また、VMWare vCenter と連携することで VMWare VM を Hyper-V VM に移行することができます。&lt;br&gt;&lt;br&gt;SCVMM の構成は、IT インフラ環境の規模や運用要件に応じて変わりますが、検証等の目的で簡易的に最短で SCVMM を構築されたいケースがあります。そういったケースに備えて、本記事では、1 台の Windows Server に SCVMM の主コンポーネントの SCVMM 管理サーバーと SCVMM コンソールをインストールして、SCVMM コンソールにサインインできるまでの手順を画面ショット付きで紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="インストール" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM のクラスター間ライブ マイグレーションの動作仕様、および仮想マシン移動時のエラーの対処方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_LiveMigration_and_Errors/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_LiveMigration_and_Errors/</id>
    <published>2024-04-01T08:20:00.000Z</published>
    <updated>2025-12-10T08:31:19.063Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆さんこんにちは、System Center サポートチームの 保科と申します。</p><p>今回は、System Center Virtual Machine Manager (SCVMM) の機能としてご利用いただける、仮想マシンのライブ マイグレーションやエラーへの対処方法についてご説明いたします。</p><!-- more --><h3 id="本ページが対象とする-SCVMM-バージョン"><a href="#本ページが対象とする-SCVMM-バージョン" class="headerlink" title="本ページが対象とする SCVMM バージョン"></a>本ページが対象とする SCVMM バージョン</h3><p>SCVMM 2016<br>SCVMM 2019<br>SCVMM 2022</p><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>SCVMM をご利用いただくメリットとして、多くの方が、クラスター間で仮想マシンを移動することが出来る点を挙げるかと思います。<br>少なくともフェールオーバー クラスター単体だと、SCVMM のように簡単に仮想マシンを移動 / ライブ マイグレーションすることが出来ません。<br>しかし、クラスター間の仮想マシン移動は、実はフェールオーバー クラスターや Hyper-V 単体においても実施いただけることをご存じでしょうか。<br>SCVMM でのクラスター間の仮想マシン移動は、この際必要となる一連の動作を 1 つの操作に纏めて実施しているにすぎません。<br>本日は、この機能がどのように実行されるかについてご紹介いたします。</p><p>また、仮想マシン移動時にエラーが発生した場合において、対処に際して見落としがちな設定等をご紹介いたします。<br>こちらは、今後弊社内にて確認した情報の増加に従って、本ブログの内容をアップデートとする予定です。</p><h3 id="SCVMM-におけるクラスター間の仮想マシン移動やライブ-マイグレーションの動作仕様"><a href="#SCVMM-におけるクラスター間の仮想マシン移動やライブ-マイグレーションの動作仕様" class="headerlink" title="SCVMM におけるクラスター間の仮想マシン移動やライブ マイグレーションの動作仕様"></a>SCVMM におけるクラスター間の仮想マシン移動やライブ マイグレーションの動作仕様</h3><p>早速ですが、SCVMM において、仮想マシンはどうやってクラスター間で移動しているのか？<br>この動作の流れをご紹介いたします。</p><ol><li>フェールオーバー クラスターに登録された、移動対象の仮想マシンの役割の削除</li><li>移行先として指定された Hyper-V ホストに、移動対象の仮想マシンを移動、もしくはライブ マイグレーション</li><li>仮想マシン移動先の Hyper-V ホストが所属するクラスターに、移動された仮想マシンの役割を登録</li></ol><p>このような流れで、内部上処理が行われています。<br>フェールオーバー クラスター上で動作する仮想マシンは、クラスターの役割を登録するという形で、高可用性構成を行うことが可能です。<br>クラスター上に役割が登録された仮想マシンは、SCVMM 外においては、クラスター内のノード間でしか仮想マシンを移動することが出来ません。<br>そのため、SCVMM 外でクラスター間の仮想マシン移動を実施する場合、仮想マシンの役割をクラスターから一度削除する必要があります。<br>これを実施することで初めて別のクラスター内ノードに仮想マシンを移動することができます。<br>最後に仮想マシン移行先の Hyper-V ホストが所属するクラスターに、移動された仮想マシンの役割を登録することで、そのクラスター内においても高可用性構成を実現いただけます。<br>なお、仮想マシンの電源がオンの状態で移動操作を実施すると、電源がオンの状態で移動 (ライブ マイグレーション) が行われます。<br>こちらの動作のしくみや、Hyper-V マネージャーを使用した手順は、下記の弊社公開情報に記載されております。<br><a href="https://learn.microsoft.com/ja-jp/windows-server/virtualization/hyper-v/manage/use-live-migration-without-failover-clustering-to-move-a-virtual-machine">フェールオーバー クラスタ リングのないライブ マイグレーションを使用して仮想マシンを移動するには | Microsoft Learn</a></p><p>SCVMM を使わない場合、上記の流れを手動で実施することで、クラスター間での仮想マシン移動が実現できます。<br>SCVMM は、この流れを 1 つの操作に纏めることで、ユーザー負担の軽減が実現できます。<br>逆に言えば、万が一 SCVMM をご利用いただけなくなった状況において、クラスター間の仮想マシン移動の実施が必要となった場合、上記手順を手動で実施いただくことで、SCVMM で実施するクラスター間仮想マシン移動と同じ操作が実現できます。</p><h3 id="仮想マシンの移動に失敗するシナリオ"><a href="#仮想マシンの移動に失敗するシナリオ" class="headerlink" title="仮想マシンの移動に失敗するシナリオ"></a>仮想マシンの移動に失敗するシナリオ</h3><p>こちらは、弊社で情報が確認でき次第、随時内容をアップデートする予定です。</p><h4 id="仮想マシン移動失敗シナリオその-1-Hyper-V-ホストの-Credential-Guard-が有効になっている"><a href="#仮想マシン移動失敗シナリオその-1-Hyper-V-ホストの-Credential-Guard-が有効になっている" class="headerlink" title="仮想マシン移動失敗シナリオその 1: Hyper-V ホストの Credential Guard が有効になっている"></a>仮想マシン移動失敗シナリオその 1: Hyper-V ホストの Credential Guard が有効になっている</h4><p>Windows OS には Credential Guard という機能が存在します。<br>こちらの詳細は、下記の弊社公開情報に記載されております。<br><a href="https://learn.microsoft.com/ja-jp/windows/security/identity-protection/credential-guard/how-it-works">Credential Guard のしくみ - Windows Security | Microsoft Learn</a><br>お客様の環境によってはこちらの機能が有効化されている可能性がありますが、仮想マシン移動時においては問題となる場合がございます。<br>その理由として、この機能が有効化されていると、仮想マシン移動時に使用される認証方式の 1 つである CredSSP が利用できなくなるように制限がかかるためです。<br>Kerberos 認証に対しては制限がかからないため、こちらの設定をご利用のお客様においては、以下のいずれかの実施が必要となります。</p><ul><li>Credential Guard を無効化する。</li><li>仮想マシン移動時の認証方式を CredSSP から Kerberos に変更する。</li></ul><p>Credential Guard の有効化状況は、下記弊社公開情報の “Credential Guard が有効になっているかどうかを確認する” 項以下に記載された手順から確認いただけます。<br><a href="https://learn.microsoft.com/ja-jp/windows/security/identity-protection/credential-guard/configure?tabs=intune">Credential Guard の構成 - Windows Security | Microsoft Learn</a><br>まずはこちらの手順で、Credential Guard が有効化されているかを確認いただく必要がございます。</p><p>お客様によっては、Credential Guard は、目的があって有効化されている状況が多いかと思います。<br>その場合は無効化が難しいと思うので、仮想マシン移動のシナリオがどうしても必要という状況であれば、認証方式を Kerberos に切り替える以外に対処方法はございません。<br>幸いこの操作は SCVMM 側において簡単に実施いただけますので、手順をご紹介いたします。</p><ol><li>SCVMM サーバーに管理者権限でログインし、SCVMM コンソールを開きます。</li><li>SCVMM コンソール画面左下ペインの [ファブリック] をクリックします。</li><li>画面左ペインの [サーバー] -&gt; [すべてのホスト] をクリックします。</li><li>ライブマイグレーション移行元、および移行先のホストを右クリックし、[プロパティ] を開きます。<br>(クラスター間で仮想マシンのライブマイグレーションを実施される場合、各種クラスターに配置されたノード全台に対して設定を実施いただくことを推奨いたします。)</li><li>表示されたプロパティ ウィンドウ左の [移行の設定] をクリックします。</li><li>[認証プロトコル] 項内の “Kerberos を使用する” チェックを入力し、[OK] をクリックして設定を保存します。</li></ol><p>手順は以上となります。<br>同一ドメイン環境の仮想マシン移動であれば Kerberos 認証をご利用いただけますので、Kerberos 認証をご利用いただく設定が一般的となります。</p><h4 id="仮想マシン移動失敗シナリオその-2-構成バージョンのサポート"><a href="#仮想マシン移動失敗シナリオその-2-構成バージョンのサポート" class="headerlink" title="仮想マシン移動失敗シナリオその 2: 構成バージョンのサポート"></a>仮想マシン移動失敗シナリオその 2: 構成バージョンのサポート</h4><p>Hyper-V 上に作成された仮想マシンは、いずれも例外なく構成バージョンという内容が構成されます。<br>この構成バージョンは OS 毎に既定で仮想マシン作成時に展開されるバージョンが決められております。<br>既定で展開される構成バージョンとは異なるバージョンで仮想マシンを展開いただく場合、コマンド経由で仮想マシンを作成いただく必要がございます。</p><p>今回の問題としては、仮想マシンの構成バージョンによっては、その構成バージョンが移行先ではサポートされていないバージョンに該当し、結果移行が失敗する可能性があるということです。<br>例えば以下の Hyper-V サーバーの構成を考えます。</p><ul><li>Windows Server 2016:<br>サポートされる最も新しい構成バージョンは 8.0 で、仮想マシン展開時の既定のバージョンもこちらになります。<br>構成バージョン 9.0 はサポートされません。</li><li>Windows Server 2019:<br>サポートされる最も新しい構成バージョンは 9.0 で、仮想マシン展開時の既定のバージョンもこちらになります。<br>構成バージョン 8.0 はサポートされます。</li></ul><p>この際、いずれも既定の構成バージョンの設定で、Windows Server 2019 Hyper-V 上で仮想マシンを作成したとします。<br>この際展開される仮想マシンは構成バージョンが 9.0 となります。<br>この仮想マシンを Windows Server 2016 Hyper-V に移行しようとすると、移行先がサポートしない構成バージョンであるとして、移行に失敗します。<br>例えば SCVMM コンソール上でこの移行操作を実施すると、以下エラーが発生して操作が失敗します。<br><img src="/blog/SCVMM/SCVMM_LiveMigration_and_Errors/SCVMM_VMVersion_MigrationError.png"></p><p>逆のパターンとして、Windows Server 2016 で作成された仮想マシンを Windows Server 2019 に移行するシナリオを考えます。<br>Windows Server 2016 Hyper-V で作成される仮想マシンは、既定で構成バージョンが 8.0 となります。<br>Windows Server 2019 Hyper-V では構成バージョン 8.0 の仮想マシンはサポートされております。<br>そのため、構成バージョンが 8.0 で動作している Windows Server 2016 Hyper-V の仮想マシンは、問題なく Windows Server 2019 Hyper-V へ移行できます。</p><p>構成バージョンのアップグレードは可能ですが、ダウングレードは実施出来ません。<br>そのため、構成バージョン 9.0 の仮想マシンを Windows Server 2016 Hyper-V に移行することは出来ません。<br>移行の際は、構成バージョンについても十分にご留意いただいた上で操作を実施いただく必要があるとご認識をいただけると幸いです。</p><p>仮想マシンの構成バージョンに関する情報は、以下の弊社公開情報に詳細が纏められております。<br><a href="https://learn.microsoft.com/ja-jp/windows-server/virtualization/hyper-v/deploy/upgrade-virtual-machine-version-in-hyper-v-on-windows-or-windows-server">Hyper-V の仮想マシンのバージョンをアップグレードする (Windows または Windows Server) | Microsoft Learn</a><br>OS による構成バージョンのサポートや、各構成バージョンで利用可能な機能といった、大変有用な情報が纏められております。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆さんこんにちは、System Center サポートチームの 保科と申します。&lt;/p&gt;
&lt;p&gt;今回は、System Center Virtual Machine Manager (SCVMM) の機能としてご利用いただける、</summary>
      
    
    
    
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
    <category term="Migration" scheme="https://jpsystemcenter.github.io/blog/tags/Migration/"/>
    
  </entry>
  
  <entry>
    <title>SCOM エージェント サーバーの CET (Control-flow Enforcement Technology) 無効化について</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_CET_Disabled/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_CET_Disabled/</id>
    <published>2024-03-26T08:00:00.000Z</published>
    <updated>2025-12-10T08:31:18.961Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>今回は、ハードウェア ベースのセキュリティ機能の CET (Control-flow Enforcement Technology) が有効な場合、SCOM エージェントのプロセスが短時間でクラッシュする既知の問題の対処方法について説明します。<br><br></p><span id="more"></span><h2 id="CET-Control-flow-Enforcement-Technology-が有効な場合の-SCOM-エージェントの既知の問題について"><a href="#CET-Control-flow-Enforcement-Technology-が有効な場合の-SCOM-エージェントの既知の問題について" class="headerlink" title="CET (Control-flow Enforcement Technology) が有効な場合の SCOM エージェントの既知の問題について"></a>CET (Control-flow Enforcement Technology) が有効な場合の SCOM エージェントの既知の問題について</h2><p>CET (Control-flow Enforcement Technology) をサポートするプロセッサを搭載したハードウェアにインストールした Windows は、<b>ハードウェア強制されたスタック保護機能 (Hardware-enforced Stack Protection) </b>を有効にすることができます。<br>※ 注意：ハードウェア強制されたスタック保護機能は、新しい OS ビルドで有効な機能になります。<br>　 Windows 10 では、20H1 (19041) and 20H2 (19042) 以降の OS ビルドでサポートされるようになっています。<br>　 ご参考：<a href="https://support.microsoft.com/ja-jp/help/4586853/windows-10-update-kb4586853">2020 年 11 月 30 日 — KB4586853 (OS ビルド 19041.662 および 19042.662)</a><br>　 <img src="001.png" width="80%"></p><p>ハードウェア強制されたスタック保護機能 (以降、本機能) は新しいセキュリティ機能であり、本記事の公開日時点の SCOM エージェントは、<b>いずれのバージョンも本機能を使用しません。</b><br>そのため、SCOM エージェント用には本機能は無効で良いですが、SCOM 2022 UR2 までは、明示的に本機能を無効にする設定が SCOM エージェントに組み込まれていません。本機能をサポートする環境に SCOM 2022 UR2 より前の SCOM エージェントをインストールした場合、SCOM エージェントは本機能が有効なプロセスとして起動します。</p><p>■ 参考：SCOM エージェントのプロセス (※ SCOM エージェントのプロセスは HealthService.exe ) が<br>　　　　 ハードウェア強制されたスタック保護機能を有効な状態で起動した際の画面ショット <img src="002.png"></p><p><b>SCOM エージェントが、ハードウェア強制されたスタック保護機能を有効な状態で起動すると、短時間でプロセスがクラッシュして、該当サーバーが SCOM で管理できない状態になる既知の事例があります。</b></p><hr><h2 id="対処方法-①-更新プログラムのロールアップを適用"><a href="#対処方法-①-更新プログラムのロールアップを適用" class="headerlink" title="対処方法 ① 更新プログラムのロールアップを適用"></a>対処方法 ① 更新プログラムのロールアップを適用</h2><p>SCOM 2022 をご利用の場合、<b>更新プログラムロールアップ 2</b>にて修正されていますので、更新プログラムロールアップ 2を適用してください。更新プログラムロールアップ 2 を適用することで、ハードウェア強制されたスタック保護機能が無効化された SCOM エージェントにアップデートすることができます。</p><p>・<a href="https://support.microsoft.com/kb/5031649">SCOM 2022 更新プログラムのロールアップ 2 のダウンロードと適用手順</a>　<img src="003.png" width="80%"></p><p>※ 更新プログラムのロールアップの適用手順につきましては、以下のサポートブログもご参照ください。<br>　<a href="../SCOM_Update_Rollup/">SCOM の 更新プログラムのロールアップの適用手順</a></p><h2 id="対処方法-②-PowerShell-コマンドによる対処"><a href="#対処方法-②-PowerShell-コマンドによる対処" class="headerlink" title="対処方法 ② PowerShell コマンドによる対処"></a>対処方法 ② PowerShell コマンドによる対処</h2><p>すぐには更新プログラムのロールアップを適用できない場合や SCOM 2019 をご利用の場合、PowerShell コマンドにて SCOM エージェント プロセスのハードウェア強制されたスタック保護機能を無効化することで回避できます。<br>実行手順は以下の通りです。</p><ol><li>SCOM エージェントをインストールしたサーバーにログインします。</li><li>PowerShell を管理者で起動します。</li><li>以下のコマンドで SCOM エージェント プロセスのハードウェア強制されたスタック保護機能を無効化します。<br><code>Set-ProcessMitigation -Name MonitoringHost.exe -Disable UserShadowStack</code></li><li>以下のコマンドで SCOM エージェント プロセス (HealthService.exe) を再起動します。<br><code>Restart-Service -Name HealthService</code></li></ol><hr><h2 id="ご参考-英語サイト"><a href="#ご参考-英語サイト" class="headerlink" title="ご参考 (英語サイト)"></a>ご参考 (英語サイト)</h2><p>ハードウェア強制されたスタック保護機能について<br>・<a href="https://techcommunity.microsoft.com/t5/windows-os-platform-blog/understanding-hardware-enforced-stack-protection/ba-p/1247815">Understanding Hardware-enforced Stack Protection</a><br>・<a href="https://techcommunity.microsoft.com/t5/windows-os-platform-blog/developer-guidance-for-hardware-enforced-stack-protection/ba-p/2163340">Developer Guidance for Hardware-enforced Stack Protection</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;今回は、ハードウェア ベースのセキュリティ機能の CET (Control-flow Enforcement Technology) が有効な場合、SCOM エージェントのプロセスが短時間でクラッシュする既知の問題の対処方法について説明します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Trouble" scheme="https://jpsystemcenter.github.io/blog/tags/Trouble/"/>
    
  </entry>
  
  <entry>
    <title>VM の強制削除および再登録</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_reregisterVM/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_reregisterVM/</id>
    <published>2024-03-24T13:00:00.000Z</published>
    <updated>2025-12-10T08:31:19.078Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Virtual Machine Manager （以後、SCVMM）で管理している VM を強制削除して、再登録する方法をご紹介いたします。</p><h2 id="SCVMM-の-DB-で保持している情報が不整合になってしまうシナリオ"><a href="#SCVMM-の-DB-で保持している情報が不整合になってしまうシナリオ" class="headerlink" title="SCVMM の DB で保持している情報が不整合になってしまうシナリオ"></a>SCVMM の DB で保持している情報が不整合になってしまうシナリオ</h2><p>下図は SCVMM の構成イメージとなりますが、SCVMM では管理している VM や Hyper-V ホストの情報を DB （SQL Server）で保持しております。<br><img src="/blog/SCVMM/SCVMM_reregisterVM/0101.png"></p><p>発生シナリオは幾つかございますが、例えば  SCVMM で管理している VM を WSFC マネージャーで別ホストにマイグレーションした場合やHyper-V マネージャーから VM を削除した場合、SCVMM がその VM を見失ってしまい SCVMM のコンソールで見た場合に VM のステータスが <code> ”不足” （英語表記： missing）</code> となってしまう場合があります<br><img src="/blog/SCVMM/SCVMM_reregisterVM/0102.png"></p><p>参考：<a href="https://learn.microsoft.com/ja-jp/troubleshoot/system-center/vmm/remove-missing-virtual-machines">不足している状態の仮想マシンを削除する</a></p><p>また上記公開情報にも記載しているように ステータスが ”不足”になるだけでなく、同じ VM が複数のホスト上にあるように見え、重複して存在しているように見える場合もございます。</p><p>上述したようなシナリオの場合、下記手順で一度 SCVMM の DB から VM や Hyper-V ホストの情報を削除して、再登録することで是正できる場合がありますのでその手順を記載いたします。</p><h2 id="VM-を削除して再登録する手順"><a href="#VM-を削除して再登録する手順" class="headerlink" title="VM を削除して再登録する手順"></a>VM を削除して再登録する手順</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.SCVMM サーバーに SCVMM の管理者ロールに属するユーザーでログインし、Virtual Machine Manager Command Shell を管理者として起動します</span><br><span class="line">2.以下のコマンドレットを実行します。Nameオプションには仮想マシン名、VMHostオプションには仮想マシンを所有する仮想化ホストサーバー名を指定します。</span><br><span class="line">　$VMs = Get-SCVirtualMachine -Name &quot;&lt;仮想マシン名&gt;&quot; -VMHost &quot; &lt;仮想マシンを所有する仮想化ホストサーバー&gt;&quot;</span><br><span class="line">3.以下のコマンドを実行し、今回削除する対象である仮想マシン の情報のみが表示されることを確認します。</span><br><span class="line">　$VMs</span><br><span class="line">4.Remove-SCVirtualMachine コマンドレットを Force オプションと、対象仮想マシンの情報が格納された変数を指定し、実行します。</span><br><span class="line">　Remove-SCVirtualMachine $VMs -Force</span><br><span class="line">　** -Force オプションをつけない場合、仮想マシン自体がファイルごと削除されます。ご注意ください。**</span><br><span class="line">　上記実行後、SCVMM より対象仮想マシンの情報が削除されていることをご確認ください。</span><br><span class="line">5.SCVMM コンソールにてホストに対して [バーチャルマシンの更新] を実行し、削除した仮想マシンを改めて検出します。</span><br></pre></td></tr></table></figure><p>上記シナリオで記載したように 2 つの Hyper-V ホスト上に同じ VM が登録されてしまっている場合は、実態として存在していない Hyper-V ホスト上の VM を削除したいので、<br>その場合 <code>-VMHost</code> で指定するホストは削除したい VM をホストしている Hyper-V ホストを指定ください。</p><p><strong>VM の再登録が不要であれば、手順は 5 は実施いただく必要ございません。</strong></p><p>■コマンド実行時の画面<br><img src="/blog/SCVMM/SCVMM_reregisterVM/0201.png"></p><p><em>作業の影響範囲</em><br>上記コマンドの影響範囲につきまして、上述している通り、 SCVMM が持つデータベース内の情報のみ削除するため、<strong>仮想マシンへの動作影響はありません</strong>。<br>しかしながら、SCVMM が持つ固有の情報（規定では使用されていない項目となります）については削除されます。<br>こちらは Hyper-V ホストでは管理しておらず、SCVMM のみが管理している情報であるためです。<br>固有の情報は以下が該当致します。<br>・仮想マシンのコストセンター (仮想マシンのプロパティ画面の全般タブ)<br>・仮想マシンのタグ (仮想マシンのプロパティ画面の全般タブ<br>・仮想マシンのクラウド (仮想マシンのプロパティ画面の全般タブ<br>・仮想マシンのカスタム プロパティ (仮想マシンのプロパティ画面のカスタム プロパティ タブ)<br>・仮想マシンのセルフサービス クォータポイント (仮想マシンのプロパティ画面の設定タブ)<br>・仮想マシンの所有者 (仮想マシンのプロパティ画面のアクセスタブ)<br>・仮想マシンのセルフサービス所有者、セルフサービスユーザー (仮想マシンのプロパティ画面のアクセスタブ)</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Virtual Machine Manager （以後、SCVMM）で管理している VM を強制削除</summary>
      
    
    
    
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
    <category term="VM の強制削除および再登録" scheme="https://jpsystemcenter.github.io/blog/tags/VM-%E3%81%AE%E5%BC%B7%E5%88%B6%E5%89%8A%E9%99%A4%E3%81%8A%E3%82%88%E3%81%B3%E5%86%8D%E7%99%BB%E9%8C%B2/"/>
    
  </entry>
  
  <entry>
    <title>パフォーマンス データを DB から取得する方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_howto_getPerformanceData_fromDB/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_howto_getPerformanceData_fromDB/</id>
    <published>2024-03-19T13:00:00.000Z</published>
    <updated>2025-12-10T08:31:19.001Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以下、SCOM） に採取されたパフォーマンス カウンターの情報を DB から採取する方法についてご紹介いたします。</p><h2 id="留意事項"><a href="#留意事項" class="headerlink" title="留意事項"></a>留意事項</h2><p>Update Rollup の適用などにより DB のテーブルの型などが変更される可能性がございます。<br>各テーブルの仕様については公開しておりません。</p><h2 id="パフォーマンス-カウンターが採取される仕組み"><a href="#パフォーマンス-カウンターが採取される仕組み" class="headerlink" title="パフォーマンス カウンターが採取される仕組み"></a>パフォーマンス カウンターが採取される仕組み</h2><p>せっかくですので、まず実際に DB からパフォーマンスカウンターを取得するクエリの説明の前に Microsoft Monitoring Agent （以後、MMA と記載します）がパフォーマンスカウンターを採取して、SCOM 管理サーバーに連携する仕組み、流れをご紹介いたします。<br>実際のパフォーマンス カウンターを採取する方法を知りたい方は <a href="#DB-%E3%81%8B%E3%82%89%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E3%82%AF%E3%82%A8%E3%83%AA">DB からパフォーマンス カウンターを取得するクエリ</a>  からご参照ください。</p><h3 id="エージェントと-SCOM-管理サーバーの通信"><a href="#エージェントと-SCOM-管理サーバーの通信" class="headerlink" title="エージェントと SCOM 管理サーバーの通信"></a>エージェントと SCOM 管理サーバーの通信</h3><p>以下ページに記載のとおりですが、MMA は採取した情報（パフォーマンス カウンター情報など）を SCOM 管理サーバーへ TCP 5723 ポート向け送ります<br>下図で “(local and remote)” と記載ございますが、本日の内容は local つまり、MMA がインストールされているマシンの情報を採取する内容とご認識いただければと存じます。<br><a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-planning-agent-deployment?view=sc-om-2022&tabs=Windows#communication-between-agents-and-management-servers">Operations Manager エージェント</a><br><img src="/blog/SCOM/SCOM_howto_getPerformanceData_fromDB/0101.png"></p><p>SCOM 管理サーバーで NW キャプチャを採取すると以下のように確認することが出来ます。</p><table><thead><tr><th>IP アドレス</th><th>通信しているコンピュータ</th></tr></thead><tbody><tr><td>172.16.1.31</td><td>監視対象コンピューター</td></tr><tr><td>172.16.1.41</td><td>SCOM 管理サーバー</td></tr></tbody></table><p><img src="/blog/SCOM/SCOM_howto_getPerformanceData_fromDB/0102.png"></p><h3 id="MMA-の実行プロセスとパフォーマンスカウンターを採取するプロセス"><a href="#MMA-の実行プロセスとパフォーマンスカウンターを採取するプロセス" class="headerlink" title="MMA の実行プロセスとパフォーマンスカウンターを採取するプロセス"></a>MMA の実行プロセスとパフォーマンスカウンターを採取するプロセス</h3><p>監視対象コンピューター （※）にインストールされた MMA は下図でわかるよう Windows のサービスとして登録され、その実行ファイル名は ”HealthService.exe” です。<br><img src="/blog/SCOM/SCOM_howto_getPerformanceData_fromDB/0103.png"></p><p>実際にパフォーマンスカウンターを採取するプロセスは ”HealthService.exe”  から呼び出される ”MonitoringHost.exe” となります。<br>※ SCOM 管理サーバーにも MMA はインストールされております</p><p>MMA がインストールされているマシンには SCOM 管理サーバーから情報を採取するための xml 形式の設定ファイルがダウンロードされます。<br>この xml ファイルの設定（対象パフォーマンスカウンターや実行インターバル、など）に従い ”MonitoringHost.exe” が採取こととなります。</p><p>具体的には xml ファイル内に定義されたスクリプト（その中で WMI クエリなどを実行）に従い採取しております。</p><p>ダウンロードされた xml ファイルは以下パスにて確認いただけます。<br>C:\Program Files\Microsoft Monitoring Agent\Agent\Health Service State\Management Packs</p><h2 id="DB-からパフォーマンス-カウンターを取得するクエリ"><a href="#DB-からパフォーマンス-カウンターを取得するクエリ" class="headerlink" title="DB からパフォーマンス カウンターを取得するクエリ"></a>DB からパフォーマンス カウンターを取得するクエリ</h2><p>ここまでで MMA がパフォーマンス カウンターを採取する仕組みを記載しましたが、SCOM 管理サーバーまで届いたパフォーマンスカウンターは Operations Manager DB に格納されます。<br>Operations Console のパフォーマンス ビューなどで確認できる監視対象のパフォーマンス カウンターはこの DB の情報を取得して、表示させている事となります。</p><p>そのため、Operations Console から取得できないような情報を DB から SQL クエリを実行して採取することが出来ます。</p><p>具体的には下記クエリとなります。</p><p>//クエリ例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">select </span><br><span class="line">R.RuleName,</span><br><span class="line">PCV.ObjectName,</span><br><span class="line">PCV.CounterName,</span><br><span class="line">PCV.InstanceName,</span><br><span class="line">PDAV.SampleValue,</span><br><span class="line">PDAV.TimeAdded,</span><br><span class="line">PDAV.TimeSampled,</span><br><span class="line">BME.FullName,</span><br><span class="line">BME.Path    </span><br><span class="line">from PerformanceDataAllView PDAV with (nolock)</span><br><span class="line">inner join PerformanceCounterView PCV with (nolock) on PDAV.PerformanceSourceInternalId=PCV.PerformanceSourceInternalId</span><br><span class="line">inner join Rules R with (nolock) on PCV.RuleId=R.RuleId</span><br><span class="line">inner join BaseManagedEntity BME with (nolock) on PCV.ManagedEntityId=BME.BaseManagedEntityId</span><br><span class="line"></span><br><span class="line">-- 抽出条件はお客様の条件に従い適宜ご変更ください --</span><br><span class="line">where BME.path like &#x27;%サーバー名%&#x27;</span><br><span class="line">and CounterName like &#x27;%カウンター名%&#x27;</span><br><span class="line">and  R.rulename like &#x27;%rule ID%&#x27;</span><br><span class="line">order by PDAV.TimeAdded desc</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>例えば上記クエリの  ”サーバー名” と “カウンター名”に実際の監視対象コンピューターと確認したいパフォーマンス カウンターを入力して実行すると下図のように取得することが可能となります。</p><p>// SSMS でのクエリ実行イメージ<br><img src="/blog/SCOM/SCOM_howto_getPerformanceData_fromDB/0201.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以下、SCOM） に採取されたパフォーマンス カウンターの情報</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="howto" scheme="https://jpsystemcenter.github.io/blog/tags/howto/"/>
    
    <category term="パフォーマンス カウンター" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC/"/>
    
  </entry>
  
  <entry>
    <title>パフォーマンス ビューに表示されているデータを取得する方法</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_howto_getData_performanceView/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_howto_getData_performanceView/</id>
    <published>2024-03-17T09:00:00.000Z</published>
    <updated>2025-12-10T08:31:18.996Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以下、SCOM） のパフォーマンス ビューに表示されているデータを取得する方法をご紹介いたします。</p><p>SCOM では採取したパフォーマンス カウンターを下図のようにグラフ表示するパフォーマンス ビュー機能がございます。<br>このグラフの基データを一覧情報として取得したい旨のお問い合わせがございますので、その具体的な方法を紹介します。</p><p>//パフォーマンス ビューの画面<br><img src="/blog/SCOM/SCOM_howto_getData_performanceView/0101.png"></p><p>パフォーマンス ビュー画面の右ペインにある [データをクリップボードにコピー]を押下すると、下図のようにメモ帳などテキストエディタにコピーしたデータを張り付けすることが出来ます。張り付けたデータを xml データとして保存してください。<br><img src="/blog/SCOM/SCOM_howto_getData_performanceView/0102.png"></p><p>続けて excel ファイルを開きます。<br>データ タブにある ボタン[データの取得] - [ファイルから] - [XML から] と選択し、開かれるファイル選択画面で上で保存した xml ファイルを選択します。<br><img src="/blog/SCOM/SCOM_howto_getData_performanceView/0103.png"></p><p>ファイルを選択すると下図のように [ナビゲーター] 画面で取り込み後のイメージ画面が出てきますので、[読み込み] ボタンを教えてください。<br><img src="/blog/SCOM/SCOM_howto_getData_performanceView/0104.png"></p><p>上記作業の結果、下図のように X 軸として日時、Y 軸としてパフォーマンス カウンターを値を一覧情報で確認いただけます。<br><img src="/blog/SCOM/SCOM_howto_getData_performanceView/0105.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以下、SCOM） のパフォーマンス ビューに表示されているデー</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="howto" scheme="https://jpsystemcenter.github.io/blog/tags/howto/"/>
    
    <category term="パフォーマンス ビュー" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%83%93%E3%83%A5%E3%83%BC/"/>
    
  </entry>
  
  <entry>
    <title>VM テンプレートから仮想マシン (Linux 系) を作成が完了しない</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_error_makeVMfromtemplete/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_error_makeVMfromtemplete/</id>
    <published>2024-03-14T13:00:00.000Z</published>
    <updated>2025-12-10T08:31:19.076Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Virtual Machine Manager で Linux VM をテンプレートから作成する際に下図のようにタスク進捗率が 99 % で止まり作成が完了しない問題についてご紹介します。</p><h2 id="事象"><a href="#事象" class="headerlink" title="事象"></a>事象</h2><p>ライブラリサーバーに配置している RHEL もしくは CentOS  の VM テンプレート（vhdx）ファイルを用いて、VM を作成しようとした場合に下図のようにタスク進捗率が 99 % で止まってしまい、60 分ほどでタイムアウトし作成が失敗する事例があります。<br><img src="/blog/SCVMM/SCVMM_error_makeVMfromtemplete/0101.png"></p><p>この問題の際に以下特徴がある場合は後述する回避策で改善できる可能性がございます。<br>　・ステップ 1.7 ”バーチャル マシンのカスタマイズ” の進捗率が 99 %で同様に止まっており、他ステップは完了している<br>　・Hyper-V コンソールから確認した際に作成を試みている VM が存在し、OS にログインできる</p><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>上記事象の場合、scvmmguestagent を起動できておらず、scvmmguestagent.bin が、SCVMMで仮想マシンを作成する際に設定した OS のプロファイル情報を反映させることができず処理が止まっている原因と考えられます。</p><h2 id="改善方法"><a href="#改善方法" class="headerlink" title="改善方法"></a>改善方法</h2><p>まず OS にログインして以下コマンドを実行してみてください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/microsoft/scvmmguestagent/bin/scvmmguestagent.bin</span><br></pre></td></tr></table></figure><p>こちらのコマンドによりタスクが完了した場合は上述した原因のため発生した事象となります。</p><p>この場合scvmmguestagent を起動に必要な言語パックインストールが入っていないことが要因と考えられます。<br>改善策として VM テンプレート作成元となった OS 上で、SCVMM ゲストエージェントインストール後に下記コマンドを実行し、再度テンプレートを作成して事象が改善するか確認いただけますと幸いです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install langpacks-en glibc-all-langpacks -y</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Virtual Machine Manager で Linux VM をテンプレートから作成する際に</summary>
      
    
    
    
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
    <category term="VM templete" scheme="https://jpsystemcenter.github.io/blog/tags/VM-templete/"/>
    
  </entry>
  
  <entry>
    <title>MonitoringHost.exe が仮想メモリを異常に消費する</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_highmemory_MonitoringHost/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_highmemory_MonitoringHost/</id>
    <published>2024-03-13T12:00:00.000Z</published>
    <updated>2025-12-10T08:31:18.995Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以下、SCOM） が監視のために利用するプロセスである MonitoringHost.exe が消費する仮想メモリ量が増大する話についてお伝えします。</p><h2 id="仮想メモリを異常に消費"><a href="#仮想メモリを異常に消費" class="headerlink" title="仮想メモリを異常に消費"></a>仮想メモリを異常に消費</h2><h3 id="事象"><a href="#事象" class="headerlink" title="事象"></a>事象</h3><p>突然、SCOM の管理サーバーやエージェントが導入されているマシンにてプロセスが異常にメモリを消費し、マシンがダウンするといった事象が発生することがあります。<br>その場合、イベント ログ [System] に以下が記録されることを確認しています。</p><h4 id="イベントの例-イベント-ID：2004"><a href="#イベントの例-イベント-ID：2004" class="headerlink" title="イベントの例 (イベント ID：2004)"></a>イベントの例 (イベント ID：2004)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ログの名前：System</span><br><span class="line">日時：yyyy/mm/dd hh:mm:ss </span><br><span class="line">ソース：Resource-Exhaustion-Detector</span><br><span class="line">レベル：警告</span><br><span class="line">タスクのカテゴリ：リソース消費診断イベント</span><br><span class="line">イベント ID：2004</span><br><span class="line">ユーザー：NT AUTHORITY\SYSTEM</span><br><span class="line">コンピュータ：hyperv01.contoso.com</span><br><span class="line">説明：Windows は仮想メモリの不足状態を診断しました。仮想メモリを多く消費したのは次のプログラムです:</span><br><span class="line">*MonitoringHost.exe (4904) は 3003106107520 バイトを消費し* 、WmiPrvSE.exe (2122) は 2003314000 バイトを消費し、svchost.exe (1134) は 192024218 バイトを消費しました。</span><br></pre></td></tr></table></figure><p>上記のイベントではプロセス MonitoringHost.exe が 約280GB （※）の仮想メモリを使用していることを示しています。<br>このイベントが記録されるタイミングでまた、SCOM に関するイベント ログ [Operations Manager] には同時にイベント ID：26008 がかなりの頻度で記録されていることも確認しています。<br>過去お問い合わせを頂いたお客様では、具体的な頻度の度合いは数秒で2000～3000件というかなりの頻度もございました。</p><p>※ 3003106107520 B / 1024 (KB 換算) / 1024 （MB 換算）/ 1024  （GB 換算） ≒ 280 GB</p><h4 id="イベントの例-イベントID：26008"><a href="#イベントの例-イベントID：26008" class="headerlink" title="イベントの例 (イベントID：26008)"></a>イベントの例 (イベントID：26008)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ソース：Health Service Modules</span><br><span class="line">日時：yyyy/mm/dd hh:mm:ss</span><br><span class="line">イベントID：26008</span><br><span class="line">Level：エラー</span><br><span class="line">コンピュータ名：hyperv01.contoso.com</span><br><span class="line">説明：コンピューター &#x27;hyperv01.contoso.com&#x27; の Operations Manager イベント ログは壊れた状態のままです。イベント ログ プロバイダーが、問題があると思われるレコードをスキップすることによって回復を試みます。</span><br><span class="line">最大 2 つのレコードがスキップされる可能性があります。</span><br><span class="line">1 つ以上のワークフローがこの影響を受けました。</span><br><span class="line"></span><br><span class="line">ワークフロー名: Microsoft.SystemCenter.Apm.Infrastructure.Monitoring.ApmAgent.APMConfigurationConflict.Monitor</span><br><span class="line">      インスタンス名: hyperv01.contoso.com</span><br><span class="line">      インスタンス ID: &#123;8E315A0A-DFFD-8341-6461-A4A561E0F2D&#125;</span><br><span class="line">      管理グループ: SCOM</span><br></pre></td></tr></table></figure><p>上記のイベントが記録されている状態はプロセス MonitoringHost.exe が仮想メモリを異常に消費してしまう状況が発生しており、OS 上の仮想メモリを枯渇させてしまい再起動するしか対処方法がありません。<br>併せて、この問題が発生致しますと Application のイベント ログにイベント ID：1530 が記録されます。</p><h4 id="イベントの例-イベントID：1530"><a href="#イベントの例-イベントID：1530" class="headerlink" title="イベントの例 (イベントID：1530)"></a>イベントの例 (イベントID：1530)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ソース：User Profile Service</span><br><span class="line">日時：yyyy/mm/dd hh:mm:ss</span><br><span class="line">イベントID：1530</span><br><span class="line">ユーザー：NT AUTHORITY\SYSTEM</span><br><span class="line">Level：警告</span><br><span class="line">コンピュータ名：hyperv01.contoso.com</span><br><span class="line">説明：レジストリ ファイルは他のアプリケーションまたはサービスで使用されています。ファイルはすぐにアンロードされます。レジストリ ファイルを保持しているアプリケーションまたはサービスはこれ以降正しく機能しない可能性があります</span><br><span class="line"></span><br><span class="line">詳細 -</span><br><span class="line">32 user registry handles leaked from \Registry\User\S-1-5-21-1614895754-1085031214-725345543-289007:</span><br><span class="line">Process 4904 (\Device\HarddiskVolume1\Program Files\Microsoft System Center 2016\Operations Manager\Server\MonitoringHost.exe) has opened key \REGISTRY\USER\S-1-5-21-1614895754-1085031214-725345543-289007</span><br><span class="line">&lt;・・・以下、同様の内容が記録されるため割愛しています・・・&gt;</span><br></pre></td></tr></table></figure><p>こちらのイベント ID の説明の中で MonitoringHost.exe  のプロセスの記載があれば本事象に該当いたします。<br>そのため、こちらのイベント ログが記録されているかをまずご確認いただく方法も有効です。</p><h3 id="要因"><a href="#要因" class="headerlink" title="要因"></a>要因</h3><p>この事象の問題や要因を説明します。<br>こちらの問題は SCOM の管理サーバーやエージェントが利用するアクション アカウントが関連します。</p><p>SCOM は管理サーバーやエージェント上で監視を行う際に実行される処理はこのアクション アカウントによって実行される仕組みを取っておりますが、このアクション アカウントと同じアカウントを利用して OS 上で操作を行いログオフを実施すると今回の事象が発生することを確認しています。<br>これは OS 上でアクション アカウントと同じアカウントの操作によってログオフが実施されると User Profile がアンロードされるために発生します。</p><p>アクション アカウントでの監視はユーザーによるログオフ操作が実施されたあとも継続するため、User Profile をロードしようとします。<br>しかし、すでにログオフ操作のためアンロードされてしまっているためアクション アカウントは User Profile のロードを正常に行うことができず、エラーとなります。<br>このエラーが繰り返し発生し、エラー時に増加するヒープ領域が仮想メモリの領域を圧迫します。<br>仮想メモリの領域が圧迫されますと、上記のイベント ID：2004 が記録されます。</p><p>発生までの流れは以下です。</p><p>～～発生のプロセス～～</p><ol><li>SCOM 管理サーバーやエージェントで利用するアカウントがアンロードされた User Profile に含まれていたレジストリ キーにアクセスしようとする。</li><li>アクセスが失敗し、エラーに関連する情報がヒープ領域に格納される。</li><li>SCOM 管理サーバーやエージェントで利用するアカウントが繰り返しレジストリ キーへのアクセスを実行し、エラーの情報がヒープに格納され続ける。</li><li>ヒープ領域が肥大化する。</li><li>仮想メモリが枯渇する。</li></ol><p>この挙動は SCOM 含めた COM+ アプリケーションの実装では想定されている動作でもありますため、お客様環境にてこういった状況とならないよう事前にご利用いただくアカウントについてご確認いただく必要がございます。</p><p>この事象を回避いただくための対処方法は至って単純です。<br>それは SCOM の管理サーバーやアクション アカウントに使用しているアカウントと OS 上へとログオン/ログオフするアカウントを異なるものに変更するだけです。</p><p>SCOM の場合ですとアクション アカウントに ローカル システム アカウントを利用することが可能ですので、アカウントを基本的にローカル システム アカウントへと変更していただく、という運用が一番シンプルです。</p><p>しかし、ローカル システム アカウントの場合ですと権限が Administrator と同等ですので、SCOM のプロセスが悪用されるリスクを懸念されるお客様もいらっしゃるかと存じます。<br>それを考慮した場合、ドメインのアカウントを指定するほうがリスクは小さくなります。<br>どのアカウントを利用するかはお客様の運用ポリシーに依存する部分でもありますので検討の上、アカウントを決定してください。</p><p>SCOM のアクション アカウントにご利用いただくための権限については以下に公開情報があるのでご覧ください。</p><p>• 公開情報<br><a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-security-accounts?view=sc-om-2022">サービス、ユーザー、およびセキュリティ アカウント</a><br>※SCOM 2022 の情報ですが、SCOM 2019、SCOM 2016 でも同様です。</p><p>今の環境でこの Blog で案内している事象が発生する可能性があるか、というのは以下の手順で SCOM のアクション アカウントを確認してください。<br>以下の手順ではアクション アカウントに指定されているアカウントを確認していただき、そのアカウントがログオン/ログオフを実施するアカウントであるか確認できます。</p><p>&lt;&lt;確認手順&gt;&gt;<br>以下の手順にてエージェントのアクション アカウントをご確認が可能です。</p><ol><li>SCOM 管理コンソールを起動し、[管理] ペインを開きます。</li><li>左ペインの [プロファイル] をクリックします。</li><li>一覧から [既定のアクション アカウント] をダブルクリックします。</li><li>ウィザード画面上で、[次へ] をクリックします。</li><li>全般プロパティ画面にて [次へ] をクリックします。</li><li>実行アカウント画面に一覧から、問題が発生している SCOM 管理サーバー や SCOM エージェントに設定されているアカウント名を確認します。</li></ol><p>手順は以上です。</p><h2 id="他の問題事例"><a href="#他の問題事例" class="headerlink" title="他の問題事例"></a>他の問題事例</h2><p>アクション アカウントとログオン/ログオフに使用しているアカウントが同じであることによる他の問題事例を紹介します。</p><p>事例：以下アカウントで指定しているユーザーが同じである場合<br>　・SCOM 管理サーバーの  MonitoringHost.exe のアクションアカウント<br>　・SCOM 管理サーバーにログインするアカウント</p><p>この場合、SCOM 管理サーバーの OS からログオフした際に SCOM 管理サーバーの  MonitoringHost.exe で監視している linux コンピューターがグレーアウトする事例がございます。<br>下図構成となるため、ログオフした際に MonitoringHost.exe が動作するために必要な情報（例えばレジストリキーに設定している値）などもログオフとともに参照できなくなり、linux コンピューターが監視不能状態となりグレーアウト状態になる場合があります。</p><p><a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-planning-agent-deployment?view=sc-om-2022&tabs=Windows#linuxunix-agent">Operations Manager エージェント</a></p><p><img src="/blog/SCOM/SCOM_highmemory_MonitoringHost/0101.png"></p><p>上記事例もございますため、アクション アカウントとログオン/ログオフに使用しているアカウントが同じ場合はどちらかのアカウントを変更してくださいするようお願いいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以下、SCOM） が監視のために利用するプロセスである Mon</summary>
      
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Troubleshoot" scheme="https://jpsystemcenter.github.io/blog/tags/Troubleshoot/"/>
    
    <category term="MonitoringHost.exe" scheme="https://jpsystemcenter.github.io/blog/tags/MonitoringHost-exe/"/>
    
  </entry>
  
  <entry>
    <title>SCOM の 更新プログラムのロールアップの適用手順</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_Update_Rollup/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_Update_Rollup/</id>
    <published>2023-11-20T05:00:00.000Z</published>
    <updated>2025-12-10T08:31:18.987Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>今回は、SCOM に更新プログラムのロールアップ (UR：Update Rollup) を適用する手順について説明します。<br><br></p><span id="more"></span><h2 id="更新プログラムのロールアップ-UR：Update-Rollup-について"><a href="#更新プログラムのロールアップ-UR：Update-Rollup-について" class="headerlink" title="更新プログラムのロールアップ (UR：Update Rollup) について"></a>更新プログラムのロールアップ (UR：Update Rollup) について</h2><p>本記事の公開日時点 (2023/11/20) でサポートが有効な System Center Operations Manager（以後 SCOM）には SCOM 2016, SCOM 2019, SCOM 2022 の 3つのバージョンがあります。<br>各々のバージョンの初期公開時のモジュールを一般公開版 (GA：General Availability) と呼びます。一般公開版のリリース後、機能追加や不具合修正、セキュリティ対策等の更新プログラムは、更新プログラムのロールアップ (UR：Update Rollup) として提供されます。そのため、SCOM を最新の状態に維持するためには、更新プログラムのロールアップを適用いただく必要があります。</p><p>各々のバージョンの 更新プログラムのロールアップのリリース状況は以下サイトをご参照ください。<br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/scom/release-build-versions?view=sc-om-2022">SCOM 2022： System Center Operations Manager のリリース ビルドのバージョン | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/scom/release-build-versions?view=sc-om-2019">SCOM 2019： System Center Operations Manager のリリース ビルドのバージョン | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/scom/release-build-versions?view=sc-om-2016">SCOM 2016： System Center Operations Manager のリリース ビルドのバージョン | Microsoft Learn</a></p><p>なお、セキュリティ対策以外の更新プログラム (機能追加や不具合修正) は、原則、メインストリーム サポート期間中 (SCOM 2022, SCOM 2019 <span style="color: red; ">※2023/11/20 時点</span>) の製品に対して提供されます。延長サポート期間中 (SCOM 2016 <span style="color: red; ">※2023/11/20 時点</span>) の製品には、セキュリティ対策の更新プログラムのみが提供されます。</p><p>各バージョンのサポート状況につきましては以下のサイトをご参照ください。<br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2022-operations-manager">System Center 2022 Operations Manager - Microsoft Lifecycle | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2019-operations-manager">System Center 2019 Operations Manager - Microsoft Lifecycle | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2016-operations-manager">System Center 2016 Operations Manager - Microsoft Lifecycle | Microsoft Learn</a><br>また、メインストリーム サポート期間や延長サポート期間の説明につきましては、<a href="https://learn.microsoft.com/ja-jp/lifecycle/policies/fixed">固定ライフサイクル ポリシーのサイト</a>をご参照ください。</p><h2 id="更新プログラムのロールアップ-UR：Update-Rollup-の適用手順"><a href="#更新プログラムのロールアップ-UR：Update-Rollup-の適用手順" class="headerlink" title="更新プログラムのロールアップ (UR：Update Rollup) の適用手順"></a>更新プログラムのロールアップ (UR：Update Rollup) の適用手順</h2><p>今回は、<b>SCOM 2022 に本記事の公開日時点で最新の UR2 を適用する手順</b>をご紹介します。<br>SCOM の更新プログラムのロールアップは累積型のため、順番に適用する必要はありません。常に最新の更新プログラムを適用できます。一般公開版の SCOM 2022 を導入し、更新プログラムのロールアップを適用したことがない場合でも、利用可能な最新の更新プログラム (今回の場合は UR2) を適用することができます。</p><p>UR の適用の際には、<a href="https://learn.microsoft.com/ja-jp/system-center/scom/release-build-versions?view=sc-om-2022#management-server-and-other-components">System Center Operations Manager のビルド バージョン</a> の表の KB 列のリンクをクリックして、最新の更新プログラム ロールアップのサイトに進みます。<br><img src="000.png"></p><p><a href="https://support.microsoft.com/kb/5031649">更新プログラム ロールアップのサイト(SCOM 2022 UR2)</a> には、更新プログラムの内容（機能追加、不具合修正、セキュリティ対策）とモジュールのダウンロード方法、インストール手順が記載されています。</p><hr><p><b>● ステップ１：モジュールをダウンロードする</b><br>① ～ ②のリンクからモジュールをダウンロードします。<br><img src="001.png"></p><p>① Operations Manager 更新プログラム パッケージを<a href="https://www.catalog.update.microsoft.com/Search.aspx?q=5031649">ダウンロード</a>します。<br><img src="002.png"></p><p>ダウンロードファイルしたファイルを展開します。</p><table border="1">    <tr>        <th style="background-color: royalblue; text-align: center; color: black;">対象</th>        <th style="background-color: royalblue; text-align: center; color: black;">ダウンロードファイル</th>        <th style="background-color: royalblue; text-align: center; color: black;">cab ファイル展開後のファイル</th>        <th style="background-color: royalblue; text-align: center; color: black;">備考</th>    </tr>    <tr style="font-size: 12px;">        <td>SCOM 管理サーバー</td>        <td>kb5031649-amd64-server_***.cab</td>        <td>KB5031649-amd64-Server.msp</td>        <td>簡略化された SCOM 管理サーバーの修正プログラムを<br>実行する場合は不要です。</td>    </tr>    <tr style="font-size: 12px;">        <td>SCOM 監査コレクション (ACS)</td>        <td>kb5031649-amd64-acs_***.cab</td>        <td>KB5031649-amd64-ACS.msp</td>        <td></td>    </tr>    <tr style="font-size: 12px;">        <td>Web コンソール</td>        <td>kb5031649-amd64-webconsole_***.cab</td>        <td>KB5031649-amd64-WebConsole.msp</td>        <td></td>    </tr>    <tr style="font-size: 12px;">        <td>SCOM ゲートウェイサーバー</td>        <td>kb5031649-amd64-gateway_***.cab</td>        <td>KB5031649-amd64-Gateway.msp</td>        <td></td>    </tr>    <tr style="font-size: 12px;">        <td>SCOM 管理コンソール</td>        <td>kb5031649-amd64-console_***.cab</td>        <td>KB5031649-amd64-Console.msp</td>        <td></td>    </tr>    <tr style="font-size: 12px;">        <td>レポート</td>        <td>kb5031649-amd64-reporting_***.cab</td>        <td>KB5031649-amd64-Reporting.msp</td>        <td></td>    </tr>    <tr style="font-size: 12px;">        <td>SCOM エージェント</td>        <td>kb5031649-amd64-agent_***.cab</td>        <td>KB5031649-amd64-Agent.msp</td>        <td>SCOM コンソールからアップデートも可能です。</td>    </tr></table><p>② 簡略化された SCOM 管理サーバーの修正プログラム (KB5031649-amd64-Server.exe) を<a href="https://download.microsoft.com/download/d/d/2/dd29ad67-a37e-42f8-9e02-50dd7dac7ec0/KB5031649-amd64-Server.exe">ダウンロード</a>します。</p><p><b>● ステップ２：コマンドプロンプトを管理者で起動して、以下の順でモジュールを実行します。</b><br>　※ コマンドプロンプトを管理者として起動 <img src="003.png"></p><p>【実行の順番】</p><ol><li>簡略化された SCOM 管理サーバーの修正プログラム KB5031649-amd64-Server.exe</li><li>監査コレクション用モジュール　　 KB5031649-amd64-ACS.msp</li><li>Web コンソール用モジュール　　　 KB5031649-amd64-WebConsole.msp</li><li>ゲートウェイサーバー用モジュール KB5031649-amd64-Gateway.msp</li><li>SCOM 管理コンソール用モジュール  KB5031649-amd64-Console.msp</li><li>レポート用モジュール　　　　　　 KB5031649-amd64-Reporting.msp</li><li>エージェント用モジュール　　　　 KB5031649-amd64-Agent.msp</li></ol><p>実行コマンド結果の画面ショットは以下の通りです。</p><ol><li><p>簡略化された SCOM 管理サーバーの修正プログラム (KB5031649-amd64-Server.exe)<br>※ 簡略化された SCOM 管理サーバーの修正プログラムが存在する場合は、本プログラムの使用を推奨します。SCOM 管理サーバー用モジュール (KB5031649-amd64-Server.msp) を用いてアップデートする場合、追加でデータベースの更新と管理パックの更新が必要になります。簡略化された SCOM 管理サーバーの修正プログラムは、これらの更新を一括で行うプログラムです。 <img src="004.png"><br>[Install] を実行します。　<img src="005.png"><br>  <img src="005_2.png"></p></li><li><p>監査コレクション用モジュール (KB5031649-amd64-ACS.mspe)<br><span style="color: red; ">※ 監査コレクションを導入していない SCOM 環境では不要です。</span> <img src="006.png">　<img src="007.png"></p></li><li><p>Web コンソール用モジュール (KB5031649-amd64-WebConsole.msp)<br><span style="color: red; ">※ Web コンソールを導入していない SCOM 環境では不要です。</span> <img src="008.png"></p></li><li><p>ゲートウェイサーバー用モジュール (KB5031649-amd64-Gateway.msp)<br><span style="color: red; ">※ SCOM ゲートウェイ サーバーで実行します。SCOM ゲートウェイ サーバーを導入していない SCOM 環境では不要です。</span> <img src="009.png"></p></li><li><p>SCOM 管理コンソール用モジュール (KB5031649-amd64-Console.msp)<br><span style="color: red; ">※ SCOM 管理サーバーと SCOM コンソールを導入した全てのサーバーで実行します。</span> <img src="010.png"></p></li><li><p>レポート用モジュール (KB5031649-amd64-Reporting.msp)<br><span style="color: red; ">※ レポート機能を導入していない SCOM 環境では不要です。</span> <img src="016.png"></p></li><li><p>エージェント用モジュール (KB5031649-amd64-Agent.msp)<br><span style="color: red; ">※ エージェントサーバーで実行します。</span> <img src="011.png"></p></li></ol><p>※ SCOM コンソールからプッシュインストールしていた場合は、SCOM コンソールから UR2 への更新が可能です。 <img src="012.png"></p><ol start="8"><li>UNIX および Linux 管理パックの更新<br>以下のサイトよりUNIX および Linux 管理パックをダウンロードして、SCOM にインポートします。<br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=104213">Download System Center 2022 Management Pack for UNIX and Linux Operating Systems from Official Microsoft Download Center</a><br><br>管理パックのインポート方法については以下のサポートブログもご参照ください。<br><a href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_ManagementPacks/">管理パック (MP) のインポートについて | Japan System Center Support Blog (jpsystemcenter.github.io)</a></li></ol><p><b>● ステップ３：適用状況を確認します。</b><br>SCOM 管理コンソールの管理画面の [Operations Manager 製品] 配下のメニューにて各モジュールのバージョンを確認できます。<br>SCOM 2022 UR2 のバージョンは<span style="color: red; "> [10.22.10610.0] </span>です。</p><p>■ SCOM 管理サーバー<br><img src="015.png"></p><p>■ SCOM 管理コンソール<br><img src="017.png"></p><p>■ Web コンソール<br><img src="013.png"></p><p>■ 監査コレクション<br><img src="014.png"> </p><p>■ レポート<br><img src="018.png"></p><hr><h2 id="UR-適用時の-OS-再起動の可能性について"><a href="#UR-適用時の-OS-再起動の可能性について" class="headerlink" title="UR 適用時の OS 再起動の可能性について"></a>UR 適用時の OS 再起動の可能性について</h2><p>UR の適用では、基本的には SCOM 管理サーバーや管理対象のサーバーの再起動は発生いたしません。ユーザー様からの事例報告でも OS 再起動はほとんど確認しておりません。<br>ただし、仕組み上は OS 再起動が発生する可能性があります。</p><p>UR のモジュールは、Windows インストーラ形式のファイル ( msp/msi ファイル) にて提供されます。msp/msi インストーラを使用したインストール/アンインストールの挙動として、実行時に置き換えが必要なファイル等が他プロセスによりハンドルを保持されていて置き換えできない場合、一度 OS 再起動を試行してファイルの置き換えを実施します。 そのため、この仕様にあたる状況となった場合に OS 再起動が発生する可能性があります。<br>下記公開情報に記載の通り、基本的にはアプリケーション単位でシャットダウンして、システム全体 (OS) のシャットダウンにつながらないような考慮になっておりますが、可能性という意味では発生し得る点をご認識ください。<br>　参考：再起動マネージャーでの Windows インストーラーの使用<br>　<a href="https://learn.microsoft.com/ja-jp/windows/win32/msi/using-windows-installer-with-restart-manager">https://learn.microsoft.com/ja-jp/windows/win32/msi/using-windows-installer-with-restart-manager</a></p><hr><p>SCOM の UR 適用手順は以上の通りです。<br>本手順を参考に SCOM を常に最新の状態にてご利用いただけますと幸いです</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;今回は、SCOM に更新プログラムのロールアップ (UR：Update Rollup) を適用する手順について説明します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM サーバーの構成" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E6%A7%8B%E6%88%90/"/>
    
    <category term="更新プログラム ロールアップ" scheme="https://jpsystemcenter.github.io/blog/tags/%E6%9B%B4%E6%96%B0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0-%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97/"/>
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="インストール" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB/"/>
    
    <category term="アップグレード" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM の 更新プログラムのロールアップの適用手順</title>
    <link href="https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Update_Rollup/"/>
    <id>https://jpsystemcenter.github.io/blog/SCVMM/SCVMM_Update_Rollup/</id>
    <published>2023-11-20T04:00:00.000Z</published>
    <updated>2025-12-10T08:31:19.071Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。<br>今回は、SCVMM に更新プログラムのロールアップ (UR：Update Rollup) を適用する手順について説明します。<br><br></p><span id="more"></span><h2 id="更新プログラムのロールアップ-UR：Update-Rollup-について"><a href="#更新プログラムのロールアップ-UR：Update-Rollup-について" class="headerlink" title="更新プログラムのロールアップ (UR：Update Rollup) について"></a>更新プログラムのロールアップ (UR：Update Rollup) について</h2><p>本記事の公開日時点 (2023/11/20) でサポートが有効な System Center Virtual Machine Manager（以後 SCVMM）には SCVMM 2016, SCVMM 2019, SCVMM 2022 の 3つのバージョンがあります。<br>各々のバージョンの初期公開時のモジュールを一般公開版 (GA：General Availability) と呼びます。一般公開版のリリース後、機能追加や不具合修正、セキュリティ対策等の更新プログラムは、更新プログラムのロールアップ (UR：Update Rollup) として提供されます。そのため、SCVMM を最新の状態に維持するためには、更新プログラムのロールアップを適用いただく必要があります。</p><p>各々のバージョンの 更新プログラムのロールアップのリリース状況は以下サイトをご参照ください。<br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/release-build-versions?view=sc-vmm-2022">SCVMM 2022： System Center Virtual Machine Managerのビルド バージョンをリリースする | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/release-build-versions?view=sc-vmm-2019">SCVMM 2019： System Center Virtual Machine Managerのビルド バージョンをリリースする | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/release-build-versions?view=sc-vmm-2016">SCVMM 2016： System Center Virtual Machine Managerのビルド バージョンをリリースする | Microsoft Learn</a></p><p>なお、セキュリティ対策以外の更新プログラム (機能追加や不具合修正) は、原則、メインストリーム サポート期間中 (SCVMM 2022, SCVMM 2019 <span style="color: red; ">※2023/11/20 時点</span>) の製品に対して提供されます。延長サポート期間中 (SCVMM 2016 <span style="color: red; ">※2023/11/20 時点</span>) の製品には、セキュリティ対策の更新プログラムのみが提供されます。</p><p>各バージョンのサポート状況につきましては以下のサイトをご参照ください。<br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2022-virtual-machine-manager">System Center 2022 Virtual Machine Manager - Microsoft Lifecycle | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2019-virtual-machine-manager">System Center 2019 Virtual Machine Manager - Microsoft Lifecycle | Microsoft Learn</a><br>　・<a href="https://learn.microsoft.com/ja-jp/lifecycle/products/system-center-2016-virtual-machine-manager">System Center 2016 Virtual Machine Manager - Microsoft Lifecycle | Microsoft Learn</a><br>また、メインストリーム サポート期間や延長サポート期間の説明につきましては、<a href="https://learn.microsoft.com/ja-jp/lifecycle/policies/fixed">固定ライフサイクル ポリシーのサイト</a>をご参照ください。</p><h2 id="更新プログラムのロールアップ-UR：Update-Rollup-の適用手順"><a href="#更新プログラムのロールアップ-UR：Update-Rollup-の適用手順" class="headerlink" title="更新プログラムのロールアップ (UR：Update Rollup) の適用手順"></a>更新プログラムのロールアップ (UR：Update Rollup) の適用手順</h2><p>今回は、<b>SCVMM 2022 に本記事の公開日時点で最新の UR2 を適用する手順</b>をご紹介します。<br>SCVMM の更新プログラムのロールアップは累積型のため、順番に適用する必要はありません。常に最新の更新プログラムを適用できます。一般公開版の SCVMM 2022 を導入し、更新プログラムのロールアップを適用したことがない場合でも、利用可能な最新の更新プログラム (今回の場合は UR2) を適用することができます。</p><p>UR の適用の際には、<a href="https://learn.microsoft.com/ja-jp/system-center/vmm/release-build-versions?view=sc-vmm-2022#virtual-machine-manager-2022-build-versions">Virtual Machine Manager 2022 ビルド バージョン</a> の表の KB 列のリンクをクリックして、最新の更新プログラム ロールアップのサイトに進みます。<br><img src="001.png"></p><p><a href="https://support.microsoft.com/kb/5032369">更新プログラム ロールアップのサイト(SCVMM 2022 UR2)</a> には、更新プログラムの内容（機能追加、不具合修正、セキュリティ対策）とモジュールのダウンロード方法、インストール手順が記載されています。</p><hr><p><b>● ステップ１：モジュールをダウンロードする</b><br>① ～ ③の 3つのモジュールをダウンロードします。<br><img src="002.png"></p><p>① Virtual Machine Manager サーバー更新プログラム パッケージ (<a href="https://www.catalog.update.microsoft.com/Search.aspx?q=5032369">kb5032369_vmmserver_amd64_***.cab</a>) をダウンロードします。<br>ダウンロードファイルしたファイルを展開します。※展開後のファイル：kb5032369_vmmserver_amd64.msp<br><img src="003.png"></p><p>② 管理者コンソールの更新プログラム パッケージ (<a href="https://www.catalog.update.microsoft.com/Search.aspx?q=5032370">kb5032370_adminconsole_amd64_***.cab</a>) をダウンロードします。<br>ダウンロードファイルしたファイルを展開します。※展開後のファイル：kb5032370_AdminConsole_amd64.msp<br><img src="004.png"></p><p>③ ゲスト エージェントの更新プログラム パッケージ (<a href="https://www.catalog.update.microsoft.com/Search.aspx?q=5032371">kb5032371_vmmguestagent_amd64_***.cab</a>) をダウンロードします。<br>ダウンロードファイルしたファイルを展開します。※展開後のファイル：kb5032371_vmmGuestAgent_amd64.msp<br><img src="005.png"></p><p><b>● ステップ２：コマンドプロンプトを管理者で起動して、以下の順でモジュールを実行します。</b><br>　※ コマンドプロンプトを管理者として起動 <img src="014.png"></p><p>【実行の順番】</p><ol><li>SCVMM 管理サーバー用モジュール kb5032369_vmmserver_amd64.msp</li><li>SCVMM コンソール用モジュール 　kb5032370_AdminConsole_amd64.msp</li><li>SCVMM エージェント用モジュール kb5032371_vmmGuestAgent_amd64.msp</li></ol><p>実行コマンド結果の画面ショットは以下の通りです。</p><ol><li><p>SCVMM 管理サーバー用モジュール (kb5032369_vmmserver_amd64.msp)<br>　＞ msiexec.exe /update kb5032369_vmmserver_amd64.msp <img src="006.png"></p></li><li><p>SCVMM コンソール用モジュール (kb5032370_AdminConsole_amd64.msp)<br>　<span style="color: red; ">※ SCVMM 管理サーバーのほか、SCVMM コンソールを導入した全てのサーバーで実行します。</span><br>　＞ msiexec.exe /update kb5032370_AdminConsole_amd64.msp <img src="007.png"></p></li><li><p>SCVMM エージェント用モジュール (kb5032371_vmmGuestAgent_amd64.msp)<br>　<span style="color: red; ">※ エージェントサーバーで実行します。</span><br>　＞ msiexec.exe /update kb5032371_vmmGuestAgent_amd64.msp <img src="008.png"></p></li></ol><p>　※ SCVMM エージェントの更新は、モジュールを実行する代わりにSCVMM コンソールから UR2 へ更新することも可能です。 <img src="009.png"></p><p><b>● ステップ３：適用状況を確認します。</b><br>SCVMM コンソールから各コンポーネントのバージョンを確認することができます。<br>SCVMM 2022 UR2 のバージョンは<span style="color: red; "> [10.22.1711.0] </span>です。</p><p>■ SCVMM コンソール <img src="010.png"></p><p>■ SCVMM 管理サーバー <img src="011.png"></p><p>■ SCVMM エージェント <img src="012.png"></p><hr><h2 id="高可用性-VMM-管理サーバーを構成している場合"><a href="#高可用性-VMM-管理サーバーを構成している場合" class="headerlink" title="高可用性 VMM 管理サーバーを構成している場合"></a>高可用性 VMM 管理サーバーを構成している場合</h2><p>複数台の SCVMM 管理サーバーで高可用性 VMM 管理サーバーを構成している場合、全ての SCVMM 管理サーバーで SCVMM 管理サーバー用モジュール と SCVMM コンソール用モジュールを適用する必要があります。適用の順番は、待機系の SCVMM サーバーから適用します。</p><p>【実行の順番】</p><ol><li>待機系の SCVMM 管理サーバーにて SCVMM 管理サーバー用モジュール と SCVMM コンソール用モジュールを適用</li><li>フェールオーバー クラスターマネージャーで稼働系を待機系に切り替え （<span style="color: red; ">※1</span>）</li><li>待機系に切り替わった元稼働系サーバーに SCVMM 管理サーバー用モジュール と SCVMM コンソール用モジュールを適用</li></ol><p><span style="color: red; font-weight: bold;">※1 SCVMM の稼働系の切り替え方法</span><br>SCVMM の稼働系はフェールオーバー クラスターマネージャーの役割画面で移動することで切り替えることができます。<br><img src="013.png"><br><br></p><h2 id="UR-適用時の-OS-再起動の可能性について"><a href="#UR-適用時の-OS-再起動の可能性について" class="headerlink" title="UR 適用時の OS 再起動の可能性について"></a>UR 適用時の OS 再起動の可能性について</h2><p>UR の適用では、基本的には SCVMM 管理サーバーや管理対象のホストサーバーの再起動は発生いたしません。ユーザー様からの事例報告でも OS 再起動はほとんど確認しておりません。<br>ただし、仕組み上は OS 再起動が発生する可能性があります。</p><p>UR のモジュールは、Windows インストーラ形式のファイル ( msp/msi ファイル) にて提供されます。msp/msi インストーラを使用したインストール/アンインストールの挙動として、実行時に置き換えが必要なファイル等が他プロセスによりハンドルを保持されていて置き換えできない場合、一度 OS 再起動を試行してファイルの置き換えを実施します。 そのため、この仕様にあたる状況となった場合に OS 再起動が発生する可能性があります。<br>下記公開情報に記載の通り、基本的にはアプリケーション単位でシャットダウンして、システム全体 (OS) のシャットダウンにつながらないような考慮になっておりますが、可能性という意味では発生し得る点をご認識ください。<br>　参考：再起動マネージャーでの Windows インストーラーの使用<br>　<a href="https://learn.microsoft.com/ja-jp/windows/win32/msi/using-windows-installer-with-restart-manager">https://learn.microsoft.com/ja-jp/windows/win32/msi/using-windows-installer-with-restart-manager</a></p><hr><p>SCVMM の UR 適用手順は以上の通りです。<br>本手順を参考に SCVMM を常に最新の状態にてご利用いただけますと幸いです</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;br&gt;今回は、SCVMM に更新プログラムのロールアップ (UR：Update Rollup) を適用する手順について説明します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="更新プログラム ロールアップ" scheme="https://jpsystemcenter.github.io/blog/tags/%E6%9B%B4%E6%96%B0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0-%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97/"/>
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="インストール" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB/"/>
    
    <category term="アップグレード" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89/"/>
    
    <category term="SCVMM" scheme="https://jpsystemcenter.github.io/blog/tags/SCVMM/"/>
    
  </entry>
  
  <entry>
    <title>管理パック (MP) のインポートについて</title>
    <link href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_ManagementPacks/"/>
    <id>https://jpsystemcenter.github.io/blog/SCOM/SCOM_ManagementPacks/</id>
    <published>2023-09-22T09:00:00.000Z</published>
    <updated>2025-12-10T08:31:18.978Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、System Center サポートチームの 石原 です。</p><p>今回は、System Center Operations Manager (SCOM) に管理パック (MP：Management Pack) をインポートすることにより監視機能を拡充する手順についてご紹介します。<br><br></p><span id="more"></span><h2 id="管理パック-MP-Management-Pack-導入による監視機能の追加について"><a href="#管理パック-MP-Management-Pack-導入による監視機能の追加について" class="headerlink" title="管理パック (MP:Management Pack) 導入による監視機能の追加について"></a>管理パック (MP:Management Pack) 導入による監視機能の追加について</h2><p>以前のブログ (<a href="https://jpsystemcenter.github.io/blog/SCOM/SCOM_Install_Manual/">SCOM 管理サーバー構築手順 ～ 全画面ショット付き | Japan System Center Support Blog</a>) では SCOM 管理サーバー環境の構築手順を紹介しました。SCOM 管理サーバー環境の構築完了後、エージェントの展開などの前にまず最初に行う必要がある作業が管理パックの導入です。</p><p>SCOM には OS 種別やソフトウェアごとに『管理パック』というモジュールが存在していて、管理パックを導入することで初めて対象システムの監視が有効になります。<br><br><b>管理パックの一覧サイト</b> <a href="https://social.technet.microsoft.com/wiki/contents/articles/16174.microsoft-management-packs.aspx">Microsoft Management Packs - TechNet Articles - United States - TechNet Wiki</a><br><img src="001.png" width="400"></p><p>代表的な管理パックには以下のようなものがあります。<br>【管理パックの例】<br>・Windows Server の監視用管理パック　　　　 ：System Center Management Pack for Windows Server Operating System<br>・Microsoft SQL Server の監視用管理パック　　：Microsoft System Center MP for SQL Server<br>・Microsoft Adtive Directory の監視要管理パック：Microsoft System Center Management Pack for ADDS</p><p>SCOM 管理サーバーの構築時に導入される管理パックは、SCOM のサーバー機能の動作に必要な最小限の管理パックに限られていて、上に記載したような代表的な管理パックについても導入されていません。<br>　※SCOM サーバーの構築時にインストールされる管理パックについては、以下のサイトをご参照ください。<br>　　<a href="https://learn.microsoft.com/ja-jp/system-center/scom/manage-mp-installed-during-seutp?view=sc-om-2022">Operations Manager と一緒にインストールされる管理パック | Microsoft Learn</a></p><p>つまり、SCOM で適切な監視を開始するためには、対応する管理パックを導入する必要があります。</p><p>管理パックの導入は、以下の手順で進めます。<br>　① <a href="#%E2%91%A0-%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99%EF%BC%91%EF%BC%9AOperationsManager-%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E6%8B%A1%E5%BC%B5">事前準備１：OperationsManager データベースのファイルサイズの拡張</a><br>　② <a href="#%E2%91%A1-%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99%EF%BC%92%EF%BC%9A%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E7%94%A8%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4-%E2%80%BB%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%81%BF">事前準備２：レポート機能用データベースの設定変更 (※レポート機能をインストールした場合のみ)</a><br>　③ <a href="#%E2%91%A2-%E7%AE%A1%E7%90%86%E3%83%91%E3%83%83%E3%82%AF%E3%81%AE%E5%B0%8E%E5%85%A5">管理パックの導入</a></p><h2 id="①-事前準備１：OperationsManager-データベースのファイルサイズの拡張"><a href="#①-事前準備１：OperationsManager-データベースのファイルサイズの拡張" class="headerlink" title="① 事前準備１：OperationsManager データベースのファイルサイズの拡張"></a>① 事前準備１：OperationsManager データベースのファイルサイズの拡張</h2><p>SCOM 管理サーバーのインストール時に OperationsManager と OperationsManagerDW の２つのデータベースが作成されます。<br>これらのデータベースは、インストール ウィザードに沿ってインストールを行うと、既定で以下の設定になります。</p><table border="1">    <tr>        <th style="background-color: royalblue; text-align: center; color: black;">データベース名</th>        <th style="background-color: royalblue; text-align: center; color: black;">ファイル</th>        <th style="background-color: royalblue; text-align: center; color: black;">初期サイズ (MB)</th>        <th style="background-color: royalblue; text-align: center; color: black;">自動拡張</th>        <th style="background-color: royalblue; text-align: center; color: black;">用途</th>    </tr>    <tr style="font-size: 12px;">        <td rowspan="2">OperationsManager</td>        <td>OperationsManager.mdf</td>        <td style="background-color: yellow; text-align: center;"><b>1,000</b></td>        <td style="background-color: yellow; text-align: center;"><b>無し</b></td>        <td rowspan="2">主に短期データを保管するデータベース<br>        <a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2022#operations-manager-database">Operations Manager データベース | Microsoft Learn</a></td>    </tr>    <tr style="font-size: 12px;">        <td>OperationsManager.ldf</td>        <td style="background-color: yellow; text-align: center;"><b>500</b></td>        <td style="background-color: yellow; text-align: center;"><b>無し</b></td>    </tr>    <tr style="font-size: 12px;">        <td rowspan="2">OperationsManagerDW</td>        <td>OperationsManagerDW.mdf</td>        <td style="text-align: center;">1,000</td>        <td>あり。10 MB 単位</td>        <td rowspan="2">主に長期データを保管するデータベース<br>        <a href="https://learn.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2022#operations-manager-data-warehouse-database">Operations Manager データウェアハウス データベース | Microsoft Learn</a></td>    </tr>    <tr style="font-size: 12px;">        <td>OperationsManagerDW.ldf</td>        <td style="text-align: center;">500</td>        <td>あり。10 MB 単位</td>    </tr></table><p>SCOM に管理パックを導入すると、管理パックに包含されるモジュール (監視を定義する xml ファイルなど) がデータベースに保管されます。大部分の管理パックは数 MB 程度以内のファイルサイズですが、中には 100 MB を超える管理パックも存在します。<br>[OperationsManager] データベースは <b>自動拡張</b>が <b>[なし]</b> の設定のため、多数の管理パックを導入する場合、データベースの使用量が増加してファイルサイズを圧迫することになります。そのため、管理パックの導入の前に予めデータベースのファイルサイズを拡大しておく必要があります。</p><p>■ データベースファイルの拡張手順<br>ファイルサイズの拡張は、SQL Server Management Studio から実施できます。<br><br> 1. SQL Server Management Studio にて、データベース管理者アカウントで SCOM データベースに接続します。<br> 2. [データベース] -&gt; [OperationsManager] を選択して、右クリックメニューの [プロパティ] をクリックします。<br> 3. データベースのプロパティ画面にて [File] を開きます。<br> 4. サイズを拡大して、OK ボタンをクリックします。<br> <img src="002.png"></p><p>※ 拡張するサイズの目安について<br>データベースサーバーのディスクサイズに余裕がある場合は OperationsManager.mdf を 10,000 MB、OperationsManager.ldf を 5,000 MB程度に拡大することを推奨します。このサイズであれば、将来に渡って管理パックによるディスクサイズの圧迫は懸念する必要がなくなります。ただし、[OperationsManager] データベースには、管理パックデータ以外にもエージェントが収集した短期データなどが保管されますので、実際には環境ごとにチューニングが必要です。</p><h2 id="②-事前準備２：レポート機能用データベースの設定変更-※レポート機能をインストールした場合のみ"><a href="#②-事前準備２：レポート機能用データベースの設定変更-※レポート機能をインストールした場合のみ" class="headerlink" title="② 事前準備２：レポート機能用データベースの設定変更 (※レポート機能をインストールした場合のみ)"></a>② 事前準備２：レポート機能用データベースの設定変更 (※レポート機能をインストールした場合のみ)</h2><p>レポート機能をインストールした場合、管理パックに含まれるレポートの定義情報がレポートデータベースに展開されます。SQL Server レポーティングサービスの既定の設定を変更して、正しくコンテンツが展開できるようにする必要があります。<br>　※本設定については、以下のユーザーマニュアルサイトもご参照ください。<br>　　<a href="https://learn.microsoft.com/ja-jp/troubleshoot/system-center/scom/cannot-deploy-operations-manager-reports">Operations Manager レポートの展開に失敗する - Operations Manager | Microsoft Learn</a></p><p>レポートデータベースの設定変更の手順は以下の通りです。<br> 1. SQL Server Management Studio (SSMS) を起動し、SCOM が使用するレポートサーバーインスタンスに接続します。<br>　- サーバーの種類: Reporting Services<br>　- サーバー名: &lt;SSRS インスタンスが存在するサーバー名&gt;&lt;SSRS インスタンス名&gt;<br>　※ SSRS の既定のインスタンス名は “SSRS” です。SSRS インスタンス名は、[スタート] メニューより<br>　　[Microsoft SQL Server Reporting Services] -&gt; [Report Server Configuration Manager] を開き<br>　　[レポートサーバーの構成の接続] の [レポート サーバー インスタンス] の名称にて確認できます。<br>　- 認証、ユーザー名、パスワード: SSRS 側で設定いただいた認証方式およびパスワード<br> <img src="003.png"><br> 2. レポートサーバー名を右クリックし、[ プロパティ] を選択して、[ 詳細設定] を選択します。<br> 3. AllowedResourceExtensionsForUploadの設定を見つけ、 設定値に<b> *.* </b>を入力して、[OK] をクリックします。<br>【設定箇所】<br> <img src="004.png">【変更後の値】<br> <img src="005.png"><br> 4. SSRS を以下手順で再起動します。<br>　- Reporting Services 構成ツールを起動して、レポート サーバーに接続します。<br>　- [レポート サーバーの状態] ページで [停止] をクリックし、その後 [開始] を選択します。</p><h2 id="③-管理パックの導入"><a href="#③-管理パックの導入" class="headerlink" title="③ 管理パックの導入"></a>③ 管理パックの導入</h2><p>事前準備が完了したら、いよいよ管理パックの導入です。<br>管理パックの導入方法には、３つの方法があります。</p><p>　<a href="#link1">１）SCOM 管理コンソールの [更新プログラムと推奨機能]  にて推奨管理パックを導入</a><br>　<a href="#link2">２）SCOM 管理コンソールにて、カタログから管理パックをダウンロードして導入</a><br>　<a href="#link3">３）管理パック一覧サイトから選択した管理パックを導入</a></p><p>今回は、基本的な管理パックを [更新プログラムと推奨機能] にて導入して、追加の管理パックをカタログからダウンロードして導入した後、最後に一覧サイトからダウンロードした管理パックを追加導入するシナリオで手順を説明します。</p><div id="link1"><b>１）SCOM 管理コンソールの [更新プログラムと推奨機能]  にて推奨管理パックを導入</b></div>SCOM 管理サーバーの構築の後、たくさん存在する管理パックの中からどの管理パックの導入から開始すべきかが分からない場合、最も簡易的に進められる方法です。手順は以下の通りです。<ol><li>SCOM コンソールにログインして、画面左下ペインの [管理] をクリックして、[管理] 画面を開きます。</li><li> [管理] -&gt; [管理パック] -&gt; [更新プログラムと推奨機能] をクリックします。</li><li>特定の管理パックを選択して [管理パックを取得] をクリックするか、[すべての管理パックを取得] をクリックします。<br>今回の例では [すべての管理パックを取得] をクリックしました。<br><img src="006.png"></li><li>[管理パックのインポート] 画面にて [インストール] ボタンをクリックして、管理パックをインポートします。<br></li></ol><p>※ 注意事項<br> ① 管理パックの中には、日本語の言語パックが存在するものがありますが、[更新プログラムと推奨機能] では言語パックは選択されません。日本語の言語パックが必要な場合は、あとで追加で導入する必要があります。<br> ② [更新プログラムと推奨機能] では、最初、多数の管理パックが表示されます。管理パックには依存関係 (導入の順番) が存在するものがあるため、一部の管理パックの導入が失敗することがありますが、失敗した場合は、再度、[すべての管理パックを取得] を行うことで、依存関係を満たした管理パックの導入が成功するようになりますので、何度か本作業を繰り返してください。<br> <img src="007.png"></p><div id="link2"><b>２）SCOM 管理コンソールにて、カタログから管理パックをダウンロードして導入</b></div>[更新プログラムと推奨機能] に含まれる管理パックを導入することで、Windows Server や Unix/Linux サーバーの基本的な監視は可能になります。一方で、Microsoft SQL Server や Active Directory などのソフトウェア用の管理パックは [更新プログラムと推奨機能] には含まれておらず、相変わらず監視できません。また、[更新プログラムと推奨機能] に含まれない言語パックも未導入です。<p>これらの管理パックは、Microsoft のカタログサイトから取得して導入することができます。</p><p>手順は以下の通りです。<br> 1. SCOM コンソールにログインして、画面左下ペインの [管理] をクリックして、[管理] 画面を開きます。<br> 2. 右クリックメニューにて [管理パックのインポート] をクリックします。<br> <img src="008.png"><br> 3. [管理パックのインポート] 画面にて [追加] -&gt; [カタログから追加する] をクリックします。<br> <img src="009.png"><br> 4. [検索] を実行することでカタログからインポート可能な管理パックが表示されます。<br>　必要な管理パックを選択して [追加] ボタンをクリックします。</p><p>　例１）Active Directory Domain Service の管理パック<br>　　[Windows Server] - [Active Directory Domain Services 2016 and above]<br> <img src="010.png"><br>　例２）Windows Server 1026 and above 用の日本語言語パック<br>　　[Windows Server] - [Core OS 2016 and above] - [Japanese]<br> <img src="011.png"><br> 5. 管理パックの追加が完了したら [OK] ボタン -&gt; [インストール] ボタンをクリックして導入します。<br> <img src="012.png"></p><div id="link3"><b>３）管理パック一覧サイトから選択した管理パックを導入</b></div>SCOM 管理サーバーがインターネット接続できない場合や Microsoft のカタログサイトから取得できない管理パックを導入する場合、管理パックをローカルディスクにコピーして、ディスクから追加することができます。<p>ここでは、SQL Server の管理パックの導入を例に説明します。</p><ol><li>管理パックの一覧サイト (<a href="https://social.technet.microsoft.com/wiki/contents/articles/16174.microsoft-management-packs.aspx">Microsoft Management Packs - TechNet Articles - United States (English) - TechNet Wiki</a>) にアクセスします。</li><li>SQL Server 用管理パックのリンク (<a href="https://www.microsoft.com/en-us/download/details.aspx?id=56203">Download Microsoft System Center MP for SQL Server from Official Microsoft Download Center</a>) をクリックします。<br><img src="013.png"></li><li>[Download] をクリックします。<img src="021.png" width="500"></li><li>必要なファイルを選択して [Download] をクリックします。<br><span style="color: red;">※ 重要<br>[SQLServerMPWorkflowList.pdf] は、SQL Server 用管理パックのマニュアルです。管理パックの導入手順、システム要件、サポート対象、含まれるルールやモニター、ビューなどの情報を確認できます。多くの管理パックは、ダウンロードページにてマニュアルを取得することができます。</span><br><img src="014.png"></li><li>SCOM 管理サーバー内に msi ファイルをコピーして、管理者で実行します。<br>ローカルディスクに管理パック ファイルが解凍されます。<br>例）SQLServerMP.Windows.msi を実行して解凍した管理パックファイル<br><img src="015.png"></li><li>SCOM コンソールにログインして、画面左下ペインの [管理] をクリックして、[管理] 画面を開きます。</li><li>右クリックメニューにて [管理パックのインポート] をクリックします。</li><li>[管理パックのインポート] 画面にて [追加] -&gt; [ディスクから追加する] をクリックします。<br><img src="016.png"></li><li>解凍した管理パックファイルをすべて選択して [インストール] ボタンをクリックします。<br><img src="017.png"></li></ol><br>以上により管理パックの導入作業は完了です。<h2 id="管理パックの導入確認"><a href="#管理パックの導入確認" class="headerlink" title="管理パックの導入確認"></a>管理パックの導入確認</h2><p>管理パックの導入が完了すると、モニターやルールに該当する OS やソフトウェアの設定が追加されたことが確認できます。<br> 例）モニター画面：Active Diretory 監視用のモニター<br> <img src="018.png"><br>収集したデータを確認するためのビューが追加されたことが確認できます。<br> 例）監視画面：Active Diretory に関する収集データを確認するビュー<br> <img src="019.png"><br>レポートが追加されたことも確認できます。<br> 例）レポート画面：Active Diretory に関する収集データを確認するレポート<br> <img src="020.png"></p><p>以上により、監視の準備が完了しましたので、監視対象サーバーにエージェントを展開して、SCOM による監視ができるようになります。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;皆様こんにちは、System Center サポートチームの 石原 です。&lt;/p&gt;
&lt;p&gt;今回は、System Center Operations Manager (SCOM) に管理パック (MP：Management Pack) をインポートすることにより監視機能を拡充する手順についてご紹介します。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="SCOM" scheme="https://jpsystemcenter.github.io/blog/tags/SCOM/"/>
    
    <category term="Operations Manager" scheme="https://jpsystemcenter.github.io/blog/tags/Operations-Manager/"/>
    
    <category term="HowTo" scheme="https://jpsystemcenter.github.io/blog/tags/HowTo/"/>
    
    <category term="インストール" scheme="https://jpsystemcenter.github.io/blog/tags/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB/"/>
    
  </entry>
  
</feed>
